---
title: "Code"
author: "Edna Chiang"
date: "February 5, 2018"
output: html_document
---

### Load Packages, scripts, and functions
```{r}
library(ggplot2)
library(plyr)
library(dplyr)
library(grid)
library(car)
library(dunn.test)
library(Rmisc)
source('scripts/misc.R')
set.seed(1)
theme_set(theme_bw())
```

### Load Data
```{r}
load('crds.norm.RData')
load('crds.use.Rdata')
meta <- read.csv('metadata.csv')
```

### Prepare CRDS data
```{r}
# Add metadata
crds.use[, colnames(meta)[3:ncol(meta)]] <- NA
for(i in 1:nrow(crds.use)){
  meta.row <- which(meta$ID == crds.use$ID[i])
  crds.use[i, 7:ncol(crds.use)] <- meta[meta.row, 3:ncol(meta)]
}

# Calculate square root of AUC
crds.use$AUC <- as.numeric(crds.use$AUC)
minAUC <- min(crds.use$AUC)
crds.use$AUC_sqrt <- crds.use$AUC + (minAUC * -1)
crds.use$AUC_sqrt <- sqrt(crds.use$AUC_sqrt)

# Convert to numeric
crds.use$AvgD <- as.numeric(crds.use$AvgD)
crds.use$MaxD <- as.numeric(crds.use$MaxD)
crds.use$MaxSlope <- as.numeric(crds.use$MaxSlope)
crds.use$AUC <- as.numeric(crds.use$AUC)
crds.use$MaxD <- as.numeric(crds.use$MaxD)
crds.use$Baseline <- as.numeric(crds.use$Baseline)

# Order categorical variables
crds.use$Season <- ordered(crds.use$Season, levels = c("Summer", "Winter", "Spring"))
crds.use$Sex <- ordered(crds.use$Sex, levels = c("Female", "Male"))
crds.use$Antibiotics <- ordered(crds.use$Antibiotics, levels = c("No", "Yes"))
crds.use$Substrate <- ordered(crds.use$Substrate, levels = c("Inulin", "Saline"))
crds.use$Diet <- ordered(crds.use$Diet, levels = c("1", "2"))

# Remove outliers
crds.rem <- crds.use[-which(crds.use$ID == "S23"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "S37"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "S60"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "W43"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "W20"),]
  # This is due to odd metagenome
crds.rem <- crds.rem[-which(crds.rem$ID == "W50"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "P20"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "P22"),]

# Separate by substrate
crds.inu <- crds.rem[which(crds.rem$Substrate == "Inulin"),]
crds.sal <- crds.rem[which(crds.rem$Substrate == "Saline"),]

# Separate by substrate + season
crds.inu.s <- crds.inu[which(crds.inu$Season == "Summer"),]
crds.inu.w <- crds.inu[which(crds.inu$Season == "Winter"),]
crds.inu.p <- crds.inu[which(crds.inu$Season == "Spring"),]
crds.sal.s <- crds.sal[which(crds.sal$Season == "Summer"),]
crds.sal.w <- crds.sal[which(crds.sal$Season == "Winter"),]
crds.sal.p <- crds.sal[which(crds.sal$Season == "Spring"),]

# Separate by substrate + antibiotics
crds.inu.noabx <- crds.inu[which(crds.inu$Antibiotics == "No"),]
crds.inu.abx <- crds.inu[which(crds.inu$Antibiotics == "Yes"),]
crds.sal.noabx <- crds.sal[which(crds.sal$Antibiotics == "No"),]
crds.sal.abx <- crds.sal[which(crds.sal$Antibiotics == "Yes"),]
```




### Test AUC_sqrt
```{r}
### Inulin ###

# No ABX
res <- resid(lm(AUC_sqrt ~ Season, crds.inu.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
summary(aov(AUC_sqrt ~ Season, crds.inu.noabx))
  # p = 0.0919
TukeyHSD(aov(AUC_sqrt ~ Season, crds.inu.noabx))


# ABX
res <- resid(lm(AUC_sqrt ~ Season, crds.inu.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(AUC_sqrt ~ Season, crds.inu.abx))
  # p = 0.568
TukeyHSD(aov(AUC_sqrt ~ Season, crds.inu.abx))



### Saline ###

# No ABX
res <- resid(lm(AUC_sqrt ~ Season, crds.sal.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(AUC_sqrt ~ Season, crds.sal.noabx))
  # p = 0.146
TukeyHSD(aov(AUC_sqrt ~ Season, crds.sal.noabx))


# ABX
res <- resid(lm(AUC_sqrt ~ Season, crds.sal.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(AUC_sqrt ~ Season, crds.sal.abx))
  # p = 0.434
TukeyHSD(aov(AUC_sqrt ~ Season, crds.sal.abx))



### ANOVA/KW Adj P
p.adjust(c(0.0919, 0.568, 0.146, 0.434), "BH")
  # 0.292 0.568 0.292 0.568
```


### Plot AUC_sqrt
```{r}
### Prepare data for plotting
# Inulin
crds.inu$SeasonABX <- interaction(crds.inu$Season, crds.inu$Antibiotics)
crds.inu$SeasonABX <- ordered(crds.inu$SeasonABX, levels=c("Summer.No", "Summer.Yes", "Winter.No", "Winter.Yes", "Spring.No", "Spring.Yes"))

# Saline
crds.sal$SeasonABX <- interaction(crds.sal$Season, crds.sal$Antibiotics)
crds.sal$SeasonABX <- ordered(crds.sal$SeasonABX, levels=c("Summer.No", "Summer.Yes", "Winter.No", "Winter.Yes", "Spring.No", "Spring.Yes"))


### AUC Dot Plots

# Steal Season legend
season.legend <- g_legend(ggplot(crds.inu, aes(x = Season, y = AUC_sqrt, color = Season, fill = Season)) +
                            geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5,
                                         position = position_dodge(0.7), stackratio = 0.5) +
                            scale_color_manual(values = c("#c98b00", "#006096", "#00966d")) +
                            scale_fill_manual(values = c("#E69F00", "#0072B2", "#00bf8b")) +
                            theme(legend.title = element_text(size=10, face="bold"),
                                  legend.text = element_text(size=10),
                                  legend.margin = margin(t=1, unit='cm')))


# Steal ABX legend
abx.legend <- g_legend(ggplot(crds.inu, aes(x = Season, y = AUC_sqrt, fill = Antibiotics)) + 
                         geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5, 
                                      position = position_dodge(0.7), stackratio = 0.5) +
                         scale_fill_manual(values = c("black", "white")) +
                            theme(legend.title = element_text(size=10, face="bold"),
                                  legend.text = element_text(size=10),
                                  legend.margin = margin(b=1, unit='cm')))




  
# Inulin
inu.AUC.plot <- ggplot(crds.inu, aes(x = Season, y = AUC_sqrt, color = Season,
                                    fill = Season)) +
  facet_grid(Antibiotics ~ ., scales = "free") +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5,
               position = position_dodge(0.7), stackratio = 0.5) +
  scale_color_manual(values = c("#c98b00", "#E69F00", "#004166", "#006299", "#00966d",
                                "#00bf8b")) +
  scale_fill_manual(values = c("#E69F00", "white", "#006299", "white", "#00bf8b",
                               "white")) +
  stat_summary(fun.data = "mean_cl_normal", fun.args = list(mult = 1), geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.5) +
  ggtitle("Inulin")  + 
  ylab(expression("AUC"~~delta^13~"C"~"(%"[o]~")")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(face="bold", size=10, margin = margin(t = 7.5)),
        axis.title.y = element_text(face="bold", size=10),
        axis.text.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
        legend.position = "none")



# Saline
sal.AUC.plot <- ggplot(crds.sal, aes(x = Season, y = AUC_sqrt, color = SeasonABX,
                                    fill = SeasonABX)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5,
               position = position_dodge(0.7), stackratio = 0.5) +
  scale_color_manual(values = c("#c98b00", "#E69F00", "#004166", "#006299", "#00966d",
                                "#00bf8b")) +
  scale_fill_manual(values = c("#E69F00", "white", "#006299", "white", "#00bf8b",
                               "white")) +
  stat_summary(fun.data = "mean_cl_normal", fun.args = list(mult = 1), geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.5) +
  ggtitle("Saline")  + 
  ylab(expression("AUC"~~delta^13~"C"~"(%"[o]~")")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(face="bold", size=10, margin = margin(t = 7.5)),
        axis.title.y = element_text(face="bold", size=10),
        axis.text.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
        legend.position = "none")



### Plot

#tiff("crds.AUC.tiff", width = 200, height = 75, units = "mm", res = 600)
grid.newpage()
pushViewport(viewport(layout=grid.layout(2,3, widths = c(1, 1, 0.3))))

print(inu.AUC.plot, vp=viewport(layout.pos.row=1:2, layout.pos.col=1))
grid.text("A", x=unit(0.065, "npc"), y=unit(0.93, "npc"), 
          vp=viewport(layout.pos.row=1, layout.pos.col=1), gp=gpar(fontsize=20,fontface="bold"))


print(sal.AUC.plot, vp=viewport(layout.pos.row=1:2, layout.pos.col=2))
grid.text("B", x=unit(0.065, "npc"), y=unit(0.93, "npc"),
          vp=viewport(layout.pos.row=1, layout.pos.col=2), gp=gpar(fontsize=20,fontface="bold"))

season.legend$vp <- viewport(layout.pos.row=1, layout.pos.col=3)
grid.draw(season.legend)
abx.legend$vp <- viewport(layout.pos.row=2, layout.pos.col=3)
grid.draw(abx.legend)
#dev.off()
```


### Test AvgD
```{r}
### Inulin ###

# No ABX
res <- resid(lm(AvgD ~ Season, crds.inu.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(AvgD ~ Season, crds.inu.noabx))
  # p = 0.133
TukeyHSD(aov(AvgD ~ Season, crds.inu.noabx))
  

# ABX
res <- resid(lm(AvgD ~ Season, crds.inu.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(AvgD ~ Season, crds.inu.abx))
  # p = 0.593
TukeyHSD(aov(AvgD ~ Season, crds.inu.abx))



### Saline ###

# No ABX
res <- resid(lm(AvgD ~ Season, crds.sal.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(AvgD ~ Season, crds.sal.noabx))
  # p = 0.154
TukeyHSD(aov(AvgD ~ Season, crds.sal.noabx))


# ABX
res <- resid(lm(AvgD ~ Season, crds.sal.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(AvgD ~ Season, crds.sal.abx))
  # p = 0.195
TukeyHSD(aov(AvgD ~ Season, crds.sal.abx))





### ANOVA/KW Adj P
p.adjust(c(0.133, 0.593, 0.154, 0.195), "BH")
  # 0.260 0.593 0.260 0.260
```




### Plot AvgD
```{r}
### Prepare data for plotting
# Inulin
crds.inu$SeasonABX <- interaction(crds.inu$Season, crds.inu$Antibiotics)
crds.inu$SeasonABX <- ordered(crds.inu$SeasonABX, levels=c("Summer.No", "Summer.Yes", "Winter.No", "Winter.Yes", "Spring.No", "Spring.Yes"))

# Saline
crds.sal$SeasonABX <- interaction(crds.sal$Season, crds.sal$Antibiotics)
crds.sal$SeasonABX <- ordered(crds.sal$SeasonABX, levels=c("Summer.No", "Summer.Yes", "Winter.No", "Winter.Yes", "Spring.No", "Spring.Yes"))


### AUC Dot Plots

# Steal Season legend
season.legend <- g_legend(ggplot(crds.inu, aes(x = Season, y = AvgD, color = Season, fill = Season)) +
                            geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5,
                                         position = position_dodge(0.7), stackratio = 0.5) +
                            scale_color_manual(values = c("#c98b00", "#006096", "#00966d")) +
                            scale_fill_manual(values = c("#E69F00", "#0072B2", "#00bf8b")) +
                            theme(legend.title = element_text(size=10, face="bold"),
                                  legend.text = element_text(size=10),
                                  legend.margin = margin(t=1, unit='cm')))


# Steal ABX legend
abx.legend <- g_legend(ggplot(crds.inu, aes(x = Season, y = AvgD, fill = Antibiotics)) + 
                         geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5, 
                                      position = position_dodge(0.7), stackratio = 0.5) +
                         scale_fill_manual(values = c("black", "white")) +
                            theme(legend.title = element_text(size=10, face="bold"),
                                  legend.text = element_text(size=10),
                                  legend.margin = margin(b=1, unit='cm')))




  
# Inulin
inu.avgD.plot <- ggplot(crds.inu, aes(x = Season, y = AvgD, color = SeasonABX,
                                    fill = SeasonABX)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5,
               position = position_dodge(0.7), stackratio = 0.5) +
  scale_color_manual(values = c("#c98b00", "#E69F00", "#004166", "#006299", "#00966d",
                                "#00bf8b")) +
  scale_fill_manual(values = c("#E69F00", "white", "#006299", "white", "#00bf8b",
                               "white")) +
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1), geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.5) +
  ggtitle("Inulin")  + 
  ylab(expression("Average"~~delta^13~"C"~"(%"[o]~")")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(face="bold", size=10, margin = margin(t = 7.5)),
        axis.title.y = element_text(face="bold", size=10),
        axis.text.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
        legend.position = "none")



# Saline
sal.avgD.plot <- ggplot(crds.sal, aes(x = Season, y = AvgD, color = SeasonABX,
                                    fill = SeasonABX)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5,
               position = position_dodge(0.7), stackratio = 0.5) +
  scale_color_manual(values = c("#c98b00", "#E69F00", "#004166", "#006299", "#00966d",
                                "#00bf8b")) +
  scale_fill_manual(values = c("#E69F00", "white", "#006299", "white", "#00bf8b",
                               "white")) +
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1), geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.5) +
  ggtitle("Saline")  + 
  ylab(expression("Average"~~delta^13~"C"~"(%"[o]~")")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(face="bold", size=10, margin = margin(t = 7.5)),
        axis.title.y = element_text(face="bold", size=10),
        axis.text.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
        legend.position = "none")



### Plot

#tiff("crds.avgD.tiff", width = 200, height = 75, units = "mm", res = 600)
grid.newpage()
pushViewport(viewport(layout=grid.layout(2,3, widths = c(1, 1, 0.3))))

print(inu.avgD.plot, vp=viewport(layout.pos.row=1:2, layout.pos.col=1))
grid.text("A", x=unit(0.065, "npc"), y=unit(0.93, "npc"), 
          vp=viewport(layout.pos.row=1, layout.pos.col=1), gp=gpar(fontsize=20,fontface="bold"))


print(sal.avgD.plot, vp=viewport(layout.pos.row=1:2, layout.pos.col=2))
grid.text("B", x=unit(0.065, "npc"), y=unit(0.93, "npc"),
          vp=viewport(layout.pos.row=1, layout.pos.col=2), gp=gpar(fontsize=20,fontface="bold"))

season.legend$vp <- viewport(layout.pos.row=1, layout.pos.col=3)
grid.draw(season.legend)
abx.legend$vp <- viewport(layout.pos.row=2, layout.pos.col=3)
grid.draw(abx.legend)
#dev.off()
```


### Test MaxD
```{r}
### Inulin ###

# No ABX
res <- resid(lm(MaxD ~ Season, crds.inu.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(MaxD ~ Season, crds.inu.noabx))
  # p = 0.00765
TukeyHSD(aov(MaxD ~ Season, crds.inu.noabx))



# ABX
res <- resid(lm(MaxD ~ Season, crds.inu.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(MaxD ~ Season, crds.inu.abx))
  # p = 0.991
TukeyHSD(aov(MaxD ~ Season, crds.inu.abx))



### Saline ###

# No ABX
res <- resid(lm(MaxD ~ Season, crds.sal.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(MaxD ~ Season, crds.sal.noabx))
  # p = 0.191
TukeyHSD(aov(MaxD ~ Season, crds.sal.noabx))



# ABX
res <- resid(lm(MaxD ~ Season, crds.sal.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(MaxD ~ Season, crds.sal.abx))
  # p = 0.191
TukeyHSD(aov(MaxD ~ Season, crds.sal.abx))



### ANOVA/KW Adj P
p.adjust(c(0.00765, 0.991, 0.191, 0.191), "BH")
  # 0.0306000 0.9910000 0.2546667 0.2546667
```



### Plot MaxD
```{r}
### Prepare data for plotting
# Inulin
crds.inu$SeasonABX <- interaction(crds.inu$Season, crds.inu$Antibiotics)
crds.inu$SeasonABX <- ordered(crds.inu$SeasonABX, levels=c("Summer.No", "Summer.Yes", "Winter.No", "Winter.Yes", "Spring.No", "Spring.Yes"))

# Saline
crds.sal$SeasonABX <- interaction(crds.sal$Season, crds.sal$Antibiotics)
crds.sal$SeasonABX <- ordered(crds.sal$SeasonABX, levels=c("Summer.No", "Summer.Yes", "Winter.No", "Winter.Yes", "Spring.No", "Spring.Yes"))


### AUC Dot Plots

# Steal Season legend
season.legend <- g_legend(ggplot(crds.inu, aes(x = Season, y = MaxD, color = Season, fill = Season)) +
                            geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5,
                                         position = position_dodge(0.7), stackratio = 0.5) +
                            scale_color_manual(values = c("#c98b00", "#006096", "#00966d")) +
                            scale_fill_manual(values = c("#E69F00", "#0072B2", "#00bf8b")) +
                            theme(legend.title = element_text(size=10, face="bold"),
                                  legend.text = element_text(size=10),
                                  legend.margin = margin(t=1, unit='cm')))


# Steal ABX legend
abx.legend <- g_legend(ggplot(crds.inu, aes(x = Season, y = MaxD, fill = Antibiotics)) + 
                         geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5, 
                                      position = position_dodge(0.7), stackratio = 0.5) +
                         scale_fill_manual(values = c("black", "white")) +
                            theme(legend.title = element_text(size=10, face="bold"),
                                  legend.text = element_text(size=10),
                                  legend.margin = margin(b=1, unit='cm')))




  
# Inulin
inu.maxD.plot <- ggplot(crds.inu, aes(x = Season, y = MaxD, color = SeasonABX,
                                    fill = SeasonABX)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5,
               position = position_dodge(0.7), stackratio = 0.5) +
  scale_color_manual(values = c("#c98b00", "#E69F00", "#004166", "#006299", "#00966d",
                                "#00bf8b")) +
  scale_fill_manual(values = c("#E69F00", "white", "#006299", "white", "#00bf8b",
                               "white")) +
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1), geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.5) +
  ggtitle("Inulin")  + 
  ylab(expression("Maximum"~~delta^13~"C"~"(%"[o]~")")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(face="bold", size=10, margin = margin(t = 7.5)),
        axis.title.y = element_text(face="bold", size=10),
        axis.text.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
        legend.position = "none")



# Saline
sal.maxD.plot <- ggplot(crds.sal, aes(x = Season, y = MaxD, color = SeasonABX,
                                    fill = SeasonABX)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5,
               position = position_dodge(0.7), stackratio = 0.5) +
  scale_color_manual(values = c("#c98b00", "#E69F00", "#004166", "#006299", "#00966d",
                                "#00bf8b")) +
  scale_fill_manual(values = c("#E69F00", "white", "#006299", "white", "#00bf8b",
                               "white")) +
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1), geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.5) +
  ggtitle("Saline")  + 
  ylab(expression("Maximum"~~delta^13~"C"~"(%"[o]~")")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(face="bold", size=10, margin = margin(t = 7.5)),
        axis.title.y = element_text(face="bold", size=10),
        axis.text.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
        legend.position = "none")



### Plot

#tiff("crds.maxD.tiff", width = 200, height = 75, units = "mm", res = 600)
grid.newpage()
pushViewport(viewport(layout=grid.layout(2,3, widths = c(1, 1, 0.3))))

print(inu.maxD.plot, vp=viewport(layout.pos.row=1:2, layout.pos.col=1))
grid.text("A", x=unit(0.065, "npc"), y=unit(0.93, "npc"), 
          vp=viewport(layout.pos.row=1, layout.pos.col=1), gp=gpar(fontsize=20,fontface="bold"))


print(sal.maxD.plot, vp=viewport(layout.pos.row=1:2, layout.pos.col=2))
grid.text("B", x=unit(0.065, "npc"), y=unit(0.93, "npc"),
          vp=viewport(layout.pos.row=1, layout.pos.col=2), gp=gpar(fontsize=20,fontface="bold"))

season.legend$vp <- viewport(layout.pos.row=1, layout.pos.col=3)
grid.draw(season.legend)
abx.legend$vp <- viewport(layout.pos.row=2, layout.pos.col=3)
grid.draw(abx.legend)
#dev.off()
```



### Test MaxSlope
```{r}
### Inulin ###

# No ABX
res <- resid(lm(MaxSlope ~ Season, crds.inu.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(MaxSlope ~ Season, crds.inu.noabx))
  # p = 0.000286
TukeyHSD(aov(MaxSlope ~ Season, crds.inu.noabx))



# ABX
res <- resid(lm(MaxSlope ~ Season, crds.inu.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(MaxSlope ~ Season, crds.inu.abx))
  # p = 0.00123
TukeyHSD(aov(MaxSlope ~ Season, crds.inu.abx))




### Saline ###

# No ABX
res <- resid(lm(MaxSlope ~ Season, crds.sal.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Test says not normal, but I disagree
  # Normal
summary(aov(MaxSlope ~ Season, crds.sal.noabx))
  # p = 0.64
TukeyHSD(aov(MaxSlope ~ Season, crds.sal.noabx))


# ABX
res <- resid(lm(MaxSlope ~ Season, crds.sal.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(MaxSlope ~ Season, crds.sal.abx))
  # p = 0.217
TukeyHSD(aov(MaxSlope ~ Season, crds.sal.abx))


### ANOVA/KW Adj P
p.adjust(c(0.000286, 0.00123, 0.64, 0.217), "BH")
  # 0.0011440 0.0024600 0.6400000 0.2893333





### Test Spring Variance
crds.inu.p.noabx <- crds.inu.noabx[which(crds.inu.noabx$Season == "Spring"),]
crds.inu.p.noabx$Day <- substr(crds.inu.p.noabx$Date_Sampled, 3, 4)
crds.inu.p.noabx$Day[1] <- 8
crds.inu.p.noabx$Day <- as.numeric(crds.inu.p.noabx$Day)

# Correlation
res <- resid(lm(MaxSlope ~ Day, crds.inu.p.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
cor.test(crds.inu.p.noabx$MaxSlope, crds.inu.p.noabx$Day, method = "pearson")
  # p-value = 0.4681
  # CI = -0.8678027  0.5620692
  # cor = -0.3311587 
```



### Plot MaxSlope
```{r}
### Prepare data for plotting
# Inulin
crds.inu$SeasonABX <- interaction(crds.inu$Season, crds.inu$Antibiotics)
crds.inu$SeasonABX <- ordered(crds.inu$SeasonABX, levels=c("Summer.No", "Summer.Yes", "Winter.No", "Winter.Yes", "Spring.No", "Spring.Yes"))

# Saline
crds.sal$SeasonABX <- interaction(crds.sal$Season, crds.sal$Antibiotics)
crds.sal$SeasonABX <- ordered(crds.sal$SeasonABX, levels=c("Summer.No", "Summer.Yes", "Winter.No", "Winter.Yes", "Spring.No", "Spring.Yes"))


### AUC Dot Plots

# Steal Season legend
season.legend <- g_legend(ggplot(crds.inu, aes(x = Season, y = MaxSlope, color = Season, fill = Season)) +
                            geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5,
                                         position = position_dodge(0.7), stackratio = 0.5) +
                            scale_color_manual(values = c("#c98b00", "#006096", "#00966d")) +
                            scale_fill_manual(values = c("#E69F00", "#0072B2", "#00bf8b")) +
                            theme(legend.title = element_text(size=10, face="bold"),
                                  legend.text = element_text(size=10),
                                  legend.margin = margin(t=1, unit='cm')))


# Steal ABX legend
abx.legend <- g_legend(ggplot(crds.inu, aes(x = Season, y = MaxSlope, fill = Antibiotics)) + 
                         geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5, 
                                      position = position_dodge(0.7), stackratio = 0.5) +
                         scale_fill_manual(values = c("black", "white")) +
                            theme(legend.title = element_text(size=10, face="bold"),
                                  legend.text = element_text(size=10),
                                  legend.margin = margin(b=1, unit='cm')))




  
# Inulin
inu.slope.plot <- ggplot(crds.inu, aes(x = Season, y = MaxSlope, color = SeasonABX,
                                    fill = SeasonABX)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5,
               position = position_dodge(0.7), stackratio = 0.5) +
  scale_color_manual(values = c("#c98b00", "#E69F00", "#004166", "#006299", "#00966d",
                                "#00bf8b")) +
  scale_fill_manual(values = c("#E69F00", "white", "#006299", "white", "#00bf8b",
                               "white")) +
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1), geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.5) +
  ggtitle("Inulin")  + 
  ylab(expression("Maximum"~~delta^13~"C Slope"~"(%"[o]~~"/ time)")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(face="bold", size=10, margin = margin(t = 7.5)),
        axis.title.y = element_text(face="bold", size=10),
        axis.text.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
        legend.position = "none")



# Saline
sal.slope.plot <- ggplot(crds.sal, aes(x = Season, y = MaxSlope, color = SeasonABX,
                                    fill = SeasonABX)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5,
               position = position_dodge(0.7), stackratio = 0.5) +
  scale_color_manual(values = c("#c98b00", "#E69F00", "#004166", "#006299", "#00966d",
                                "#00bf8b")) +
  scale_fill_manual(values = c("#E69F00", "white", "#006299", "white", "#00bf8b",
                               "white")) +
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1), geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.5) +
  ggtitle("Saline")  + 
  ylab(expression("Maximum"~~delta^13~"C Slope"~"(%"[o]~~"/ time)")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(face="bold", size=10, margin = margin(t = 7.5)),
        axis.title.y = element_text(face="bold", size=10),
        axis.text.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
        legend.position = "none")



### Plot

#tiff("crds.slope.tiff", width = 200, height = 75, units = "mm", res = 600)
grid.newpage()
pushViewport(viewport(layout=grid.layout(2,3, widths = c(1, 1, 0.3))))

print(inu.slope.plot, vp=viewport(layout.pos.row=1:2, layout.pos.col=1))
grid.text("A", x=unit(0.065, "npc"), y=unit(0.93, "npc"), 
          vp=viewport(layout.pos.row=1, layout.pos.col=1), gp=gpar(fontsize=20,fontface="bold"))


print(sal.slope.plot, vp=viewport(layout.pos.row=1:2, layout.pos.col=2))
grid.text("B", x=unit(0.065, "npc"), y=unit(0.93, "npc"),
          vp=viewport(layout.pos.row=1, layout.pos.col=2), gp=gpar(fontsize=20,fontface="bold"))

season.legend$vp <- viewport(layout.pos.row=1, layout.pos.col=3)
grid.draw(season.legend)
abx.legend$vp <- viewport(layout.pos.row=2, layout.pos.col=3)
grid.draw(abx.legend)
#dev.off()
```






### Prepare data for Delta curve plots
```{r}
crds.sum <- crds.norm %>%
  group_by(Substrate, Antibiotics, Season, BinTime) %>%
  summarize(Y_Mean = mean(DeltaNorm),
            Y_SD = sd(DeltaNorm),
            Y_SE = se(DeltaNorm),
            X_Mean = mean(RelTime),
            X_SD = sd(RelTime),
            X_SE = se(RelTime),
            SampSize = n())
  # X_Mean is different from BinTime because BinTime was calculated with ABX and non-ABX combined
    # BinTime was calculated this way to make sure datapoints for all individuals will align together on x-axis. If datapoints are misaligned that can be confusing for the audience. So binning was done this way for the clearest visualization.
    # X_Mean is calculated for ABX and non-ABX separately, so there will be some variation
crds.sum$Season <- ordered(crds.sum$Season, levels=c("Summer", "Winter", "Spring"))


# Prepare data
inu.all <- crds.sum[which(crds.sum$Substrate == "Inulin"),]
sal.all <- crds.sum[which(crds.sum$Substrate == "Saline"),]
```



### Plot Delta Curves
```{r}

### Inulin
inu.delta.plot <- ggplot(inu.all, aes(x=X_Mean, y=Y_Mean, color=Season)) +
   geom_line(aes(linetype=Antibiotics), size=0.75, show.legend = F) +
   geom_point(size=2.5, shape=21, aes(color=Season, 
                                    fill=factor(ifelse(Antibiotics == "Yes", NA, Season))), show.legend = F) +
  scale_color_manual(values = c("#E69F00", "#0072B2", "#00bf8b"), guide = "none") +
  scale_fill_manual(values=c("#E69F00", "#0072B2", "#00bf8b"), na.value="white", guide="none") +
  geom_errorbar(aes(ymin = Y_Mean-Y_SD, ymax = Y_Mean+Y_SD), width = 0.09,
                position = "dodge") +
  geom_errorbarh(aes(xmin = X_Mean-X_SD, xmax = X_Mean+X_SD), height = 125,
                 position = "dodge") +
  ggtitle(expression("Inulin"~~delta^13~"C")) +
  xlab("Time Since Gavage (hr)") +
  ylab(expression("Mean"~~delta^13~"C"~"(%"[o]~")")) +
  xlim(-0.3,4.15) +
  scale_y_continuous(breaks=c(-780, 0, 780, 1560, 2340, 3120, 3900), limits=c(-780, 3900)) +
    theme(plot.title=element_text(hjust=0.5, size=10),
        axis.title.x=element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.text.x=element_text(size=10),
        axis.text.y=element_text(size=10),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())


## Saline
sal.delta.plot <- ggplot(sal.all, aes(x=X_Mean, y=Y_Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=0.75) +
  geom_point(size=2.5, shape=21, aes(color=Season, 
                                   fill=factor(ifelse(Antibiotics == "Yes", NA, Season))), show.legend = F) +
  scale_color_manual(values = c("#E69F00", "#0072B2", "#00bf8b")) +
  scale_fill_manual(values=c("#E69F00", "#0072B2", "#00bf8b"), na.value="white") +
  geom_errorbar(aes(ymin = Y_Mean-Y_SD, ymax = Y_Mean+Y_SD), width = 0.05,
                position = "dodge") +
  geom_errorbarh(aes(xmin = X_Mean-X_SD, xmax = X_Mean+X_SD), height = 0.75,
                 position = "dodge") +
  scale_y_continuous(breaks=c(-15, -10, -5, 0, 5, 10), limits=c(-19, 7.4)) +
  ggtitle(expression("Saline"~~delta^13~"C")) +
  xlab("Time Since Gavage (hr)") +
  ylab(expression("Mean"~~delta^13~"C"~"(%"[o]~")")) +
  theme(plot.title=element_text(hjust=0.5, size=10),
        axis.title.x=element_text(size=10),
        axis.title.y=element_text(size=10),
        axis.text.x=element_text(size=10),
        axis.text.y=element_text(size=10),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        legend.title=element_text(size=10, face = "bold"),
        legend.text=element_text(size=10))






tiff("delta.curves.tiff", width = 6.5, height = 3, units = "in", res = 600)
grid.newpage()
pushViewport(viewport(layout=grid.layout(1,2, widths = c(1, 1.35))))

print(inu.delta.plot, vp=viewport(layout.pos.row=1, layout.pos.col=1))
grid.text("A", x=unit(0.065, "npc"), y=unit(0.95, "npc"), 
          vp=viewport(layout.pos.row=1, layout.pos.col=1), gp=gpar(fontsize=14,fontface="bold"))


print(sal.delta.plot, vp=viewport(layout.pos.row=1, layout.pos.col=2))
grid.text("B", x=unit(0.05, "npc"), y=unit(0.95, "npc"),
          vp=viewport(layout.pos.row=1, layout.pos.col=2), gp=gpar(fontsize=14,fontface="bold"))

dev.off()






### All 2 substrates on same axis
carb.plot <- ggplot(crds.sum, aes(x=BinTime, y=Y_Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
   geom_point(size=3, shape=21, aes(color=Season, fill=factor(ifelse(Antibiotics == "Yes", NA, Season)))) +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"), na.value="white", guide="none") +
  geom_errorbar(aes(ymin = Y_Mean-Y_SD, ymax = Y_Mean+Y_SD), width=0.125, position=position_dodge(0.1)) + 
  facet_grid(.~Substrate) +
  xlab("Time Since Gavage (hr)") +
  ylab(expression("Mean"~~delta^13~"C"~"(%"[o]~")")) +
  xlim(-0.6,4.41) +
  scale_y_continuous(breaks=c(0, 500, 1000, 1500, 2000, 2500, 3000, 3500, 4000), limits=c(-30, 4000)) +
  theme(axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        axis.title.x = element_text(size=20, margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y = element_text(size=20, margin=margin(t=0, r=10, b=, l=0)),
        strip.text.x = element_text(size=20, face="bold"),
        strip.text.y = element_text(size=14),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 20, face="bold"),
        legend.text = element_text(size=18),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        strip.background = element_blank()
  )



#png("deltaCurves.sd.png", width = 240, height = 110, units = "mm", res = 400)
carb.plot
#dev.off()
```



### Hib Dates
```{r}
### Load data

# Dates
dates <- read.csv('metadata_dates.csv')
dates_use <- dates[-which(dates$Season == "Summer"),]
rownames(dates_use) <- 1:nrow(dates_use)
dates_use <- dates_use[-13:-28,]
rownames(dates_use) <- 1:nrow(dates_use)
dates_use <- dates_use[-33:-40,]

# Remove outliers
dates_use <- dates_use[-which(dates_use$ID == "W20"),]



# Add CRDS metrics
for(k in 1:nrow(dates_use)){
  ID <- dates_use$ID[k]
  rowUse <- which(crds.rem$ID == ID)
  dates_use$AvgD[k] <- crds.rem$AvgD[rowUse]
  dates_use$MaxD[k] <- crds.rem$MaxD[rowUse]
  dates_use$MaxSlope[k] <- crds.rem$MaxSlope[rowUse]
  dates_use$AUC_sqrt[k] <- crds.rem$AUC_sqrt[rowUse]
  dates_use$Baseline[k] <- crds.rem$Baseline[rowUse]
}
  
# Separate Spring
dates.spr <- dates_use[which(dates_use$Season == "Spring"),]



### Test IBA-Hib Ratio

# Test normality
res <- resid(lm(IBA.Hib ~ Season, dates_use))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
var.test(IBA.Hib ~ Season, dates_use)
  # p-value = 0.8404
t.test(IBA.Hib ~ Season, dates_use)
  # p = 0.3313

```
