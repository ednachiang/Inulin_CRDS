---
title: "Code"
author: "Edna Chiang"
date: "February 5, 2018"
output: html_document
---

### Load Packages, scripts, and functions
```{r}
library(ggplot2)
library(plyr)
library(dplyr)
library(grid)
library(MESS)
library(pgirmess)
library(Bolstad2)
library(phyloseq)
library(miLineage)
library(psych)
library(car)
source('scripts/import_crds.R')
source('scripts/bin_crds.R')
source('scripts/misc.R')
source('scripts/calc_delta_metrics.R')
set.seed(1)
theme_set(theme_bw())

### Stats Notes
# Use 'subset' in kruskal.test
# Do NOT use 'subset' in kruskalmc or pairwise.wilcox.test; it doesn't work!
```

### Load Data
```{r}
crds <- import.crds('CSV', 'metadata.csv')
```

### Bin RelTime
```{r}
crds.bin <- bin.crds(crds)
```

### Summarize by Substrate + ABX
```{r}
### Remove Inulin outliers
#crds.rem <- crds.bin[-which(crds.bin$ID == "S34"),]
crds.rem <- crds.bin[-which(crds.bin$ID == "S37"),]
  # ABX didn't work; high [DNA]
crds.rem <- crds.rem[-which(crds.rem$ID == "P28"),]
#crds.rem <- crds.rem[-which(crds.rem$ID == "P30"),]

# Remove Saline outliers
#crds.rem <- crds.rem[-which(crds.rem$ID == "W26"),]
#crds.rem <- crds.rem[-which(crds.rem$ID == "W43"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "W50"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "P04"),]
  # This is an adult, not pup

crds.rem$Season <- ordered(crds.rem$Season, levels=c("Summer", "Winter", "Spring"))


# Summarize
crds.sum <- crds.rem %>%
  group_by(Substrate, Antibiotics, Season, BinTime) %>%
  summarize(Y_Mean = mean(Delta),
            Y_Median = median(Delta),
            Y_SD = sd(Delta),
            Y_SE = se(Delta),
            Y_IQR = IQR(Delta),
            X_Mean = mean(RelTime),
            X_Median = median(RelTime),
            X_SD = sd(RelTime),
            X_SE = se(RelTime),
            X_IQR = IQR(RelTime),
            SampSize = n())
  # X_Mean is different from BinTime because BinTime was calculated with ABX and non-ABX combined
    # BinTime was calculated this way to make sure datapoints for all individuals will align together on x-axis. If datapoints are misaligned that can be confusing for the audience. So binning was done this way for the clearest visualization.
    # X_Mean is calculated for ABX and non-ABX separately, so there will be some variation
crds.sum$Season <- ordered(crds.sum$Season, levels=c("Summer", "Winter", "Spring"))
```


### Calculate Delta Metrics
```{r}
# Calculate delta metrics
d.metrics <- calc.delta.metrics(crds.rem)
#write.csv(d.metrics, "delta_metrics.csv", row.names = F)

# Load metadata
meta <- read.csv('metadata.csv', fileEncoding="UTF-8-BOM")

# Add metadata to delta metrics
d.metrics[,colnames(meta)[3:12]] <- NA
for(sq in 1:nrow(d.metrics)){
  meta.row <- which(meta$ID == d.metrics$ID[sq])
  d.metrics[sq, 5:14] <- meta[meta.row, 3:12]
}

# Convert to numeric
d.metrics$TimeMaxD <- as.numeric(d.metrics$TimeMaxD)
d.metrics$Slope <- as.numeric(d.metrics$Slope)
d.metrics$SlopeTime <- as.numeric(d.metrics$SlopeTime)

# Order seasons
d.metrics$Season <- ordered(d.metrics$Season, levels=c("Summer", "Winter", "Spring"))

# Separate substrates
d.inu <- d.metrics[which(d.metrics$Substrate == "Inulin"),]
d.sal <- d.metrics[which(d.metrics$Substrate == "Saline"),]

# Separate by substrate + ABX
d.inu.abx <- d.inu[which(d.inu$Antibiotics == "Yes"),]
d.inu.noabx <- d.inu[which(d.inu$Antibiotics == "No"),]
d.sal.abx <- d.sal[which(d.sal$Antibiotics == "Yes"),]
d.sal.noabx <- d.sal[which(d.sal$Antibiotics == "No"),]
```




### Test Delta Curve Slope
```{r}
### Test for normality
hist(d.inu.abx$Slope)
qqnorm(d.inu.abx$Slope)
qqline(d.inu.abx$Slope)
shapiro.test(d.inu.abx$Slope)
  # p-value = 0.54
  # Normal

hist(d.inu.noabx$Slope)
qqnorm(d.inu.noabx$Slope)
qqline(d.inu.noabx$Slope)
shapiro.test(d.inu.noabx$Slope)
  # p-value = 0.4073
  # Normal

hist(d.sal.abx$Slope)
qqnorm(d.sal.abx$Slope)
qqline(d.sal.abx$Slope)
shapiro.test(d.sal.abx$Slope)
  # p-value = 0.02514
  # Not Normal

hist(d.sal.noabx$Slope)
qqnorm(d.sal.noabx$Slope)
qqline(d.sal.noabx$Slope)
shapiro.test(d.sal.noabx$Slope)
  # p-value = 1.228e-05
  # Not Normal



### Test Mean
summary(aov(Slope ~ Season, data = d.inu.abx))
  # p-value = 0.000437*
TukeyHSD(aov(Slope ~ Season, data = d.inu.abx))
  # Summer-Spring = 0.0006632*
  # Winter-Spring = 0.7445972
  # Winter-Summer = 0.0020914* 
summary(aov(Slope ~ Season, data = d.inu.noabx))
  # p-value = 0.000363*
TukeyHSD(aov(Slope ~ Season, data = d.inu.noabx))
  # Summer-Spring = 0.9969632
  # Winter-Spring = 0.0011246*
  # Winter-Summer = 0.0009560*
kruskal.test(formula = Slope ~ Season, data = d.sal.abx)
  # p-value = 0.2049
kruskal.test(formula = Slope ~ Season, data = d.sal.noabx)
  # p-value = 0.999



### Test Variance
fligner.test(Slope ~ Season, d.inu.abx)
  # p-value = 0.1514
fligner.test(Slope ~ Season, d.inu.noabx)
  # p-value = 0.3065
fligner.test(Slope ~ Season, d.sal.abx)
  # p-value = 0.7135
fligner.test(Slope ~ Season, d.sal.noabx)
  # p-value = 0.4988

```


### Plot Delta Curve Slope
```{r}
### Prepare data for plotting
# Inulin
d.inu$SeasonABX <- interaction(d.inu$Season, d.inu$Antibiotics)
d.inu$SeasonABX <- ordered(d.inu$SeasonABX, levels=c("Summer.No", "Summer.Yes", "Winter.No", "Winter.Yes", "Spring.No", "Spring.Yes"))

# Saline
d.sal$SeasonABX <- interaction(d.sal$Season, d.sal$Antibiotics)
d.sal$SeasonABX <- ordered(d.sal$SeasonABX, levels=c("Summer.No", "Summer.Yes", "Winter.No", "Winter.Yes", "Spring.No", "Spring.Yes"))


### AUC Dot Plots

# Steal Season legend
season.legend <- g_legend(ggplot(d.inu, aes(x = Season, y = Slope, color = Season, fill = Season)) +
                            geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5,
                                         position = position_dodge(0.7), stackratio = 0.5) +
                            scale_color_manual(values = c("#c98b00", "#006096", "#00966d")) +
                            scale_fill_manual(values = c("#E69F00", "#0072B2", "#00bf8b")) +
                            theme(legend.title = element_text(size=10, face="bold"),
                                  legend.text = element_text(size=10),
                                  legend.margin = margin(t=1, unit='cm')))


# Steal ABX legend
abx.legend <- g_legend(ggplot(d.inu, aes(x = Season, y = Slope, fill = Antibiotics)) + 
                         geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5, 
                                      position = position_dodge(0.7), stackratio = 0.5) +
                         scale_fill_manual(values = c("black", "white")) +
                            theme(legend.title = element_text(size=10, face="bold"),
                                  legend.text = element_text(size=10),
                                  legend.margin = margin(b=1, unit='cm')))




  
# Inulin
inu.slope.plot <- ggplot(d.inu, aes(x = Season, y = Slope, color = SeasonABX,
                                    fill = SeasonABX)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5,
               position = position_dodge(0.7), stackratio = 0.5) +
  scale_color_manual(values = c("#c98b00", "#E69F00", "#004166", "#006299", "#00966d",
                                "#00bf8b")) +
  scale_fill_manual(values = c("#E69F00", "white", "#006299", "white", "#00bf8b",
                               "white")) +
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1), geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.5) +
  ggtitle("Inulin")  + 
  ylab(expression("Maximum"~~delta^13~"C"~"Slope"~"(%"[o]~"/ hour)")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(face="bold", size=10, margin = margin(t = 7.5)),
        axis.title.y = element_text(face="bold", size=10),
        axis.text.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
        legend.position = "none")



# Saline
sal.slope.plot <- ggplot(d.sal, aes(x = Season, y = Slope, color = SeasonABX,
                                    fill = SeasonABX)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5,
               position = position_dodge(0.7), stackratio = 0.5) +
  scale_color_manual(values = c("#c98b00", "#E69F00", "#004166", "#006299", "#00966d",
                                "#00bf8b")) +
  scale_fill_manual(values = c("#E69F00", "white", "#006299", "white", "#00bf8b",
                               "white")) +
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1), geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.5) +
  ggtitle("Saline")  + 
  ylab(expression("Maximum"~~delta^13~"C"~"Slope"~"(%"[o]~"/ hour)")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(face="bold", size=10, margin = margin(t = 7.5)),
        axis.title.y = element_text(face="bold", size=10),
        axis.text.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
        legend.position = "none")



### Plot

#png("prospectus.deltaSlope.png", width = 200, height = 75, units = "mm", res = 400)
grid.newpage()
pushViewport(viewport(layout=grid.layout(2,3, widths = c(1, 1, 0.3))))

print(inu.slope.plot, vp=viewport(layout.pos.row=1:2, layout.pos.col=1))
grid.text("A", x=unit(0.065, "npc"), y=unit(0.93, "npc"), 
          vp=viewport(layout.pos.row=1, layout.pos.col=1), gp=gpar(fontsize=20,fontface="bold"))


print(sal.slope.plot, vp=viewport(layout.pos.row=1:2, layout.pos.col=2))
grid.text("B", x=unit(0.065, "npc"), y=unit(0.93, "npc"),
          vp=viewport(layout.pos.row=1, layout.pos.col=2), gp=gpar(fontsize=20,fontface="bold"))

season.legend$vp <- viewport(layout.pos.row=1, layout.pos.col=3)
grid.draw(season.legend)
abx.legend$vp <- viewport(layout.pos.row=2, layout.pos.col=3)
grid.draw(abx.legend)
#dev.off()


#png("d.slope.png", width = 170, height = 75, units = "mm", res = 300)
grid.newpage()
pushViewport(viewport(layout=grid.layout(2,3, widths = c(1, 1, 0.3))))

print(inu.slope.plot, vp=viewport(layout.pos.row=1:2, layout.pos.col=1))
grid.text("A", x=unit(0.065, "npc"), y=unit(0.93, "npc"), 
          vp=viewport(layout.pos.row=1, layout.pos.col=1), gp=gpar(fontsize=20,fontface="bold"))


print(sal.slope.plot, vp=viewport(layout.pos.row=1:2, layout.pos.col=2))
grid.text("B", x=unit(0.065, "npc"), y=unit(0.93, "npc"),
          vp=viewport(layout.pos.row=1, layout.pos.col=2), gp=gpar(fontsize=20,fontface="bold"))

season.legend$vp <- viewport(layout.pos.row=1, layout.pos.col=3)
grid.draw(season.legend)
abx.legend$vp <- viewport(layout.pos.row=2, layout.pos.col=3)
grid.draw(abx.legend)
#dev.off()


```



### Separate by substrate
```{r}
inu.all <- crds.sum[which(crds.sum$Substrate == "Inulin"),]
sal.all <- crds.sum[which(crds.sum$Substrate == "Saline"),]
```


### Calculate AUC
```{r}
# AUC = Area Under Curve
# Trapezoid Method

### Calculate AUC
ids <- unique(crds.rem$ID)
auc.df <- data.frame(crds.rem[1,])
auc.df <- auc.df[,-2:-3]
  # Remove Delta and CO2 cols
auc.df <- auc.df[,-13]
  # Remove BinTime col
colnames(auc.df) <- c("AUC", "Number", "ID", "Season", "Sex", "Antibiotics", "Substrate", "Diet", "Mom", "Mom_Location", "BodyMass", "BodyTemp")
auc.df$Ketones <- NA
  # Rename cols
meta <- read.csv('metadata.csv', fileEncoding="UTF-8-BOM")

#crds.rem= crds.bin
# First normalize Rel Time so 
#for (i in 2){
for (i in 1:length(ids)){
  ID <- ids[i]
  select <- crds.rem[which(crds.rem$ID == ID),]
    # Dataframe with CRDS values for 1 squirrel

  # Normalize delta value to baseline
  select$Delta <- select$Delta - select$Delta[1]
  
  # Remove baseline from AUC calculation because we care about the AUC after gavage
  # Since we already normalized delta value to baseline, we don't need that value anymore
  # Set baseline to gavage time = 0
  select[1,1] <- 0
  
  # Normalize AUC end time
  # Since length of experiment varies for each individual, we don't want experimental length to bias our AUC calculations
  # Normalize length to min time within each substrate
    # Inu = 4.0667
    # Sal = 2.21667
  if (select$Substrate == "Inulin") {
    max <- which(select$RelTime > 4.06667)
    select$RelTime[max] <- 4.06667
  } else if (select$Substrate == "Saline") {
    max <- which(select$RelTime > 2.21666667)
    select$RelTime[max] <- 2.21666667
  }

  # Create auc variable
  AUC <- 0
  
  # Run rectangle method integration - less accurate
  #for (j in 1:(nrow(select)-1)){
  #  AUC <- AUC + ((select$RelTime[j+1]-select$RelTime[j])*select$Delta[j+1])
  #}
  
  # Run trapezoid method integration - more accurate
  for(j in 1:(nrow(select)-1)){
    avgH <- (select$Delta[j+1]+select$Delta[j])/2
      # Calculates average height between start and end point
    width <- (select$RelTime[j+1]-select$RelTime[j])
    AUC <- AUC + (avgH*width)
  }
    
  auc.df[i,1] <- AUC
  auc.df[i, 2:12] <- select[1, 4:14]
  
  use <- which(meta$ID == ID)
  auc.df$Ketones[i] <- meta$Ketones[use]
}

#write.csv(auc.df, "auc.csv", row.names=F)


### Subset by Substrate & ABX
auc.inu <- auc.df[which(auc.df$Substrate == "Inulin"),]
auc.sal <- auc.df[which(auc.df$Substrate == "Saline"),]
auc.inu.s <- auc.inu[which(auc.inu$Season == "Summer"),]
auc.inu.w <- auc.inu[which(auc.inu$Season == "Winter"),]
auc.inu.p <- auc.inu[which(auc.inu$Season == "Spring"),]
auc.sal.s <- auc.sal[which(auc.sal$Season == "Summer"),]
auc.sal.w <- auc.sal[which(auc.sal$Season == "Winter"),]
auc.sal.p <- auc.sal[which(auc.sal$Season == "Spring"),]
auc.inu.abx <- auc.inu[which(auc.inu$Antibiotics == "Yes"),]
auc.inu.noabx <- auc.inu[which(auc.inu$Antibiotics == "No"),]
auc.sal.abx <- auc.sal[which(auc.sal$Antibiotics == "Yes"),]
auc.sal.noabx <- auc.sal[which(auc.sal$Antibiotics == "No"),]
```

### Test AUC
```{r}
### Check Normality - Inulin
hist(auc.inu.noabx$AUC)
qqnorm(auc.inu.noabx$AUC)
qqline(auc.inu.noabx$AUC)
shapiro.test(auc.inu.noabx$AUC)
  # p-value = 0.03022
  # Not Normal

hist(auc.inu.abx$AUC)
qqnorm(auc.inu.abx$AUC)
qqline(auc.inu.abx$AUC)
shapiro.test(auc.inu.abx$AUC)
  # p-value = 0.6626
  # Normal



### Check Normality - Saline
hist(auc.sal.noabx$AUC)
qqnorm(auc.sal.noabx$AUC)
qqline(auc.sal.noabx$AUC)
shapiro.test(auc.sal.noabx$AUC)
  # p-value = 0.277
  # Normal

hist(auc.sal.abx$AUC)
qqnorm(auc.sal.abx$AUC)
qqline(auc.sal.abx$AUC)
shapiro.test(auc.sal.abx$AUC)
  # p-value = 0.0001217
  # Not Normal



### Test AUC Variance - Seasons
fligner.test(AUC ~ Season, auc.inu.noabx)
  # p-value = 0.02061*
fligner.test(AUC ~ Season, auc.inu.noabx[which(auc.inu.noabx$Season != "Spring"),])
  # p-value = 0.3274
fligner.test(AUC ~ Season, auc.inu.noabx[which(auc.inu.noabx$Season != "Winter"),])
  # p-value = 0.04832*
fligner.test(AUC ~ Season, auc.inu.noabx[which(auc.inu.noabx$Season != "Summer"),])
  # p-value = 0.01802*
p.adjust(c(0.3274, 0.04832, 0.01802), method = "fdr")
  # 0.32740 0.07248 0.05406

fligner.test(AUC ~ Season, auc.sal.noabx)
  # p-value = 0.8339
fligner.test(AUC ~ Season, auc.inu.abx)
  # p-value = 0.4247
fligner.test(AUC ~ Season, auc.sal.abx)
  # p-value = 0.5042



### Test AUC - Seasons
kruskal.test(formula = AUC ~ Season, data=auc.inu.noabx)
  # p-value = 0.1629
summary(aov(formula = AUC ~ Season, data=auc.sal.noabx))
  # p-value = 0.405
summary(aov(formula = AUC ~ Season, data=auc.inu.abx))
  # p-value = 0.883
kruskal.test(formula = AUC ~ Season, data=auc.sal.abx)
  # p-value = 0.3546

p.adjust(c(0.1629, 0.405, 0.883, 0.3546), method = "BH")
  # 0.540 0.540 0.883 0.540
```



### Plot AUC
```{r}
### Prepare data for plotting
# Inulin
auc.inu$SeasonABX <- interaction(auc.inu$Season, auc.inu$Antibiotics)
auc.inu$SeasonABX <- ordered(auc.inu$SeasonABX, levels=c("Summer.No", "Summer.Yes", "Winter.No", "Winter.Yes", "Spring.No", "Spring.Yes"))

# Saline
auc.sal$SeasonABX <- interaction(auc.sal$Season, auc.sal$Antibiotics)
auc.sal$SeasonABX <- ordered(auc.sal$SeasonABX, levels=c("Summer.No", "Summer.Yes", "Winter.No", "Winter.Yes", "Spring.No", "Spring.Yes"))



# Steal Season legend
season.legend <- g_legend(ggplot(auc.inu, aes(x = Season, y = AUC, color = Season, fill = Season)) +
                            geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5,
                                         position = position_dodge(0.7), stackratio = 0.5) +
                            scale_color_manual(values = c("#c98b00", "#004166", "#00966d")) +
                            scale_fill_manual(values = c("#E69F00", "#006299", "#00bf8b")) +
                            theme(legend.title = element_text(size=10, face="bold"),
                                  legend.text = element_text(size=10),
                                  legend.margin = margin(t=1, unit='cm')))
# Steal ABX legend
abx.legend <- g_legend(ggplot(auc.inu, aes(x = Season, y = AUC, fill = Antibiotics)) + 
                         geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5, 
                                      position = position_dodge(0.7), stackratio = 0.5) +
                         scale_fill_manual(values = c("black", "white")) +
                            theme(legend.title = element_text(size=10, face="bold"),
                                  legend.text = element_text(size=10),
                                  legend.margin = margin(b=1, unit='cm')))




### AUC Dot Plots
  
# Inulin
inu.auc.plot <- ggplot(auc.inu, aes(x = Season, y = AUC, color = SeasonABX,
                                    fill = SeasonABX)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5,
               position = position_dodge(0.7), stackratio = 0.5) +
  scale_color_manual(values = c("#c98b00", "#E69F00", "#004166", "#006299", "#00966d",
                                "#00bf8b")) +
  scale_fill_manual(values = c("#E69F00", "white", "#006299", "white", "#00bf8b",
                               "white")) +
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1), geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.5) +
  ggtitle("Inulin")  + 
  ylab(expression("Area Under"~~delta^13~"C"~~"Curve"~"(%"[o]^2~")")) +
  scale_y_continuous(breaks=c(0, 1750, 3500, 5250, 7000, 8750), limits=c(0, 8750),
                     minor_breaks = seq(0,8750,1750)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(face="bold", size=10, margin = margin(t = 7.5)),
        axis.title.y = element_text(face="bold", size=11),
        axis.text.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
        legend.position = "none")


# Saline
sal.auc.plot <- ggplot(auc.sal, aes(x = Season, y = AUC, color = SeasonABX,
                                    fill = SeasonABX)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5,
               position = position_dodge(0.7), stackratio = 0.5) +
  scale_color_manual(values = c("#c98b00", "#E69F00", "#006096", "#0072B2", "#00966d",
                                "#00bf8b"), guide = "none") +
  scale_fill_manual(values = c("#E69F00", "white", "#0072B2", "white", "#00bf8b",
                               "white"),
                    name = "Season",
                    labels = c("Summer", "", "Winter", "", "Spring", ""),
                    guide = guide_legend(override.aes = list(fill = c("#E69F00", NA,
                                                                      "#0072B2", NA,
                                                                      "#00bf8b", NA),
                                                             alpha = c(1,0,1,0,1,0),
                                                             color = NA),
                                         keyheight = c(1.25,0,1.25,0,1.25,0))) +
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1), geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.5) +
  ggtitle("Saline")  +
  ylab(expression("Area Under"~~delta^13~"C"~~"Curve"~"(%"[o]^2~")")) +
  scale_y_continuous(breaks=c(-5.0, -2.2, 0.6, 3.4, 6.2), limits=c(-5.0, 6.2)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(face="bold", size=10, margin = margin(t = 7.5)),
        axis.title.y = element_text(face="bold", size=11),
        axis.text.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
        legend.position = "none")












# Inulin
#inu.noabx.auc.plot <- ggplot(auc.inu.noabx, aes(x = Season, y = AUC, fill = Season)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5, stackratio = 1) +
  scale_fill_manual(values = c("#E69F00", "#0072B2", "#00bf8b")) +
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1), geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.5) +
  ggtitle("Inulin")  + 
  ylab(expression("Area Under"~~delta^13~"C"~~"Curve"~"(%"[o]^2~")")) +
  #scale_y_continuous(breaks=c(0, 1750, 3500, 5250, 7000, 8750), limits=c(-7, 8750),
                     #minor_breaks = seq(0,8750,1750)) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(face="bold", size=10, margin = margin(t = 7.5)),
        axis.title.y = element_text(face="bold", size=11),
        axis.text.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
        legend.position = "none")
  









##### Save AUC Dot Plots #####

#png("prospectus.auc.png", width = 200, height = 75, units = "mm", res = 400)
grid.newpage()
pushViewport(viewport(layout=grid.layout(2,3, widths = c(1, 1, 0.3))))

print(inu.auc.plot, vp=viewport(layout.pos.row=1:2, layout.pos.col=1))
grid.text("A", x=unit(0.065, "npc"), y=unit(0.93, "npc"), 
          vp=viewport(layout.pos.row=1, layout.pos.col=1), gp=gpar(fontsize=20,fontface="bold"))

print(sal.auc.plot, vp=viewport(layout.pos.row=1:2, layout.pos.col=2))
grid.text("B", x=unit(0.065, "npc"), y=unit(0.93, "npc"),
          vp=viewport(layout.pos.row=1, layout.pos.col=2), gp=gpar(fontsize=20,fontface="bold"))

season.legend$vp <- viewport(layout.pos.row=1, layout.pos.col=3)
grid.draw(season.legend)
abx.legend$vp <- viewport(layout.pos.row=2, layout.pos.col=3)
grid.draw(abx.legend)
#dev.off()

  
#png("auc.png", width = 170, height = 75, units = "mm", res = 300)
grid.newpage()
pushViewport(viewport(layout=grid.layout(2,3, widths = c(1, 1, 0.3))))

print(inu.auc.plot, vp=viewport(layout.pos.row=1:2, layout.pos.col=1))
grid.text("A", x=unit(0.065, "npc"), y=unit(0.93, "npc"), 
          vp=viewport(layout.pos.row=1, layout.pos.col=1), gp=gpar(fontsize=20,fontface="bold"))

print(sal.auc.plot, vp=viewport(layout.pos.row=1:2, layout.pos.col=2))
grid.text("B", x=unit(0.065, "npc"), y=unit(0.93, "npc"),
          vp=viewport(layout.pos.row=1, layout.pos.col=2), gp=gpar(fontsize=20,fontface="bold"))

season.legend$vp <- viewport(layout.pos.row=1, layout.pos.col=3)
grid.draw(season.legend)
abx.legend$vp <- viewport(layout.pos.row=2, layout.pos.col=3)
grid.draw(abx.legend)
#dev.off()

#png("auc.inu.man.png", width = 175, height = 75, units = "mm", res = 300)
grid.newpage()
pushViewport(viewport(layout=grid.layout(1,3, widths = c(1.05, 0.1, 1))))
print(inu.noabx.auc.plot, vp=viewport(layout.pos.row=1, layout.pos.col=1))
#dev.off()

```




### Plot Delta Curves
```{r}
# Steal Season legend
season.legend <- g_legend(ggplot(inu.all, aes(x=BinTime, y=Y_Mean, color=Season)) +
                         geom_line(aes(linetype=Antibiotics), size=1) +
                         geom_point(size=3, shape=21, aes(color=Season, 
                                    fill=factor(ifelse(Antibiotics == "Yes", NA, Season)))) +
                         scale_color_manual(values = c("#E69F00", "#0072B2", "#00bf8b")) +
                         scale_fill_manual(values=c("#E69F00", "#0072B2", "#00bf8b"),
                                           na.value="white") +
                         theme(plot.title=element_text(hjust=0.5, size=20),
                               axis.title.x=element_text(size=20, 
                                  margin=margin(t=10, r=0, b=0, l=0)),
                               axis.title.y=element_text(size=18),
                               axis.text.x=element_text(size=16),
                               axis.text.y=element_text(size=16),
                               plot.margin = unit(c(0, 0.3, 0.3, 0.3), "cm"),
                                  #top, right, bottom, left
                               panel.grid.major.x = element_blank(),
                               panel.grid.minor.y = element_blank(),
                               panel.grid.minor.x = element_blank())
                         )
# Steal ABX legend
abx.legend <- g_legend(ggplot(inu.all, aes(x=BinTime, y=Y_Mean, color=Season)) +
                         geom_line(aes(linetype=Antibiotics), size=1) +
                         geom_point(size=3, shape=21, aes(color=Season, 
                                    fill=factor(ifelse(Antibiotics == "Yes", NA, Season)))) +
                         scale_color_manual(values = c("#E69F00", "#0072B2", "#00bf8b")) +
                         scale_fill_manual(values=c("#E69F00", "#0072B2", "#00bf8b"),
                                           na.value="white") +
                         theme(plot.title=element_text(hjust=0.5, size=20),
                               axis.title.x=element_text(size=20, 
                                  margin=margin(t=10, r=0, b=0, l=0)),
                               axis.title.y=element_text(size=18),
                               axis.text.x=element_text(size=16),
                               axis.text.y=element_text(size=16),
                               plot.margin = unit(c(0, 0.3, 0.3, 0.3), "cm"),
                                  #top, right, bottom, left
                               panel.grid.major.x = element_blank(),
                               panel.grid.minor.y = element_blank(),
                               panel.grid.minor.x = element_blank())
                       )


### Inulin
inu.delta.plot <- ggplot(inu.all, aes(x=BinTime, y=Y_Mean, color=Season)) +
   geom_line(aes(linetype=Antibiotics), size=1) +
   geom_point(size=3, shape=21, aes(color=Season, 
                                    fill=factor(ifelse(Antibiotics == "Yes", NA, Season)))) +
  scale_color_manual(values = c("#E69F00", "#0072B2", "#00bf8b"), guide = "none") +
  scale_fill_manual(values=c("#E69F00", "#0072B2", "#00bf8b"), na.value="white", guide="none") +
  geom_errorbar(aes(ymin = Y_Mean-Y_SE, ymax = Y_Mean+Y_SE), 
                width=0.125, position=position_dodge(0.1)) +
  ggtitle(expression("Inulin"~~delta^13~"C")) +
  xlab("Time Since Gavage (hr)") +
  ylab(expression("Mean"~~delta^13~"C"~"(%"[o]~")")) +
  xlim(-0.6,4.1) +
  scale_y_continuous(breaks=c(0, 500, 1000, 1500, 2000, 2500, 3000), limits=c(-30, 3100)) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.title.x=element_text(size=20, 
                                  margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y=element_text(size=18),
        axis.text.x=element_text(size=16),
        axis.text.y=element_text(size=16),
        plot.margin = unit(c(0, 0.3, 0.3, 0.3), "cm"),
          #top, right, bottom, left
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())


## Saline
sal.delta.plot <- ggplot(sal.all, aes(x=BinTime, y=Y_Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
  geom_point(size=3, shape=21, aes(color=Season, 
                                   fill=factor(ifelse(Antibiotics == "Yes", NA, Season)))) +
  scale_color_manual(values = c("#E69F00", "#0072B2", "#00bf8b"), guide = "none") +
  scale_fill_manual(values=c("#E69F00", "#0072B2", "#00bf8b"), na.value="white", guide="none") +
  geom_errorbar(aes(ymin = Y_Mean-Y_SE, ymax = Y_Mean+Y_SE), width=0.125,
                position=position_dodge(0.1)) +
  ggtitle(expression("Saline"~~delta^13~"C")) +
  xlab("Time Since Gavage (hr)") +
  ylab(expression("Mean"~~delta^13~"C"~"(%"[o]~")")) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.title.x=element_text(size=14),
        axis.title.y=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text.y=element_text(size=12),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank())





### All 2 substrates on same axis
carb.plot <- ggplot(crds.sum, aes(x=BinTime, y=Y_Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
   geom_point(size=3, shape=21, aes(color=Season, fill=factor(ifelse(Antibiotics == "Yes", NA, Season)))) +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"), na.value="white", guide="none") +
  geom_errorbar(aes(ymin = Y_Mean-Y_SE, ymax = Y_Mean+Y_SE), width=0.125, position=position_dodge(0.1)) + 
  facet_grid(.~Substrate) +
  xlab("Time Since Gavage (hr)") +
  ylab(expression("Mean"~~delta^13~"C"~"(%"[o]~")")) +
  xlim(-0.6,4.41) +
  scale_y_continuous(breaks=c(0, 500, 1000, 1500, 2000, 2500, 3000), limits=c(-30, 3100)) +
  theme(axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        axis.title.x = element_text(size=20, margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y = element_text(size=20, margin=margin(t=0, r=10, b=, l=0)),
        strip.text.x = element_text(size=20, face="bold"),
        strip.text.y = element_text(size=14),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 20, face="bold"),
        legend.text = element_text(size=18),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank(),
        strip.background = element_blank()
  )



png("prospectus.delta.curves.png", width = 240, height = 110, units = "mm", res = 400)
carb.plot
dev.off()
```




### Plot
```{r}
## All individuals
ggplot(crds.bin, aes(x=BinTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point()

ggplot(crds.rem, aes(x=BinTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point() +
  facet_grid(Season ~ Antibiotics)


### Split into experimental groups
crds.split <- crds.rem %>%
  group_split(Substrate, Antibiotics, Season) %>%
  as.data.frame


### Plot
for(group in 1:length(crds.split$.)){
  df <- crds.split[[1]][[group]]
  print(df)
  name <- paste0(c(df$Substrate[1], as.character(df$Season[1]), df$Antibiotics[1]),
                 collapse = ".")
  plotName <- paste0(c(name, "tiff"), collapse = ".")
  
  plot <- ggplot(df, aes(x=RelTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point() +
  facet_grid(ID ~.)
  
  #tiff(plotName, width = 10, height = 10, units = "in", res = 300)
  print(plot)
  #dev.off()

}












## Substrate/ABX
ggplot(crds.sum, aes(x=BinTime, y=Mean, color=Substrate)) +
  geom_line(aes(linetype=Antibiotics)) +
  geom_point() +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE))

## Inulin
inu.plot <- ggplot(inu.all, aes(x=BinTime, y=Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
   geom_point(size=3, shape=21, aes(color=Season, fill=factor(ifelse(Antibiotics == "Yes", NA, Season)))) +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"), na.value="white", guide="none") +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE), width=0.125, position=position_dodge(0.1)) +
  ggtitle(expression("Inulin"~~delta^13~"C")) +
  xlab("Time Since Gavage (hr)") +
  ylab(expression("Mean"~~delta^13~"C"~"(%"[o]~")")) +
  xlim(-0.6,4.1) +
  scale_y_continuous(breaks=c(0, 625, 1250, 1875, 2500), limits=c(-30, 2700)) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.title.x=element_text(size=20, 
                                  margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y=element_text(size=18),
        axis.text.x=element_text(size=16),
        axis.text.y=element_text(size=16),
        plot.margin = unit(c(0, 0.3, 0.3, 0.3), "cm"),
          #top, right, bottom, left
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank()
  ) +
  guides(colour=F, linetype=F)



## Saline
sal.plot <- ggplot(sal.all, aes(x=BinTime, y=Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
  geom_point(size=3, shape=21, aes(color=Season, fill=factor(ifelse(Antibiotics == "Yes", NA, Season)))) +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"), na.value="white", guide="none") +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE), width=0.125, position=position_dodge(0.1)) +
  ggtitle(expression("Saline"~~delta^13~"C")) +
  xlab("Time Since Gavage (hr)") +
  ylab(expression("Mean"~~delta^13~"C"~"(%"[o]~")")) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.title.x=element_text(size=14),
        axis.title.y=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text.y=element_text(size=12),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank()) +
  guides(colour=F, linetype=F)




## Steal legend
steal.legend <- ggplot(sal.all, aes(x=BinTime, y=Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
  geom_point(size=3) +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE), width=0.125, position=position_dodge(0.1)) +
  ggtitle(expression("Saline"~~delta^13~"C")) +
  xlab("Time Since Gavage (hr)") +
  ylab(expression("Mean"~~delta^13~"C"~"(%"[o]~")")) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.title.x=element_text(size=14),
        axis.title.y=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text.y=element_text(size=12),
        legend.title = element_text(size=20, face="bold"),
        legend.text = element_text(size=18)
        )
legend <- g_legend(steal.legend)






### All 3 substrates on same axis
carb.plot <- ggplot(crds.rem, aes(x=BinTime, y=Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
   geom_point(size=3, shape=21, aes(color=Season, fill=factor(ifelse(Antibiotics == "Yes", NA, Season)))) +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"), na.value="white", guide="none") +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE), width=0.125, position=position_dodge(0.1)) + 
  facet_grid(.~Substrate) +
  xlab("Time Since Gavage (hr)") +
  ylab(expression("Mean"~~delta^13~"C"~"(%"[o]~")")) +
  xlim(-0.6,4.1) +
  scale_y_continuous(breaks=c(0, 500, 1000, 1500, 2000, 2500), limits=c(-30, 2700)) +
  theme(axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        axis.title.x = element_text(size=20, margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y = element_text(size=20, margin=margin(t=0, r=10, b=, l=0)),
        strip.text.x = element_text(size=20, face="bold"),
        #strip.text.y = element_text(size=14),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 20, face="bold"),
        legend.text = element_text(size=18),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.y = element_blank(),
        panel.grid.minor.x = element_blank(),
  )



#tiff("crds.tiff", width = 12.75, height = 3.5, units = "in", res = 300)
carb.plot
dev.off()
```