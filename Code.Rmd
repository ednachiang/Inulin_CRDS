---
title: "Code"
author: "Edna Chiang"
date: "February 5, 2018"
output: html_document
---

### Load Packages, scripts, and functions
```{r}
library(ggplot2)
library(dplyr)
library(grid)
library(MESS)
library(pgirmess)
library(Bolstad2)
library(phyloseq)
library(miLineage)
library(psych)
library(car)
source('scripts/import_crds.R')
source('scripts/import_crds_sep.R')
source('scripts/bin_crds.R')
source('scripts/misc.R')
set.seed(1)
theme_set(theme_bw())

### Stats Notes
# Use 'subset' in kruskal.test
# Do NOT use 'subset' in kruskalmc or pairwise.wilcox.test; it doesn't work!
```

### Urea
```{r}
# Load data
crds.urea.csv <- import.crds('urea.csv','urea.metadata.csv')
crds.all.urea <- import.crds.sep('urea.csv', 'urea.metadata.csv')

# Bin Rel Time
crds.bin.urea <- bin.crds(crds.urea.csv)


# Pull out L-Urea
ure.ind.raw <- crds.urea.csv[which(crds.urea.csv$Substrate == "L-Urea"),]

# Separate by ABX
ure.noabx.ind.raw <- ure.ind.raw[which(ure.ind.raw$Antibiotics == "No"),]
ure.abx.ind.raw <- ure.ind.raw[which(ure.ind.raw$Antibiotics == "Yes"),]

# Separate by ABX and Season
ure.noabx.sum.ind.raw <- ure.noabx.ind.raw[which(ure.noabx.ind.raw$Season == "Summer"),]
ure.noabx.win.ind.raw <- ure.noabx.ind.raw[which(ure.noabx.ind.raw$Season == "Early Winter"),]
ure.noabx.spr.ind.raw <- ure.noabx.ind.raw[which(ure.noabx.ind.raw$Season == "Winter"),]


# Clean up urea data
rem.urea <- which(is.na(crds.urea.csv$Delta))
crds.rem.urea <- crds.bin.urea[-rem.urea,]
crds.rem.urea <- crds.rem.urea[which(crds.rem.urea$Substrate == "L-Urea"),]

# Summarize
crds.sum.urea <- crds.rem.urea %>%
  group_by(Substrate, Antibiotics, Season, BinTime) %>%
  summarize(Mean = mean(Delta),
            Median = median(Delta),
            SD = sd(Delta),
            SE = se(Delta),
            iqr = IQR(Delta))
crds.sum.urea$Season <- ordered(crds.sum.urea$Season, levels=c("Summer", "Early Winter", "Winter"))

# Calculate AUC
crds.auc.urea <- crds.rem.urea
crds.auc.urea$Substrate <- droplevels(crds.rem.urea$Substrate)
crds.auc.urea$ID <- droplevels(crds.rem.urea$ID)
ids <- levels(crds.auc.urea$ID)
auc.urea.df <- data.frame(crds.auc.urea[1,])
auc.urea.df <- auc.urea.df[,-2:-3]
auc.urea.df <- auc.urea.df[,-8]
colnames(auc.urea.df) <- c("AUC", "Number", "ID", "Season", "Sex", "Antibiotics", "Substrate")
for(i in 1:length(ids)){
  ID <- ids[i]
  select <- crds.auc.urea[which(crds.auc.urea$ID == ID),]
  baseline <- which(select$RelTime < 0)
  baseline.reltime <- mean(select$RelTime[baseline])
  baseline.delta <- mean(select$Delta[baseline])
  baseline.co2 <- mean(select$CO2[baseline])
  baseline.bintime <- mean(select$BinTime[baseline])
  select.norm <- data.frame(RelTime=baseline.reltime, Delta=0, CO2=baseline.co2,
                            Number=select$Number[1], ID=select$ID[1], Season=select$Season[1],
                            Sex=select$Sex[1], Antibiotics=select$Antibiotics[1],
                            Substrate=select$Substrate[1], BinTime=baseline.bintime)
    # Delta = 0 because we want to normalize everything to baseline. Any neg Deltas will decrease the AUC (subtracted from AUC), which is not what we want.
  exp <- which(select$RelTime>0)
  for(j in 1:(nrow(select)-length(baseline))){
    select.norm[j+1,] <- select[exp[j],]
  }
  select.norm[2:nrow(select.norm),2] <- (select.norm[2:nrow(select.norm),2]-baseline.delta)
  x <- select.norm$RelTime
  y <- select.norm$Delta
  AUC <- auc(x, y, type = 'spline')
  auc.urea.df[i,1] <- AUC
  auc.urea.df[i,2:7] <- select.norm[1,4:9]
}
```

### Load Data
```{r}
crds <- import.crds('CSV', 'metadata.csv')
crds.all <- import.crds.sep('CSV', 'metadata.csv')
```

### Bin RelTime
```{r}
crds.bin <- bin.crds(crds)
```

### Separate Samples by Raw Rel Time for AUC
```{r}
### Separate by Substrate
inu.ind.raw <- crds[which(crds$Substrate == "Inulin"),]
man.ind.raw <- crds[which(crds$Substrate == "Mannitol"),]
sal.ind.raw <- crds[which(crds$Substrate == "Saline"),]


### Separate by Substrate & ABX
inu.noabx.ind.raw <- inu.ind.raw[which(inu.ind.raw$Antibiotics == "No"),]
inu.abx.ind.raw <- inu.ind.raw[which(inu.ind.raw$Antibiotics == "Yes"),]
man.noabx.ind.raw <- man.ind.raw[which(man.ind.raw$Antibiotics == "No"),]
man.abx.ind.raw <- man.ind.raw[which(man.ind.raw$Antibiotics == "Yes"),]
sal.noabx.ind.raw <- sal.ind.raw[which(sal.ind.raw$Antibiotics == "No"),]
sal.abx.ind.raw <- sal.ind.raw[which(sal.ind.raw$Antibiotics == "Yes"),]


### Separate by Substrate & ABX & Season
inu.noabx.sum.ind.raw <- inu.noabx.ind.raw[which(inu.noabx.ind.raw$Season == "Summer"),]
inu.noabx.win.ind.raw <- inu.noabx.ind.raw[which(inu.noabx.ind.raw$Season == "Winter"),]
inu.noabx.spr.ind.raw <- inu.noabx.ind.raw[which(inu.noabx.ind.raw$Season == "Spring"),]
man.noabx.sum.ind.raw <- man.noabx.ind.raw[which(man.noabx.ind.raw$Season == "Summer"),]
man.noabx.win.ind.raw <- man.noabx.ind.raw[which(man.noabx.ind.raw$Season == "Winter"),]
man.noabx.spr.ind.raw <- man.noabx.ind.raw[which(man.noabx.ind.raw$Season == "Spring"),]
sal.noabx.sum.ind.raw <- sal.noabx.ind.raw[which(sal.noabx.ind.raw$Season == "Summer"),]
sal.noabx.win.ind.raw <- sal.noabx.ind.raw[which(sal.noabx.ind.raw$Season == "Winter"),]
sal.noabx.spr.ind.raw <- sal.noabx.ind.raw[which(sal.noabx.ind.raw$Season == "Spring"),]
```

### Plot raw individuals
```{r}
ggplot(inu.ind.raw, aes(x=RelTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point() +
  facet_grid(Antibiotics~Season)

ggplot(inu.ind.raw, aes(x=RelTime, y=Delta, color=Season)) +
  geom_line() +
  geom_point() +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  facet_grid(Antibiotics~Season)

ggplot(inu.noabx.ind.raw, aes(x=RelTime, y=Delta, color=Season)) +
  geom_line() +
  geom_point() +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  facet_grid(.~Season)


ggplot(inu.noabx.sum.ind.raw, aes(x=RelTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point()

ggplot(inu.noabx.win.ind.raw, aes(x=RelTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point()

ggplot(inu.noabx.spr.ind.raw, aes(x=RelTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point()







ggplot(man.ind.raw, aes(x=RelTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point() +
  facet_grid(Antibiotics~Season)


ggplot(man.ind.raw, aes(x=RelTime, y=Delta, color=Season)) +
  geom_line() +
  geom_point() +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  facet_grid(Antibiotics~Season)






ggplot(sal.ind.raw, aes(x=RelTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point() +
  facet_grid(Antibiotics~Season)


ggplot(sal.ind.raw, aes(x=RelTime, y=Delta, color=Season)) +
  geom_line() +
  geom_point() +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  facet_grid(Antibiotics~Season)

```


### Summarize by Substrate + ABX
```{r}
# Remove 3982 because it's an outlier
crds.rem <- crds.bin[-which(crds.bin$Number == 3982),]
crds.rem$ID <- droplevels(crds.rem$ID)
crds.rem$Season <- ordered(crds.rem$Season, levels=c("Summer", "Winter", "Spring"))


# Summarize
crds.sum <- crds.rem %>%
  group_by(Substrate, Antibiotics, Season, BinTime) %>%
  summarize(Mean = mean(Delta),
            Median = median(Delta),
            SD = sd(Delta),
            SE = se(Delta),
            iqr = IQR(Delta))
crds.sum$Season <- ordered(crds.sum$Season, levels=c("Summer", "Winter", "Spring"))
```

### Test crds values for ABX
```{r}
crds.val <- crds.rem[which(crds.rem$Substrate != "Urea"),]
crds.val <- crds.val[which(crds.val$Substrate != "Acetate"),]
crds.val <- crds.val[which(crds.val$Substrate != "Butyrate"),]
crds.inu.val <- crds.val[which(crds.val$Substrate == "Inulin"),]
crds.man.val <- crds.val[which(crds.val$Substrate == "Mannitol"),]
crds.sal.val <- crds.val[which(crds.val$Substrate == "Saline"),]
crds.inu.end.val <- crds.inu.val[which(crds.inu.val$RelTime > 0),]
crds.man.end.val <- crds.man.val[which(crds.man.val$RelTime > 0),]
crds.sal.end.val <- crds.sal.val[which(crds.sal.val$RelTime > 0),]


### Check Normality
hist(crds.val$Delta)
qqnorm(crds.val$Delta)
qqline(crds.val$Delta)
shapiro.test(crds.val$Delta)
  # p-value < 2.2e-16
hist(crds.inu.val$Delta)
qqnorm(crds.inu.val$Delta)
qqline(crds.inu.val$Delta)
shapiro.test(crds.inu.val$Delta)
  # p-value < 2.2e-16
hist(crds.man.val$Delta)
qqnorm(crds.man.val$Delta)
qqline(crds.man.val$Delta)
shapiro.test(crds.man.val$Delta)
  # p-value < 2.2e-16
hist(crds.inu.end.val$Delta)
qqnorm(crds.inu.end.val$Delta)
qqline(crds.inu.end.val$Delta)
shapiro.test(crds.inu.end.val$Delta)
  # p-value < 2.2e-16
hist(crds.man.end.val$Delta)
qqnorm(crds.man.end.val$Delta)
qqline(crds.man.end.val$Delta)
shapiro.test(crds.man.end.val$Delta)
  # p-value < 2.2e-16

### Test
wilcox.test(Delta~Antibiotics, data=crds.val)
  # p-value < 2.2e-16
wilcox.test(Delta~Antibiotics, data=crds.inu.val)
  # p-value < 2.2e-16
wilcox.test(Delta~Antibiotics, data=crds.man.val)
  # p-value = 2.002e-15
wilcox.test(Delta~Antibiotics, data=crds.sal.val)
  # p-value = 3.964e-05
wilcox.test(Delta~Antibiotics, data=crds.inu.end.val, alternative="greater")
  # p-value < 2.2e-16
wilcox.test(Delta~Antibiotics, data=crds.man.end.val, alternative="greater")
  # p-value < 2.2e-16
wilcox.test(Delta~Antibiotics, data=crds.sal.end.val, alternative="greater")
  # p-value = 1.249e-05

p.adjust(c(2.2e-16, 9.664e-13, 2.499e-05), method="BH")
  # Inulin End = 4.400e-16
  # Mannitol End = 9.664e-13
  # Saline End = 2.499e-05
```

### Separate by substrate
```{r}
inu.all <- crds.sum[which(crds.sum$Substrate == "Inulin"),]

man.all <- crds.sum[which(crds.sum$Substrate == "Mannitol"),]

sal.all <- crds.sum[which(crds.sum$Substrate == "Saline"),]

#ure.all <- crds.sum[which(crds.sum$Substrate == "Urea"),]
```

### Calculate AUC
```{r}
# AUC = Area Under Curve
# Rectangle Method

### Remove unwanted substrates
#crds.auc <- crds.rem[-which(crds.rem$Substrate == "Urea"),]
crds.auc <- crds.rem[-which(crds.rem$Substrate == "Acetate"),]
crds.auc <- crds.auc[-which(crds.auc$Substrate == "Butyrate"),]
crds.auc$Substrate <- droplevels(crds.auc$Substrate)
crds.auc$ID <- droplevels(crds.auc$ID)


### Calculate AUC
ids <- levels(crds.auc$ID)
auc.df <- data.frame(crds.auc[1,])
auc.df <- auc.df[,-2:-3]
  # Remove Delta and CO2 cols
auc.df <- auc.df[,-8]
  # Remove BinTime col
colnames(auc.df) <- c("AUC", "Number", "ID", "Season", "Sex", "Antibiotics", "Substrate")
  # Rename cols

# First normalize Rel Time so 
for (i in 1:length(ids)){
  ID <- ids[i]
  select <- crds.auc[which(crds.auc$ID == ID),]
    # Dataframe with CRDS values for 1 squirrel

  # Normalize delta value to baseline
  select$Delta <- select$Delta - select$Delta[1]
  
  # Remove baseline from AUC calculation because we care about the AUC after gavage
  # Since we already normalized delta value to baseline, we don't need that value anymore
  # Set baseline to gavage time = 0
  select[1,1] <- 0
  
  # Normalize AUC end time
  # Since length of experiment varies for each individual, we don't want experimental length to bias our AUC calculations
  # Normalize length to min time within each substrate
    # Inu = 4.0667
    # Sal = 2.25
    # Man = 1.95
  if (select$Substrate == "Inulin") {
    max <- which(select$RelTime > 4.06667)
    select$RelTime[max] <- 4.06667
  } else if (select$Substrate == "Mannitol") {
    max <- which(select$RelTime > 1.95)
    select$RelTime[max] <- 1.95
  } else if (select$Substrate == "Saline") {
    max <- which(select$RelTime > 2.25)
    select$RelTime[max] <- 2.25
  }

  # Create auc variable
  AUC <- 0
  
  # Run rectangle method integration
  for (j in 1:(nrow(select)-1)){
    AUC <- AUC + ((select$RelTime[j+1]-select$RelTime[j])*select$Delta[j+1])
  }
    
  auc.df[i,1] <- AUC
  auc.df[i, 2:7] <- select[1, 4:9]
}

#write.csv(auc.df, "auc.csv", row.names=F)


### Subset by Substrate & ABX
auc.inu <- auc.df[which(auc.df$Substrate == "Inulin"),]
auc.man <- auc.df[which(auc.df$Substrate == "Mannitol"),]
auc.sal <- auc.df[which(auc.df$Substrate == "Saline"),]
auc.abx <- auc.df[which(auc.df$Antibiotics == "Yes"),]
auc.noabx <- auc.df[which(auc.df$Antibiotics == "No"),]
auc.inu.abx <- auc.inu[which(auc.inu$Antibiotics == "Yes"),]
auc.inu.noabx <- auc.inu[which(auc.inu$Antibiotics == "No"),]
auc.man.abx <- auc.man[which(auc.man$Antibiotics == "Yes"),]
auc.man.noabx <- auc.man[which(auc.man$Antibiotics == "No"),]
auc.sal.abx <- auc.sal[which(auc.sal$Antibiotics == "Yes"),]
auc.sal.noabx <- auc.sal[which(auc.sal$Antibiotics == "No"),]
```

### AUC Stats & Plots
```{r}
### Check Normality
hist(auc.df$AUC)
qqnorm(auc.df$AUC)
qqline(auc.df$AUC)
shapiro.test(auc.df$AUC)
  # p-value = 2.2e-16
  # Not Normal

hist(auc.inu$AUC)
qqnorm(auc.inu$AUC)
qqline(auc.inu$AUC)
shapiro.test(auc.inu$AUC)
  # p-value = 1.55e-06
  # Not Normal

hist(auc.inu.noabx$AUC)
qqnorm(auc.inu.noabx$AUC)
qqline(auc.inu.noabx$AUC)
shapiro.test(auc.inu.noabx$AUC)
  # p-value = 0.0395
  # Not Normal

hist(auc.man$AUC)
qqnorm(auc.man$AUC)
qqline(auc.man$AUC)
shapiro.test(auc.man$AUC)
  # p-value = 9.891e-11
  # Not Normal

hist(auc.man.noabx$AUC)
qqnorm(auc.man.noabx$AUC)
qqline(auc.man.noabx$AUC)
shapiro.test(auc.man.noabx$AUC)
  # p-value = 2.431e-05
  # Not Normal

hist(auc.sal$AUC)
qqnorm(auc.sal$AUC)
qqline(auc.sal$AUC)
shapiro.test(auc.sal$AUC)
  # p-value = 2.653e-09
  # Not Normal

hist(auc.abx$AUC)
qqnorm(auc.abx$AUC)
qqline(auc.abx$AUC)
shapiro.test(auc.abx$AUC)
  # p-value = 7.397e-10
  # Not Normal

hist(auc.noabx$AUC)
qqnorm(auc.noabx$AUC)
qqline(auc.noabx$AUC)
shapiro.test(auc.noabx$AUC)
  # p-value = 1.455e-10
  # Not Normal


### Test homogeneity of variance
# http://www.sthda.com/english/wiki/compare-multiple-sample-variances-in-r
fligner.test(AUC ~ Season, data=auc.inu.noabx)
  # p-value = 0.0395
fligner.test(AUC ~ Season, data=auc.inu.noabx[which(auc.inu.noabx$Season != "Summer"),])
  # Winter vs. Spring
  # p-value = 0.0245
fligner.test(AUC ~ Season, data=auc.inu.noabx[which(auc.inu.noabx$Season != "Winter"),])
  # Summer vs. Spring
  # p-value = 0.07724
fligner.test(AUC ~ Season, data=auc.inu.noabx[which(auc.inu.noabx$Season != "Spring"),])
  # Summer vs. Winter
  # p-value = 0.6508

fligner.test(AUC ~ Season, data=auc.man.noabx)
  # p-value = 0.1691






### Boxplots
auc.carb.df <- auc.df[which(auc.df$Substrate != "Saline"),]
auc.carb.df <- auc.carb.df[which(auc.carb.df$Antibiotics == "No"),]
auc.carb.plot <- ggplot(auc.carb.df, aes(x=Season, y=AUC, fill=Season)) +
  geom_boxplot(outlier.size=-1) +
  geom_point(position=position_jitterdodge(jitter.width=0.75)) +
  facet_grid(.~Substrate) +
  scale_fill_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ylab(expression("Area Under"~~delta^13~"C"~~"Curve"~"(%"[o]^2~")")) +
  scale_y_continuous(breaks=c(0, 2500, 5000, 7500, 10000), limits=c(0, 10000)) +
  theme(axis.text.x = element_text(size=20),
        axis.text.y = element_text(size=14),
        axis.title.x = element_text(size=20, margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y = element_text(size=20, margin=margin(t=0, r=10, b=, l=0)),
        strip.text.x = element_text(size=20,face="bold"),
        #strip.text.y = element_text(size=14),
        panel.spacing=unit(2, "lines"),
        legend.title = element_text(size = 18, face="bold"),
        legend.text = element_text(size=16),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        strip.background = element_blank()
  )

tiff("auc.mdtp.tiff", width = 12.5, height = 4, units = "in", res = 300)
auc.carb.plot
dev.off()








## Inulin
inu.auc.plot <- ggplot(auc.inu, aes(x=Season, y=AUC, fill=Season)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point(size=2) +
  scale_fill_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Inulin") +
  ylab(expression("Area Under"~~delta^13~"C"~~"Curve"~"(%"[o]^2~")")) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.text.x = element_text(size=20),
        axis.text.y = element_text(size=14),
        axis.title.x = element_text(size=20, margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y = element_text(size=20, margin=margin(t=0, r=10, b=0, l=0)),
        strip.text.x = element_text(size=20),
        #strip.text.y = element_text(size=14),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 18),
        legend.text = element_text(size=16),
        panel.grid.major = element_blank()
  ) +
  guides(fill=F)



    
    

## Mannitol
man.auc.plot <- ggplot(auc.man, aes(x=Season, y=AUC, fill=Season)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point(size=2) +
  scale_fill_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Mannitol") +
  ylab(expression("Area Under"~~delta^13~"C"~~"Curve"~"(%"[o]^2~")")) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.text.x = element_text(size=20),
        axis.text.y = element_text(size=14),
        axis.title.x = element_text(size=20, margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y = element_text(size=20, margin=margin(t=0, r=10, b=0, l=0)),
        strip.text.x = element_text(size=20),
        #strip.text.y = element_text(size=14),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 18),
        legend.text = element_text(size=16),
        panel.grid.major = element_blank()
  ) +
  guides(fill=F)







## Steal legend
steal.legend <- ggplot(auc.man, aes(x=Season, y=AUC, fill=Season)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point(size=2) +
  scale_fill_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Mannitol") +
  ylab(expression("Area Under"~~delta^13~"C"~~"Curve"~"(%"[o]^2~")")) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.text.x = element_text(size=20),
        axis.text.y = element_text(size=14),
        axis.title.x = element_text(size=20, margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y = element_text(size=20, margin=margin(t=0, r=10, b=0, l=0)),
        strip.text.x = element_text(size=20),
        #strip.text.y = element_text(size=14),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 20, face="bold"),
        legend.text = element_text(size=18),
        panel.grid.major = element_blank()
  )
legend <- g_legend(steal.legend)


tiff("auc.mdtp.tiff", width = 12.5, height = 4.1, units = "in", res = 300)
grid.newpage()
pushViewport(viewport(layout=(grid.layout(1,3, widths=c(1,1,0.25), heights=c(1,1,1)))))
print(inu.auc.plot, vp=viewport(layout.pos.row=1, layout.pos.col=1))
print(man.auc.plot, vp=viewport(layout.pos.row=1, layout.pos.col=2))
legend$vp <- viewport(layout.pos.row=1, layout.pos.col=3)
grid.draw(legend)
dev.off()










### Kruskal-Wallis
wilcox.test(AUC~Antibiotics, data=auc.df)
  # p-value = 0.0008417
kruskal.test(formula = AUC ~ Substrate, data=auc.abx)
  # p-value = 3.002e-11
kruskalmc(resp = AUC ~ Substrate, data=auc.abx)
  # Inulin-Mannitol
  # Inulin-Saline
  # Mannitol-Saline
kruskal.test(formula = AUC ~ Season, data=auc.abx)
  # p-value = 0.4577
wilcox.test(AUC~Sex, data=auc.df)
  # p-value = 0.5471

# Inulin
wilcox.test(AUC~Antibiotics, data=auc.inu)
  # p-value = 1.407e-07
kruskal.test(formula = AUC ~ Season, data=auc.inu.abx)
  # p-value = 0.5463
kruskal.test(formula = AUC ~ Season, data=auc.inu.noabx)
  # p-value = 0.1063

# Mannitol
wilcox.test(AUC~Antibiotics, data=auc.man)
  # p-value = 2.509e-05
kruskal.test(formula = AUC ~ Season, data=auc.man.abx)
  # p-value = 0.6277
kruskal.test(formula = AUC ~ Season, data=auc.man.noabx)
  # p-value = 0.1983


# Saline
wilcox.test(AUC~Antibiotics, data=auc.sal)
  # p-value = 0.03583
kruskal.test(formula = AUC ~ Season, data=auc.sal.abx)
  # p-value = 0.06838
kruskal.test(formula = AUC ~ Season, data=auc.sal.noabx)
  # p-value = 0.1124



### Kruskal-Wallis BH-adjusted p-values
# Within-substrate ABX wilcoxon test
p.adjust(c(1.407e-07, 2.509e-05, 0.03583), method="BH")
  # Inulin = 4.2210e-07
  # Mannitol = 3.7635e-05
  # Saline = 3.5830e-02
# Within-substrate season kruskal-wallis test
p.adjust(c(0.5463, 0.1063, 0.6277, 0.1983, 0.06838, 0.1124), method="BH")
  # Inulin ABX = 0.62770
  # Inulin No ABX = 0.22480
  # Mannitol ABX = 0.62770
  # Mannitol No ABX = 0.29745
  # Saline ABX = 0.22480
  # Saline No ABX = 0.22480









### Summarize
auc.sum <- auc.df %>%
  group_by(Substrate, Antibiotics, Season) %>%
  summarize(Mean = mean(AUC),
            Median = median(AUC),
            SD = sd(AUC),
            SE = se(AUC),
            iqr = IQR(AUC))
auc.sum$Season <- ordered(auc.sum$Season, levels=c("Summer", "Winter", "Spring"))




```


### AUC Stats - Summer 2020 Poster
```{r}
### Check Normality
hist(auc.inu$AUC)
qqnorm(auc.inu$AUC)
qqline(auc.inu$AUC)
shapiro.test(auc.inu$AUC)
  # p-value = 1.55e-06
  # Not Normal

hist(auc.inu.noabx$AUC)
qqnorm(auc.inu.noabx$AUC)
qqline(auc.inu.noabx$AUC)
shapiro.test(auc.inu.noabx$AUC)
  # p-value = 0.0395
  # Not Normal

hist(auc.inu.abx$AUC)
qqnorm(auc.inu.abx$AUC)
qqline(auc.inu.abx$AUC)
shapiro.test(auc.inu.abx$AUC)
  # p-value = 0.9476
  # Normal

hist(auc.sal$AUC)
qqnorm(auc.sal$AUC)
qqline(auc.sal$AUC)
shapiro.test(auc.sal$AUC)
  # p-value = 2.653e-09
  # Not Normal

hist(auc.sal.noabx$AUC)
qqnorm(auc.sal.noabx$AUC)
qqline(auc.sal.noabx$AUC)
shapiro.test(auc.sal.noabx$AUC)
  # p-value = 3.141e-06
  # Not Normal

hist(auc.sal.abx$AUC)
qqnorm(auc.sal.abx$AUC)
qqline(auc.sal.abx$AUC)
shapiro.test(auc.sal.abx$AUC)
  # p-value = 1.433e-06
  # Not Normal


### Test homogeneity of variance
# http://www.sthda.com/english/wiki/compare-multiple-sample-variances-in-r
fligner.test(AUC ~ Season, data=auc.inu.noabx)
  # p-value = 0.0395
fligner.test(AUC ~ Season, data=auc.inu.noabx[which(auc.inu.noabx$Season != "Summer"),])
  # Winter vs. Spring
  # p-value = 0.0245
fligner.test(AUC ~ Season, data=auc.inu.noabx[which(auc.inu.noabx$Season != "Winter"),])
  # Summer vs. Spring
  # p-value = 0.07724
fligner.test(AUC ~ Season, data=auc.inu.noabx[which(auc.inu.noabx$Season != "Spring"),])
  # Summer vs. Winter
  # p-value = 0.6508

fligner.test(AUC ~ Season, data=auc.inu.abx)
  # p-value = 0.3151

fligner.test(AUC ~ Season, data=auc.sal.noabx)
  # p-value = 0.3938

fligner.test(AUC ~ Season, data=auc.sal.abx)
  # p-value = 0.3774

### Pairwise Fligner-Killeen BH-adjusted p-values - Inulin No ABX
p.adjust(c(0.0245, 0.07724, 0.6508), method="BH")
  # Winter vs. Spring = 0.07350
  # Summer vs. Spring = 0.11586
  # Summer vs. Winter = 0.65080

### Boxplots
auc.carb.df <- auc.df[which(auc.df$Substrate != "Mannitol"),]
auc.carb.df <- auc.carb.df[which(auc.carb.df$Antibiotics == "No"),]
auc.carb.plot <- ggplot(auc.carb.df, aes(x=Season, y=AUC, fill=Season)) +
  geom_boxplot(outlier.size=-1) +
  geom_point(position=position_jitterdodge(jitter.width=0.75)) +
  facet_grid(.~Substrate) +
  scale_fill_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ylab(expression("Area Under"~~delta^13~"C"~~"Curve"~"(%"[o]^2~")")) +
  scale_y_continuous(breaks=c(0, 2500, 5000, 7500, 10000), limits=c(0, 10000)) +
  theme(axis.text.x = element_text(size=20),
        axis.text.y = element_text(size=14),
        axis.title.x = element_text(size=20, margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y = element_text(size=20, margin=margin(t=0, r=10, b=, l=0)),
        strip.text.x = element_text(size=20,face="bold"),
        #strip.text.y = element_text(size=14),
        panel.spacing=unit(2, "lines"),
        legend.title = element_text(size = 18, face="bold"),
        legend.text = element_text(size=16),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        strip.background = element_blank()
  )

tiff("auc.mdtp.tiff", width = 12.5, height = 4, units = "in", res = 300)
auc.carb.plot
dev.off()





## Inulin
inu.auc.plot <- ggplot(auc.inu, aes(x=Season, y=AUC, fill=Season)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point(size=2) +
  scale_fill_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Inulin") +
  ylab(expression("Area Under"~~delta^13~"C"~~"Curve"~"(%"[o]^2~")")) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.text.x = element_text(size=20),
        axis.text.y = element_text(size=14),
        axis.title.x = element_text(size=20, margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y = element_text(size=20, margin=margin(t=0, r=10, b=0, l=0)),
        strip.text.x = element_text(size=20),
        #strip.text.y = element_text(size=14),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 18),
        legend.text = element_text(size=16),
        panel.grid.major = element_blank()
  ) +
  guides(fill=F)



    
 




## Steal legend
steal.legend <- ggplot(auc.man, aes(x=Season, y=AUC, fill=Season)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point(size=2) +
  scale_fill_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Mannitol") +
  ylab(expression("Area Under"~~delta^13~"C"~~"Curve"~"(%"[o]^2~")")) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.text.x = element_text(size=20),
        axis.text.y = element_text(size=14),
        axis.title.x = element_text(size=20, margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y = element_text(size=20, margin=margin(t=0, r=10, b=0, l=0)),
        strip.text.x = element_text(size=20),
        #strip.text.y = element_text(size=14),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 20, face="bold"),
        legend.text = element_text(size=18),
        panel.grid.major = element_blank()
  )
legend <- g_legend(steal.legend)


tiff("auc.mdtp.tiff", width = 12.5, height = 4.1, units = "in", res = 300)
grid.newpage()
pushViewport(viewport(layout=(grid.layout(1,3, widths=c(1,1,0.25), heights=c(1,1,1)))))
print(inu.auc.plot, vp=viewport(layout.pos.row=1, layout.pos.col=1))
print(man.auc.plot, vp=viewport(layout.pos.row=1, layout.pos.col=2))
legend$vp <- viewport(layout.pos.row=1, layout.pos.col=3)
grid.draw(legend)
dev.off()










### Kruskal-Wallis

# Inulin
wilcox.test(AUC~Antibiotics, data=auc.inu)
  # p-value = 1.407e-07
kruskal.test(formula = AUC ~ Season, data=auc.inu.abx)
  # p-value = 0.5463
kruskal.test(formula = AUC ~ Season, data=auc.inu.noabx)
  # p-value = 0.1063

# Saline
wilcox.test(AUC~Antibiotics, data=auc.sal)
  # p-value = 0.03583
kruskal.test(formula = AUC ~ Season, data=auc.sal.abx)
  # p-value = 0.06838
kruskal.test(formula = AUC ~ Season, data=auc.sal.noabx)
  # p-value = 0.1124



### Kruskal-Wallis BH-adjusted p-values
# Within-substrate season kruskal-wallis test
p.adjust(c(0.5463, 0.1063, 0.06838, 0.1124), method="BH")
  # Inulin ABX = 0.5463000
  # Inulin No ABX = 0.1498667
  # Saline ABX = 0.1498667
  # Saline No ABX = 0.1498667



```


### Test Delta & Rel Time
```{r}
### Organize data
inu.ind.raw
  # All inulin squirrels
sal.ind.raw2 <- sal.ind.raw[-which(sal.ind.raw$ID == "W42"),]
  # All saline squirrels
  # Remove W42 because it's an outlier with a very high AUC
inu.sal.raw <- crds[which(crds$Substrat != "Mannitol"),]
  # Pull out just saline and inulin squirrels


### Test raw delta values for normality
hist(inu.sal.raw$Delta)
qqnorm(inu.sal.raw$Delta)
qqline(inu.sal.raw$Delta)
shapiro.test(inu.sal.raw$Delta)
  # p-value = 2.2e-16
  # Not Normal

hist(inu.ind.raw$Delta)
qqnorm(inu.ind.raw$Delta)
qqline(inu.ind.raw$Delta)
shapiro.test(inu.ind.raw$Delta)




kruskal.test(formula = Delta ~ RelTime * Season, data=inu.ind.raw)



inu.ind.raw <- crds[which(crds$Substrate == "Inulin"),]
man.ind.raw <- crds[which(crds$Substrate == "Mannitol"),]
sal.ind.raw <- crds[which(crds$Substrate == "Saline"),]

### Separate by Substrate & ABX
inu.noabx.ind.raw <- inu.ind.raw[which(inu.ind.raw$Antibiotics == "No"),]
inu.abx.ind.raw <- inu.ind.raw[which(inu.ind.raw$Antibiotics == "Yes"),]
man.noabx.ind.raw <- man.ind.raw[which(man.ind.raw$Antibiotics == "No"),]
man.abx.ind.raw <- man.ind.raw[which(man.ind.raw$Antibiotics == "Yes"),]
sal.noabx.ind.raw <- sal.ind.raw[which(sal.ind.raw$Antibiotics == "No"),]
sal.abx.ind.raw <- sal.ind.raw[which(sal.ind.raw$Antibiotics == "Yes"),]


### Separate by Substrate & ABX & Season
inu.noabx.sum.ind.raw <- inu.noabx.ind.raw[which(inu.noabx.ind.raw$Season == "Summer"),]
inu.noabx.win.ind.raw <- inu.noabx.ind.raw[which(inu.noabx.ind.raw$Season == "Winter"),]
inu.noabx.spr.ind.raw <- inu.noabx.ind.raw[which(inu.noabx.ind.raw$Season == "Spring"),]
man.noabx.sum.ind.raw <- man.noabx.ind.raw[which(man.noabx.ind.raw$Season == "Summer"),]
man.noabx.win.ind.raw <- man.noabx.ind.raw[which(man.noabx.ind.raw$Season == "Winter"),]
man.noabx.spr.ind.raw <- man.noabx.ind.raw[which(man.noabx.ind.raw$Season == "Spring"),]
sal.noabx.sum.ind.raw <- sal.noabx.ind.raw[which(sal.noabx.ind.raw$Season == "Summer"),]
sal.noabx.win.ind.raw <- sal.noabx.ind.raw[which(sal.noabx.ind.raw$Season == "Winter"),]
sal.noabx.spr.ind.raw <- sal.noabx.ind.raw[which(sal.noabx.ind.raw$Season == "Spring"),]


### Separate
crds.rem.inu.noabx <- crds.rem[which(crds.rem$Substrate == "Inulin"),]
crds.rem.inu.noabx <- crds.rem.inu.noabx[which(crds.rem.inu.noabx$Antibiotics == "No"),]
inu.beg <- crds.rem.inu.noabx[which(crds.rem.inu.noabx$RelTime < 0),]
inu.end <- crds.rem.inu.noabx[which(crds.rem.inu.noabx$RelTime > 0),]


### Test normality
hist(inu.beg$Delta)
qqnorm(inu.beg$Delta)
qqline(inu.beg$Delta)
shapiro.test(inu.beg$Delta)
  # p-value = 7.876e-10


### Test
kruskal.test(formula = Delta ~ ID, data=inu.beg)
  # p-value = 0.9486
kruskal.test(formula = Delta ~ RelTime, data=inu.beg)
  # p-value = 0.01868
kruskal.test(formula = Delta ~ Season, data=inu.beg)
  # p-value = 0.2358

```


### Calculate Max Delta Change & RelTime Peak
```{r}
### Remove unwanted substrates
crds.max <- crds.rem[-which(crds.rem$Substrate == "Acetate"),]
crds.max <- crds.max[-which(crds.max$Substrate == "Butyrate"),]
crds.max$Substrate <- droplevels(crds.max$Substrate)
crds.max$ID <- droplevels(crds.max$ID)

### Pull out max delta value
ids <- levels(crds.max$ID)
max.df <- data.frame(crds.max[1,])
max.df <- max.df[,-3]
max.df <- max.df[,-9]
for(i in 1:length(ids)){
  ID <- ids[i]  
  select <- crds.max[which(crds.max$ID == ID),]
  baseline.delta <- select$Delta[1]
  Max <- (max(select$Delta)-baseline.delta)
  Max.time <- select$RelTime[which(select$Delta == max(select$Delta))]
  max.df[i,1:3] <- c(Max.time, Max, select$Number[1])
  max.df[i, 4] <- as.character(select$ID[1])
  max.df[i, 5] <- as.character(select$Season[1])
  max.df[i, 6] <- as.character(select$Sex[1])
  max.df[i, 7] <- as.character(select$Antibiotics[1])
  max.df[i, 8] <- as.character(select$Substrate[1])
}




### Subset by Substrate & ABX
max.inu <- max.df[which(max.df$Substrate == "Inulin"),]
max.man <- max.df[which(max.df$Substrate == "Mannitol"),]
max.sal <- max.df[which(max.df$Substrate == "Saline"),]
max.abx <- max.df[which(max.df$Antibiotics == "Yes"),]
max.noabx <- max.df[which(max.df$Antibiotics == "No"),]
max.inu.abx <- max.inu[which(max.inu$Antibiotics == "Yes"),]
max.inu.noabx <- max.inu[which(max.inu$Antibiotics == "No"),]
max.man.abx <- max.man[which(max.man$Antibiotics == "Yes"),]
max.man.noabx <- max.man[which(max.man$Antibiotics == "No"),]
max.sal.abx <- max.sal[which(max.sal$Antibiotics == "Yes"),]
max.sal.noabx <- max.sal[which(max.sal$Antibiotics == "No"),]
```




### Separate by substrate & ABX (individuals)
```{r}
### Separate by Substrate
inu.ind <- crds.rem[which(crds.rem$Substrate == "Inulin"),]
man.ind <- crds.rem[which(crds.rem$Substrate == "Mannitol"),]
sal.ind <- crds.rem[which(crds.rem$Substrate == "Saline"),]

### Separate by Substrate & ABX
inu.noabx.ind <- inu.ind[which(inu.ind$Antibiotics == "No"),]
inu.abx.ind <- inu.ind[which(inu.ind$Antibiotics == "Yes"),]
man.noabx.ind <- man.ind[which(man.ind$Antibiotics == "No"),]
man.abx.ind <- man.ind[which(man.ind$Antibiotics == "Yes"),]
sal.noabx.ind <- sal.ind[which(sal.ind$Antibiotics == "No"),]
sal.abx.ind <- sal.ind[which(sal.ind$Antibiotics == "Yes"),]


### Separate by Substrate & ABX & Season
inu.noabx.sum.ind <- inu.noabx.ind[which(inu.noabx.ind$Season == "Summer"),]
inu.noabx.win.ind <- inu.noabx.ind[which(inu.noabx.ind$Season == "Winter"),]
inu.noabx.spr.ind <- inu.noabx.ind[which(inu.noabx.ind$Season == "Spring"),]
man.noabx.sum.ind <- man.noabx.ind[which(man.noabx.ind$Season == "Summer"),]
man.noabx.win.ind <- man.noabx.ind[which(man.noabx.ind$Season == "Winter"),]
man.noabx.spr.ind <- man.noabx.ind[which(man.noabx.ind$Season == "Spring"),]
sal.noabx.sum.ind <- sal.noabx.ind[which(sal.noabx.ind$Season == "Summer"),]
sal.noabx.win.ind <- sal.noabx.ind[which(sal.noabx.ind$Season == "Winter"),]
sal.noabx.spr.ind <- sal.noabx.ind[which(sal.noabx.ind$Season == "Spring"),]

```


### Plot individuals (explore)
```{r}
ggplot(inu.ind, aes(x=BinTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point() +
  facet_grid(Antibiotics~Season)

ggplot(inu.ind, aes(x=BinTime, y=Delta, color=Season)) +
  geom_line() +
  geom_point() +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  facet_grid(Antibiotics~Season)

ggplot(inu.noabx.sum.ind, aes(x=BinTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point()

ggplot(inu.noabx.win.ind, aes(x=BinTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point()

ggplot(inu.noabx.spr.ind, aes(x=BinTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point()


## Pull out one individual to plot for methods explanation
example <- inu.noabx.spr.ind[which(inu.noabx.spr.ind$ID == "P07"),]
example.plot <- ggplot(example, aes(x=RelTime, y=Delta)) +
  geom_line() +
  geom_point(size=3) +
  ggtitle(expression("Example")) +
  xlab("Time Since Gavage (hr)") +
  ylab(expression(delta^13~"C"~"(%"[o]~")")) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.title.x=element_text(size=20, 
                                  margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y=element_text(size=18),
        axis.text.x=element_text(size=16),
        axis.text.y=element_text(size=16),
        plot.margin = unit(c(0, 0.3, 0.3, 0.3), "cm"),
          #top, right, bottom, left
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
  )

tiff("example.mdtp.tiff", width = 9.5, height = 6, units = "in", res = 300)
example.plot
dev.off()











ggplot(man.ind, aes(x=BinTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point() +
  facet_grid(Antibiotics~Season)


ggplot(man.ind, aes(x=BinTime, y=Delta, color=Season)) +
  geom_line() +
  geom_point() +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  facet_grid(Antibiotics~Season)






ggplot(sal.ind, aes(x=BinTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point() +
  facet_grid(Antibiotics~Season)


ggplot(sal.ind, aes(x=BinTime, y=Delta, color=Season)) +
  geom_line() +
  geom_point() +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  facet_grid(Antibiotics~Season)


```


### Plot
```{r}
## All individuals
ggplot(crds.bin, aes(x=BinTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point()

## Substrate/ABX
ggplot(crds.sum, aes(x=BinTime, y=Mean, color=Substrate)) +
  geom_line(aes(linetype=Antibiotics)) +
  geom_point() +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE))

## Inulin
inu.plot <- ggplot(inu.all, aes(x=BinTime, y=Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
   geom_point(size=3, shape=21, aes(color=Season, fill=factor(ifelse(Antibiotics == "Yes", NA, Season)))) +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"), na.value="white", guide="none") +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE), width=0.125, position=position_dodge(0.1)) +
  ggtitle(expression("Inulin"~~delta^13~"C")) +
  xlab("Time Since Gavage (hr)") +
  ylab(expression("Mean"~~delta^13~"C"~"(%"[o]~")")) +
  xlim(-0.6,4.1) +
  scale_y_continuous(breaks=c(0, 625, 1250, 1875, 2500), limits=c(-30, 2700)) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.title.x=element_text(size=20, 
                                  margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y=element_text(size=18),
        axis.text.x=element_text(size=16),
        axis.text.y=element_text(size=16),
        plot.margin = unit(c(0, 0.3, 0.3, 0.3), "cm"),
          #top, right, bottom, left
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
  ) +
  guides(colour=F, linetype=F)




## Mannitol
man.plot <- ggplot(man.all, aes(x=BinTime, y=Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
  geom_point(size=3, shape=21, aes(color=Season, fill=factor(ifelse(Antibiotics == "Yes", NA, Season)))) +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"), na.value="white", guide="none") +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE), width=0.125, position=position_dodge(0.1)) +
  ggtitle(expression("Mannitol"~~delta^13~"C")) +
  xlab("Time Since Gavage (hr)") +
  ylab(expression("Mean"~~delta^13~"C"~"(%"[o]~")")) +
  xlim(-0.6,2.6) +
  scale_y_continuous(breaks=c(0, 250, 500, 750, 1000), limits=c(-30, 760)) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.title.x=element_text(size=20, 
                                  margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y=element_text(size=18),
        axis.text.x=element_text(size=16),
        axis.text.y=element_text(size=16),
        plot.margin = unit(c(0, 0.3, 0.3, 0.3), "cm"),
          #top, right, bottom, left
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
  ) +
  guides(colour=F, linetype=F)




## Saline
sal.plot <- ggplot(sal.all, aes(x=BinTime, y=Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
  geom_point(size=3, shape=21, aes(color=Season, fill=factor(ifelse(Antibiotics == "Yes", NA, Season)))) +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"), na.value="white", guide="none") +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE), width=0.125, position=position_dodge(0.1)) +
  ggtitle(expression("Saline"~~delta^13~"C")) +
  xlab("Time Since Gavage (hr)") +
  ylab(expression("Mean"~~delta^13~"C"~"(%"[o]~")")) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.title.x=element_text(size=14),
        axis.title.y=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text.y=element_text(size=12)) +
  guides(colour=F, linetype=F)


## Urea
ure.plot <- ggplot(ure.all, aes(x=BinTime, y=Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
  geom_point(size=3, shape=21, aes(color=Season, fill=factor(ifelse(Antibiotics == "Yes", NA, Season)))) +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"), na.value="white", guide="none") +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE), width=0.125, position=position_dodge(0.1)) +
  ggtitle(expression("Urea"~~delta^13~"C")) +
  xlab("Time Since Gavage (hr)") +
  ylab(expression("Mean"~~delta^13~"C"~"(%"[o]~")")) +
  theme(plot.title=element_text(hjust=0.5)) #+
  #guides(colour=F, linetype=F)

## Steal legend
steal.legend <- ggplot(sal.all, aes(x=BinTime, y=Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
  geom_point(size=3) +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE), width=0.125, position=position_dodge(0.1)) +
  ggtitle(expression("Saline"~~delta^13~"C")) +
  xlab("Time Since Gavage (hr)") +
  ylab(expression("Mean"~~delta^13~"C"~"(%"[o]~")")) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.title.x=element_text(size=14),
        axis.title.y=element_text(size=14),
        axis.text.x=element_text(size=12),
        axis.text.y=element_text(size=12),
        legend.title = element_text(size=20, face="bold"),
        legend.text = element_text(size=18)
        )
legend <- g_legend(steal.legend)






### All 3 substrates on same axis
carb.sum <- crds.sum[which(crds.sum$Substrate != "Urea"),]
carb.sum <- carb.sum[which(carb.sum$Substrate != "Acetate"),]
carb.sum <- carb.sum[which(carb.sum$Substrate != "Butyrate"),]


carb.plot <- ggplot(carb.sum, aes(x=BinTime, y=Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
   geom_point(size=3, shape=21, aes(color=Season, fill=factor(ifelse(Antibiotics == "Yes", NA, Season)))) +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"), na.value="white", guide="none") +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE), width=0.125, position=position_dodge(0.1)) + 
  facet_grid(.~Substrate) +
  xlab("Time Since Gavage (hr)") +
  ylab(expression("Mean"~~delta^13~"C"~"(%"[o]~")")) +
  xlim(-0.6,4.1) +
  scale_y_continuous(breaks=c(0, 500, 1000, 1500, 2000, 2500), limits=c(-30, 2700)) +
  theme(axis.text.x = element_text(size=16),
        axis.text.y = element_text(size=16),
        axis.title.x = element_text(size=20, margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y = element_text(size=20, margin=margin(t=0, r=10, b=, l=0)),
        strip.text.x = element_text(size=20, face="bold"),
        #strip.text.y = element_text(size=14),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 20, face="bold"),
        legend.text = element_text(size=18),
        panel.grid.minor = element_blank(),
        #panel.grid.major = element_blank(),
        strip.background = element_blank()
  )



tiff("crds.mdtp.tiff", width = 12.75, height = 3.5, units = "in", res = 300)
carb.plot
dev.off()
```



### Poster Plots
```{r}
tiff("prelim.fig3.tiff", width = 9, height = 3.5, units = "in", res = 300)
grid.newpage()
pushViewport(viewport(layout=(grid.layout(1,4, widths=c(1,1,1,0.4), heights=c(1,1,1,1)))))
print(inu.plot, vp=viewport(layout.pos.row=1, layout.pos.col=1))
print(man.plot, vp=viewport(layout.pos.row=1, layout.pos.col=2))
print(sal.plot, vp=viewport(layout.pos.row=1, layout.pos.col=3))
legend$vp <- viewport(layout.pos.row=1, layout.pos.col=4)
grid.draw(legend)
dev.off()


tiff("inu.man.mdtp.tiff", width = 12.5, height = 3.25, units = "in", res = 300)
grid.newpage()
pushViewport(viewport(layout=(grid.layout(1,3, widths=c(1,1,0.35), heights=c(1,1,1)))))
print(inu.plot, vp=viewport(layout.pos.row=1, layout.pos.col=1))
print(man.plot, vp=viewport(layout.pos.row=1, layout.pos.col=2))
legend$vp <- viewport(layout.pos.row=1, layout.pos.col=3)
grid.draw(legend)
dev.off()
```



### Inulin Plots
```{r}
## All individuals
inu.ind <- crds.rem[which(crds.rem$Substrate == "Inulin"),]
ggplot(inu.ind, aes(x=BinTime, y=Delta, color=Season)) +
  geom_line(aes(linetype=ABX)) +
  geom_point() +
  scale_color_manual(name="Season", values=c("red", "Blue"))

## Summer
inu.sum <- crds.rem[which(crds.rem$Substrate == "Inulin" & crds.rem$Season == "Summer"),]
ggplot(inu.sum, aes(x=BinTime, y=Delta, color=ABX)) +
  geom_line(aes(linetype=ABX)) +
  geom_point() +
  scale_color_manual(name="ABX", values=c("red", "Blue"))

## Summer ABX
inu.sum.abx <- crds.rem[which(crds.rem$Substrate == "Inulin" & crds.rem$Season == "Summer" & crds.rem$ABX == "Yes"),]
ggplot(inu.sum.abx, aes(x=BinTime, y=Delta, color=ID)) +
  geom_line(aes(linetype=ABX)) +
  geom_point()
  # 3982 is an outlier -- is it actually ABX?
  # Until confirmed, remove from data
```







### Test Max Delta Change
```{r}
### Check Max Delta Normality
hist(max.df$Delta)
qqnorm(max.df$Delta)
qqline(max.df$Delta)
shapiro.test(max.df$Delta)
  # p-value < 2.2e-16
  # Not Normal

hist(max.inu$Delta)
qqnorm(max.inu$Delta)
qqline(max.inu$Delta)
shapiro.test(max.inu$Delta)
  # p-value = 7.558e-06
  # Not Normal

hist(max.inu.noabx$Delta)
qqnorm(max.inu.noabx$Delta)
qqline(max.inu.noabx$Delta)
shapiro.test(max.inu.noabx$Delta)
  # p-value = 0.1429
  # Normal

hist(max.man$Delta)
qqnorm(max.man$Delta)
qqline(max.man$Delta)
shapiro.test(max.man$Delta)
  # p-value = 5.542e-09
  # Not Normal

hist(max.man.noabx$Delta)
qqnorm(max.man.noabx$Delta)
qqline(max.man.noabx$Delta)
shapiro.test(max.man.noabx$Delta)
  # p-value = 0.001635
  # Not Normal

hist(max.sal$Delta)
qqnorm(max.sal$Delta)
qqline(max.sal$Delta)
shapiro.test(max.sal$Delta)
  # p-value = 5.269e-13
  # Not Normal

hist(max.abx$Delta)
qqnorm(max.abx$Delta)
qqline(max.abx$Delta)
shapiro.test(max.abx$Delta)
  # p-value = 2.942e-09
  # Normal

hist(max.noabx$Delta)
qqnorm(max.noabx$Delta)
qqline(max.noabx$Delta)
shapiro.test(max.noabx$Delta)
  # p-value = 7.414e-09
  # Not Normal




### Boxplots
max.carb.df <- max.df[which(max.df$Substrate != "Saline"),]
max.carb.df <- max.carb.df[which(max.carb.df$Antibiotics == "No"),]
max.carb.plot <- ggplot(max.carb.df, aes(x=Season, y=Delta, fill=Season)) +
  geom_boxplot(outlier.size=-1) +
  geom_point(position=position_jitterdodge(jitter.width=0.75)) +
  facet_grid(.~Substrate) +
  scale_fill_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ylab(expression("Max"~~delta^13~"C"~~"(%"[o]~")")) +
  scale_y_continuous(breaks=c(0, 1125, 2250, 3375, 4500), limits=c(0, 4500)) +
  theme(axis.text.x = element_text(size=20),
        axis.text.y = element_text(size=14),
        axis.title.x = element_text(size=20, margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y = element_text(size=20, margin=margin(t=0, r=10, b=, l=0)),
        strip.text.x = element_text(size=20, face="bold"),
        #strip.text.y = element_text(size=14),
        panel.spacing=unit(2, "lines"),
        legend.title = element_text(size = 18, face="bold"),
        legend.text = element_text(size=16),
        panel.grid.minor = element_blank(),
        panel.grid.major.x = element_blank(),
        strip.background = element_blank()
  )

tiff("max.mdtp.tiff", width = 12.5, height = 4, units = "in", res = 300)
max.carb.plot
dev.off()





## Inulin
inu.max.plot <- ggplot(max.inu, aes(x=Season, y=Delta, fill=Season)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point(size=2) +
  scale_fill_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Inulin") +
  ylab(expression("Max"~~delta^13~"C"~~"(%"[o]~")")) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.text.x = element_text(size=20),
        axis.text.y = element_text(size=14),
        axis.title.x = element_text(size=20, margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y = element_text(size=20, margin=margin(t=0, r=10, b=0, l=0)),
        strip.text.x = element_text(size=20),
        #strip.text.y = element_text(size=14),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 18),
        legend.text = element_text(size=16),
        panel.grid.major = element_blank()
  ) +
  guides(fill=F)



    
    

## Mannitol
man.max.plot <- ggplot(max.man, aes(x=Season, y=Delta, fill=Season)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point(size=2) +
  scale_fill_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Mannitol") +
  ylab(expression("Max"~~delta^13~"C"~~"(%"[o]~")")) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.text.x = element_text(size=20),
        axis.text.y = element_text(size=14),
        axis.title.x = element_text(size=20, margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y = element_text(size=20, margin=margin(t=0, r=10, b=0, l=0)),
        strip.text.x = element_text(size=20),
        #strip.text.y = element_text(size=14),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 18),
        legend.text = element_text(size=16),
        panel.grid.major = element_blank()
  ) +
  guides(fill=F)







## Steal legend
steal.legend <- ggplot(max.man, aes(x=Season, y=Delta, fill=Season)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point(size=2) +
  scale_fill_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Mannitol") +
  ylab(expression("Max"~~delta^13~"C"~~"(%"[o]~")")) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.text.x = element_text(size=20),
        axis.text.y = element_text(size=14),
        axis.title.x = element_text(size=20, margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y = element_text(size=20, margin=margin(t=0, r=10, b=0, l=0)),
        strip.text.x = element_text(size=20),
        #strip.text.y = element_text(size=14),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 20, face="bold"),
        legend.text = element_text(size=18),
        panel.grid.major = element_blank(),
  )
legend <- g_legend(steal.legend)


tiff("max.mdtp.tiff", width = 12.5, height = 4, units = "in", res = 300)
grid.newpage()
pushViewport(viewport(layout=(grid.layout(1,3, widths=c(1,1,0.25), heights=c(1,1,1)))))
print(inu.max.plot, vp=viewport(layout.pos.row=1, layout.pos.col=1))
print(man.max.plot, vp=viewport(layout.pos.row=1, layout.pos.col=2))
legend$vp <- viewport(layout.pos.row=1, layout.pos.col=3)
grid.draw(legend)
dev.off()





tiff("crds.mdtp.tiff", width = 12.75, height = 5, units = "in", res = 300)
carb.plot
dev.off()









ggplot(max.df, aes(x=Season, y=Delta, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(Antibiotics~Substrate) 
ggplot(max.inu, aes(x=Season, y=Delta, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point()
ggplot(max.man, aes(x=Season, y=Delta, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point()
ggplot(max.sal, aes(x=Season, y=Delta, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point()




### Kruskal-Wallis
wilcox.test(Delta ~ Antibiotics, data=max.df)
  # p-value = 0.0001069
kruskal.test(formula = Delta ~ Substrate, data=max.abx)
  # p-value = 1.325e-09
kruskalmc(resp = Delta ~ Substrate, data=max.abx)
  # Inulin-Mannitol
  # Inulin-Saline
  # Mannitol-Saline
kruskal.test(formula = Delta ~ Season, data=max.abx)
  # p-value = 0.3582
wilcox.test(Delta~Sex, data=max.abx)
  # p-value = 0.3535


# Inulin
wilcox.test(Delta~Antibiotics, data=max.inu)
  # p-value = 2.935e-08
kruskal.test(formula = Delta ~ Season, data=max.inu.abx)
  # p-value = 0.862
kruskal.test(formula = Delta ~ Season, data=max.inu.noabx)
  # p-value = 0.004309
kruskalmc(resp = Delta ~ Season, data=max.inu.noabx)
  # Spring-Winter
  # Summer-Winter
pairwise.wilcox.test(max.inu.noabx$Delta, max.inu.noabx$Season, method="BH")
  # Summer-Spring = 0.5350
  # Winter-Spring = 0.0140
  # Summer-Winter = 0.0035


# Mannitol
wilcox.test(Delta~Antibiotics, data=max.man)
  # p-value = 1.897e-05
kruskal.test(formula = Delta ~ Season, data=max.man.abx)
  # p-value = 0.225
kruskal.test(formula = Delta ~ Season, data=max.man.noabx)
  # p-value = 0.05701


# Saline
wilcox.test(Delta~Antibiotics, data=max.sal)
  # p-value = 0.2554
kruskal.test(formula = Delta ~ Season, data=max.sal.abx)
  # p-value = 0.02766
kruskal.test(formula = Delta ~ Season, data=max.sal.noabx)
  # p-value = 0.252



### Kruskal-Wallis BH-adjusted p-values
# Within-substrate ABX wilcoxon test
p.adjust(c(2.935e-08, 1.897e-05, 0.2554), method="BH")
  # Inulin = 8.8050e-08
  # Mannitol = 2.8455e-05
  # Saline = 0.25540
# Within-substrate season kruskal-wallis test
p.adjust(c(0.862, 0.004309, 0.225, 0.05701, 0.02766, 0.252), method="BH")
  # Inulin ABX = 0.86200
  # Inulin No ABX = 0.025854
  # Mannitol ABX = 0.302400
  # Mannitol No ABX = 0.11402
  # Saline ABX = 0.08298
  # Saline No ABX = 0.302400


```


### Test Max Peak Time
```{r}
### Check Max RelTime Normality
hist(max.df$RelTime)
qqnorm(max.df$RelTime)
qqline(max.df$RelTime)
shapiro.test(max.df$RelTime)
  # p-value = 0.1732
  # Normal

hist(max.inu$RelTime)
qqnorm(max.inu$RelTime)
qqline(max.inu$RelTime)
shapiro.test(max.inu$RelTime)
  # p-value = 0.0002087
  # Not Normal

hist(max.man$RelTime)
qqnorm(max.man$RelTime)
qqline(max.man$RelTime)
shapiro.test(max.man$RelTime)
  # p-value = 8.585e-06
  # Not Normal

hist(max.sal$RelTime)
qqnorm(max.sal$RelTime)
qqline(max.sal$RelTime)
shapiro.test(max.sal$RelTime)
  # p-value = 0.009691
  # Not Normal

hist(max.abx$RelTime)
qqnorm(max.abx$RelTime)
qqline(max.abx$RelTime)
shapiro.test(max.abx$RelTime)
  # p-value = 0.1728
  # Normal

hist(max.noabx$RelTime)
qqnorm(max.noabx$RelTime)
qqline(max.noabx$RelTime)
shapiro.test(max.noabx$RelTime)
  # p-value = 0.006763
  # Not Normal




### Boxplots
ggplot(max.df, aes(x=Season, y=RelTime, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Substrate) 
ggplot(max.inu, aes(x=Season, y=RelTime, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point()
ggplot(max.man, aes(x=Season, y=RelTime, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point()
ggplot(max.sal, aes(x=Season, y=RelTime, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point()




### Kruskal-Wallis
t.test(RelTime ~ Antibiotics, data=max.df)
  # p-value = 3.541e-07
summary(aov(RelTime ~ Substrate, data=max.abx))
  # p-value = 0.167
TukeyHSD(aov(RelTime ~ Substrate, data=max.abx))
  # Mannitol-Inulin = 0.2869741
  # Saline-Inulin = 0.9877289
  # Saline-Mannitol = 0.1917229
summary(aov(RelTime ~ Season, data=max.abx))
  # p-value = 0.00898
TukeyHSD(aov(RelTime ~ Season, data=max.abx))
  # Summer-Spring = 0.5721568
  # Winter-Spring = 0.0976318
  # Winter-Summer = 0.0076053
t.test(RelTime ~ Sex, data=max.df)
  # p-value = 0.5183


# Inulin
wilcox.test(RelTime~Antibiotics, data=max.inu)
  # p-value = 1.787e-06
kruskal.test(formula = RelTime ~ Season, data=max.inu.abx)
  # p-value = 0.06165
kruskal.test(formula = RelTime ~ Season, data=max.inu.noabx)
  # p-value = 0.8789


# Mannitol
wilcox.test(RelTime~Antibiotics, data=max.man)
  # p-value = 0.00232
kruskal.test(formula = RelTime ~ Season, data=max.man.abx)
  # p-value = 0.05151
kruskal.test(formula = RelTime ~ Season, data=max.man.noabx)
  # p-value = 0.2417


# Saline
wilcox.test(RelTime~Antibiotics, data=max.sal)
  # p-value = 0.6885
kruskal.test(formula = RelTime ~ Season, data=max.sal.abx)
  # p-value = 0.078
kruskal.test(formula = RelTime ~ Season, data=max.sal.noabx)
  # p-value = 0.02704
kruskalmc(resp = RelTime ~ Season, data=max.sal.noabx)
  # Summer-Winter
pairwise.wilcox.test(max.sal.noabx$RelTime, max.sal.noabx$Season)
  # Summer-Spring = 0.318
  # Winter-Spring = 0.256
  # Summer-Winter = 0.021



### Kruskal-Wallis BH-adjusted p-values
# Within-substrate ABX wilcoxon test
p.adjust(c(1.787e-06, 0.00232, 0.6885), method="BH")
  # Inulin = 5.361e-06
  # Mannitol = 0.003480
  # Saline = 0.6885
# Within-substrate season kruskal-wallis test
p.adjust(c(0.06165, 0.8789, 0.05151, 0.2417, 0.078, 0.02704), method="BH")
  # Inulin ABX = 0.11700
  # Inulin No ABX = 0.87890
  # Mannitol ABX = .11700
  # Mannitol No ABX = 0.29004
  # Saline ABX = 0.11700
  # Saline No ABX = 0.11700
```

### Subset Summer
```{r}
sum.all <- crds.sum[which(crds.sum$Season == "Summer"),]
sum.all <- sum.all[which(sum.all$Substrate != "Acetate"),]
sum.all <- sum.all[which(sum.all$Substrate != "Butyrate"),]
sum.all <- sum.all[which(sum.all$Substrate != "Urea"),]


sum.inu <- sum.all[which(sum.all$Substrate == "Inulin"),]

sum.man <- sum.all[which(sum.all$Substrate == "Mannitol"),]

sum.sal <- sum.all[which(sum.all$Substrate == "Saline"),]

sum.abx <- sum.all[which(sum.all$Antibiotics == "Yes"),]
```

### Summer Correlate [DNA] & CRDS
```{r}
dna <- read.csv('dna.csv', fileEncoding="UTF-8-BOM")
auc.sum <- auc.df[which(auc.df$Season == "Summer"),]

# Pull out shared squirrels
both <- intersect(dna$Squirrel, auc.sum$ID)
dna.sum <- dna[1,]
dna.sum$AUC <- NA
dna.sum$MaxDelta <- NA
dna.sum$PeakTime <- NA
for(i in 1:length(both)){
  ID <- both[i]
  dna.sum[i,1:ncol(dna)] <- dna[which(dna$Squirrel == ID),]
  dna.sum[i,(ncol(dna)+1)] <- auc.df$AUC[which(auc.df$ID == ID)]
  dna.sum[i,(ncol(dna)+2)] <- max.df$Delta[which(max.df$ID == ID)]
  dna.sum[i,(ncol(dna)+3)] <- max.df$RelTime[which(max.df$ID == ID)]
}



# Model = Water Consumption --> DNA Yield --> CRDS



### Test Normality
hist(dna.sum$DNA_Yield)
qqnorm(dna.sum$DNA_Yield)
qqline(dna.sum$DNA_Yield)
shapiro.test(dna.sum$DNA_Yield)
  # p-value = 0.0007067
  # Not Normal

hist(dna.sum$AUC)
qqnorm(dna.sum$AUC)
qqline(dna.sum$AUC)
shapiro.test(dna.sum$AUC)
  # p-value = 1.321e-06
  # Not Normal

hist(dna.sum$MaxDelta)
qqnorm(dna.sum$MaxDelta)
qqline(dna.sum$MaxDelta)
shapiro.test(dna.sum$MaxDelta)
  # p-value = 1.363e-05
  # Not Normal

hist(dna.sum$PeakTime)
qqnorm(dna.sum$PeakTime)
qqline(dna.sum$PeakTime)
shapiro.test(dna.sum$PeakTime)
  # p-value = 0.113
  # Normal



### Look for cross-correlations
pairs(dna.sum[,12:15])



### Linear Correlation
xyplot(AUC ~ DNA_Yield, dna.sum)
summary(lm(AUC ~ DNA_Yield, dna.sum))
  # p-value = 0.0238
  # R2 = 0.1754
confint(lm(AUC ~ DNA_Yield, dna.sum), level=0.95)

xyplot(MaxDelta ~ DNA_Yield, dna.sum)
summary(lm(MaxDelta ~ DNA_Yield, dna.sum))
  # p-value = 0.00626
  # Adj R2 = 0.2613
confint(lm(MaxDelta ~ DNA_Yield, dna.sum), level=0.95)

xyplot(PeakTime ~ DNA_Yield, dna.sum)
summary(lm(PeakTime ~ DNA_Yield, dna.sum))
  # p-value = 0.00615
  # Adj R2 = 0.2623
confint(lm(PeakTime ~ DNA_Yield, dna.sum), level=0.95)

```

### Summarize/Organize
```{r}
max.org <- max.df %>%
  group_by(Season, Substrate, Antibiotics) %>%
  summarize(Mean = mean(Delta),
            Median = median(Delta),
            SD = sd(Delta),
            SE = (sd(Delta)/(sqrt(length(Delta)))),
            iqr = IQR(Delta))




```

### DNA vs. CRDS Kendall Correlation
```{r}
Kendall(dna.sum$DNA_Yield, dna.sum$AUC)
  # p-value = 0.0073302
  # tau = 0.412
Kendall(dna.sum$DNA_Yield, dna.sum$MaxDelta)
  # p-value = 0.11464
  # tau = 0.389
Kendall(dna.sum$DNA_Yield, dna.sum$PeakTime)
  # p-value = 0.0030445
  # tau = 0.455


corr.test(x=dna.sum$DNA_Yield, y=dna.sum$AUC, method="kendall", use="complete", adjust="BH")
  # p-value = 0.05
  # tau = 0.41
corr.test(x=dna.sum$DNA_Yield, y=dna.sum$MaxDelta, method="kendall", use="complete", adjust="BH")
  # p-value = 0.06
  # tau = 0.39
corr.test(x=dna.sum$DNA_Yield, y=dna.sum$PeakTime, method="kendall", use="complete", adjust="BH")
  # p-value = 0.03
  # tau = 0.46
```

### Import & Prep Summer OTUs
```{r}
# Import phyloseq object
load("Physeq.RData")

# Pull out common samples
both <- intersect(dna.sum$Squirrel, data.frame(sample_data(physeq))$Squirrel)
dna.keep <- dna.sum[1,]
for(i in 1:length(both)){
  ID <- both[i]
  dna.keep[i,] <- dna.sum[which(dna.sum$Squirrel == ID),]
}
physeq.keep <- subset_samples(physeq, Squirrel != "S11")
physeq.keep <- subset_samples(physeq.keep, Squirrel != "S37")
physeq.keep <- subset_samples(physeq.keep, Squirrel != "S40")

# Remove taxa < 1% rel abund
physeq.ra <- transform_sample_counts(physeq.keep, function(x){x/sum(x)})
physeq.use <- prune_taxa(taxa_sums(physeq.ra)>0.01, physeq.ra)

# Pick top 20 taxa
cutoff <- summary(sort(taxa_sums(physeq.use), decreasing=T)[1:20])
physeq.top <- prune_taxa(taxa_sums(physeq.use)>(cutoff[1]-0.0000001), physeq.use)
```

### OTU vs CRDS Correlation
```{r}
### AUC
auc.all <- corr.test(x=dna.keep$AUC, y=t(otu_table(physeq.use)), method="kendall", use="complete", adjust="BH")
which(auc.all$p < 0.05)
  # None

auc.all2 <- corr.test(x=dna.keep$AUC, y=t(otu_table(physeq.use)), method="kendall", use="pairwise", adjust="BH")
which(auc.all2$p < 0.05)
  # None

auc.top <- corr.test(x=dna.keep$AUC, y=t(otu_table(physeq.top)), method="kendall", use="complete", adjust="BH")
which(auc.top$p < 0.05)
  # None



### Max Delta
del.all <- corr.test(x=dna.keep$MaxDelta, y=t(otu_table(physeq.use)), method="kendall", use="complete", adjust="BH")
which(del.all$p < 0.05)
  # None

del.all2 <- corr.test(x=dna.keep$MaxDelta, y=t(otu_table(physeq.use)), method="kendall", use="pairwise", adjust="BH")
which(del.all2$p < 0.05)
  # None

del.top <- corr.test(x=dna.keep$MaxDelta, y=t(otu_table(physeq.top)), method="kendall", use="complete", adjust="BH")
which(del.top$p < 0.05)
  # None



### Peak Time
tim.all <- corr.test(x=dna.keep$PeakTime, y=t(otu_table(physeq.use)), method="kendall", use="complete", adjust="BH")
which(tim.all$p < 0.05)
  # None

tim.all2 <- corr.test(x=dna.keep$PeakTime, y=t(otu_table(physeq.use)), method="kendall", use="pairwise", adjust="BH")
which(tim.all2$p < 0.05)
  # None

tim.top <- corr.test(x=dna.keep$PeakTime, y=t(otu_table(physeq.top)), method="kendall", use="complete", adjust="BH")
which(tim.top$p < 0.05)
  # None
```

### miLineage
```{r}
# Prep inputs
tax.ml <- as.matrix(tax_table(physeq.keep))
colnames(tax.ml) <- c("Rank1","Rank2","Rank3","Rank4","Rank5","Rank6","Rank7")
otu.ml.pre <- data.frame(otu_table(physeq.keep))
otu.ml <- otu.ml.pre[,1:8]
otu.ml$CC2_S21 <- otu.ml.pre[,20]
otu.ml[,10:20] <- otu.ml.pre[,9:19]
otu.ml <- as.matrix(t(otu.ml))
var.ml <- as.matrix(dna.keep[,13])
  # AUC
var2.ml <- as.matrix(dna.keep[,14])
  # Max Delta
var3.ml <- as.matrix(dna.keep[,15])
  # Peak Time
rownames(var.ml) <- dna.keep$Sample

# Run test
ml.results <- QCAT_GEE(OTU=otu.ml, Tax=tax.ml, X=var.ml, X.index = 1, Z=var.ml, Z.index=1,  fdr.alpha=0.05, n.resample = 100)
  # AUC
  # No sig
ml.results2 <- QCAT_GEE(OTU=otu.ml, Tax=tax.ml, X=var2.ml, X.index = 1, Z=var2.ml, Z.index=1,  fdr.alpha=0.05, n.resample = 100)
  # Max Delta
  # No sig
ml.results3 <- QCAT_GEE(OTU=otu.ml, Tax=tax.ml, X=var3.ml, X.index = 1, Z=var3.ml, Z.index=1,  fdr.alpha=0.05, n.resample = 100)
  # Peak Time
  # No sig
```

### Pull out summer no ABX
```{r}
physeq.noabx <- subset_samples(physeq.keep, Antibiotics == "No Antibiotics")

# Remove taxa < 1% rel abund
physeq.noabx.ra <- transform_sample_counts(physeq.noabx, function(x){x/sum(x)})
physeq.noabx.use <-
  prune_taxa(taxa_sums(physeq.noabx.ra)>0.01,
             physeq.noabx.ra)

# Pick top 20 taxa
cutoff.noabx <- summary(sort(taxa_sums(physeq.noabx.use),
                             decreasing=T)[1:20])
physeq.noabx.top <- 
  prune_taxa(taxa_sums(physeq.noabx.use)>(cutoff[1]-0.0000001), physeq.noabx.use)

# Prep DNA metadata
both <- intersect(dna.keep$Squirrel, data.frame(sample_data(physeq.noabx.use))$Squirrel)
dna.keep.noabx <- dna.keep[1,]
for(i in 1:length(both)){
  ID <- both[i]
  dna.keep.noabx[i,] <- dna.keep[which(dna.keep$Squirrel == ID),]
}
```


### No ABX OTU vs CRDS Correlation
```{r}
### AUC
auc.noabx <- corr.test(x=dna.keep.noabx$AUC, y=t(otu_table(physeq.noabx.use)), method="kendall", use="complete", adjust="BH")
which(auc.noabx$p < 0.05)
  # None

auc.noabx2 <- corr.test(x=dna.keep.noabx$AUC, y=t(otu_table(physeq.noabx.use)), method="kendall", use="pairwise", adjust="BH")
which(auc.noabx2$p < 0.05)
  # None

auc.noabx.top <- corr.test(x=dna.keep.noabx$AUC, y=t(otu_table(physeq.noabx.top)), method="kendall", use="complete", adjust="BH")
which(auc.noabx.top$p < 0.05)
  # None



### Max Delta
del.noabx <- corr.test(x=dna.keep.noabx$MaxDelta, y=t(otu_table(physeq.noabx.use)), method="kendall", use="complete", adjust="BH")
which(del.noabx$p < 0.05)
  # None

del.noabx2 <- corr.test(x=dna.keep.noabx$MaxDelta, y=t(otu_table(physeq.noabx.use)), method="kendall", use="pairwise", adjust="BH")
which(del.noabx2$p < 0.05)
  # None

del.noabx.top <- corr.test(x=dna.keep.noabx$MaxDelta, y=t(otu_table(physeq.noabx.top)), method="kendall", use="complete", adjust="BH")
which(del.noabx.top$p < 0.05)
  # None



### Peak Time
tim.noabx <- corr.test(x=dna.keep.noabx$PeakTime, y=t(otu_table(physeq.noabx.use)), method="kendall", use="complete", adjust="BH")
which(tim.noabx$p < 0.05)
  # None

tim.noabx2 <- corr.test(x=dna.keep.noabx$PeakTime, y=t(otu_table(physeq.noabx.use)), method="kendall", use="pairwise", adjust="BH")
which(tim.noabx2$p < 0.05)
  # None

tim.noabx.top <- corr.test(x=dna.keep.noabx$PeakTime, y=t(otu_table(physeq.noabx.top)), method="kendall", use="complete", adjust="BH")
which(tim.noabx.top$p < 0.05)
  # None
```

### miLineage
```{r}
#### Prep inputs
tax.noabx.ml <- as.matrix(tax_table(physeq.noabx))
colnames(tax.noabx.ml) <-
  c("Rank1","Rank2","Rank3","Rank4","Rank5","Rank6",
    "Rank7")
otu.noabx.ml <- as.matrix(t(otu_table(physeq.noabx)))
var.noabx.ml <- as.matrix(dna.keep.noabx[,13])
  # AUC
var2.noabx.ml <- as.matrix(dna.keep.noabx[,14])
  # Max Delta
var3.noabx.ml <- as.matrix(dna.keep.noabx[,15])
  # Peak Time


#### Prep Inulin No ABX
physeq.inu.noabx <- subset_samples(physeq.noabx, Substrate == "Inulin")

# Remove taxa < 1% rel abund
physeq.inu.noabx.ra <- transform_sample_counts(physeq.inu.noabx, function(x){x/sum(x)})
physeq.inu.noabx.use <-
  prune_taxa(taxa_sums(physeq.inu.noabx.ra)>0.01,
             physeq.inu.noabx.ra)

# Prep DNA metadata
both <- intersect(dna.keep$Squirrel, data.frame(sample_data(physeq.inu.noabx.use))$Squirrel)
dna.inu.keep.noabx <- dna.keep[1,]
for(i in 1:length(both)){
  ID <- both[i]
  dna.inu.keep.noabx[i,] <- dna.keep[which(dna.keep$Squirrel == ID),]
}

# Prep Inputs
tax.inu.noabx.ml <- as.matrix(tax_table(physeq.inu.noabx))
colnames(tax.inu.noabx.ml) <-
  c("Rank1","Rank2","Rank3","Rank4","Rank5","Rank6",
    "Rank7")
otu.inu.noabx.ml <- as.matrix(t(otu_table(physeq.inu.noabx)))
var.inu.noabx.ml <- as.matrix(dna.inu.keep.noabx[,13])
  # AUC
var2.inu.noabx.ml <- as.matrix(dna.inu.keep.noabx[,14])
  # Max Delta
var3.inu.noabx.ml <- as.matrix(dna.inu.keep.noabx[,15])
  # Peak Time



### Prep Mannitol No ABX
physeq.man.noabx <- subset_samples(physeq.noabx, Substrate == "Mannitol")
# Remove taxa < 1% rel abund
physeq.man.noabx.ra <- transform_sample_counts(physeq.man.noabx, function(x){x/sum(x)})
physeq.man.noabx.use <-
  prune_taxa(taxa_sums(physeq.man.noabx.ra)>0.01,
             physeq.man.noabx.ra)

# Prep DNA metadata
both <- intersect(dna.keep$Squirrel, data.frame(sample_data(physeq.man.noabx.use))$Squirrel)
dna.man.keep.noabx <- dna.keep[1,]
for(i in 1:length(both)){
  ID <- both[i]
  dna.man.keep.noabx[i,] <- dna.keep[which(dna.keep$Squirrel == ID),]
}

# Prep Inputs
tax.man.noabx.ml <- as.matrix(tax_table(physeq.man.noabx))
colnames(tax.man.noabx.ml) <-
  c("Rank1","Rank2","Rank3","Rank4","Rank5","Rank6",
    "Rank7")
otu.man.noabx.ml <- as.matrix(t(otu_table(physeq.man.noabx)))
var.man.noabx.ml <- as.matrix(dna.man.keep.noabx[,13])
  # AUC
var2.man.noabx.ml <- as.matrix(dna.man.keep.noabx[,14])
  # Max Delta
var3.man.noabx.ml <- as.matrix(dna.man.keep.noabx[,15])
  # Peak Time




### Run test
ml.results <- QCAT_GEE(OTU=otu.noabx.ml, Tax=tax.noabx.ml, X=var.noabx.ml, X.index = 1, Z=var.noabx.ml, Z.index=1,  fdr.alpha=0.05, n.resample = 100)
  # AUC
  # No sig
ml.results2 <- QCAT_GEE(OTU=otu.noabx.ml, Tax=tax.noabx.ml, X=var2.noabx.ml, X.index = 1, Z=var2.noabx.ml, Z.index=1,  fdr.alpha=0.05, n.resample = 100)
  # Max Delta
  # No sig
ml.results3 <- QCAT_GEE(OTU=otu.noabx.ml, Tax=tax.noabx.ml, X=var3.noabx.ml, X.index = 1, Z=var3.noabx.ml, Z.index=1,  fdr.alpha=0.05, n.resample = 100)
  # Peak Time
  # No sig




### Run Inulin test
ml.inu.results <- QCAT_GEE(OTU=otu.inu.noabx.ml, Tax=tax.inu.noabx.ml, X=var.inu.noabx.ml, X.index = 1, Z=var.inu.noabx.ml, Z.index=1,  fdr.alpha=0.05, n.resample = 100)
  # AUC
  # No sig
ml.inu.results2 <- QCAT_GEE(OTU=otu.inu.noabx.ml, Tax=tax.inu.noabx.ml, X=var2.inu.noabx.ml, X.index = 1, Z=var2.inu.noabx.ml, Z.index=1,  fdr.alpha=0.05, n.resample = 100)
  # Max Delta
  # No sig
ml.inu.results3 <- QCAT_GEE(OTU=otu.inu.noabx.ml, Tax=tax.inu.noabx.ml, X=var3.inu.noabx.ml, X.index = 1, Z=var3.inu.noabx.ml, Z.index=1,  fdr.alpha=0.05, n.resample = 100)
  # Peak Time
  # No sig






### Run Mannitol test
ml.man.results <- QCAT_GEE(OTU=otu.man.noabx.ml, Tax=tax.man.noabx.ml, X=var.man.noabx.ml, X.index = 1, Z=var.man.noabx.ml, Z.index=1,  fdr.alpha=0.05, n.resample = 100)
  # AUC
  # No sig
ml.man.results2 <- QCAT_GEE(OTU=otu.man.noabx.ml, Tax=tax.man.noabx.ml, X=var2.man.noabx.ml, X.index = 1, Z=var2.man.noabx.ml, Z.index=1,  fdr.alpha=0.05, n.resample = 100)
  # Max Delta
  # No sig
ml.man.results3 <- QCAT_GEE(OTU=otu.man.noabx.ml, Tax=tax.man.noabx.ml, X=var3.man.noabx.ml, X.index = 1, Z=var3.man.noabx.ml, Z.index=1,  fdr.alpha=0.05, n.resample = 100)
  # Peak Time
  # No sig
```





### Format AUC data for Fariba
```{r}
### Format auc input data
fa.df <- data.frame(crds.auc[1,])
fa.df <- fa.df[,-2:-3]
  # Remove Delta and CO2 cols
fa.df <- fa.df[,-8]
  # Remove BinTime col
colnames(fa.df) <- c("AUC", "Number", "ID", "Season", "Sex", "Antibiotics", "Substrate")
  # Rename cols

for (i in 1:length(ids)){
  ID <- ids[i]
  select <- crds.auc[which(crds.auc$ID == ID),]
    # Dataframe with CRDS values for 1 squirrel

  # Normalize delta value to baseline
  select$Delta <- select$Delta - select$Delta[1]
  
  # Normalize RelTime to baseline
  select$RelTime <- select$RelTime - select$RelTime[1]
  
  if (i < 2){
      fa.df <- select
      # Creates initial dataframe with the first file
    } else {
      fa.df <- rbind(fa.df, select)
      # Appends onto the dataframe for all subsequent files
    }
}

fa.df <- fa.df[,-3:-4]
fa.df <- fa.df[,-4:-8]
#write.csv(fa.df, "crds.csv", row.names=F)


### Format AUC output
crds.fariba <- crds.auc
crds.fariba <- crds.fariba[,-3:-4]
crds.fariba <- crds.fariba[,-4:-8]
write.csv(crds.fariba, "crds.csv", row.names=F)
```


### Inulin MetaG Endo/Exo Total Protein
```{r}
### Import total Endo / Exo / Protein Counts
endoexo <- read.csv("eCAMI/endo_exo.csv", fileEncoding="UTF-8-BOM")
endoexo$Endo_RelAbund <- (endoexo$Endo / endoexo$Total_Protein)*100
endoexo$Exo_RelAbund <- (endoexo$Exo / endoexo$Total_Protein)*100
endoexo$Season <- c("Spring", "Spring", "Spring", "Summer", "Summer", "Summer", "Winter", "Winter", "Winter")
endoexo$Season <- ordered(endoexo$Season, levels=c("Summer", "Winter", "Spring"))

### Test Endo / Exo Rel Abund for Normality
hist(endoexo$Endo_RelAbund)
qqnorm(endoexo$Endo_RelAbund)
qqline(endoexo$Endo_RelAbund)
shapiro.test(endoexo$Endo_RelAbund)
  # p-value = 0.003571
  # Not Normal

hist(endoexo$Exo_RelAbund)
qqnorm(endoexo$Exo_RelAbund)
qqline(endoexo$Exo_RelAbund)
shapiro.test(endoexo$Exo_RelAbund)
  # p-value = 0.1865
  # Normal


### Test Endo
kruskal.test(formula = Endo_RelAbund ~ Season, data=endoexo)
  # p-value = 0.9481


### Test Exo
summary(aov(Exo_RelAbund ~ Season, data=endoexo))
  # p-value = 0.901


### Plot Endo
endo.plot <- ggplot(endoexo, aes(x=Season, y=Endo_RelAbund, fill=Season)) +
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_fill_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Endo-Inulinase") +
  ylab("Relative Abundance (%)") +
  scale_y_continuous(breaks=c(0.00, 0.0125, 0.025, 0.0375, 0.05), limits=c(0, 0.05)) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.text.x = element_text(size=14),
        axis.text.y = element_text(size=14),
        axis.title.x = element_text(size=20, margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y = element_text(size=20, margin=margin(t=0, r=10, b=0, l=0)),
        strip.text.x = element_text(size=20),
        #strip.text.y = element_text(size=14),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 18),
        legend.text = element_text(size=16),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
  )+
  guides(fill=F)

tiff("endo.mdtp.tiff", width = 5.5, height = 3.5, units = "in", res = 300)
endo.plot
dev.off()


### Plot Exo

legend <- g_legend(exo.plot)

exo.plot <- ggplot(endoexo, aes(x=Season, y=Exo_RelAbund, fill=Season)) +
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_fill_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Exo-Inulinase") +
  ylab("Relative Abundance (%)") +
  scale_y_continuous(breaks=c(0.00, 0.0125, 0.025, 0.0375, 0.05), limits=c(0, 0.05)) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.text.x = element_text(size=14),
        axis.text.y = element_text(size=14),
        axis.title.x = element_text(size=20, margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y = element_text(size=20, margin=margin(t=0, r=10, b=0, l=0)),
        strip.text.x = element_text(size=20),
        strip.text.y = element_text(size=14),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 18, face="bold"),
        legend.text = element_text(size=16),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
  ) +
  guides(fill=F)

tiff("exo.mdtp.tiff", width = 5.5, height = 3.5, units = "in", res = 300)
exo.plot
dev.off()



tiff("endo.exo.mdtp.tiff", width = 12.5, height = 3.5, units = "in", res = 300)
grid.newpage()
pushViewport(viewport(layout=(grid.layout(1,3, widths=c(1,1,0.25), heights=c(1,1,1)))))
print(endo.plot, vp=viewport(layout.pos.row=1, layout.pos.col=1))
print(exo.plot, vp=viewport(layout.pos.row=1, layout.pos.col=2))
legend$vp <- viewport(layout.pos.row=1, layout.pos.col=3)
grid.draw(legend)
dev.off()

```

### Inulin MetaG Exo Taxa Import
```{r}
### Import Data
exo.shared <- read.csv("eCAMI/exo.shared.csv", fileEncoding="UTF-8-BOM")
rownames(exo.shared) <- exo.shared$X
exo.shared <- exo.shared[,-1]
exo.tax <- read.csv("eCAMI/exo_tax.csv", fileEncoding="UTF-8-BOM")
rownames(exo.tax) <- exo.tax$Protein
exo.tax <- exo.tax[,-1]

### Make physeq object
exo.otu <- otu_table(t(exo.shared), taxa_are_rows=T)
exo.samp <- sample_data(endoexo)
exo.tax <- tax_table(exo.tax)
taxa_names(exo.tax) <- taxa_names(exo.otu)
colnames(exo.tax) <- c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species")
sample_names(exo.samp) <- sample_names(exo.otu)
exo.physeq <- merge_phyloseq(exo.otu, exo.samp, exo.tax)

### Combine at diff taxa levels
exo.gen <- tax_glom(exo.physeq, taxrank="Genus")
exo.fam <- tax_glom(exo.physeq, taxrank="Family")
exo.ord <- tax_glom(exo.physeq, taxrank="Order")
exo.cla <- tax_glom(exo.physeq, taxrank="Class")
```

### Inulin MetaG Exo Rel Abund
```{r}
# Calculate rel abund
exo.ra <- transform_sample_counts(exo.gen, function(x){(x/sum(x))*100})

# Create rank abundance plot
barplot(sort(taxa_sums(exo.ra),TRUE)[1:20]/nsamples(exo.ra),las=2,cex.axis=.7)

# Pull out top 10 genera
top10 <- as.data.frame(sort(taxa_sums(exo.ra),TRUE)[1:10]/nsamples(exo.ra))
exo.df <- psmelt(exo.ra)

exo.top <- exo.df[which(exo.df$OTU == rownames(top10)[1]),]
exo.top[10:18,] <- exo.df[which(exo.df$OTU == rownames(top10)[3]),]
exo.top[19:27,] <- exo.df[which(exo.df$OTU == rownames(top10)[5]),]
exo.top[28:36,] <- exo.df[which(exo.df$OTU == rownames(top10)[6]),]
exo.top[37:45,] <- exo.df[which(exo.df$OTU == rownames(top10)[7]),]
exo.top[46:54,] <- exo.df[which(exo.df$OTU == rownames(top10)[9]),]
exo.top$Genus <- ordered(exo.top$Genus, levels = c("Bacteroides", "Muribaculum", "Cohnella", "Prevotella", "Parabacteroides", "Asaia"))

# exo.top$Genus <- factor(c(rep("Bacteroides",9), rep("Unclassified",9), rep("Muribaculum",9),
#                           rep("Bacteria - Unclassified",9), rep("Cohnella", 9), rep("Prevotella", 9),
#                           rep("Parabacteroides",9), rep("Muribaculaceae - Unclassified",9),
#                           rep("Asaia", 9), rep("Clostridiales - Unclassified", 9)))


#Summarize data
exo.sum <- exo.top %>%
  group_by(Genus) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance),
            SE = se(Abundance))

### Plot
exo.gen.mdtp <- ggplot(exo.top, aes(x=Genus, y=Abundance, fill=Genus)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=3, stackratio=1.15) +
  facet_grid(Season~.) +
  ylab("Relative Abundance (%)") +
  ggtitle("Top 6 Genera") +
  scale_fill_manual(values=c("red2", "gold", "deepskyblue1","darkorchid1", "papayawhip", "gray12")) +
  ylim(0,30) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.title.x=element_text(size=18, 
                                  margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y=element_text(size=18),
        axis.text.x=element_text(size=14, angle=25, hjust=1),
        axis.text.y=element_text(size=14),
        plot.margin = unit(c(0, 0.3, 0.3, 0.3), "cm"),
          #top, right, bottom, left
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.text.y = element_text(size=14, face="bold"),
        strip.background = element_blank(),
        legend.title = element_text(size=15, face="bold"),
        legend.text=element_text(size=15),
        panel.spacing.y=unit(1,"lines")
  )

tiff("exo.genus.mdtp.tiff", width=8.45, height=6.2, units="in", res=600)
exo.gen.mdtp
dev.off()


### Make plot w/ top 6 genera + 2 unclassified
exo.top.unclass <- exo.df[which(exo.df$OTU == rownames(top10)[1]),]
exo.top.unclass[10:18,] <- exo.df[which(exo.df$OTU == rownames(top10)[2]),]
exo.top.unclass[19:27,] <- exo.df[which(exo.df$OTU == rownames(top10)[3]),]
exo.top.unclass[28:36,] <- exo.df[which(exo.df$OTU == rownames(top10)[4]),]
exo.top.unclass[37:45,] <- exo.df[which(exo.df$OTU == rownames(top10)[5]),]
exo.top.unclass[46:54,] <- exo.df[which(exo.df$OTU == rownames(top10)[6]),]
exo.top.unclass[55:63,] <- exo.df[which(exo.df$OTU == rownames(top10)[7]),]
exo.top.unclass[64:72,] <- exo.df[which(exo.df$OTU == rownames(top10)[9]),]
exo.top.unclass$Genus <- ordered(exo.top.unclass$Genus, levels = c("Bacteroides", "Muribaculum", "Cohnella", "Prevotella", "Parabacteroides", "Asaia", "Unclassified Domain", "Unclassified Bacteria"))
exo.top.unclass$Genus[10:18] <- "Unclassified Domain"
exo.top.unclass$Genus[28:36] <- "Unclassified Bacteria"



#Summarize data
exo.unclass.sum <- exo.top.unclass %>%
  group_by(Genus) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance),
            SE = se(Abundance))

### Plot
exo.gen.unclass.mdtp <- ggplot(exo.top.unclass, aes(x=Genus, y=Abundance, fill=Genus)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=3, stackratio=1.15) +
  facet_grid(Season~.) +
  ylab("Relative Abundance (%)") +
  ggtitle("Top 6 Genera + Unclassified") +
  scale_fill_manual(values=c("red2", "gold", "deepskyblue1","darkorchid1", "papayawhip", "gray12", "gray47", "gray86")) +
  ylim(0,30) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.title.x=element_text(size=18, 
                                  margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y=element_text(size=18),
        axis.text.x=element_text(size=14, angle=25, hjust=1),
        axis.text.y=element_text(size=14),
        plot.margin = unit(c(0, 0.3, 0.3, 0.3), "cm"),
          #top, right, bottom, left
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.text.y = element_text(size=14, face="bold"),
        strip.background = element_blank(),
        legend.title = element_text(size=15, face="bold"),
        legend.text=element_text(size=15),
        panel.spacing.y=unit(1,"lines")
  )

tiff("exo.genus.unclass.mdtp.tiff", width=10.55, height=6.2, units="in", res=600)
exo.gen.unclass.mdtp
dev.off()

```

### Inulin MetaG Exo NMDS
```{r}
### Bray-Curtis NMDS
exo.nmds <- ordinate(physeq=exo.physeq, method="NMDS", distance="bray")
  # stress = 0.1096339

tiff("exo.nmds.mdtp.tiff", width=8, height=6, units="in", res=600)
plot_ordination(physeq=exo.physeq, ordination=exo.nmds, color="Season") + 
  scale_color_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  geom_path(data=exo.physeq.elip.df, aes(x=NMDS1, y=NMDS2, colour=group), size=1, linetype=1) +
  ggtitle("Exo-Inulinase") +
  geom_point(size=3) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.text.x = element_text(size=20),
        axis.text.y = element_text(size=20),
        axis.title.x = element_text(size=20),
        axis.title.y = element_text(size=20),
        legend.title = element_text(size=20, face="bold"),
        legend.text = element_text(size=20),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
        )
dev.off()


### NMDS Ellipses
sample_data(exo.physeq)$Elip <- paste(sample_data(exo.physeq)$Season)
exo.physeq.elip <- data.frame(MDS1 = exo.nmds$points[,1], MDS2 = exo.nmds$points[,2],
                           Group = sample_data(exo.physeq)$Season)
plot.new()
exo.physeq.elip.ord <- ordiellipse(exo.nmds, sample_data(exo.physeq)$Elip, display="sites", kind="se", conf=0.95, label=T)
exo.physeq.elip.df <- data.frame()
for(i in levels(exo.physeq.elip$Group)){
  exo.physeq.elip.df <- rbind(exo.physeq.elip.df,
                           cbind(as.data.frame(with(exo.physeq.elip[exo.physeq.elip$Group==i,],
                                                    veganCovEllipse(exo.physeq.elip.ord[[i]]$cov,
                                                                    exo.physeq.elip.ord[[i]]$center,
                                                                    exo.physeq.elip.ord[[i]]$scale))), group=i
                                 ))
}

### Bray-Curtis PCoA
exo.pcoa <- ordinate(physeq=exo.physeq, method="PCoA", distance="bray")

plot_ordination(physeq=exo.physeq, ordination=exo.pcoa, color="Season") + 
  scale_color_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"))



### PERMANOVA for NMDS
exo.physeq.sampdf <- data.frame(sample_data(exo.physeq))
exo.bray<- phyloseq::distance(physeq=exo.physeq, method="bray")

## Season
adonis(exo.bray~ Season, data=exo.physeq.sampdf)
  # p-value = 0.902
beta.tax = betadisper(d=exo.bray, group=exo.physeq.sampdf$Season)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.604




# ### Import data
# P01 <- read.csv("eCAMI/P01_counts.csv", fileEncoding="UTF-8-BOM")
# P07 <- read.csv("eCAMI/P07_counts.csv", fileEncoding="UTF-8-BOM")
# P11 <- read.csv("eCAMI/P11_counts.csv", fileEncoding="UTF-8-BOM")
# S07 <- read.csv("eCAMI/S07_counts.csv", fileEncoding="UTF-8-BOM")
# S29 <- read.csv("eCAMI/S29_counts.csv", fileEncoding="UTF-8-BOM")
# S34 <- read.csv("eCAMI/S34_counts.csv", fileEncoding="UTF-8-BOM")
# W31 <- read.csv("eCAMI/W31_counts.csv", fileEncoding="UTF-8-BOM")
# W32 <- read.csv("eCAMI/W32_counts.csv", fileEncoding="UTF-8-BOM")
# W33 <- read.csv("eCAMI/W33_counts.csv", fileEncoding="UTF-8-BOM")
# 
# ### Remove endo rows
# P07 <- P07[-1,]
# S07 <- S07[-1,]
# S34 <- S34[-1,]
# W33 <- W33[-1,]



```
