---
title: "Code"
author: "Edna Chiang"
date: "February 5, 2018"
output: html_document
---

### Load Packages, scripts, and functions
```{r}
library(ggplot2)
library(dplyr)
library(grid)
library(MESS)
library(pgirmess)
library(Bolstad2)
library(phyloseq)
library(miLineage)
library(psych)
source('scripts/import_crds.R')
source('scripts/import_crds_sep.R')
source('scripts/bin_crds.R')
source('scripts/misc.R')
set.seed(1)
theme_set(theme_bw())

### Stats Notes
# Use 'subset' in kruskal.test
# Do NOT use 'subset' in kruskalmc or pairwise.wilcox.test; it doesn't work!
```

### Load Data
```{r}
crds <- import.crds('CSV', 'metadata.csv')
crds.all <- import.crds.sep('CSV', 'metadata.csv')
```

### Bin RelTime
```{r}
crds.bin <- bin.crds(crds)
```

### Summarize by Substrate + ABX
```{r}
# Remove NA's (gavage time)
rem <- which(is.na(crds.bin$Delta))
crds.rem <- crds.bin[-rem,]

# Remove 3982 because it may be incorrectly labeled
crds.rem <- crds.rem[-which(crds.rem$Number == 3982),]
crds.rem$ID <- droplevels(crds.rem$ID)
crds.rem$Season <- ordered(crds.rem$Season, levels=c("Summer", "Winter", "Spring"))



# Summarize
crds.sum <- crds.rem %>%
  group_by(Substrate, Antibiotics, Season, BinTime) %>%
  summarize(Mean = mean(Delta),
            Median = median(Delta),
            SD = sd(Delta),
            SE = se(Delta),
            iqr = IQR(Delta))
crds.sum$Season <- ordered(crds.sum$Season, levels=c("Summer", "Winter", "Spring"))
```

### Separate by substrate
```{r}
inu.all <- crds.sum[which(crds.sum$Substrate == "Inulin"),]

man.all <- crds.sum[which(crds.sum$Substrate == "Mannitol"),]

sal.all <- crds.sum[which(crds.sum$Substrate == "Saline"),]

ure.all <- crds.sum[which(crds.sum$Substrate == "Urea"),]
```

### Calculate AUC
```{r}
# AUC = Area Under Curve
# https://stackoverflow.com/questions/4954507/calculate-the-area-under-a-curve

### Remove unwanted substrates
crds.auc <- crds.rem[-which(crds.rem$Substrate == "Urea"),]
crds.auc <- crds.auc[-which(crds.auc$Substrate == "Acetate"),]
crds.auc$Substrate <- droplevels(crds.auc$Substrate)
crds.auc$ID <- droplevels(crds.auc$ID)

### Calculate AUC
ids <- levels(crds.auc$ID)
auc.df <- data.frame(crds.auc[1,])
auc.df <- auc.df[,-2:-3]
auc.df <- auc.df[,-8]
colnames(auc.df) <- c("AUC", "Number", "ID", "Season", "Sex", "Antibiotics", "Substrate")
for(i in 1:length(ids)){
  ID <- ids[i]
  select <- crds.auc[which(crds.auc$ID == ID),]
  baseline <- which(select$RelTime < 0)
  baseline.reltime <- mean(select$RelTime[baseline])
  baseline.delta <- mean(select$Delta[baseline])
  baseline.co2 <- mean(select$CO2[baseline])
  baseline.bintime <- mean(select$BinTime[baseline])
  select.norm <- data.frame(RelTime=baseline.reltime, Delta=0, CO2=baseline.co2,
                            Number=select$Number[1], ID=select$ID[1], Season=select$Season[1],
                            Sex=select$Sex[1], Antibiotics=select$Antibiotics[1],
                            Substrate=select$Substrate[1], BinTime=baseline.bintime)
    # Delta = 0 because we want to normalize everything to baseline. Any neg Deltas will decrease the AUC (subtracted from AUC), which is not what we want.
  exp <- which(select$RelTime>0)
  for(j in 1:(nrow(select)-length(baseline))){
    select.norm[j+1,] <- select[exp[j],]
  }
  select.norm[2:nrow(select.norm),2] <- (select.norm[2:nrow(select.norm),2]-baseline.delta)
  x <- select.norm$RelTime
  y <- select.norm$Delta
  AUC <- auc(x, y, type = 'spline')
  auc.df[i,1] <- AUC
  auc.df[i,2:7] <- select.norm[1,4:9]
}

### Subset by Substrate & ABX
auc.inu <- auc.df[which(auc.df$Substrate == "Inulin"),]
auc.man <- auc.df[which(auc.df$Substrate == "Mannitol"),]
auc.sal <- auc.df[which(auc.df$Substrate == "Saline"),]
auc.abx <- auc.df[which(auc.df$Antibiotics == "Yes"),]
auc.noabx <- auc.df[which(auc.df$Antibiotics == "No"),]
auc.inu.abx <- auc.inu[which(auc.inu$Antibiotics == "Yes"),]
auc.inu.noabx <- auc.inu[which(auc.inu$Antibiotics == "No"),]
auc.man.abx <- auc.man[which(auc.man$Antibiotics == "Yes"),]
auc.man.noabx <- auc.man[which(auc.man$Antibiotics == "No"),]
auc.sal.abx <- auc.sal[which(auc.sal$Antibiotics == "Yes"),]
auc.sal.noabx <- auc.sal[which(auc.sal$Antibiotics == "No"),]
```


### Calculate AUC after 2 h
```{r}
### Calculate AUC
ids <- levels(crds.auc$ID)
auc.beg.df <- data.frame(crds.auc[1,])
auc.beg.df <- auc.beg.df[,-2:-3]
auc.beg.df <- auc.beg.df[,-8]
colnames(auc.beg.df) <- c("AUC", "Number", "ID", "Season", "Sex", "Antibiotics", "Substrate")
auc.end.df <- data.frame(crds.auc[1,])
auc.end.df <- auc.end.df[,-2:-3]
auc.end.df <- auc.end.df[,-8]
colnames(auc.end.df) <- c("AUC", "Number", "ID", "Season", "Sex", "Antibiotics", "Substrate")
for(i in 1:length(ids)){
  ID <- ids[i]
  select <- crds.auc[which(crds.auc$ID == ID),]
  baseline <- which(select$RelTime < 0)
  baseline.reltime <- mean(select$RelTime[baseline])
  baseline.delta <- mean(select$Delta[baseline])
  baseline.co2 <- mean(select$CO2[baseline])
  baseline.bintime <- mean(select$BinTime[baseline])
  select.norm <- data.frame(RelTime=baseline.reltime, Delta=0, CO2=baseline.co2,
                            Number=select$Number[1], ID=select$ID[1], Season=select$Season[1],
                            Sex=select$Sex[1], Antibiotics=select$Antibiotics[1],
                            Substrate=select$Substrate[1], BinTime=baseline.bintime)
    # Delta = 0 because we want to normalize everything to baseline. Any neg Deltas will decrease the AUC (subtracted from AUC), which is not what we want.
  exp <- which(select$RelTime>0)
  for(j in 1:(nrow(select)-length(baseline))){
    select.norm[j+1,] <- select[exp[j],]
  }
  select.norm[2:nrow(select.norm),2] <- (select.norm[2:nrow(select.norm),2]-baseline.delta)
  x <- select.norm$RelTime
  y <- select.norm$Delta
  x2 <- x[which(x > 2)]
  y2 <- y[which(x > 2)]
  x3 <- x[which(x < 2)]
  y3 <- y[which(x < 2)]
  AUC <- auc(x2, y2, type = 'spline')
  auc.end.df[i,1] <- AUC
  auc.end.df[i,2:7] <- select.norm[1,4:9]
  AUC <- auc(x3, y3, type = 'spline')
  auc.beg.df[i,1] <- AUC
  auc.beg.df[i, 2:7] <- select.norm[1,4:9]
}




### Check Normality
hist(auc.beg.df$AUC)
qqnorm(auc.beg.df$AUC)
qqline(auc.beg.df$AUC)
shapiro.test(auc.beg.df$AUC)
  # p-value = 2.864e-14

### Boxplots
ggplot(auc.beg.df, aes(x=Season, y=AUC, fill=Season)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() +
  facet_grid(Antibiotics~Substrate)


### Separate
auc.inu.beg <- auc.beg.df[which(auc.beg.df$Substrate == "Inulin"),]
auc.inu.beg.abx <- auc.inu.beg[which(auc.inu.beg$Antibiotics == "Yes"),]
auc.inu.beg.noabx <- auc.inu.beg[which(auc.inu.beg$Antibiotics == "No"),]


# Inulin
wilcox.test(AUC~Antibiotics, data=auc.inu.beg)
  # p-value = 2.845e-06
kruskal.test(formula = AUC ~ Season, data=auc.inu.beg.abx)
  # p-value = 0.02828
kruskal.test(formula = AUC ~ Season, data=auc.inu.beg.noabx)
  # p-value = 0.03087
kruskalmc(resp = AUC ~ Season, data=auc.inu.beg.noabx)
  # Spring-Winter
pairwise.wilcox.test(auc.inu.beg.noabx$AUC, auc.inu.beg.noabx$Season)
  # Summer-Spring = 0.298
  # Winter-Spring = 0.024
  # Summer-Winter = 0.298
```

### Test Delta & Rel Time
```{r}
### Separate
crds.rem.inu.noabx <- crds.rem[which(crds.rem$Substrate == "Inulin"),]
crds.rem.inu.noabx <- crds.rem.inu.noabx[which(crds.rem.inu.noabx$Antibiotics == "No"),]
inu.beg <- crds.rem.inu.noabx[which(crds.rem.inu.noabx$RelTime < 1),]
inu.end <- crds.rem.inu.noabx[which(crds.rem.inu.noabx$RelTime > 1),]


### Test normality
hist(inu.beg$Delta)
qqnorm(inu.beg$Delta)
qqline(inu.beg$Delta)
shapiro.test(inu.beg$Delta)
  # p-value = 1.828e-13


### Test
kruskal.test(formula = Delta ~ ID, data=inu.beg)
  # p-value = 0.8875
kruskal.test(formula = Delta ~ RelTime, data=inu.beg)
  # p-value = 0.0201
kruskal.test(formula = Delta ~ Season, data=inu.beg)
  # p-value = 0.03685
kruskalmc(resp = Delta ~ Season, data=inu.beg)
  # Summer-Winter

```


### Calculate Max Delta Change & RelTime Peak
```{r}
### Remove unwanted substrates
crds.max <- crds.rem[-which(crds.rem$Substrate == "Urea"),]
crds.max <- crds.max[-which(crds.max$Substrate == "Acetate"),]
crds.max$Substrate <- droplevels(crds.max$Substrate)
crds.max$ID <- droplevels(crds.max$ID)

### Pull out max delta value
ids <- levels(crds.max$ID)
max.df <- data.frame(crds.max[1,])
max.df <- max.df[,-3]
max.df <- max.df[,-9]
for(i in 1:length(ids)){
  ID <- ids[i]  
  select <- crds.max[which(crds.max$ID == ID),]
  baseline <- which(select$RelTime < 0)
  baseline.delta <- mean(select$Delta[baseline])
  Max <- (max(select$Delta)-baseline.delta)
  Max.time <- select$RelTime[which(select$Delta == max(select$Delta))]
  max.df[i,1:3] <- c(Max.time, Max, select$Number[1])
  max.df[i, 4] <- as.character(select$ID[1])
  max.df[i, 5] <- as.character(select$Season[1])
  max.df[i, 6] <- as.character(select$Sex[1])
  max.df[i, 7] <- as.character(select$Antibiotics[1])
  max.df[i, 8] <- as.character(select$Substrate[1])
}




### Subset by Substrate & ABX
max.inu <- max.df[which(max.df$Substrate == "Inulin"),]
max.man <- max.df[which(max.df$Substrate == "Mannitol"),]
max.sal <- max.df[which(max.df$Substrate == "Saline"),]
max.abx <- max.df[which(max.df$Antibiotics == "Yes"),]
max.noabx <- max.df[which(max.df$Antibiotics == "No"),]
max.inu.abx <- max.inu[which(max.inu$Antibiotics == "Yes"),]
max.inu.noabx <- max.inu[which(max.inu$Antibiotics == "No"),]
max.man.abx <- max.man[which(max.man$Antibiotics == "Yes"),]
max.man.noabx <- max.man[which(max.man$Antibiotics == "No"),]
max.sal.abx <- max.sal[which(max.sal$Antibiotics == "Yes"),]
max.sal.noabx <- max.sal[which(max.sal$Antibiotics == "No"),]
```

### Separate by substrate & ABX (individuals)
```{r}
### Separate by Substrate
inu.ind <- crds.rem[which(crds.rem$Substrate == "Inulin"),]
man.ind <- crds.rem[which(crds.rem$Substrate == "Mannitol"),]
sal.ind <- crds.rem[which(crds.rem$Substrate == "Saline"),]

### Separate by Substrate & ABX
inu.noabx.ind <- inu.ind[which(inu.ind$Antibiotics == "No"),]
inu.abx.ind <- inu.ind[which(inu.ind$Antibiotics == "Yes"),]
man.noabx.ind <- man.ind[which(man.ind$Antibiotics == "No"),]
man.abx.ind <- man.ind[which(man.ind$Antibiotics == "Yes"),]
sal.noabx.ind <- sal.ind[which(sal.ind$Antibiotics == "No"),]
sal.abx.ind <- sal.ind[which(sal.ind$Antibiotics == "Yes"),]


### Separate by Substrate & ABX & Season
inu.noabx.sum.ind <- inu.noabx.ind[which(inu.noabx.ind$Season == "Summer"),]
inu.noabx.win.ind <- inu.noabx.ind[which(inu.noabx.ind$Season == "Winter"),]
inu.noabx.spr.ind <- inu.noabx.ind[which(inu.noabx.ind$Season == "Spring"),]
man.noabx.sum.ind <- man.noabx.ind[which(man.noabx.ind$Season == "Summer"),]
man.noabx.win.ind <- man.noabx.ind[which(man.noabx.ind$Season == "Winter"),]
man.noabx.spr.ind <- man.noabx.ind[which(man.noabx.ind$Season == "Spring"),]
sal.noabx.sum.ind <- sal.noabx.ind[which(sal.noabx.ind$Season == "Summer"),]
sal.noabx.win.ind <- sal.noabx.ind[which(sal.noabx.ind$Season == "Winter"),]
sal.noabx.spr.ind <- sal.noabx.ind[which(sal.noabx.ind$Season == "Spring"),]

```


### Plot individuals (explore)
```{r}
ggplot(inu.ind, aes(x=BinTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point() +
  facet_grid(Antibiotics~Season)

ggplot(inu.ind, aes(x=BinTime, y=Delta, color=Season)) +
  geom_line() +
  geom_point() +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  facet_grid(Antibiotics~Season)

ggplot(inu.noabx.sum.ind, aes(x=BinTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point()

ggplot(inu.noabx.win.ind, aes(x=BinTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point()

ggplot(inu.noabx.spr.ind, aes(x=BinTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point()







ggplot(man.ind, aes(x=BinTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point() +
  facet_grid(Antibiotics~Season)


ggplot(man.ind, aes(x=BinTime, y=Delta, color=Season)) +
  geom_line() +
  geom_point() +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  facet_grid(Antibiotics~Season)






ggplot(sal.ind, aes(x=BinTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point() +
  facet_grid(Antibiotics~Season)


ggplot(sal.ind, aes(x=BinTime, y=Delta, color=Season)) +
  geom_line() +
  geom_point() +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  facet_grid(Antibiotics~Season)


```


### Plot
```{r}
## All individuals
ggplot(crds.bin, aes(x=BinTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point()

## Substrate/ABX
ggplot(crds.sum, aes(x=BinTime, y=Mean, color=Substrate)) +
  geom_line(aes(linetype=Antibiotics)) +
  geom_point() +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE))

## Inulin
inu.plot <- ggplot(inu.all, aes(x=BinTime, y=Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
   geom_point(size=3, shape=21, aes(color=Season, fill=factor(ifelse(Antibiotics == "Yes", NA, Season)))) +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"), na.value="white", guide="none") +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE), width=0.125, position=position_dodge(0.1)) +
  ggtitle(expression("Inulin"~~delta^13~"C")) +
  xlab("Time Since Gavage") +
  ylab(expression("Mean"~~delta^13~"C"))+
  theme(plot.title=element_text(hjust=0.5, size=12),
        axis.title.x=element_text(size=12),
        axis.title.y=element_text(size=12)) +
  guides(colour=F, linetype=F)

## Mannitol
man.plot <- ggplot(man.all, aes(x=BinTime, y=Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
  geom_point(size=3, shape=21, aes(color=Season, fill=factor(ifelse(Antibiotics == "Yes", NA, Season)))) +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"), na.value="white", guide="none") +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE), width=0.125, position=position_dodge(0.1)) +
  ggtitle(expression("Mannitol"~~delta^13~"C")) +
  xlab("Time Since Gavage") +
  ylab(expression("Mean"~~delta^13~"C"))+
  theme(plot.title=element_text(hjust=0.5, size=12),
        axis.title.x=element_text(size=12),
        axis.title.y=element_text(size=12)) +
  guides(colour=F, linetype=F)

## Saline
sal.plot <- ggplot(sal.all, aes(x=BinTime, y=Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
  geom_point(size=3, shape=21, aes(color=Season, fill=factor(ifelse(Antibiotics == "Yes", NA, Season)))) +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"), na.value="white", guide="none") +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE), width=0.125, position=position_dodge(0.1)) +
  ggtitle(expression("Saline"~~delta^13~"C")) +
  xlab("Time Since Gavage") +
  ylab(expression("Mean"~~delta^13~"C"))+
  theme(plot.title=element_text(hjust=0.5, size=12),
        axis.title.x=element_text(size=12),
        axis.title.y=element_text(size=12)) +
  guides(colour=F, linetype=F)

## Urea
ure.plot <- ggplot(ure.all, aes(x=BinTime, y=Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
  geom_point(size=3, shape=21, aes(color=Season, fill=factor(ifelse(Antibiotics == "Yes", NA, Season)))) +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"), na.value="white", guide="none") +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE), width=0.125, position=position_dodge(0.1)) +
  ggtitle(expression("Urea"~~delta^13~"C")) +
  xlab("Time Since Gavage") +
  ylab(expression("Mean"~~delta^13~"C"))+
  theme(plot.title=element_text(hjust=0.5)) #+
  #guides(colour=F, linetype=F)

## Steal legend
steal.legend <- ggplot(sal.all, aes(x=BinTime, y=Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
  geom_point(size=3) +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE), width=0.125, position=position_dodge(0.1)) +
  ggtitle(expression("Saline"~~delta^13~"C")) +
  xlab("Time Since Gavage") +
  ylab(expression("Mean"~~delta^13~"C"))+
  theme(plot.title=element_text(hjust=0.5))
legend <- g_legend(steal.legend)
```



### Poster Plots
```{r}
tiff("prelim.fig3.tiff", width = 9, height = 3.5, units = "in", res = 300)
grid.newpage()
pushViewport(viewport(layout=(grid.layout(1,4, widths=c(1,1,1,0.4), heights=c(1,1,1,1)))))
print(inu.plot, vp=viewport(layout.pos.row=1, layout.pos.col=1))
print(man.plot, vp=viewport(layout.pos.row=1, layout.pos.col=2))
print(sal.plot, vp=viewport(layout.pos.row=1, layout.pos.col=3))
legend$vp <- viewport(layout.pos.row=1, layout.pos.col=4)
grid.draw(legend)
dev.off()


tiff("crds.mdtp.tiff", width = 12, height = 3.5, units = "in", res = 300)
grid.newpage()
pushViewport(viewport(layout=(grid.layout(1,4, widths=c(1,1,1,0.4), heights=c(1,1,1,1)))))
print(inu.plot, vp=viewport(layout.pos.row=1, layout.pos.col=1))
print(man.plot, vp=viewport(layout.pos.row=1, layout.pos.col=2))
print(sal.plot, vp=viewport(layout.pos.row=1, layout.pos.col=3))
legend$vp <- viewport(layout.pos.row=1, layout.pos.col=4)
grid.draw(legend)
dev.off()
```



### Inulin Plots
```{r}
## All individuals
inu.ind <- crds.rem[which(crds.rem$Substrate == "Inulin"),]
ggplot(inu.ind, aes(x=BinTime, y=Delta, color=Season)) +
  geom_line(aes(linetype=ABX)) +
  geom_point() +
  scale_color_manual(name="Season", values=c("red", "Blue"))

## Summer
inu.sum <- crds.rem[which(crds.rem$Substrate == "Inulin" & crds.rem$Season == "Summer"),]
ggplot(inu.sum, aes(x=BinTime, y=Delta, color=ABX)) +
  geom_line(aes(linetype=ABX)) +
  geom_point() +
  scale_color_manual(name="ABX", values=c("red", "Blue"))

## Summer ABX
inu.sum.abx <- crds.rem[which(crds.rem$Substrate == "Inulin" & crds.rem$Season == "Summer" & crds.rem$ABX == "Yes"),]
ggplot(inu.sum.abx, aes(x=BinTime, y=Delta, color=ID)) +
  geom_line(aes(linetype=ABX)) +
  geom_point()
  # 3982 is an outlier -- is it actually ABX?
  # Until confirmed, remove from data
```






### AUC
```{r}
### Check Normality
hist(auc.df$AUC)
qqnorm(auc.df$AUC)
qqline(auc.df$AUC)
shapiro.test(auc.df$AUC)
  # p-value = 5.601e-15
  # Not Normal

hist(auc.inu$AUC)
qqnorm(auc.inu$AUC)
qqline(auc.inu$AUC)
shapiro.test(auc.inu$AUC)
  # p-value = 0.0002643
  # Not Normal

hist(auc.man$AUC)
qqnorm(auc.man$AUC)
qqline(auc.man$AUC)
shapiro.test(auc.man$AUC)
  # p-value = 1.582e-08
  # Not Normal

hist(auc.sal$AUC)
qqnorm(auc.sal$AUC)
qqline(auc.sal$AUC)
shapiro.test(auc.sal$AUC)
  # p-value = 4.957e-05
  # Not Normal

hist(auc.abx$AUC)
qqnorm(auc.abx$AUC)
qqline(auc.abx$AUC)
shapiro.test(auc.abx$AUC)
  # p-value = 3.16e-08
  # Not Normal

hist(auc.noabx$AUC)
qqnorm(auc.noabx$AUC)
qqline(auc.noabx$AUC)
shapiro.test(auc.noabx$AUC)
  # p-value = 2.481e-09
  # Not Normal



### Boxplots
ggplot(auc.df, aes(x=Season, y=AUC, fill=Season)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() +
  facet_grid(Antibiotics~Substrate)
ggplot(auc.df, aes(x=Season, y=AUC, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Substrate) 
ggplot(auc.inu, aes(x=Season, y=AUC, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point()
ggplot(auc.man, aes(x=Season, y=AUC, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point()
ggplot(auc.sal, aes(x=Season, y=AUC, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point()



### Kruskal-Wallis
wilcox.test(AUC~Antibiotics, data=auc.df)
  # p-value = 0.0008937
kruskal.test(formula = AUC ~ Substrate, data=auc.abx)
  # p-value = 8.831e-07
kruskalmc(resp = AUC ~ Substrate, data=auc.abx)
  # Inulin-Mannitol
  # Inulin-Saline
  # Mannitol-Saline
kruskal.test(formula = AUC ~ Season, data=auc.abx)
  # p-value = 0.1231
wilcox.test(AUC~Sex, data=auc.df)
  # p-value = 0.3964

# Inulin
wilcox.test(AUC~Antibiotics, data=auc.inu)
  # p-value = 0.0001171
kruskal.test(formula = AUC ~ Season, data=auc.inu.abx)
  # p-value = 0.9168
kruskal.test(formula = AUC ~ Season, data=auc.inu.noabx)
  # p-value = 0.09011
kruskalmc(resp = AUC ~ Season, data=auc.inu.noabx)
pairwise.wilcox.test(auc.inu.noabx$AUC, auc.inu.noabx$Season)
  # Summer-Spring = 0.30
  # Winter-Spring = 0.29
  # Summer-Winter = 0.30

# Mannitol
wilcox.test(AUC~Antibiotics, data=auc.man)
  # p-value = 7.173e-05
kruskal.test(formula = AUC ~ Season, data=auc.man.abx)
  # p-value = 0.8836
kruskal.test(formula = AUC ~ Season, data=auc.man.noabx)
  # p-value = 0.2792
kruskalmc(resp = AUC ~ Season, data=auc.man.noabx)
pairwise.wilcox.test(auc.man.noabx$AUC, auc.man.noabx$Season)
  # Summer-Spring = 1.0
  # Winter-Spring = 1.0
  # Summer-Winter = 0.30


# Saline
wilcox.test(AUC~Antibiotics, data=auc.sal)
  # p-value = 0.0001171
kruskal.test(formula = AUC ~ Season, data=auc.sal.abx)
  # p-value = 0.06287
kruskal.test(formula = AUC ~ Season, data=auc.sal.noabx)
  # p-value = 0.6906




### Kruskal-Wallis BH-adjusted p-values
# Within-substrate ABX wilcoxon test
p.adjust(c(0.0001171, 7.173e-05, 0.0001171), method="BH")
  # Inulin = 0.0001171
  # Mannitol = 0.0001171
  # Saline = 0.0001171
# Within-substrate season kruskal-wallis test
p.adjust(c(0.9168, 0.09011, 0.8836, 0.2792, 0.06287, 0.6906), method="BH")
  # Inulin ABX = 0.91680
  # Inulin No ABX = 0.27033
  # Mannitol ABX = 0.91680
  # Mannitol No ABX = 0.55840
  # Saline ABX = 0.27033
  # Saline No ABX = 0.91680









### Summarize
auc.sum <- auc.df %>%
  group_by(Substrate, Antibiotics, Season) %>%
  summarize(Mean = mean(AUC),
            Median = median(AUC),
            SD = sd(AUC),
            SE = se(AUC),
            iqr = IQR(AUC))
auc.sum$Season <- ordered(auc.sum$Season, levels=c("Summer", "Winter", "Spring"))


```



### AUC 2
```{r}
# https://stackoverflow.com/questions/4954507/calculate-the-area-under-a-curve

### Remove unwanted substrates
crds.auc <- crds.rem[-which(crds.rem$Substrate == "Urea"),]
crds.auc <- crds.auc[-which(crds.auc$Substrate == "Acetate"),]
crds.auc$Substrate <- droplevels(crds.auc$Substrate)
crds.auc$ID <- droplevels(crds.auc$ID)

### Calculate AUC 2
ids <- levels(crds.auc$ID)
auc2.df <- data.frame(crds.auc[1,])
auc2.df <- auc2.df[,-2:-3]
auc2.df <- auc2.df[,-8]
colnames(auc2.df) <- c("AUC", "Number", "ID", "Season", "Sex", "Antibiotics", "Substrate")
for(i in 1:length(ids)){
  ID <- ids[i]
  print(ID)
  select <- crds.auc[which(crds.auc$ID == ID),]
  baseline <- which(select$RelTime < 0)
  baseline.reltime <- mean(select$RelTime[baseline])
  baseline.delta <- mean(select$Delta[baseline])
  baseline.co2 <- mean(select$CO2[baseline])
  baseline.bintime <- mean(select$BinTime[baseline])
  select.norm <- data.frame(RelTime=baseline.reltime, Delta=0, CO2=baseline.co2,
                            Number=select$Number[1], ID=select$ID[1], Season=select$Season[1],
                            Sex=select$Sex[1], Antibiotics=select$Antibiotics[1],
                            Substrate=select$Substrate[1], BinTime=baseline.bintime)
      # Delta = 0 because we want to normalize everything to baseline. Any neg Deltas will decrease the AUC (subtracted from AUC), which is not what we want.
  exp <- which(select$RelTime>0)
  for(j in 1:(nrow(select)-length(baseline))){
    select.norm[j+1,] <- select[exp[j],]
  }
  select.norm[2:nrow(select.norm),2] <- (select.norm[2:nrow(select.norm),2]-baseline.delta)
  x <- select.norm$RelTime
  y <- select.norm$Delta
  AUC <- sintegral(x,y)$int
  print(AUC)
  auc2.df[i,1] <- AUC
  auc2.df[i,2:7] <- select.norm[1,4:9]
}



### Compare AUC1 vs. AUC2
auc.comp <- auc.df
auc.comp[((nrow(auc.df)+1):(nrow(auc.df)+nrow(auc2.df))),] <- auc2.df
auc.comp$Test <- c(rep("Spline",88), rep("Simpson",88))
wilcox.test(AUC~Test, data=auc.comp)
  # p-value = 0.8003



### Subset by Substrate & ABX
auc2.inu <- auc2.df[which(auc2.df$Substrate == "Inulin"),]
auc2.man <- auc2.df[which(auc2.df$Substrate == "Mannitol"),]
auc2.sal <- auc2.df[which(auc2.df$Substrate == "Saline"),]
auc2.abx <- auc2.df[which(auc2.df$Antibiotics == "Yes"),]
auc2.noabx <- auc2.df[which(auc2.inu$Antibiotics == "No"),]
auc2.inu.abx <- auc2.inu[which(auc2.inu$Antibiotics == "Yes"),]
auc2.inu.noabx <- auc2.inu[which(auc2.inu$Antibiotics == "No"),]
auc2.man.abx <- auc2.man[which(auc2.man$Antibiotics == "Yes"),]
auc2.man.noabx <- auc2.man[which(auc2.man$Antibiotics == "No"),]
auc2.sal.abx <- auc2.sal[which(auc2.sal$Antibiotics == "Yes"),]
auc2.sal.noabx <- auc2.sal[which(auc2.sal$Antibiotics == "No"),]


### Check Normality
hist(auc2.df$AUC)
qqnorm(auc2.df$AUC)
qqline(auc2.df$AUC)
shapiro.test(auc2.df$AUC)
  # p-value = 6.356e-15
  # Not Normal

hist(auc2.inu$AUC)
qqnorm(auc2.inu$AUC)
qqline(auc2.inu$AUC)
shapiro.test(auc2.inu$AUC)
  # p-value = 0.0002609
  # Not Normal

hist(auc2.man$AUC)
qqnorm(auc2.man$AUC)
qqline(auc2.man$AUC)
shapiro.test(auc2.man$AUC)
  # p-value = 1.17e-08
  # Not Normal

hist(auc2.sal$AUC)
qqnorm(auc2.sal$AUC)
qqline(auc2.sal$AUC)
shapiro.test(auc2.sal$AUC)
  # p-value = 0.0001006
  # Not Normal

hist(auc2.abx$AUC)
qqnorm(auc2.abx$AUC)
qqline(auc2.abx$AUC)
shapiro.test(auc2.abx$AUC)
  # p-value = 3.136e-08
  # Not Normal

hist(auc2.noabx$AUC)
qqnorm(auc2.noabx$AUC)
qqline(auc2.noabx$AUC)
shapiro.test(auc2.noabx$AUC)
  # p-value = 2.767e-09
  # Not Normal



### Boxplots
ggplot(auc2.df, aes(x=Season, y=AUC, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Substrate) 
ggplot(auc2.inu, aes(x=Season, y=AUC, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point()
ggplot(auc2.man, aes(x=Season, y=AUC, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point()
ggplot(auc2.sal, aes(x=Season, y=AUC, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point()



### Kruskal-Wallis
wilcox.test(AUC~Antibiotics, data=auc2.df)
  # p-value = 0.001071
kruskal.test(formula = AUC ~ Substrate, data=auc2.abx)
  # p-value = 7.341e-07
kruskalmc(resp = AUC ~ Substrate, data=auc2.abx)
  # Inulin-Mannitol
  # Inulin-Saline
  # Mannitol-Saline
kruskal.test(formula = AUC ~ Season, data=auc2.abx)
  # p-value = 0.1093
wilcox.test(AUC~Sex, data=auc2.df)
  # p-value = 0.4494

# Inulin
wilcox.test(AUC~Antibiotics, data=auc2.inu)
  # p-value = 0.0001171
kruskal.test(formula = AUC ~ Season, data=auc2.inu.abx)
  # p-value = 0.9168
kruskal.test(formula = AUC ~ Season, data=auc2.inu.noabx)
  # p-value = 0.06794

# Mannitol
wilcox.test(AUC~Antibiotics, data=auc2.man)
  # p-value = 7.173e-05
kruskal.test(formula = AUC ~ Season, data=auc2.man.abx)
  # p-value = 0.7697
kruskal.test(formula = AUC ~ Season, data=auc2.man.noabx)
  # p-value = 0.2523

# Saline
wilcox.test(AUC~Antibiotics, data=auc2.sal)
  # p-value = 0.02334
kruskal.test(formula = AUC ~ Season, data=auc2.sal.abx)
  # p-value = 0.05411
kruskal.test(formula = AUC ~ Season, data=auc2.sal.noabx)
  # p-value = 0.07628




### Kruskal-Wallis BH-adjusted p-values
# Within-substrate ABX wilcoxon test
p.adjust(c(0.0001171, 7.173e-05, 0.02334), method="BH")
  # Inulin = 0.00017565
  # Mannitol = 0.00017565
  # Saline = 0.02334000
# Within-substrate season kruskal-wallis test
p.adjust(c(0.9168, 0.06794, 0.7697, 0.2523, 0.05411, 0.07628), method="BH")
  # Inulin ABX = 0.9168
  # Inulin No ABX = 0.15256
  # Mannitol ABX = 0.91680
  # Mannitol No ABX = 0.37845
  # Saline ABX = 0.15256
  # Saline No ABX = 0.15256
```




### Test Max Delta Change
```{r}
### Check Max Delta Normality
hist(max.df$Delta)
qqnorm(max.df$Delta)
qqline(max.df$Delta)
shapiro.test(max.df$Delta)
  # p-value = 4.088e-14
  # Not Normal

hist(max.inu$Delta)
qqnorm(max.inu$Delta)
qqline(max.inu$Delta)
shapiro.test(max.inu$Delta)
  # p-value = 0.0008221
  # Not Normal

hist(max.man$Delta)
qqnorm(max.man$Delta)
qqline(max.man$Delta)
shapiro.test(max.man$Delta)
  # p-value = 2.408e-07
  # Not Normal

hist(max.sal$Delta)
qqnorm(max.sal$Delta)
qqline(max.sal$Delta)
shapiro.test(max.sal$Delta)
  # p-value = 2.809e-08
  # Not Normal

hist(max.abx$Delta)
qqnorm(max.abx$Delta)
qqline(max.abx$Delta)
shapiro.test(max.abx$Delta)
  # p-value = 6.738e-08
  # Normal

hist(max.noabx$Delta)
qqnorm(max.noabx$Delta)
qqline(max.noabx$Delta)
shapiro.test(max.noabx$Delta)
  # p-value = 4.564e-08
  # Not Normal




### Boxplots
ggplot(max.df, aes(x=Season, y=Delta, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Substrate) 
ggplot(max.inu, aes(x=Season, y=Delta, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point()
ggplot(max.man, aes(x=Season, y=Delta, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point()
ggplot(max.sal, aes(x=Season, y=Delta, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point()




### Kruskal-Wallis
wilcox.test(Delta ~ Antibiotics, data=max.df)
  # p-value = 0.00107
kruskal.test(formula = Delta ~ Substrate, data=max.abx)
  # p-value = 6.25e-06
kruskalmc(resp = Delta ~ Substrate, data=max.abx)
  # Inulin-Mannitol
  # Inulin-Saline
kruskal.test(formula = Delta ~ Season, data=max.abx)
  # p-value = 0.04308
wilcox.test(Delta~Sex, data=max.inu)
  # p-value = 0.9807


# Inulin
wilcox.test(Delta~Antibiotics, data=max.inu)
  # p-value = 3.295e-05
kruskal.test(formula = Delta ~ Season, data=max.inu.abx)
  # p-value = 0.6015
kruskal.test(formula = Delta ~ Season, data=max.inu.noabx)
  # p-value = 0.005072
kruskalmc(resp = Delta ~ Season, data=max.inu.noabx)
  # Spring-Winter
  # Summer-Winter
pairwise.wilcox.test(max.inu.noabx$Delta, max.inu.noabx$Season)
  # Summer-Spring = 0.3434
  # Winter-Spring = 0.0159
  # Summer-Winter = 0.0076


# Mannitol
wilcox.test(Delta~Antibiotics, data=max.man)
  # p-value = 5.631e-05
kruskal.test(formula = Delta ~ Season, data=max.man.abx)
  # p-value = 0.3055
kruskal.test(formula = Delta ~ Season, data=max.man.noabx)
  # p-value = 0.2295


# Saline
wilcox.test(Delta~Antibiotics, data=max.sal)
  # p-value = 0.275
kruskal.test(formula = Delta ~ Season, data=max.sal.abx)
  # p-value = 0.2656
kruskal.test(formula = Delta ~ Season, data=max.sal.noabx)
  # p-value = 0.0335
kruskalmc(resp = Delta ~ Season, data=max.sal.noabx)
  # Summer-Winter
pairwise.wilcox.test(max.sal.noabx$Delta, max.sal.noabx$Season)
  # Summer-Spring = 0.093
  # Winter-Spring = 0.042
  # Summer-Winter = 0.945



### Kruskal-Wallis BH-adjusted p-values
# Within-substrate ABX wilcoxon test
p.adjust(c(3.295e-05, 5.631e-05, 0.275), method="BH")
  # Inulin = 8.4465e-05
  # Mannitol = 8.4465e-05
  # Saline = 0.275
# Within-substrate season kruskal-wallis test
p.adjust(c(0.6015, 0.005072, 0.3055, 0.2295, 0.2656, 0.0335), method="BH")
  # Inulin ABX = 0.601500
  # Inulin No ABX = 0.030432
  # Mannitol ABX = 0.366600
  # Mannitol No ABX = 0.366600
  # Saline ABX = 0.366600
  # Saline No ABX = 0.100500
```


### Test Max Peak Time
```{r}
### Check Max RelTime Normality
hist(max.df$RelTime)
qqnorm(max.df$RelTime)
qqline(max.df$RelTime)
shapiro.test(max.df$RelTime)
  # p-value = 0.1365
  # Normal

hist(max.inu$RelTime)
qqnorm(max.inu$RelTime)
qqline(max.inu$RelTime)
shapiro.test(max.inu$RelTime)
  # p-value = 0.002164
  # Not Normal

hist(max.man$RelTime)
qqnorm(max.man$RelTime)
qqline(max.man$RelTime)
shapiro.test(max.man$RelTime)
  # p-value = 0.002208
  # Not Normal

hist(max.sal$RelTime)
qqnorm(max.sal$RelTime)
qqline(max.sal$RelTime)
shapiro.test(max.sal$RelTime)
  # p-value = 0.003141
  # Not Normal

hist(max.abx$RelTime)
qqnorm(max.abx$RelTime)
qqline(max.abx$RelTime)
shapiro.test(max.abx$RelTime)
  # p-value = 0.4276
  # Normal

hist(max.noabx$RelTime)
qqnorm(max.noabx$RelTime)
qqline(max.noabx$RelTime)
shapiro.test(max.noabx$RelTime)
  # p-value = 0.003662
  # Not Normal




### Boxplots
ggplot(max.df, aes(x=Season, y=RelTime, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point() + 
  facet_grid(.~Substrate) 
ggplot(max.inu, aes(x=Season, y=RelTime, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point()
ggplot(max.man, aes(x=Season, y=RelTime, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point()
ggplot(max.sal, aes(x=Season, y=RelTime, fill = Antibiotics)) +
  geom_boxplot(position=position_dodge(1)) +
  geom_point()




### Kruskal-Wallis
t.test(RelTime ~ Antibiotics, data=max.df)
  # p-value = 0.0003384
summary(aov(RelTime ~ Substrate, data=max.abx))
  # p-value = 0.0262
TukeyHSD(aov(RelTime ~ Substrate, data=max.abx))
  # Mannitol-Inulin = 0.1685152
  # Saline-Inulin = 0.7582566
  # Saline-Mannitol = 0.02229182
summary(aov(RelTime ~ Season, data=max.abx))
  # p-value = 0.000141
TukeyHSD(aov(RelTime ~ Season, data=max.abx))
  # Summer-Spring = 0.7122043
  # Winter-Spring = 0.0080773
  # Winter-Summer = 0.0002553
t.test(RelTime ~ Sex, data=max.df)
  # p-value = 0.9617


# Inulin
wilcox.test(RelTime~Antibiotics, data=max.inu)
  # p-value = 3.295e-05
kruskal.test(formula = RelTime ~ Season, data=max.inu.abx)
  # p-value = 0.0472
pairwise.wilcox.test(max.inu.abx$RelTime, max.inu.abx$Season)
  # Summer-Winter = 0.056
kruskal.test(formula = RelTime ~ Season, data=max.inu.noabx)
  # p-value = 0.9413


# Mannitol
wilcox.test(RelTime~Antibiotics, data=max.man)
  # p-value = 0.009409
kruskal.test(formula = RelTime ~ Season, data=max.man.abx)
  # p-value = 0.01901
pairwise.wilcox.test(max.man.abx$RelTime, max.man.abx$Season)
  # Summer-Winter = 0.023
kruskal.test(formula = RelTime ~ Season, data=max.man.noabx)
  # p-value = 0.1658


# Saline
wilcox.test(RelTime~Antibiotics, data=max.sal)
  # p-value = 0.8582
kruskal.test(formula = RelTime ~ Season, data=max.sal.abx)
  # p-value = 0.0139
kruskalmc(resp = RelTime ~ Season, data=max.sal.abx)
  # Summer-Winter
pairwise.wilcox.test(max.sal.abx$RelTime, max.sal.abx$Season)
  # Summer-Spring = 0.383
  # Winter-Spring = 0.114
  # Summer-Winter = 0.018
kruskal.test(formula = RelTime ~ Season, data=max.sal.noabx)
  # p-value = 0.004845
kruskalmc(resp = RelTime ~ Season, data=max.sal.noabx)
  # Spring-Winter
pairwise.wilcox.test(max.sal.noabx$RelTime, max.sal.noabx$Season)
  # Summer-Spring = 0.109
  # Winter-Spring = 0.024
  # Summer-Winter = 0.024



### Kruskal-Wallis BH-adjusted p-values
# Within-substrate ABX wilcoxon test
p.adjust(c(3.295e-05, 0.009409, 0.8582), method="BH")
  # Inulin = 0.00009885
  # Mannitol = 0.01411350
  # Saline = 0.85820000
# Within-substrate season kruskal-wallis test
p.adjust(c(0.0472, 0.9413, 0.01901, 0.1658, 0.0139, 0.004845), method="BH")
  # Inulin ABX = 0.07080
  # Inulin No ABX = 0.94130
  # Mannitol ABX = 0.03802
  # Mannitol No ABX = 0.19896
  # Saline ABX = 0.03802
  # Saline No ABX = 0.02907
```

### Subset Summer
```{r}
sum.all <- crds.sum[which(crds.sum$Season == "Summer"),]
sum.all <- sum.all[which(sum.all$Substrate != "Acetate"),]
sum.all <- sum.all[which(sum.all$Substrate != "Butyrate"),]
sum.all <- sum.all[which(sum.all$Substrate != "Urea"),]


sum.inu <- sum.all[which(sum.all$Substrate == "Inulin"),]

sum.man <- sum.all[which(sum.all$Substrate == "Mannitol"),]

sum.sal <- sum.all[which(sum.all$Substrate == "Saline"),]

sum.abx <- sum.all[which(sum.all$Antibiotics == "Yes"),]
```

### Summer Correlate [DNA] & CRDS
```{r}
dna <- read.csv('dna.csv', fileEncoding="UTF-8-BOM")
auc.sum <- auc.df[which(auc.df$Season == "Summer"),]

# Pull out shared squirrels
both <- intersect(dna$Squirrel, auc.sum$ID)
dna.sum <- dna[1,]
dna.sum$AUC <- NA
dna.sum$MaxDelta <- NA
dna.sum$PeakTime <- NA
for(i in 1:length(both)){
  ID <- both[i]
  dna.sum[i,1:ncol(dna)] <- dna[which(dna$Squirrel == ID),]
  dna.sum[i,(ncol(dna)+1)] <- auc.df$AUC[which(auc.df$ID == ID)]
  dna.sum[i,(ncol(dna)+2)] <- max.df$Delta[which(max.df$ID == ID)]
  dna.sum[i,(ncol(dna)+3)] <- max.df$RelTime[which(max.df$ID == ID)]
}



# Model = Water Consumption --> DNA Yield --> CRDS



### Test Normality
hist(dna.sum$DNA_Yield)
qqnorm(dna.sum$DNA_Yield)
qqline(dna.sum$DNA_Yield)
shapiro.test(dna.sum$DNA_Yield)
  # p-value = 0.0007067
  # Not Normal

hist(dna.sum$AUC)
qqnorm(dna.sum$AUC)
qqline(dna.sum$AUC)
shapiro.test(dna.sum$AUC)
  # p-value = 1.321e-06
  # Not Normal

hist(dna.sum$MaxDelta)
qqnorm(dna.sum$MaxDelta)
qqline(dna.sum$MaxDelta)
shapiro.test(dna.sum$MaxDelta)
  # p-value = 1.363e-05
  # Not Normal

hist(dna.sum$PeakTime)
qqnorm(dna.sum$PeakTime)
qqline(dna.sum$PeakTime)
shapiro.test(dna.sum$PeakTime)
  # p-value = 0.113
  # Normal



### Look for cross-correlations
pairs(dna.sum[,12:15])



### Linear Correlation
xyplot(AUC ~ DNA_Yield, dna.sum)
summary(lm(AUC ~ DNA_Yield, dna.sum))
  # p-value = 0.0238
  # R2 = 0.1754
confint(lm(AUC ~ DNA_Yield, dna.sum), level=0.95)

xyplot(MaxDelta ~ DNA_Yield, dna.sum)
summary(lm(MaxDelta ~ DNA_Yield, dna.sum))
  # p-value = 0.00626
  # Adj R2 = 0.2613
confint(lm(MaxDelta ~ DNA_Yield, dna.sum), level=0.95)

xyplot(PeakTime ~ DNA_Yield, dna.sum)
summary(lm(PeakTime ~ DNA_Yield, dna.sum))
  # p-value = 0.00615
  # Adj R2 = 0.2623
confint(lm(PeakTime ~ DNA_Yield, dna.sum), level=0.95)

```

### Summarize/Organize
```{r}
max.org <- max.df %>%
  group_by(Season, Substrate, Antibiotics) %>%
  summarize(Mean = mean(Delta),
            Median = median(Delta),
            SD = sd(Delta),
            SE = (sd(Delta)/(sqrt(length(Delta)))),
            iqr = IQR(Delta))




```

### DNA vs. CRDS Kendall Correlation
```{r}
Kendall(dna.sum$DNA_Yield, dna.sum$AUC)
  # p-value = 0.0073302
  # tau = 0.412
Kendall(dna.sum$DNA_Yield, dna.sum$MaxDelta)
  # p-value = 0.11464
  # tau = 0.389
Kendall(dna.sum$DNA_Yield, dna.sum$PeakTime)
  # p-value = 0.0030445
  # tau = 0.455


corr.test(x=dna.sum$DNA_Yield, y=dna.sum$AUC, method="kendall", use="complete", adjust="BH")
  # p-value = 0.05
  # tau = 0.41
corr.test(x=dna.sum$DNA_Yield, y=dna.sum$MaxDelta, method="kendall", use="complete", adjust="BH")
  # p-value = 0.06
  # tau = 0.39
corr.test(x=dna.sum$DNA_Yield, y=dna.sum$PeakTime, method="kendall", use="complete", adjust="BH")
  # p-value = 0.03
  # tau = 0.46
```

### Import & Prep Summer OTUs
```{r}
# Import phyloseq object
load("Physeq.RData")

# Pull out common samples
both <- intersect(dna.sum$Squirrel, data.frame(sample_data(physeq))$Squirrel)
dna.keep <- dna.sum[1,]
for(i in 1:length(both)){
  ID <- both[i]
  dna.keep[i,] <- dna.sum[which(dna.sum$Squirrel == ID),]
}
physeq.keep <- subset_samples(physeq, Squirrel != "S11")
physeq.keep <- subset_samples(physeq.keep, Squirrel != "S37")
physeq.keep <- subset_samples(physeq.keep, Squirrel != "S40")

# Remove taxa < 1% rel abund
physeq.ra <- transform_sample_counts(physeq.keep, function(x){x/sum(x)})
physeq.use <- prune_taxa(taxa_sums(physeq.ra)>0.01, physeq.ra)

# Pick top 20 taxa
cutoff <- summary(sort(taxa_sums(physeq.use), decreasing=T)[1:20])
physeq.top <- prune_taxa(taxa_sums(physeq.use)>(cutoff[1]-0.0000001), physeq.use)
```

### OTU vs CRDS Correlation
```{r}
### AUC
auc.all <- corr.test(x=dna.keep$AUC, y=t(otu_table(physeq.use)), method="kendall", use="complete", adjust="BH")
which(auc.all$p < 0.05)
  # None

auc.all2 <- corr.test(x=dna.keep$AUC, y=t(otu_table(physeq.use)), method="kendall", use="pairwise", adjust="BH")
which(auc.all2$p < 0.05)
  # None

auc.top <- corr.test(x=dna.keep$AUC, y=t(otu_table(physeq.top)), method="kendall", use="complete", adjust="BH")
which(auc.top$p < 0.05)
  # None



### Max Delta
del.all <- corr.test(x=dna.keep$MaxDelta, y=t(otu_table(physeq.use)), method="kendall", use="complete", adjust="BH")
which(del.all$p < 0.05)
  # None

del.all2 <- corr.test(x=dna.keep$MaxDelta, y=t(otu_table(physeq.use)), method="kendall", use="pairwise", adjust="BH")
which(del.all2$p < 0.05)
  # None

del.top <- corr.test(x=dna.keep$MaxDelta, y=t(otu_table(physeq.top)), method="kendall", use="complete", adjust="BH")
which(del.top$p < 0.05)
  # None



### Peak Time
tim.all <- corr.test(x=dna.keep$PeakTime, y=t(otu_table(physeq.use)), method="kendall", use="complete", adjust="BH")
which(tim.all$p < 0.05)
  # None

tim.all2 <- corr.test(x=dna.keep$PeakTime, y=t(otu_table(physeq.use)), method="kendall", use="pairwise", adjust="BH")
which(tim.all2$p < 0.05)
  # None

tim.top <- corr.test(x=dna.keep$PeakTime, y=t(otu_table(physeq.top)), method="kendall", use="complete", adjust="BH")
which(tim.top$p < 0.05)
  # None
```

### miLineage
```{r}
# Prep inputs
tax.ml <- as.matrix(tax_table(physeq.keep))
colnames(tax.ml) <- c("Rank1","Rank2","Rank3","Rank4","Rank5","Rank6","Rank7")
otu.ml.pre <- data.frame(otu_table(physeq.keep))
otu.ml <- otu.ml.pre[,1:8]
otu.ml$CC2_S21 <- otu.ml.pre[,20]
otu.ml[,10:20] <- otu.ml.pre[,9:19]
otu.ml <- as.matrix(t(otu.ml))
var.ml <- as.matrix(dna.keep[,13])
  # AUC
var2.ml <- as.matrix(dna.keep[,14])
  # Max Delta
var3.ml <- as.matrix(dna.keep[,15])
  # Peak Time
rownames(var.ml) <- dna.keep$Sample

# Run test
ml.results <- QCAT_GEE(OTU=otu.ml, Tax=tax.ml, X=var.ml, X.index = 1, Z=var.ml, Z.index=1,  fdr.alpha=0.05, n.resample = 100)
  # AUC
  # No sig
ml.results2 <- QCAT_GEE(OTU=otu.ml, Tax=tax.ml, X=var2.ml, X.index = 1, Z=var2.ml, Z.index=1,  fdr.alpha=0.05, n.resample = 100)
  # Max Delta
  # No sig
ml.results3 <- QCAT_GEE(OTU=otu.ml, Tax=tax.ml, X=var3.ml, X.index = 1, Z=var3.ml, Z.index=1,  fdr.alpha=0.05, n.resample = 100)
  # Peak Time
  # No sig
```

### Pull out summer no ABX
```{r}
physeq.noabx <- subset_samples(physeq.keep, Antibiotics == "No Antibiotics")

# Remove taxa < 1% rel abund
physeq.noabx.ra <- transform_sample_counts(physeq.noabx, function(x){x/sum(x)})
physeq.noabx.use <-
  prune_taxa(taxa_sums(physeq.noabx.ra)>0.01,
             physeq.noabx.ra)

# Pick top 20 taxa
cutoff.noabx <- summary(sort(taxa_sums(physeq.noabx.use),
                             decreasing=T)[1:20])
physeq.noabx.top <- 
  prune_taxa(taxa_sums(physeq.noabx.use)>(cutoff[1]-0.0000001), physeq.noabx.use)

# Prep DNA metadata
both <- intersect(dna.keep$Squirrel, data.frame(sample_data(physeq.noabx.use))$Squirrel)
dna.keep.noabx <- dna.keep[1,]
for(i in 1:length(both)){
  ID <- both[i]
  dna.keep.noabx[i,] <- dna.keep[which(dna.keep$Squirrel == ID),]
}
```


### No ABX OTU vs CRDS Correlation
```{r}
### AUC
auc.noabx <- corr.test(x=dna.keep.noabx$AUC, y=t(otu_table(physeq.noabx.use)), method="kendall", use="complete", adjust="BH")
which(auc.noabx$p < 0.05)
  # None

auc.noabx2 <- corr.test(x=dna.keep.noabx$AUC, y=t(otu_table(physeq.noabx.use)), method="kendall", use="pairwise", adjust="BH")
which(auc.noabx2$p < 0.05)
  # None

auc.noabx.top <- corr.test(x=dna.keep.noabx$AUC, y=t(otu_table(physeq.noabx.top)), method="kendall", use="complete", adjust="BH")
which(auc.noabx.top$p < 0.05)
  # None



### Max Delta
del.noabx <- corr.test(x=dna.keep.noabx$MaxDelta, y=t(otu_table(physeq.noabx.use)), method="kendall", use="complete", adjust="BH")
which(del.noabx$p < 0.05)
  # None

del.noabx2 <- corr.test(x=dna.keep.noabx$MaxDelta, y=t(otu_table(physeq.noabx.use)), method="kendall", use="pairwise", adjust="BH")
which(del.noabx2$p < 0.05)
  # None

del.noabx.top <- corr.test(x=dna.keep.noabx$MaxDelta, y=t(otu_table(physeq.noabx.top)), method="kendall", use="complete", adjust="BH")
which(del.noabx.top$p < 0.05)
  # None



### Peak Time
tim.noabx <- corr.test(x=dna.keep.noabx$PeakTime, y=t(otu_table(physeq.noabx.use)), method="kendall", use="complete", adjust="BH")
which(tim.noabx$p < 0.05)
  # None

tim.noabx2 <- corr.test(x=dna.keep.noabx$PeakTime, y=t(otu_table(physeq.noabx.use)), method="kendall", use="pairwise", adjust="BH")
which(tim.noabx2$p < 0.05)
  # None

tim.noabx.top <- corr.test(x=dna.keep.noabx$PeakTime, y=t(otu_table(physeq.noabx.top)), method="kendall", use="complete", adjust="BH")
which(tim.noabx.top$p < 0.05)
  # None
```

### miLineage
```{r}
# Prep inputs
tax.noabx.ml <- as.matrix(tax_table(physeq.noabx))
colnames(tax.noabx.ml) <-
  c("Rank1","Rank2","Rank3","Rank4","Rank5","Rank6",
    "Rank7")
otu.noabx.ml <- as.matrix(t(otu_table(physeq.noabx)))
var.noabx.ml <- as.matrix(dna.keep.noabx[,13])
  # AUC
var2.noabx.ml <- as.matrix(dna.keep.noabx[,14])
  # Max Delta
var3.noabx.ml <- as.matrix(dna.keep.noabx[,15])
  # Peak Time

# Run test
ml.results <- QCAT_GEE(OTU=otu.noabx.ml, Tax=tax.noabx.ml, X=var.noabx.ml, X.index = 1, Z=var.noabx.ml, Z.index=1,  fdr.alpha=0.05, n.resample = 100)
  # AUC
  # No sig
ml.results2 <- QCAT_GEE(OTU=otu.noabx.ml, Tax=tax.noabx.ml, X=var2.noabx.ml, X.index = 1, Z=var2.noabx.ml, Z.index=1,  fdr.alpha=0.05, n.resample = 100)
  # Max Delta
  # No sig
ml.results3 <- QCAT_GEE(OTU=otu.noabx.ml, Tax=tax.noabx.ml, X=var3.noabx.ml, X.index = 1, Z=var3.noabx.ml, Z.index=1,  fdr.alpha=0.05, n.resample = 100)
  # Peak Time
  # No sig
```