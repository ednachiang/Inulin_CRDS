---
title: "Code"
author: "Edna Chiang"
date: "February 5, 2018"
output: html_document
---

### Load Packages, scripts, and functions
```{r}
library(ggplot2)
library(dplyr)
library(grid)
source('scripts/import_crds.R')
source('scripts/import_crds_sep.R')
source('scripts/bin_crds.R')
source('scripts/misc.R')
set.seed(1)
theme_set(theme_bw())
```

### Load Data
```{r}
crds <- import.crds('CSV', 'metadata.csv')
crds.all <- import.crds.sep('CSV', 'metadata.csv')
```

### Bin RelTime
```{r}
crds.bin <- bin.crds(crds)
```

### Summarize by Substrate + ABX
```{r}
# Remove NA's (gavage time)
rem <- which(is.na(crds.bin$Delta))
crds.rem <- crds.bin[-rem,]

# Remove 3982 because it may be incorrectly labeled
crds.rem <- crds.rem[-which(crds.rem$Number == 3982),]
crds.rem$ID <- droplevels(crds.rem$ID)

# Summarize
crds.sum <- crds.rem %>%
  group_by(Substrate, Antibiotics, Season, BinTime) %>%
  summarize(Mean = mean(Delta),
            Median = median(Delta),
            SD = sd(Delta),
            SE = se(Delta),
            iqr = IQR(Delta))
crds.sum$Season <- ordered(crds.sum$Season, levels=c("Summer", "Winter", "Spring"))
```

### Separate by substrate
```{r}
inu.all <- crds.sum[which(crds.sum$Substrate == "Inulin"),]

man.all <- crds.sum[which(crds.sum$Substrate == "Mannitol"),]

sal.all <- crds.sum[which(crds.sum$Substrate == "Saline"),]

ure.all <- crds.sum[which(crds.sum$Substrate == "Urea"),]
```


### Plot
```{r}
## All individuals
ggplot(crds.bin, aes(x=BinTime, y=Delta, color=ID)) +
  geom_line() +
  geom_point()

## Substrate/ABX
ggplot(crds.sum, aes(x=BinTime, y=Mean, color=Substrate)) +
  geom_line(aes(linetype=Antibiotics)) +
  geom_point() +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE))

## Inulin
inu.plot <- ggplot(inu.all, aes(x=BinTime, y=Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
   geom_point(size=3, shape=21, aes(color=Season, fill=factor(ifelse(Antibiotics == "Yes", NA, Season)))) +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"), na.value="white", guide="none") +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE), width=0.125, position=position_dodge(0.1)) +
  ggtitle(expression("Inulin"~~delta^13~"C")) +
  xlab("Time Since Gavage") +
  ylab(expression("Mean"~~delta^13~"C"))+
  theme(plot.title=element_text(hjust=0.5, size=12),
        axis.title.x=element_text(size=12),
        axis.title.y=element_text(size=12)) +
  guides(colour=F, linetype=F)

## Mannitol
man.plot <- ggplot(man.all, aes(x=BinTime, y=Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
  geom_point(size=3, shape=21, aes(color=Season, fill=factor(ifelse(Antibiotics == "Yes", NA, Season)))) +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"), na.value="white", guide="none") +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE), width=0.125, position=position_dodge(0.1)) +
  ggtitle(expression("Mannitol"~~delta^13~"C")) +
  xlab("Time Since Gavage") +
  ylab(expression("Mean"~~delta^13~"C"))+
  theme(plot.title=element_text(hjust=0.5, size=12),
        axis.title.x=element_text(size=12),
        axis.title.y=element_text(size=12)) +
  guides(colour=F, linetype=F)

## Saline
sal.plot <- ggplot(sal.all, aes(x=BinTime, y=Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
  geom_point(size=3, shape=21, aes(color=Season, fill=factor(ifelse(Antibiotics == "Yes", NA, Season)))) +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"), na.value="white", guide="none") +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE), width=0.125, position=position_dodge(0.1)) +
  ggtitle(expression("Saline"~~delta^13~"C")) +
  xlab("Time Since Gavage") +
  ylab(expression("Mean"~~delta^13~"C"))+
  theme(plot.title=element_text(hjust=0.5, size=12),
        axis.title.x=element_text(size=12),
        axis.title.y=element_text(size=12)) +
  guides(colour=F, linetype=F)

## Urea
ure.plot <- ggplot(ure.all, aes(x=BinTime, y=Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
  geom_point(size=3, shape=21, aes(color=Season, fill=factor(ifelse(Antibiotics == "Yes", NA, Season)))) +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  scale_fill_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"), na.value="white", guide="none") +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE), width=0.125, position=position_dodge(0.1)) +
  ggtitle(expression("Urea"~~delta^13~"C")) +
  xlab("Time Since Gavage") +
  ylab(expression("Mean"~~delta^13~"C"))+
  theme(plot.title=element_text(hjust=0.5)) #+
  #guides(colour=F, linetype=F)

## Steal legend
steal.legend <- ggplot(sal.all, aes(x=BinTime, y=Mean, color=Season)) +
  geom_line(aes(linetype=Antibiotics), size=1) +
  geom_point(size=3) +
  scale_color_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  geom_errorbar(aes(ymin = Mean-SE, ymax = Mean+SE), width=0.125, position=position_dodge(0.1)) +
  ggtitle(expression("Saline"~~delta^13~"C")) +
  xlab("Time Since Gavage") +
  ylab(expression("Mean"~~delta^13~"C"))+
  theme(plot.title=element_text(hjust=0.5))
legend <- g_legend(steal.legend)
```


### Poster Plots
```{r}
tiff("prelim.fig3.tiff", width = 9, height = 3.5, units = "in", res = 300)
grid.newpage()
pushViewport(viewport(layout=(grid.layout(1,4, widths=c(1,1,1,0.4), heights=c(1,1,1,1)))))
print(inu.plot, vp=viewport(layout.pos.row=1, layout.pos.col=1))
print(man.plot, vp=viewport(layout.pos.row=1, layout.pos.col=2))
print(sal.plot, vp=viewport(layout.pos.row=1, layout.pos.col=3))
legend$vp <- viewport(layout.pos.row=1, layout.pos.col=4)
grid.draw(legend)
dev.off()

```


### Inulin Plots
```{r}
## All individuals
inu.ind <- crds.rem[which(crds.rem$Substrate == "Inulin"),]
ggplot(inu.ind, aes(x=BinTime, y=Delta, color=Season)) +
  geom_line(aes(linetype=ABX)) +
  geom_point() +
  scale_color_manual(name="Season", values=c("red", "Blue"))

## Summer
inu.sum <- crds.rem[which(crds.rem$Substrate == "Inulin" & crds.rem$Season == "Summer"),]
ggplot(inu.sum, aes(x=BinTime, y=Delta, color=ABX)) +
  geom_line(aes(linetype=ABX)) +
  geom_point() +
  scale_color_manual(name="ABX", values=c("red", "Blue"))

## Summer ABX
inu.sum.abx <- crds.rem[which(crds.rem$Substrate == "Inulin" & crds.rem$Season == "Summer" & crds.rem$ABX == "Yes"),]
ggplot(inu.sum.abx, aes(x=BinTime, y=Delta, color=ID)) +
  geom_line(aes(linetype=ABX)) +
  geom_point()
  # 3982 is an outlier -- is it actually ABX?
  # Until confirmed, remove from data
```


### AUC
```{r}
# https://stackoverflow.com/questions/4954507/calculate-the-area-under-a-curve

ids <- levels(crds.rem$ID)
auc.df <- data.frame(crds.rem[1,])
auc.df <- auc.df[,-2:-3]
auc.df <- auc.df[,-8]
colnames(auc.df) <- c("AUC", "Number", "ID", "Season", "Sex", "Antibiotics", "Substrate")
for(i in 1:length(ids)){
  ID <- ids[i]
  print(ID)
  select <- crds.rem[which(crds.rem$ID == ID),]
  baseline <- which(select$RelTime < 0)
  baseline.reltime <- mean(select$RelTime[baseline])
  baseline.delta <- mean(select$Delta[baseline])
  baseline.co2 <- mean(select$CO2[baseline])
  baseline.bintime <- mean(select$BinTime[baseline])
  select.norm <- data.frame(RelTime=baseline.reltime, Delta=0, CO2=baseline.co2, Number=select$Number[1], ID=select$ID[1], Season=select$Season[1], Sex=select$Sex[1], Antibiotics=select$Antibiotics[1], Substrate=select$Substrate[1], BinTime=baseline.bintime)
  exp <- which(select$RelTime>0)
  for(j in 1:(nrow(select)-length(baseline))){
    select.norm[j+1,] <- select[exp[j],]
  }
  select.norm[2:nrow(select.norm),2] <- (select.norm[2:nrow(select.norm),2]-baseline.delta)
  x <- select.norm$RelTime
  y <- select.norm$Delta
  AUC <- auc(x, y, type = 'spline')
  print(AUC)
  auc.df[i,1] <- AUC
  auc.df[i,2:7] <- select.norm[1,4:9]
}


```


### ANOVA
```{r}

```


