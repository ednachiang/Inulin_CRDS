---
title: "Identify Outliers"
author: "Edna Chiang"
date: "1/17/2022"
output: html_document
---

### Load Packages, scripts, and functions
```{r}
library(ggplot2)
library(plyr)
library(dplyr)
library(grid)
library(MESS)
library(pgirmess)
library(Bolstad2)
library(phyloseq)
library(psych)
library(car)
source('scripts/misc.R')
set.seed(1)
theme_set(theme_bw())
```

### Load Data
```{r}
load('crds.norm.RData')
load('crds.use.Rdata')
meta <- read.csv('metadata.csv')
```

### Prepare CRDS data
```{r}
# Add metadata
crds.use[, colnames(meta)[3:ncol(meta)]] <- NA
for(i in 1:nrow(crds.use)){
  meta.row <- which(meta$ID == crds.use$ID[i])
  crds.use[i, 6:ncol(crds.use)] <- meta[meta.row, 3:ncol(meta)]
}

# Calculate square root of AUC
minAUC <- min(crds.use$AUC)
crds.use$AUC_Sqrt <- crds.use$AUC + (minAUC * -1)
crds.use$AUC_sqrt <- sqrt(crds.use$AUC_Sqrt)

# Convert to numeric
crds.use$AvgDelta <- as.numeric(crds.use$AvgDelta)
crds.use$MaxD <- as.numeric(crds.use$MaxD)
crds.use$MaxSlope <- as.numeric(crds.use$MaxSlope)
crds.use$AUC <- as.numeric(crds.use$AUC)
crds.use$AUC_sqrt <- as.numeric(crds.use$AUC_sqrt)

# Order categorical variables
crds.use$Season <- ordered(crds.use$Season, levels = c("Summer", "Winter", "Spring"))
crds.use$Sex <- ordered(crds.use$Sex, levels = c("Female", "Male"))
crds.use$Antibiotics <- ordered(crds.use$Antibiotics, levels = c("No", "Yes"))
crds.use$Substrate <- ordered(crds.use$Substrate, levels = c("Inulin", "Saline"))
crds.use$Diet <- ordered(crds.use$Diet, levels = c("1", "2"))

# Remove outliers
#crds.rem <- crds.bin[-which(crds.bin$ID == "S34"),]
#crds.rem <- crds.bin[-which(crds.bin$ID == "S37"),]


# Separate by substrate
crds.inu <- crds.use[which(crds.use$Substrate == "Inulin"),]
crds.sal <- crds.use[which(crds.use$Substrate == "Saline"),]

# Separate by substrate + ABX
crds.inu.abx <- crds.inu[which(crds.inu$Antibiotics == "Yes"),]
crds.inu.noabx <- crds.inu[which(crds.inu$Antibiotics == "No"),]
crds.sal.abx <- crds.sal[which(crds.sal$Antibiotics == "Yes"),]
crds.sal.noabx <- crds.sal[which(crds.sal$Antibiotics == "No"),]

# Separate by substrate + season
crds.inu.s <- crds.inu[which(crds.inu$Season == "Summer"),]
crds.inu.w <- crds.inu[which(crds.inu$Season == "Winter"),]
crds.inu.p <- crds.inu[which(crds.inu$Season == "Spring"),]
crds.sal.s <- crds.sal[which(crds.sal$Season == "Summer"),]
crds.sal.w <- crds.sal[which(crds.sal$Season == "Winter"),]
crds.sal.p <- crds.sal[which(crds.sal$Season == "Spring"),]

```






### Baseline
```{r}
### Separate samples
crds.base <- crds.norm[which(crds.norm$RelTime == 0),]
base.inu <- crds.base[which(crds.base$Substrate == "Inulin"),]
base.sal <- crds.base[which(crds.base$Substrate == "Saline"),]
base.inu.s <- base.inu[which(base.inu$Season == "Summer"),]
base.inu.w <- base.inu[which(base.inu$Season == "Winter"),]
base.inu.p <- base.inu[which(base.inu$Season == "Spring"),]
base.sal.s <- base.sal[which(base.sal$Season == "Summer"),]
base.sal.w <- base.sal[which(base.sal$Season == "Winter"),]
base.sal.p <- base.sal[which(base.sal$Season == "Spring"),]
base.noabx <- crds.base[which(crds.base$Antibiotics == "No"),]
base.abx <- crds.base[which(crds.base$Antibiotics == "Yes"),]
base.noabx.s <- base.noabx[which(base.noabx$Season == "Summer"),]
base.noabx.w <- base.noabx[which(base.noabx$Season == "Winter"),]
base.noabx.p <- base.noabx[which(base.noabx$Season == "Spring"),]
base.abx.p <- base.abx[which(base.abx$Season == "Spring"),]
base.s <- crds.base[which(crds.base$Season == "Summer"),]
base.w <- crds.base[which(crds.base$Season == "Winter"),]
base.p <- crds.base[which(crds.base$Season == "Spring"),]


# All
res <- resid(lm(Delta ~ Season, crds.base))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p-value = 4.017e-15
  # Not Normal
kruskal.test(Delta ~ Season, crds.base)
  # p-value = 1.753e-08
wilcox.test(Delta ~ Antibiotics, crds.base)
  # p-value = 0.07652
wilcox.test(Delta ~ Substrate, crds.base)
  # p-value = 0.3642
wilcox.test(Delta ~ Diet, crds.base)
  # p-value = 0.09588


# Summer
res <- resid(lm(Delta ~ Antibiotics, base.s))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p-value = 0.7892
  # Normal
summary(aov(Delta ~ Antibiotics + Substrate + Diet, base.s))
  # No sig

# Winter
res <- resid(lm(Delta ~ Antibiotics, base.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p-value = 3.085e-09
  # But looks Normal
summary(aov(Delta ~ Antibiotics + Substrate + Diet, base.w))
  # No sig

# Spring
res <- resid(lm(Delta ~ Antibiotics, base.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p-value = 0.8872
  # Normal
summary(aov(Delta ~ Antibiotics + Diet + Substrate, base.p))
  # ABX & Diet sig


# No ABX Spring
res <- resid(lm(Delta ~ Diet, base.noabx.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p-value = 0.08701
  # Normal
summary(aov(Delta ~ Diet + Substrate, base.noabx.p))
  # Diet p = 0.0216*
  # Substrate p = 0.4869
  # Diet:Substrate

# ABX Spring
res <- resid(lm(Delta ~ Diet, base.abx.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p-value = 0.7651
  # Normal
summary(aov(Delta ~ Diet + Substrate, base.abx.p))
  # Diet = 0.000358
  # Substrate = 0.426050

```



### DNA Concentration
```{r}
dna <- read.csv("dna.csv", header=T)

# Pull out content samples
cc <- dna.con <- dna[which(substr(dna$Sample,1,2) == "CC"),]

# Separate
dna.inu <- dna.con[which(dna.con$Substrate == "Inulin"),]
dna.sal <- dna.con[which(dna.con$Substrate == "Saline"),]
dna.inu.s <- dna.inu[which(dna.inu$Season == "Summer"),]
dna.inu.w <- dna.inu[which(dna.inu$Season == "Winter"),]
dna.inu.p <- dna.inu[which(dna.inu$Season == "Spring"),]
dna.sal.s <- dna.sal[which(dna.sal$Season == "Summer"),]
dna.sal.w <- dna.sal[which(dna.sal$Season == "Winter"),]
dna.sal.p <- dna.sal[which(dna.sal$Season == "Spring"),]
```


### Find outliers
```{r}
### Boxplot - baseline
ggplot(base.inu.s, aes(x = Antibiotics, y = Delta, fill = Antibiotics)) +
  geom_boxplot()
  # 1 ABX
ggplot(base.inu.w, aes(x = Antibiotics, y = Delta, fill = Antibiotics)) +
  geom_boxplot()
  # 1 No ABX
  # 1 ABX
ggplot(base.inu.p, aes(x = Antibiotics, y = Delta, fill = Antibiotics)) +
  geom_boxplot()
  # 1 ABX
ggplot(base.sal.s, aes(x = Antibiotics, y = Delta, fill = Antibiotics)) +
  geom_boxplot()
  # 1 ABX
ggplot(base.sal.w, aes(x = Antibiotics, y = Delta, fill = Antibiotics)) +
  geom_boxplot()
  # 2 ABX
ggplot(base.sal.p, aes(x = Antibiotics, y = Delta, fill = Antibiotics)) +
  geom_boxplot()


### Boxplot - AUC
ggplot(crds.inu.s, aes(x = Antibiotics, y = AUC_sqrt, fill = Antibiotics)) +
  geom_boxplot()
  # 1 ABX
ggplot(crds.inu.w, aes(x = Antibiotics, y = AUC_sqrt, fill = Antibiotics)) +
  geom_boxplot()
ggplot(crds.inu.p, aes(x = Antibiotics, y = AUC_sqrt, fill = Antibiotics)) +
  geom_boxplot()
  # 2 ABX
ggplot(crds.sal.s, aes(x = Antibiotics, y = AUC_sqrt, fill = Antibiotics)) +
  geom_boxplot()
ggplot(crds.sal.w, aes(x = Antibiotics, y = AUC_sqrt, fill = Antibiotics)) +
  geom_boxplot()
  # 1 No ABX
  # 2 ABX
ggplot(crds.sal.p, aes(x = Antibiotics, y = AUC_sqrt, fill = Antibiotics)) +
  geom_boxplot()


### Boxplot - MaxD
ggplot(d.inu.s, aes(x = Antibiotics, y = MaxD, fill = Antibiotics)) +
  geom_boxplot()
  # 1 ABX
ggplot(d.inu.w, aes(x = Antibiotics, y = MaxD, fill = Antibiotics)) +
  geom_boxplot()
ggplot(d.inu.p, aes(x = Antibiotics, y = MaxD, fill = Antibiotics)) +
  geom_boxplot()
  # 2 ABX
ggplot(d.sal.s, aes(x = Antibiotics, y = MaxD, fill = Antibiotics)) +
  geom_boxplot()
ggplot(d.sal.w, aes(x = Antibiotics, y = MaxD, fill = Antibiotics)) +
  geom_boxplot()
  # 1 No ABX
  # 2 ABX
ggplot(d.sal.p, aes(x = Antibiotics, y = MaxD, fill = Antibiotics)) +
  geom_boxplot()


### Boxplot - MaxSlope
ggplot(d.inu.s, aes(x = Antibiotics, y = Slope, fill = Antibiotics)) +
  geom_boxplot()
  # 1 ABX
ggplot(d.inu.w, aes(x = Antibiotics, y = Slope, fill = Antibiotics)) +
  geom_boxplot()
ggplot(d.inu.p, aes(x = Antibiotics, y = Slope, fill = Antibiotics)) +
  geom_boxplot()
  # 1 No ABX
ggplot(d.sal.s, aes(x = Antibiotics, y = Slope, fill = Antibiotics)) +
  geom_boxplot()
  # 1 No ABX
ggplot(d.sal.w, aes(x = Antibiotics, y = Slope, fill = Antibiotics)) +
  geom_boxplot()
ggplot(d.sal.p, aes(x = Antibiotics, y = Slope, fill = Antibiotics)) +
  geom_boxplot()
  # 1 No ABX



### Boxplot - DNA Concentration
ggplot(dna.inu[which(dna.inu$Antibiotics == "No Antibiotics"),], aes(x = Season, y = DNA_Yield_.ng.mg., fill = Season)) +
  geom_boxplot()
ggplot(dna.inu[which(dna.inu$Antibiotics == "Antibiotics"),], aes(x = Season, y = DNA_Yield_.ng.mg., fill = Season)) +
  geom_boxplot()


ggplot(dna.inu.s, aes(x = Antibiotics, y = DNA_Yield_.ng.mg., fill = Antibiotics)) +
  geom_boxplot()
  # 1 ABX
ggplot(dna.inu.w, aes(x = Antibiotics, y = DNA_Yield_.ng.mg., fill = Antibiotics)) +
  geom_boxplot()
  # 1 No ABX
ggplot(dna.inu.p, aes(x = Antibiotics, y = DNA_Yield_.ng.mg., fill = Antibiotics)) +
  geom_boxplot()
  # 1 ABX
ggplot(dna.sal.s, aes(x = Antibiotics, y = DNA_Yield_.ng.mg., fill = Antibiotics)) +
  geom_boxplot()
  # 1 No ABX
ggplot(dna.sal.w, aes(x = Antibiotics, y = DNA_Yield_.ng.mg., fill = Antibiotics)) +
  geom_boxplot()
ggplot(dna.sal.p, aes(x = Antibiotics, y = DNA_Yield_.ng.mg., fill = Antibiotics)) +
  geom_boxplot()
  # 1 ABX
```
