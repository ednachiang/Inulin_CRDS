---
title: "Identify Outliers"
author: "Edna Chiang"
date: "1/17/2022"
output: html_document
---

### Load Packages, scripts, and functions
```{r}
library(ggplot2)
library(plyr)
library(dplyr)
library(grid)
library(car)
source('scripts/misc.R')
set.seed(1)
theme_set(theme_bw())
```

### Load Data
```{r}
load('crds.norm.RData')
load('crds.use.Rdata')
meta <- read.csv('metadata.csv')
```

### Prepare CRDS data
```{r}
# Add metadata
crds.use[, colnames(meta)[3:ncol(meta)]] <- NA
for(i in 1:nrow(crds.use)){
  meta.row <- which(meta$ID == crds.use$ID[i])
  crds.use[i, 7:ncol(crds.use)] <- meta[meta.row, 3:ncol(meta)]
}

# Calculate square root of AUC
crds.use$AUC <- as.numeric(crds.use$AUC)
minAUC <- min(crds.use$AUC)
crds.use$AUC_sqrt <- crds.use$AUC + (minAUC * -1)
crds.use$AUC_sqrt <- sqrt(crds.use$AUC_sqrt)

# Convert to numeric
crds.use$AvgD <- as.numeric(crds.use$AvgD)
crds.use$MaxD <- as.numeric(crds.use$MaxD)
crds.use$MaxSlope <- as.numeric(crds.use$MaxSlope)
crds.use$AUC <- as.numeric(crds.use$AUC)
crds.use$AUC_sqrt <- as.numeric(crds.use$AUC_sqrt)
crds.use$Baseline <- as.numeric(crds.use$Baseline)


# Order categorical variables
crds.use$Season <- ordered(crds.use$Season, levels = c("Summer", "Winter", "Spring"))
crds.use$Sex <- ordered(crds.use$Sex, levels = c("Female", "Male"))
crds.use$Antibiotics <- ordered(crds.use$Antibiotics, levels = c("No", "Yes"))
crds.use$Substrate <- ordered(crds.use$Substrate, levels = c("Inulin", "Saline"))
crds.use$Diet <- ordered(crds.use$Diet, levels = c("1", "2"))

# Remove outliers
crds.rem <- crds.use[-which(crds.use$ID == "S23"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "S37"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "S60"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "W43"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "W20"),]
  # This is due to odd metagenome
crds.rem <- crds.rem[-which(crds.rem$ID == "W50"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "P20"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "P22"),]


# Separate by substrate
crds.inu <- crds.rem[which(crds.rem$Substrate == "Inulin"),]
crds.sal <- crds.rem[which(crds.rem$Substrate == "Saline"),]

# Separate by substrate + ABX
crds.inu.abx <- crds.inu[which(crds.inu$Antibiotics == "Yes"),]
crds.inu.noabx <- crds.inu[which(crds.inu$Antibiotics == "No"),]
crds.sal.abx <- crds.sal[which(crds.sal$Antibiotics == "Yes"),]
crds.sal.noabx <- crds.sal[which(crds.sal$Antibiotics == "No"),]

# Separate by substrate + season
crds.inu.s <- crds.inu[which(crds.inu$Season == "Summer"),]
crds.inu.w <- crds.inu[which(crds.inu$Season == "Winter"),]
crds.inu.p <- crds.inu[which(crds.inu$Season == "Spring"),]
crds.sal.s <- crds.sal[which(crds.sal$Season == "Summer"),]
crds.sal.w <- crds.sal[which(crds.sal$Season == "Winter"),]
crds.sal.p <- crds.sal[which(crds.sal$Season == "Spring"),]

```



### Test Baseline
```{r}
### All ###
res <- resid(lm(Baseline ~ Season, crds.rem))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p-value = 0.5647
  # Normal
summary(aov(Baseline ~ Season + Diet + Antibiotics + Substrate + Season*Diet + Season*Antibiotics + Antibiotics*Sex, crds.rem))
  # Season p < 2e-16
  # Diet p = 6.86e-08
  # Antibiotics p = 0.000968
  # Substrate = 0.103008
  # Sex = 0.710210
  # Season:Diet = 3.05e-05
  # Season:Antibiotics = 0.062482
  # Antibiotics:Sex = 0.028783
TukeyHSD(aov(Baseline ~ Season + Diet + Antibiotics + Substrate + Season*Diet + Season*Antibiotics + Antibiotics*Sex, crds.rem), conf.level = 0.95)


```

### Find outliers
```{r}
### Boxplot - baseline
ggplot(base.inu.s, aes(x = Antibiotics, y = Delta, fill = Antibiotics)) +
  geom_boxplot()
  # 1 ABX
ggplot(base.inu.w, aes(x = Antibiotics, y = Delta, fill = Antibiotics)) +
  geom_boxplot()
  # 1 ABX
ggplot(base.inu.p, aes(x = Antibiotics, y = Delta, fill = Antibiotics)) +
  geom_boxplot()
  # 1 ABX
ggplot(base.sal.s, aes(x = Antibiotics, y = Delta, fill = Antibiotics)) +
  geom_boxplot()
  # 1 ABX
ggplot(base.sal.w, aes(x = Antibiotics, y = Delta, fill = Antibiotics)) +
  geom_boxplot()
  # 2 ABX
ggplot(base.sal.p, aes(x = Antibiotics, y = Delta, fill = Antibiotics)) +
  geom_boxplot()
```


### Plot baseline
```{r}
### Prepare data for plotting
crds.rem$SeasonABX <- interaction(crds.rem$Season, crds.rem$Antibiotics)
crds.rem$SeasonABX <- ordered(crds.rem$SeasonABX, levels=c("Summer.No", "Summer.Yes", "Winter.No", "Winter.Yes", "Spring.No", "Spring.Yes"))

#tiff("crds.baseline.tiff", width = 4, height = 3, units = "in", res = 600)
ggplot(crds.rem, aes(x = Season, y = Baseline, color = SeasonABX,
                                    fill = SeasonABX)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 1.5,
               position = position_dodge(0.7), stackratio = 0.5) +
  scale_color_manual(values = c("#c98b00", "#E69F00", "#004166", "#006299", "#00966d",
                                "#00bf8b")) +
  scale_fill_manual(values = c("#E69F00", "white", "#006299", "white", "#00bf8b",
                               "white")) +
  stat_summary(fun.data = "mean_cl_normal", geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.5) +
  ylab(expression("Baseline"~~delta^13~"C"~"(%"[o]~")")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(face="bold", size=10, margin = margin(t = 7.5)),
        axis.title.y = element_text(face="bold", size=10),
        axis.text.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        plot.title = element_text(hjust = 0.5, size = 12, face = "bold"),
        legend.position = "none")
#dev.off()

```


### Prepare DNA yield
```{r}
 Load data
dna <- read.csv('dna.csv')
dna.c <- dna[which(grepl("CC", dna$Sample) == T),]

# Remove outliers
dna.c <- dna.c[-which(dna.c$Squirrel == "S23"),]
dna.c <- dna.c[-which(dna.c$Squirrel == "S37"),]
dna.c <- dna.c[-which(dna.c$Squirrel == "S60"),]
dna.c <- dna.c[-which(dna.c$Squirrel == "W43"),]
dna.c <- dna.c[-which(dna.c$Squirrel == "W20"),]
  # This is due to odd metagenome
dna.c <- dna.c[-which(dna.c$Squirrel == "W50"),]
dna.c <- dna.c[-which(dna.c$Squirrel == "P20"),]
  # ABX didn't work

dna.c$Metabolism <- "a"
dna.c$Metabolism[which(dna.c$Season == "Winter")] <- "Hibernation"
dna.c$Metabolism[which(dna.c$Season != "Winter")] <- "Active"
dna.c$Metabolism <- ordered(dna.c$Metabolism, levels = c("Active", "Hibernation"))
dna.c$Season <- ordered(dna.c$Season, levels = c("Summer", "Winter", "Spring"))
dna.s <- dna.c[which(dna.c$Season == "Summer"),]
dna.w <- dna.c[which(dna.c$Season == "Winter"),]
dna.p <- dna.c[which(dna.c$Season == "Spring"),]
dna.inu.s <- dna.s[which(dna.s$Substrate == "Inulin"),]
dna.inu.w <- dna.w[which(dna.w$Substrate == "Inulin"),]
dna.inu.p <- dna.p[which(dna.p$Substrate == "Inulin"),]
dna.sal.s <- dna.s[which(dna.s$Substrate == "Saline"),]
dna.sal.w <- dna.w[which(dna.w$Substrate == "Saline"),]
dna.sal.p <- dna.p[which(dna.p$Substrate == "Saline"),]

```

### Find DNA yield outliers
```{r}
# Inulin
ggplot(dna.inu.s[which(dna.inu.s$Antibiotics == "Antibiotics"),],
       aes(x = Antibiotics, y = DNA_Yield_.ng.mg., fill = Antibiotics)) +
  geom_boxplot()
  # 1 outlier
ggplot(dna.inu.w[which(dna.inu.w$Antibiotics == "Antibiotics"),],
       aes(x = Antibiotics, y = DNA_Yield_.ng.mg., fill = Antibiotics)) +
  geom_boxplot()
ggplot(dna.inu.p[which(dna.inu.p$Antibiotics == "Antibiotics"),], aes(x = Antibiotics, y = DNA_Yield_.ng.mg., fill = Antibiotics)) +
  geom_boxplot()
  # 1 outlier

# Saline
ggplot(dna.sal.s[which(dna.sal.s$Antibiotics == "Antibiotics"),], 
       aes(x = Antibiotics, y = DNA_Yield_.ng.mg., fill = Antibiotics)) +
  geom_boxplot()
ggplot(dna.sal.w[which(dna.sal.w$Antibiotics == "Antibiotics"),], 
       aes(x = Antibiotics, y = DNA_Yield_.ng.mg., fill = Antibiotics)) +
  geom_boxplot()
ggplot(dna.sal.p[which(dna.sal.p$Antibiotics == "Antibiotics"),], aes(x = Antibiotics, y = DNA_Yield_.ng.mg., fill = Antibiotics)) +
  geom_boxplot()
  # 1 outlier
```