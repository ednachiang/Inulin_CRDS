---
title: "Identify Outliers"
author: "Edna Chiang"
date: "1/17/2022"
output: html_document
---

### Load Packages, scripts, and functions
```{r}
library(ggplot2)
library(plyr)
library(dplyr)
library(grid)
library(MESS)
library(pgirmess)
library(Bolstad2)
library(phyloseq)
library(psych)
library(car)
source('scripts/import_crds.R')
source('scripts/bin_crds.R')
source('scripts/misc.R')
source('scripts/calc_delta_metrics.R')
set.seed(1)
theme_set(theme_bw())

### Stats Notes
# Use 'subset' in kruskal.test
# Do NOT use 'subset' in kruskalmc or pairwise.wilcox.test; it doesn't work!
```

### Load Data
```{r}
crds <- import.crds('CSV', 'metadata.csv')
```

### Bin RelTime
```{r}
crds.bin <- bin.crds(crds)
```

### Summarize by Substrate + ABX
```{r}
### Remove Inulin outliers
#crds.rem <- crds.bin[-which(crds.bin$ID == "S34"),]
crds.rem <- crds.bin[-which(crds.bin$ID == "S37"),]
  # ABX didn't work; high [DNA]
crds.rem <- crds.rem[-which(crds.rem$ID == "S23"),]
  # Low baseline
#crds.rem <- crds.rem[-which(crds.rem$ID == "P28"),]
#crds.rem <- crds.rem[-which(crds.rem$ID == "P30"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "W31"),]
  # Weird baseline. Decreased over time and was lower than ABX squirrels.

# Remove Saline outliers
#crds.rem <- crds.rem[-which(crds.rem$ID == "W26"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "W43"),]
  # Weird baseline, AUC, and MaxD
crds.rem <- crds.rem[-which(crds.rem$ID == "W50"),]
  # Baseline (both values are high), AUC, MaxD


crds.rem$Season <- ordered(crds.rem$Season, levels=c("Summer", "Winter", "Spring"))


# Summarize
#crds.sum <- crds.rem %>%
  group_by(Substrate, Antibiotics, Season, BinTime) %>%
  summarize(Y_Mean = mean(Delta),
            Y_Median = median(Delta),
            Y_SD = sd(Delta),
            Y_SE = se(Delta),
            Y_IQR = IQR(Delta),
            X_Mean = mean(RelTime),
            X_Median = median(RelTime),
            X_SD = sd(RelTime),
            X_SE = se(RelTime),
            X_IQR = IQR(RelTime),
            SampSize = n())
  # X_Mean is different from BinTime because BinTime was calculated with ABX and non-ABX combined
    # BinTime was calculated this way to make sure datapoints for all individuals will align together on x-axis. If datapoints are misaligned that can be confusing for the audience. So binning was done this way for the clearest visualization.
    # X_Mean is calculated for ABX and non-ABX separately, so there will be some variation
#crds.sum$Season <- ordered(crds.sum$Season, levels=c("Summer", "Winter", "Spring"))
```


### Calculate Delta Metrics
```{r}
# Calculate delta metrics
d.metrics <- calc.delta.metrics(crds.rem)
#write.csv(d.metrics, "delta_metrics.csv", row.names = F)

# Load metadata
meta <- read.csv('metadata.csv')

# Add metadata to delta metrics
d.metrics[,colnames(meta)[3:12]] <- NA
for(sq in 1:nrow(d.metrics)){
  meta.row <- which(meta$ID == d.metrics$ID[sq])
  d.metrics[sq, 4:13] <- meta[meta.row, 3:12]
}

# Convert to numeric
d.metrics$MaxD <- as.numeric(d.metrics$MaxD)
d.metrics$Slope <- as.numeric(d.metrics$Slope)

# Order seasons
d.metrics$Season <- ordered(d.metrics$Season, levels=c("Summer", "Winter", "Spring"))

# Separate by substrate
d.inu <- d.metrics[which(d.metrics$Substrate == "Inulin"),]
d.sal <- d.metrics[which(d.metrics$Substrate == "Saline"),]

# Separate by substrate + ABX
d.inu.abx <- d.inu[which(d.inu$Antibiotics == "Yes"),]
d.inu.noabx <- d.inu[which(d.inu$Antibiotics == "No"),]
d.sal.abx <- d.sal[which(d.sal$Antibiotics == "Yes"),]
d.sal.noabx <- d.sal[which(d.sal$Antibiotics == "No"),]

# Separate by substrate + season
d.inu.s <- d.inu[which(d.inu$Season == "Summer"),]
d.inu.w <- d.inu[which(d.inu$Season == "Winter"),]
d.inu.p <- d.inu[which(d.inu$Season == "Spring"),]
d.sal.s <- d.sal[which(d.sal$Season == "Summer"),]
d.sal.w <- d.sal[which(d.sal$Season == "Winter"),]
d.sal.p <- d.sal[which(d.sal$Season == "Spring"),]
```


### Calculate AUC
```{r}
# AUC = Area Under Curve
# Trapezoid Method

### Calculate AUC
ids <- unique(crds.rem$ID)
auc.df <- data.frame(crds.rem[1,])
auc.df <- auc.df[,-2:-3]
  # Remove Delta and CO2 cols
auc.df <- auc.df[,-14]
  # Remove BinTime col
colnames(auc.df) <- c("AUC", "Number", "ID", "Season", "Sex", "Antibiotics", "Substrate", "Diet", "Mom", "Mom_Location", "BodyMass", "BodyTemp", "Date_Sampled")
auc.df$Ketones <- NA
#auc.df$Date_Sampled <- NA

  # Rename cols
meta <- read.csv('metadata.csv')

#crds.rem= crds.bin
# First normalize Rel Time so 
#for (i in 2){
for (i in 1:length(ids)){
  ID <- ids[i]
  select <- crds.rem[which(crds.rem$ID == ID),]
    # Dataframe with CRDS values for 1 squirrel

  # Normalize delta value to baseline
  select$Delta <- select$Delta - select$Delta[1]
  
  # Remove baseline from AUC calculation because we care about the AUC after gavage
  # Since we already normalized delta value to baseline, we don't need that value anymore
  # Set baseline to gavage time = 0
  select[1,1] <- 0
  
  # Normalize AUC end time
  # Since length of experiment varies for each individual, we don't want experimental length to bias our AUC calculations
  # Normalize length to min time within each substrate
    # Inu = 4.0667
    # Sal = 2.21667
  if (select$Substrate == "Inulin") {
    max <- which(select$RelTime > 4.06667)
    select$RelTime[max] <- 4.06667
  } else if (select$Substrate == "Saline") {
    max <- which(select$RelTime > 2.21666667)
    select$RelTime[max] <- 2.21666667
  }

  # Create auc variable
  AUC <- 0
  
  # Run rectangle method integration - less accurate
  #for (j in 1:(nrow(select)-1)){
  #  AUC <- AUC + ((select$RelTime[j+1]-select$RelTime[j])*select$Delta[j+1])
  #}
  
  # Run trapezoid method integration - more accurate
  for(j in 1:(nrow(select)-1)){
    avgH <- (select$Delta[j+1]+select$Delta[j])/2
      # Calculates average height between start and end point
    width <- (select$RelTime[j+1]-select$RelTime[j])
    AUC <- AUC + (avgH*width)
  }
    
  auc.df[i,1] <- AUC
  auc.df[i, 2:14] <- select[1, 4:15]
  
  use <- which(meta$ID == ID)
  auc.df$Ketones[i] <- meta$Ketones[use]
}



### Subset by Substrate & ABX
auc.inu <- auc.df[which(auc.df$Substrate == "Inulin"),]
auc.sal <- auc.df[which(auc.df$Substrate == "Saline"),]
auc.inu.s <- auc.inu[which(auc.inu$Season == "Summer"),]
auc.inu.w <- auc.inu[which(auc.inu$Season == "Winter"),]
auc.inu.p <- auc.inu[which(auc.inu$Season == "Spring"),]
auc.sal.s <- auc.sal[which(auc.sal$Season == "Summer"),]
auc.sal.w <- auc.sal[which(auc.sal$Season == "Winter"),]
auc.sal.p <- auc.sal[which(auc.sal$Season == "Spring"),]
```


### Baseline
```{r}
### Separate samples
crds.base <- crds.rem[which(crds.rem$RelTime < 0),]
base.inu <- crds.base[which(crds.base$Substrate == "Inulin"),]
base.sal <- crds.base[which(crds.base$Substrate == "Saline"),]
base.inu.s <- base.inu[which(base.inu$Season == "Summer"),]
base.inu.w <- base.inu[which(base.inu$Season == "Winter"),]
base.inu.p <- base.inu[which(base.inu$Season == "Spring"),]
base.sal.s <- base.sal[which(base.sal$Season == "Summer"),]
base.sal.w <- base.sal[which(base.sal$Season == "Winter"),]
base.sal.p <- base.sal[which(base.sal$Season == "Spring"),]
base.noabx <- crds.base[which(crds.base$Antibiotics == "No"),]
base.abx <- crds.base[which(crds.base$Antibiotics == "Yes"),]
base.noabx.s <- base.noabx[which(base.noabx$Season == "Summer"),]
base.noabx.w <- base.noabx[which(base.noabx$Season == "Winter"),]
base.noabx.p <- base.noabx[which(base.noabx$Season == "Spring"),]
base.abx.p <- base.abx[which(base.abx$Season == "Spring"),]
base.s <- crds.base[which(crds.base$Season == "Summer"),]
base.w <- crds.base[which(crds.base$Season == "Winter"),]
base.p <- crds.base[which(crds.base$Season == "Spring"),]


# All
hist(crds.base$Delta)
qqnorm(crds.base$Delta)
qqline(crds.base$Delta)
shapiro.test(crds.base$Delta)
  # p-value = 0.0002832
  # Not Normal
kruskal.test(Delta ~ Season, crds.base)
  # p-value = 8.278e-09
wilcox.test(Delta ~ Antibiotics, crds.base)
  # p-value = 0.03488
wilcox.test(Delta ~ Substrate, crds.base)
  # p-value = 0.4112
wilcox.test(Delta ~ Diet, crds.base)
  # p-value = 0.05552


# Summer
hist(base.s$Delta)
qqnorm(base.s$Delta)
qqline(base.s$Delta)
shapiro.test(base.s$Delta)
  # p-value = 0.3867
  # Normal
summary(aov(Delta ~ Antibiotics + Substrate + Diet, base.s))
  # No sig

# Winter
hist(base.w$Delta)
qqnorm(base.w$Delta)
qqline(base.w$Delta)
shapiro.test(base.w$Delta)
  # p-value = 0.746
  # Normal
summary(aov(Delta ~ Antibiotics + Substrate + Diet, base.w))
  # No sig

# Spring
hist(base.p$Delta)
qqnorm(base.p$Delta)
qqline(base.p$Delta)
shapiro.test(base.p$Delta)
  # p-value = 0.0834
  # Normal
summary(aov(Delta ~ Antibiotics + Diet + Substrate, base.p))
  # ABX & Diet sig


# No ABX Spring
hist(base.noabx.p$Delta)
qqnorm(base.noabx.p$Delta)
qqline(base.noabx.p$Delta)
shapiro.test(base.noabx.p$Delta)
  # p-value = 0.09155
  # Normal
summary(aov(Delta ~ Diet + Substrate, base.noabx.p))
  # Diet p = 0.0216*
  # Substrate p = 0.4869
  # Diet:Substrate

# ABX Spring
hist(base.abx.p$Delta)
qqnorm(base.abx.p$Delta)
qqline(base.abx.p$Delta)
shapiro.test(base.abx.p$Delta)
  # p-value = 0.1459
  # Normal
summary(aov(Delta ~ Diet + Substrate, base.abx.p))
  # Diet = 0.000358
  # Substrate = 0.426050

```



### DNA Concentration
```{r}
dna <- read.csv("dna.csv", header=T)

# Pull out content samples
cc <- dna.con <- dna[which(substr(dna$Sample,1,2) == "CC"),]

# Separate
dna.inu <- dna.con[which(dna.con$Substrate == "Inulin"),]
dna.sal <- dna.con[which(dna.con$Substrate == "Saline"),]
dna.inu.s <- dna.inu[which(dna.inu$Season == "Summer"),]
dna.inu.w <- dna.inu[which(dna.inu$Season == "Winter"),]
dna.inu.p <- dna.inu[which(dna.inu$Season == "Spring"),]
dna.sal.s <- dna.sal[which(dna.sal$Season == "Summer"),]
dna.sal.w <- dna.sal[which(dna.sal$Season == "Winter"),]
dna.sal.p <- dna.sal[which(dna.sal$Season == "Spring"),]
```


### Find outliers
```{r}
### Boxplot - AUC
ggplot(auc.inu.s, aes(x = Antibiotics, y = AUC, fill = Antibiotics)) +
  geom_boxplot()
  # 1 No ABX
ggplot(auc.inu.w, aes(x = Antibiotics, y = AUC, fill = Antibiotics)) +
  geom_boxplot()
ggplot(auc.inu.p, aes(x = Antibiotics, y = AUC, fill = Antibiotics)) +
  geom_boxplot()
  # 2 ABX
ggplot(auc.sal.s, aes(x = Antibiotics, y = AUC, fill = Antibiotics)) +
  geom_boxplot()
ggplot(auc.sal.w, aes(x = Antibiotics, y = AUC, fill = Antibiotics)) +
  geom_boxplot()
  # 1 No ABX
  # 2 ABX
ggplot(auc.sal.p, aes(x = Antibiotics, y = AUC, fill = Antibiotics)) +
  geom_boxplot()



### Boxplot - baseline
ggplot(base.s, aes(x = Antibiotics, y = Delta, fill = Antibiotics)) +
  geom_boxplot()
ggplot(base.w, aes(x = Antibiotics, y = Delta, fill = Antibiotics)) +
  geom_boxplot()
ggplot(base.p, aes(x = Antibiotics, y = Delta, fill = Antibiotics)) +
  geom_boxplot()


ggplot(base.inu.s, aes(x = Antibiotics, y = Delta, fill = Antibiotics)) +
  geom_boxplot()
  # 1 ABX
ggplot(base.inu.w, aes(x = Antibiotics, y = Delta, fill = Antibiotics)) +
  geom_boxplot()
  # 1 No ABX
  # 1 ABX
ggplot(base.inu.p, aes(x = Antibiotics, y = Delta, fill = Antibiotics)) +
  geom_boxplot()
  # 1 ABX
ggplot(base.sal.s, aes(x = Antibiotics, y = Delta, fill = Antibiotics)) +
  geom_boxplot()
  # 1 ABX
ggplot(base.sal.w, aes(x = Antibiotics, y = Delta, fill = Antibiotics)) +
  geom_boxplot()
  # 2 ABX
ggplot(base.sal.p, aes(x = Antibiotics, y = Delta, fill = Antibiotics)) +
  geom_boxplot()


### Boxplot - Slope
ggplot(d.inu.s, aes(x = Antibiotics, y = Slope, fill = Antibiotics)) +
  geom_boxplot()
ggplot(d.inu.w, aes(x = Antibiotics, y = Slope, fill = Antibiotics)) +
  geom_boxplot()
  # 2 ABX
ggplot(d.inu.p, aes(x = Antibiotics, y = Slope, fill = Antibiotics)) +
  geom_boxplot()
ggplot(d.sal.s, aes(x = Antibiotics, y = Slope, fill = Antibiotics)) +
  geom_boxplot()
ggplot(d.sal.w, aes(x = Antibiotics, y = Slope, fill = Antibiotics)) +
  geom_boxplot()
  # 1 No ABX
  # 1 ABX
ggplot(d.sal.p, aes(x = Antibiotics, y = Slope, fill = Antibiotics)) +
  geom_boxplot()
  # 1 No ABX
  # 1 ABX


### Boxplot - MaxD
ggplot(d.inu.s, aes(x = Antibiotics, y = MaxD, fill = Antibiotics)) +
  geom_boxplot()
ggplot(d.inu.w, aes(x = Antibiotics, y = MaxD, fill = Antibiotics)) +
  geom_boxplot()
ggplot(d.inu.p, aes(x = Antibiotics, y = MaxD, fill = Antibiotics)) +
  geom_boxplot()
  # 2 ABX
ggplot(d.sal.s, aes(x = Antibiotics, y = MaxD, fill = Antibiotics)) +
  geom_boxplot()
ggplot(d.sal.w, aes(x = Antibiotics, y = MaxD, fill = Antibiotics)) +
  geom_boxplot()
  # 1 No ABX
  # 2 ABX
ggplot(d.sal.p, aes(x = Antibiotics, y = MaxD, fill = Antibiotics)) +
  geom_boxplot()



### Boxplot - DNA Concentration
ggplot(dna.inu[which(dna.inu$Antibiotics == "No Antibiotics"),], aes(x = Season, y = DNA_Yield_.ng.mg., fill = Season)) +
  geom_boxplot()
ggplot(dna.inu[which(dna.inu$Antibiotics == "Antibiotics"),], aes(x = Season, y = DNA_Yield_.ng.mg., fill = Season)) +
  geom_boxplot()


ggplot(dna.inu.s, aes(x = Antibiotics, y = DNA_Yield_.ng.mg., fill = Antibiotics)) +
  geom_boxplot()
  # 1 ABX
ggplot(dna.inu.w, aes(x = Antibiotics, y = DNA_Yield_.ng.mg., fill = Antibiotics)) +
  geom_boxplot()
  # 1 No ABX
ggplot(dna.inu.p, aes(x = Antibiotics, y = DNA_Yield_.ng.mg., fill = Antibiotics)) +
  geom_boxplot()
  # 1 ABX
ggplot(dna.sal.s, aes(x = Antibiotics, y = DNA_Yield_.ng.mg., fill = Antibiotics)) +
  geom_boxplot()
  # 1 No ABX
ggplot(dna.sal.w, aes(x = Antibiotics, y = DNA_Yield_.ng.mg., fill = Antibiotics)) +
  geom_boxplot()
ggplot(dna.sal.p, aes(x = Antibiotics, y = DNA_Yield_.ng.mg., fill = Antibiotics)) +
  geom_boxplot()
  # 1 ABX
```
