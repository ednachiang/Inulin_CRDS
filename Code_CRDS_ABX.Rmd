---
title: "Code_TestABX"
author: "Edna Chiang"
date: "12/14/2021"
output: html_document
---
### Load Packages, scripts, and functions
```{r}
library(ggplot2)
library(plyr)
library(dplyr)
library(grid)
library(MESS)
library(pgirmess)
library(Bolstad2)
library(phyloseq)
library(psych)
library(car)
source('scripts/import_crds.R')
source('scripts/bin_crds.R')
source('scripts/misc.R')
source('scripts/calc_delta_metrics.R')
set.seed(1)
theme_set(theme_bw())

### Stats Notes
# Use 'subset' in kruskal.test
# Do NOT use 'subset' in kruskalmc or pairwise.wilcox.test; it doesn't work!
```

### Load Data
```{r}
crds <- import.crds('CSV', 'metadata.csv')
```

### Bin RelTime
```{r}
crds.bin <- bin.crds(crds)
```

### Summarize by Substrate + ABX
```{r}
### Remove Inulin outliers
#crds.rem <- crds.bin[-which(crds.bin$ID == "S34"),]
crds.rem <- crds.bin[-which(crds.bin$ID == "S37"),]
  # ABX didn't work; high [DNA]
crds.rem <- crds.rem[-which(crds.rem$ID == "P28"),]
#crds.rem <- crds.rem[-which(crds.rem$ID == "P30"),]

# Remove Saline outliers
#crds.rem <- crds.rem[-which(crds.rem$ID == "W26"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "W43"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "W50"),]

crds.rem$Season <- ordered(crds.rem$Season, levels=c("Summer", "Winter", "Spring"))


# Summarize
crds.sum <- crds.rem %>%
  group_by(Substrate, Antibiotics, Season, BinTime) %>%
  summarize(Y_Mean = mean(Delta),
            Y_Median = median(Delta),
            Y_SD = sd(Delta),
            Y_SE = se(Delta),
            Y_IQR = IQR(Delta),
            X_Mean = mean(RelTime),
            X_Median = median(RelTime),
            X_SD = sd(RelTime),
            X_SE = se(RelTime),
            X_IQR = IQR(RelTime),
            SampSize = n())
  # X_Mean is different from BinTime because BinTime was calculated with ABX and non-ABX combined
    # BinTime was calculated this way to make sure datapoints for all individuals will align together on x-axis. If datapoints are misaligned that can be confusing for the audience. So binning was done this way for the clearest visualization.
    # X_Mean is calculated for ABX and non-ABX separately, so there will be some variation
crds.sum$Season <- ordered(crds.sum$Season, levels=c("Summer", "Winter", "Spring"))
```

### Test baseline - ABX
```{r}
### Separate samples
crds.base <- crds.rem[which(crds.rem$RelTime < 0),]
base.inu <- crds.base[which(crds.base$Substrate == "Inulin"),]
base.sal <- crds.base[which(crds.base$Substrate == "Saline"),]
base.inu.s <- base.inu[which(base.inu$Season == "Summer"),]
base.inu.w <- base.inu[which(base.inu$Season == "Winter"),]
base.inu.p <- base.inu[which(base.inu$Season == "Spring"),]
base.sal.s <- base.sal[which(base.sal$Season == "Summer"),]
base.sal.w <- base.sal[which(base.sal$Season == "Winter"),]
base.sal.p <- base.sal[which(base.sal$Season == "Spring"),]


### Check Normality

# Inulin Summer
hist(base.inu.s$Delta)
qqnorm(base.inu.s$Delta)
qqline(base.inu.s$Delta)
shapiro.test(base.inu.s$Delta)
  # p-value = 0.1731
  # Normal

# Inulin Winter
hist(base.inu.w$Delta)
qqnorm(base.inu.w$Delta)
qqline(base.inu.w$Delta)
shapiro.test(base.inu.w$Delta)
  # p-value = 0.02846
  # Not Normal

# Inulin Spring
hist(base.inu.p$Delta)
qqnorm(base.inu.p$Delta)
qqline(base.inu.p$Delta)
shapiro.test(base.inu.p$Delta)
  # p-value = 0.2146
  # Normal

# Saline Summer
hist(base.sal.s$Delta)
qqnorm(base.sal.s$Delta)
qqline(base.sal.s$Delta)
shapiro.test(base.sal.s$Delta)
  # p-value = 0.1744
  # Normal

# Saline Winter
hist(base.sal.w$Delta)
qqnorm(base.sal.w$Delta)
qqline(base.sal.w$Delta)
shapiro.test(base.sal.w$Delta)
  # p-value = 0.2759
  # Normal

# Saline Spring
hist(base.sal.p$Delta)
qqnorm(base.sal.p$Delta)
qqline(base.sal.p$Delta)
shapiro.test(base.sal.p$Delta)
  # p-value = 0.2234
  # Normal


### Test Inulin
# Summer
t.test(Delta ~ Antibiotics, data = base.inu.s)
  # p-value = 0.3149
  # adj p = 0.47235
# Winter
wilcox.test(Delta ~ Antibiotics, data = base.inu.w)
  # p-value = 0.62
  # adj p = 0.744
# Spring
t.test(Delta ~ Antibiotics, data = base.inu.p)
  # p-value = 0.0001459*
  # adj P = 0.0008754
### Test Saline
# Summer
t.test(Delta ~ Antibiotics, data = base.sal.s)
  # p-value = 0.2038
  # adj p = 0.47235
# Winter
t.test(Delta ~ Antibiotics, data = base.sal.w)
  # p-value = 0.9782
  # adj p = 0.978
# Spring
t.test(Delta ~ Antibiotics, data = base.sal.p)
  # p-value = 0.2762
  # adj p = 0.4723500
p.adjust(c(0.3149, 0.62, 0.0001459, 0.2038, 0.9782, 0.2762), method = "BH")
  # 0.4723500 0.7440000 0.0008754 0.4723500 0.9782000 0.4723500



## Test Baseline Variance
# Inulin
fligner.test(Delta ~ Antibiotics, base.inu.s)
  # p-value = 0.9936
  # adj p = 0.9936
var.test(Delta ~ Antibiotics, base.inu.w)
  # p-value = 0.2023
  # adj p = 0.4046
fligner.test(Delta ~ Antibiotics, base.inu.p)
  # p-value = 0.0981
  # adj p = 0.2943

# Saline
fligner.test(Delta ~ Antibiotics, base.sal.s)
  # p-value = 0.8791
  # adj p = 0.9936
fligner.test(Delta ~ Antibiotics, base.sal.w)
  # p-value = 0.0502
  # 0.2943
fligner.test(Delta ~ Antibiotics, base.sal.p)
  # p-value = 0.9257
  # adj p = 0.9936

p.adjust(c(0.9936, 0.2023, 0.0981, 0.8791, 0.0502, 0.9257), method = "BH")
  # 0.9936 0.4046 0.2943 0.9936 0.2943 0.9936
```

### Calculate Delta Metrics
```{r}
# Calculate delta metrics
d.metrics <- calc.delta.metrics(crds.rem)
#write.csv(d.metrics, "delta_metrics.csv", row.names = F)

# Load metadata
meta <- read.csv('metadata.csv', fileEncoding="UTF-8-BOM")

# Add metadata to delta metrics
d.metrics[,colnames(meta)[3:12]] <- NA
for(sq in 1:nrow(d.metrics)){
  meta.row <- which(meta$ID == d.metrics$ID[sq])
  d.metrics[sq, 6:15] <- meta[meta.row, 3:12]
}

# Convert to numeric
d.metrics$MaxD <- as.numeric(d.metrics$MaxD)
d.metrics$TimeMaxD <- as.numeric(d.metrics$TimeMaxD)
d.metrics$Slope <- as.numeric(d.metrics$Slope)
d.metrics$SlopeTime <- as.numeric(d.metrics$SlopeTime)

# Order seasons
d.metrics$Season <- ordered(d.metrics$Season, levels=c("Summer", "Winter", "Spring"))

# Separate substrates
d.inu <- d.metrics[which(d.metrics$Substrate == "Inulin"),]
d.sal <- d.metrics[which(d.metrics$Substrate == "Saline"),]

# Separate seasons
d.inu.s <- d.inu[which(d.inu$Season == "Summer"),]
d.inu.w <- d.inu[which(d.inu$Season == "Winter"),]
d.inu.p <- d.inu[which(d.inu$Season == "Spring"),]
d.sal.s <- d.sal[which(d.sal$Season == "Summer"),]
d.sal.w <- d.sal[which(d.sal$Season == "Winter"),]
d.sal.p <- d.sal[which(d.sal$Season == "Spring"),]
```


### Test Max Slope
```{r}
### Test for normality

# Inulin Summer
hist(d.inu.s$Slope)
qqnorm(d.inu.s$Slope)
qqline(d.inu.s$Slope)
shapiro.test(d.inu.s$Slope)
  # p-value = 0.03485
  # Not Normal

# Inulin Winter
hist(d.inu.w$Slope)
qqnorm(d.inu.w$Slope)
qqline(d.inu.w$Slope)
shapiro.test(d.inu.w$Slope)
  # p-value = 0.01216
  # Not Normal

# Inulin Spring
hist(d.inu.p$Slope)
qqnorm(d.inu.p$Slope)
qqline(d.inu.p$Slope)
shapiro.test(d.inu.p$Slope)
  # p-value = 0.01576
  # Not Normal

# Saline Summer
hist(d.sal.s$Slope)
qqnorm(d.sal.s$Slope)
qqline(d.sal.s$Slope)
shapiro.test(d.sal.s$Slope)
  # p-value = 0.000127
  # Not Normal

# Saline Winter
hist(d.sal.w$Slope)
qqnorm(d.sal.w$Slope)
qqline(d.sal.w$Slope)
shapiro.test(d.sal.w$Slope)
  # p-value = 2.073e-05
  # Not Normal

# Saline Spring
hist(d.sal.p$Slope)
qqnorm(d.sal.p$Slope)
qqline(d.sal.p$Slope)
shapiro.test(d.sal.p$Slope)
  # p-value = 0.1736
  # Normal


### Test Inulin
# Summer
wilcox.test(Slope ~ Antibiotics, data = d.inu.s)
  # p-value = 0.001166*
  # adj p = 0.003498*
# Winter
wilcox.test(Slope ~ Antibiotics, data = d.inu.w)
  # p-value = 0.02622*
  # adj p = 0.052440
# Spring
wilcox.test(Slope ~ Antibiotics, data = d.inu.p)
  # p-value = 0.001166*
  # adj p = 0.003498

### Test Saline
# Summer
wilcox.test(Slope ~ Antibiotics, data = d.sal.s)
  # p-value = 0.4452
  # adj p = 0.6282
# Winter
wilcox.test(Slope ~ Antibiotics, data = d.sal.w)
  # p-value = 0.6282
  # adj p = 0.6282
# Spring
t.test(Slope ~ Antibiotics, data = d.sal.p)
  # p-value = 0.6071
  # adj p = 0.6282

p.adjust(c(0.001166, 0.02622, 0.001166, 0.4452, 0.6282, 0.6071), method = "BH")
  # 0.003498 0.052440 0.003498 0.628200 0.628200 0.628200



## Test Slope Variance
# Inulin
fligner.test(Slope ~ Antibiotics, d.inu.s)
  # p-value = 0.05126
  # adj p = 0.16878
fligner.test(Slope ~ Antibiotics, d.inu.w)
  # p-value = 0.08439
  # adj p = 0.16878
fligner.test(Slope ~ Antibiotics, d.inu.p)
  # p-value = 0.06578
  # adj p = 0.16878

# Saline
fligner.test(Slope ~ Antibiotics, d.sal.s)
  # p-value = 0.1186
  # adj p = 0.1779
fligner.test(Slope ~ Antibiotics, d.sal.w)
  # p-value = 0.9316
  # adj p = 0.9316
var.test(Slope ~ Antibiotics, d.sal.p)
  # p-value = 0.3398
  # p adj = 0.40776

p.adjust(c(0.05126, 0.08439, 0.06578, 0.1186, 0.9316, 0.3398), method = "BH")
  # p-value = 0.16878 0.16878 0.16878 0.17790 0.93160 0.40776
```

### Test SlopeTime
```{r}
### Test for normality

# Inulin Summer
hist(d.inu.s$SlopeTime)
qqnorm(d.inu.s$SlopeTime)
qqline(d.inu.s$SlopeTime)
shapiro.test(d.inu.s$SlopeTime)
  # p-value = 0.3354
  # Normal

# Inulin Winter
hist(d.inu.w$SlopeTime)
qqnorm(d.inu.w$SlopeTime)
qqline(d.inu.w$SlopeTime)
shapiro.test(d.inu.w$SlopeTime)
  # p-value = 0.004898
  # Not Normal

# Inulin Spring
hist(d.inu.p$SlopeTime)
qqnorm(d.inu.p$SlopeTime)
qqline(d.inu.p$SlopeTime)
shapiro.test(d.inu.p$SlopeTime)
  # p-value = 0.03859
  # Not Normal

# Saline Summer
hist(d.sal.s$SlopeTime)
qqnorm(d.sal.s$SlopeTime)
qqline(d.sal.s$SlopeTime)
shapiro.test(d.sal.s$SlopeTime)
  # p-value = 0.1082
  # Normal

# Saline Winter
hist(d.sal.w$SlopeTime)
qqnorm(d.sal.w$SlopeTime)
qqline(d.sal.w$SlopeTime)
shapiro.test(d.sal.w$SlopeTime)
  # p-value = 0.2088
  # Normal

# Saline Spring
hist(d.sal.p$SlopeTime)
qqnorm(d.sal.p$SlopeTime)
qqline(d.sal.p$SlopeTime)
shapiro.test(d.sal.p$SlopeTime)
  # p-value = 0.4747
  # Normal


### Test Inulin

t.test(SlopeTime ~ Antibiotics, data = d.inu.s)
  # p-value = 0.6313
  # adj P = 0.6747000
wilcox.test(SlopeTime ~ Antibiotics, data = d.inu.w)
  # p-value = 0.0005828*
  # adj P = 0.0034968
wilcox.test(SlopeTime ~ Antibiotics, data = d.inu.p)
  # p-value = 0.01826*
  # adj P = 0.0547800


### Test Saline
# Summer
t.test(SlopeTime ~ Antibiotics, data = d.sal.s)
  # p-value = 0.5457
  # adj P = 0.6747000
# Winter
t.test(SlopeTime ~ Antibiotics, data = d.sal.w)
  # p-value = 0.5459
  # adj P = 0.6747000
# Spring
t.test(SlopeTime ~ Antibiotics, data = d.sal.p)
  # p-value = 0.6747
  # adj P = 0.6747000

p.adjust(c(0.6313, 0.0005828, 0.01826, 0.5457, 0.5459, 0.6747), "BH")
  # 0.6747000 0.0034968 0.0547800 0.6747000 0.6747000 0.6747000



## Test SlopeTime Variance
# Inulin
var.test(SlopeTime ~ Antibiotics, d.inu.s)
  # p-value = 0.02056*
  # adj P = 0.06168
fligner.test(SlopeTime ~ Antibiotics, d.inu.w)
  # p-value = 0.01802*
  # adj P = 0.06168
fligner.test(SlopeTime ~ Antibiotics, d.inu.p)
  # p-value = 0.5442
  # adj P = 0.81630

# Saline
var.test(SlopeTime ~ Antibiotics, d.sal.s)
  # p-value = 0.7846
  # adj P = 0.90760
var.test(SlopeTime ~ Antibiotics, d.sal.w)
  # p-value = 0.1833
  # adj P = 0.36660
var.test(SlopeTime ~ Antibiotics, d.sal.p)
  # p-value = 0.9076
  # adj P = 0.90760


p.adjust(c(0.02056, 0.01802, 0.5442, 0.7846, 0.1833, 0.9076), "BH")
  # 0.06168 0.06168 0.81630 0.90760 0.36660 0.90760
```



### Test MaxD
```{r}
### Test for normality

# Inulin Summer
hist(d.inu.s$MaxD)
qqnorm(d.inu.s$MaxD)
qqline(d.inu.s$MaxD)
shapiro.test(d.inu.s$MaxD)
  # p-value = 0.06959
  # Normal

# Inulin Winter
hist(d.inu.w$MaxD)
qqnorm(d.inu.w$MaxD)
qqline(d.inu.w$MaxD)
shapiro.test(d.inu.w$MaxD)
  # p-value = 0.001098
  # Not Normal

# Inulin Spring
hist(d.inu.p$MaxD)
qqnorm(d.inu.p$MaxD)
qqline(d.inu.p$MaxD)
shapiro.test(d.inu.p$MaxD)
  # p-value = 0.008604
  # Not Normal

# Saline Summer
hist(d.sal.s$MaxD)
qqnorm(d.sal.s$MaxD)
qqline(d.sal.s$MaxD)
shapiro.test(d.sal.s$MaxD)
  # p-value = 2.311e-05
  # Not Normal

# Saline Winter
hist(d.sal.w$MaxD)
qqnorm(d.sal.w$MaxD)
qqline(d.sal.w$MaxD)
shapiro.test(d.sal.w$MaxD)
  # p-value = 5.211e-06
  # Not Normal

# Saline Spring
hist(d.sal.p$MaxD)
qqnorm(d.sal.p$MaxD)
qqline(d.sal.p$MaxD)
shapiro.test(d.sal.p$MaxD)
  # p-value = 0.01185
  # Not Normal


### Test Inulin

t.test(MaxD ~ Antibiotics, data = d.inu.s)
  # p-value = 0.0004686*
  # adj P = 0.0028116*
wilcox.test(MaxD ~ Antibiotics, data = d.inu.w)
  # p-value = 0.006993*
  # adj P = 0.0139860*
wilcox.test(MaxD ~ Antibiotics, data = d.inu.p)
  # p-value = 0.001166*
  # adj P = 0.0034980*


### Test Saline
# Summer
wilcox.test(MaxD ~ Antibiotics, data = d.sal.s)
  # p-value = 0.1627
  # adj P = 0.1952400
# Winter
wilcox.test(MaxD ~ Antibiotics, data = d.sal.w)
  # p-value = 0.06136
  # adj P = 0.0920400
# Spring
wilcox.test(MaxD ~ Antibiotics, data = d.sal.p)
  # p-value = 0.9427
  # adj P = 0.9427000

p.adjust(c(0.0004686, 0.006993, 0.001166, 0.1627, 0.06136, 0.9427), "BH")
  # 0.0028116 0.0139860 0.0034980 0.1952400 0.0920400 0.9427000



## Test MaxD Variance
# Inulin
var.test(MaxD ~ Antibiotics, d.inu.s)
  # p-value = 0.0003629*
  # adj P = 0.0021774*
fligner.test(MaxD ~ Antibiotics, d.inu.w)
  # p-value = 0.03219*
  # adj P = 0.0482850*
fligner.test(MaxD ~ Antibiotics, d.inu.p)
  # p-value = 0.02858*
  # adj P = 0.0482850*

# Saline
fligner.test(MaxD ~ Antibiotics, d.sal.s)
  # p-value = 0.003496*
  # adj P = 0.0104880*
fligner.test(MaxD ~ Antibiotics, d.sal.w)
  # p-value = 0.2361
  # adj P = 0.2833200
fligner.test(MaxD ~ Antibiotics, d.sal.p)
  # p-value = 0.9384
  # adj P = 0.9384000


p.adjust(c(0.0003629, 0.03219, 0.02858, 0.003496, 0.2361, 0.9384), "BH")
  # 0.0021774 0.0482850 0.0482850 0.0104880 0.2833200 0.9384000
```



### Test TimeMaxD
```{r}
### Test for normality

# Inulin Summer
hist(d.inu.s$TimeMaxD)
qqnorm(d.inu.s$TimeMaxD)
qqline(d.inu.s$TimeMaxD)
shapiro.test(d.inu.s$TimeMaxD)
  # p-value = 0.01215
  # Not Normal

# Inulin Winter
hist(d.inu.w$TimeMaxD)
qqnorm(d.inu.w$TimeMaxD)
qqline(d.inu.w$TimeMaxD)
shapiro.test(d.inu.w$TimeMaxD)
  # p-value = 0.01511
  # Not Normal

# Inulin Spring
hist(d.inu.p$TimeMaxD)
qqnorm(d.inu.p$TimeMaxD)
qqline(d.inu.p$TimeMaxD)
shapiro.test(d.inu.p$TimeMaxD)
  # p-value = 0.0408
  # Not Normal

# Saline Summer
hist(d.sal.s$TimeMaxD)
qqnorm(d.sal.s$TimeMaxD)
qqline(d.sal.s$TimeMaxD)
shapiro.test(d.sal.s$TimeMaxD)
  # p-value = 0.04462
  # Not Normal

# Saline Winter
hist(d.sal.w$TimeMaxD)
qqnorm(d.sal.w$TimeMaxD)
qqline(d.sal.w$TimeMaxD)
shapiro.test(d.sal.w$TimeMaxD)
  # p-value = 0.01351
  # Not Normal

# Saline Spring
hist(d.sal.p$TimeMaxD)
qqnorm(d.sal.p$TimeMaxD)
qqline(d.sal.p$TimeMaxD)
shapiro.test(d.sal.p$TimeMaxD)
  # p-value = 0.2392
  # Normal


### Test Inulin

wilcox.test(TimeMaxD ~ Antibiotics, data = d.inu.s)
  # p-value = 0.001166*
  # adj P = 0.003498*
wilcox.test(TimeMaxD ~ Antibiotics, data = d.inu.w)
  # p-value = 0.00326*
  # adj P = 0.006400*
wilcox.test(TimeMaxD ~ Antibiotics, data = d.inu.p)
  # p-value = 0.001166*
  # adj P = 0.003498*


### Test Saline
wilcox.test(TimeMaxD ~ Antibiotics, data = d.sal.s)
  # p-value = 0.05346
  # adj P = 0.064152
wilcox.test(TimeMaxD ~ Antibiotics, data = d.sal.w)
  # p-value = 0.042*
  # adj P = 0.063000
t.test(TimeMaxD ~ Antibiotics, data = d.sal.p)
  # p-value = 0.8299
  # adj P = 0.829900

p.adjust(c(0.001166, 0.0032, 0.001166, 0.05346, 0.042, 0.8299), "BH")
  # 0.003498 0.006400 0.003498 0.064152 0.063000 0.829900



## Test TimeMaxD Variance
# Inulin
fligner.test(TimeMaxD ~ Antibiotics, d.inu.s)
  # p-value = 0.8986
  # adj P = 0.8986
fligner.test(TimeMaxD ~ Antibiotics, d.inu.w)
  # p-value = 0.2142
  # adj P = 0.3339
fligner.test(TimeMaxD ~ Antibiotics, d.inu.p)
  # p-value = 0.1445
  # adj P = 0.3339

# Saline
fligner.test(TimeMaxD ~ Antibiotics, d.sal.s)
  # p-value = 0.2226
  # adj P = 0.3339
fligner.test(TimeMaxD ~ Antibiotics, d.sal.w)
  # p-value = 0.1231
  # adj P = 0.3339
var.test(TimeMaxD ~ Antibiotics, d.sal.p)
  # p-value = 0.8626
  # adj P = 0.8986


p.adjust(c(0.8986, 0.2142, 0.1445, 0.2226, 0.1231, 0.8626), "BH")
  # 0.8986 0.3339 0.3339 0.3339 0.3339 0.8986
```



### Calculate AUC
```{r}
# AUC = Area Under Curve
# Trapezoid Method

### Calculate AUC
ids <- unique(crds.rem$ID)
auc.df <- data.frame(crds.rem[1,])
auc.df <- auc.df[,-2:-3]
  # Remove Delta and CO2 cols
auc.df <- auc.df[,-13]
  # Remove BinTime col
colnames(auc.df) <- c("AUC", "Number", "ID", "Season", "Sex", "Antibiotics", "Substrate", "Diet", "Mom", "Mom_Location", "BodyMass", "BodyTemp")
auc.df$Ketones <- NA
  # Rename cols
meta <- read.csv('metadata.csv', fileEncoding="UTF-8-BOM")

#crds.rem= crds.bin
# First normalize Rel Time so 
#for (i in 2){
for (i in 1:length(ids)){
  ID <- ids[i]
  select <- crds.rem[which(crds.rem$ID == ID),]
    # Dataframe with CRDS values for 1 squirrel

  # Normalize delta value to baseline
  select$Delta <- select$Delta - select$Delta[1]
  
  # Remove baseline from AUC calculation because we care about the AUC after gavage
  # Since we already normalized delta value to baseline, we don't need that value anymore
  # Set baseline to gavage time = 0
  select[1,1] <- 0
  
  # Normalize AUC end time
  # Since length of experiment varies for each individual, we don't want experimental length to bias our AUC calculations
  # Normalize length to min time within each substrate
    # Inu = 4.0667
    # Sal = 2.21667
  if (select$Substrate == "Inulin") {
    max <- which(select$RelTime > 4.06667)
    select$RelTime[max] <- 4.06667
  } else if (select$Substrate == "Saline") {
    max <- which(select$RelTime > 2.21666667)
    select$RelTime[max] <- 2.21666667
  }

  # Create auc variable
  AUC <- 0
  
  # Run rectangle method integration - less accurate
  #for (j in 1:(nrow(select)-1)){
  #  AUC <- AUC + ((select$RelTime[j+1]-select$RelTime[j])*select$Delta[j+1])
  #}
  
  # Run trapezoid method integration - more accurate
  for(j in 1:(nrow(select)-1)){
    avgH <- (select$Delta[j+1]+select$Delta[j])/2
      # Calculates average height between start and end point
    width <- (select$RelTime[j+1]-select$RelTime[j])
    AUC <- AUC + (avgH*width)
  }
    
  auc.df[i,1] <- AUC
  auc.df[i, 2:12] <- select[1, 4:14]
  
  use <- which(meta$ID == ID)
  auc.df$Ketones[i] <- meta$Ketones[use]
}

#write.csv(auc.df, "auc.csv", row.names=F)


### Subset by Substrate & ABX
auc.inu <- auc.df[which(auc.df$Substrate == "Inulin"),]
auc.sal <- auc.df[which(auc.df$Substrate == "Saline"),]
auc.inu.s <- auc.inu[which(auc.inu$Season == "Summer"),]
auc.inu.w <- auc.inu[which(auc.inu$Season == "Winter"),]
auc.inu.p <- auc.inu[which(auc.inu$Season == "Spring"),]
auc.sal.s <- auc.sal[which(auc.sal$Season == "Summer"),]
auc.sal.w <- auc.sal[which(auc.sal$Season == "Winter"),]
auc.sal.p <- auc.sal[which(auc.sal$Season == "Spring"),]
```

### AUC Stats & Plots
```{r}
### Check Normality

# Inulin Summer
hist(auc.inu.s$AUC)
qqnorm(auc.inu.s$AUC)
qqline(auc.inu.s$AUC)
shapiro.test(auc.inu.s$AUC)
  # p-value = 0.0261
  # Not Normal

# Inulin Winter
hist(auc.inu.w$AUC)
qqnorm(auc.inu.w$AUC)
qqline(auc.inu.w$AUC)
shapiro.test(auc.inu.w$AUC)
  # p-value = 0.001438
  # Not Normal

# Inulin Spring
hist(auc.inu.p$AUC)
qqnorm(auc.inu.p$AUC)
qqline(auc.inu.p$AUC)
shapiro.test(auc.inu.p$AUC)
  # p-value = 0.002582
  # Not Normal

# Saline Summer
hist(auc.sal.s$AUC)
qqnorm(auc.sal.s$AUC)
qqline(auc.sal.s$AUC)
shapiro.test(auc.sal.s$AUC)
  # p-value = 0.01462
  # Not Normal

# Saline Winter
hist(auc.sal.w$AUC)
qqnorm(auc.sal.w$AUC)
qqline(auc.sal.w$AUC)
shapiro.test(auc.sal.w$AUC)
  # p-value = 0.04773
  # Not Normal

# Saline Spring
hist(auc.sal.p$AUC)
qqnorm(auc.sal.p$AUC)
qqline(auc.sal.p$AUC)
shapiro.test(auc.sal.p$AUC)
  # p-value = 0.7142
  # Normal



### Test AUC - ABX
# Inulin
wilcox.test(AUC ~ Antibiotics, data = auc.inu.s)
  # p-value = 0.001166*
  # adj p = 0.006993
wilcox.test(AUC ~ Antibiotics, data = auc.inu.w)
  # p-value = 0.09732
  # adj p = 0.121680
wilcox.test(AUC ~ Antibiotics, data = auc.inu.p)
  # p-value = 0.002331*
  # adj p = 0.006993

# Saline
wilcox.test(AUC ~ Antibiotics, data = auc.sal.s)
  # p-value = 0.1014
  # adj p = 0.121680
wilcox.test(AUC ~ Antibiotics, data = auc.sal.w)
  # p-value = 0.0303
  # adj p = 0.060600
wilcox.test(AUC ~ Antibiotics, data = auc.sal.p)
  # p-value = 0.366
  # adj p = 0.366000

p.adjust(c(0.001166, 0.09732, 0.002331, 0.1014, 0.0303, 0.366), method = "BH")
  # 0.006993 0.121680 0.006993 0.121680 0.060600 0.366000



## Test AUC Variance - ABX
# Inulin
fligner.test(AUC ~ Antibiotics, auc.inu.s)
  # p-value = 0.2125
  # adj p = 0.2682
fligner.test(AUC ~ Antibiotics, auc.inu.w)
  # p-value = 0.01802*
  # adj p = 0.08574
fligner.test(AUC ~ Antibiotics, auc.inu.p)
  # p-value = 0.02858*
  # adj p = 0.08574

# Saline
fligner.test(AUC ~ Antibiotics, auc.sal.s)
  # p-value = 0.2235
  # adj p = 0.2682
fligner.test(AUC ~ Antibiotics, auc.sal.w)
  # p-value = 0.5236
  # adj p = 0.5236
fligner.test(AUC ~ Antibiotics, auc.sal.p)
  # p-value = 0.0888
  # adj p = 0.1776

p.adjust(c(0.2125, 0.01802, 0.02858, 0.2235, 0.5236, 0.0888), method = "BH")
  # 0.26820 0.08574 0.08574 0.26820 0.52360 0.17760
```



### Hib Dates
```{r}
### Load data ###

# Dates
dates <- read.csv('metadata_dates.csv')
dates_use <- dates[-which(dates$Season == "Summer"),]
rownames(dates_use) <- 1:nrow(dates_use)
dates_use <- dates_use[-13:-28,]
rownames(dates_use) <- 1:nrow(dates_use)
dates_use <- dates_use[-33:-40,]
dates_use <- dates_use[-3,]
  # Remove outlier P04

# Add d metrics + AUC
for(k in 1:nrow(dates_use)){
  ID <- dates_use$ID[k]
  rowUse <- which(d.metrics$ID == ID)
  dates_use$Slope[k] <- d.metrics$Slope[rowUse]
  rowUse2 <- which(auc.df$ID == ID)
  dates_use$AUC[k] <- auc.df$AUC[rowUse2]
}
  
# Separate by Season
dates.spr <- dates_use[which(dates_use$ Season == "Spring"),]
dates.win <- dates_use[which(dates_use$ Season == "Winter"),]



### Test normality ###

# Spring
hist(dates.spr$Days_Hib)
qqnorm(dates.spr$Days_Hib)
qqline(dates.spr$Days_Hib)
shapiro.test(dates.spr$Days_Hib)
  # p-value = 0.4172
  # Normal
hist(dates.spr$IBA.Hib)
qqnorm(dates.spr$IBA.Hib)
qqline(dates.spr$IBA.Hib)
shapiro.test(dates.spr$IBA.Hib)
  # p-value = 0.8294
  # Normal
hist(dates.spr$Num_IBA)
qqnorm(dates.spr$Num_IBA)
qqline(dates.spr$Num_IBA)
shapiro.test(dates.spr$Num_IBA)
  # p-value = 0.401
  # Normal

# Winter
hist(dates.win$Days_Hib)
qqnorm(dates.win$Days_Hib)
qqline(dates.win$Days_Hib)
shapiro.test(dates.win$Days_Hib)
  # p-value = 0.1513
  # Normal
hist(dates.win$IBA.Hib)
qqnorm(dates.win$IBA.Hib)
qqline(dates.win$IBA.Hib)
shapiro.test(dates.win$IBA.Hib)
  # p-value = 0.9897
  # Normal
hist(dates.win$Num_IBA)
qqnorm(dates.win$Num_IBA)
qqline(dates.win$Num_IBA)
shapiro.test(dates.win$Num_IBA)
  # p-value = 0.2462
  # Normal



### Test ABX within Season ###

# Spring
t.test(Days_Hib ~ Antibiotics, dates.spr)
  # p-value = 0.2672
t.test(IBA.Hib ~ Antibiotics, dates.spr)
  # p-value = 9.588
t.test(Num_IBA ~ Antibiotics, dates.spr)
  # p-value = 0.4637

# Spring variance
leveneTest(Days_Hib ~ Antibiotics, dates.spr)
  # p-value = 0.8931
leveneTest(IBA.Hib ~ Antibiotics, dates.spr)
  # p-value = 0.5261
leveneTest(Num_IBA ~ Antibiotics, dates.spr)
  # p-value = 0.3318



# Winter
t.test(Days_Hib ~ Antibiotics, dates.win)
  # p-value = 0.0006263*
t.test(IBA.Hib ~ Antibiotics, dates.win)
  # p-value = 0.4635
t.test(Num_IBA ~ Antibiotics, dates.win)
  # p-value = 0.2693

# Winter variance
leveneTest(Days_Hib ~ Antibiotics, dates.win)
  # p-value = 0.6559
leveneTest(IBA.Hib ~ Antibiotics, dates.win)
  # p-value = 0.2451
leveneTest(Num_IBA ~ Antibiotics, dates.win)
  # p-value = 0.7173
```
