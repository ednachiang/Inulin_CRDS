---
title: "Code_TestABX"
author: "Edna Chiang"
date: "12/14/2021"
output: html_document
---
### Load Packages, scripts, and functions
```{r}
library(ggplot2)
library(plyr)
library(dplyr)
library(grid)
library(MESS)
library(pgirmess)
library(Bolstad2)
library(phyloseq)
library(psych)
library(car)
source('scripts/misc.R')
set.seed(1)
theme_set(theme_bw())
```

### Load Data
```{r}
load('crds.norm.RData')
load('crds.use.Rdata')
meta <- read.csv('metadata.csv')
```

### Prepare CRDS data
```{r}
# Add metadata
crds.use[, colnames(meta)[3:ncol(meta)]] <- NA
for(i in 1:nrow(crds.use)){
  meta.row <- which(meta$ID == crds.use$ID[i])
  crds.use[i, 7:ncol(crds.use)] <- meta[meta.row, 3:ncol(meta)]
}

# Calculate square root of AUC
crds.use$AUC <- as.numeric(crds.use$AUC)
minAUC <- min(crds.use$AUC)
crds.use$MaxD <- crds.use$AUC + (minAUC * -1)
crds.use$MaxD <- sqrt(crds.use$MaxD)

# Convert to numeric
crds.use$AvgDelta <- as.numeric(crds.use$AvgDelta)
crds.use$MaxD <- as.numeric(crds.use$MaxD)
crds.use$MaxSlope <- as.numeric(crds.use$MaxSlope)
crds.use$AUC <- as.numeric(crds.use$AUC)
crds.use$MaxD <- as.numeric(crds.use$MaxD)
crds.use$Baseline <- as.numeric(crds.use$Baseline)

# Order categorical variables
crds.use$Season <- ordered(crds.use$Season, levels = c("Summer", "Winter", "Spring"))
crds.use$Sex <- ordered(crds.use$Sex, levels = c("Female", "Male"))
crds.use$Antibiotics <- ordered(crds.use$Antibiotics, levels = c("No", "Yes"))
crds.use$Substrate <- ordered(crds.use$Substrate, levels = c("Inulin", "Saline"))
crds.use$Diet <- ordered(crds.use$Diet, levels = c("1", "2"))

# Remove outliers
crds.rem <- crds.use[-which(crds.use$ID == "S23"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "S37"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "S60"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "W43"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "W20"),]
  # This is due to odd metagenome
crds.rem <- crds.rem[-which(crds.rem$ID == "W50"),]

# Separate by substrate
crds.inu <- crds.rem[which(crds.rem$Substrate == "Inulin"),]
crds.sal <- crds.rem[which(crds.rem$Substrate == "Saline"),]

# Separate by substrate + season
crds.inu.s <- crds.inu[which(crds.inu$Season == "Summer"),]
crds.inu.w <- crds.inu[which(crds.inu$Season == "Winter"),]
crds.inu.p <- crds.inu[which(crds.inu$Season == "Spring"),]
crds.sal.s <- crds.sal[which(crds.sal$Season == "Summer"),]
crds.sal.w <- crds.sal[which(crds.sal$Season == "Winter"),]
crds.sal.p <- crds.sal[which(crds.sal$Season == "Spring"),]
```


### Test baseline
```{r}
### Inulin ###

# Summer
res <- resid(lm(Baseline ~ Antibiotics, crds.inu.s))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(Baseline ~ Antibiotics, crds.inu.s))
  # p = 0.0953
var.test(Baseline ~ Antibiotics, crds.inu.s)
  # p = 0.2

# Winter
res <- resid(lm(Baseline ~ Antibiotics, crds.inu.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(Baseline ~ Antibiotics, crds.inu.w))
  # p = 0.695
var.test(Baseline ~ Antibiotics, crds.inu.w)
  # p = 0.7374

# Spring
res <- resid(lm(Baseline ~ Antibiotics, crds.inu.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(Baseline ~ Antibiotics, crds.inu.p))
  # p = 2.48e-05
var.test(Baseline ~ Antibiotics, crds.inu.p)
  # p = 0.2246




### Saline ###

# Summer
res <- resid(lm(Baseline ~ Antibiotics, crds.sal.s))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(Baseline ~ Antibiotics, crds.sal.s))
  # p = 0.179
var.test(Baseline ~ Antibiotics, crds.sal.s)
  # p = 0.0501

# Winter
res <- resid(lm(Baseline ~ Antibiotics, crds.sal.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(Baseline ~ Antibiotics, crds.sal.w))
  # p = 0.402
var.test(Baseline ~ Antibiotics, crds.sal.w)
  # p = 0.02823

# Spring
res <- resid(lm(Baseline ~ Antibiotics, crds.sal.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(Baseline ~ Antibiotics, crds.sal.p))
  # p = 0.281
var.test(Baseline ~ Antibiotics, crds.sal.p)
  # p = 0.784

# ANOVA
p.adjust(c(0.0953, 0.695, 2.48e-05, 0.179, 0.402, 0.281), "BH")
  # Inulin Summer = 0.2859000
  # Inulin Winter = 0.6950000 
  # Inulin Spring = 0.0001488*
  # Saline Summer = 0.3580000
  # Saline Winter = 0.4824000
  # Saline Spring = 0.4215000

# F test
p.adjust(c(0.2, 0.7374, 0.2246, 0.0501, 0.02823, 0.784), "BH")
  # Inulin Summer = 0.3369
  # Inulin Winter = 0.7840
  # Inulin Spring = 0.3369
  # Saline Summer = 0.1503
  # Saline Winter = 0.1503
  # Saline Spring = 0.7840

```


### Test MaxD
```{r}
### Inulin ###

# Summer
res <- resid(lm(MaxD ~ Antibiotics, crds.inu.s))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(MaxD ~ Antibiotics, crds.inu.s))
  # p = 0.000331
var.test(MaxD ~ Antibiotics, crds.inu.s)
  # p = 0.01174

# Winter
res <- resid(lm(MaxD ~ Antibiotics, crds.inu.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p = 0.02794
  # Not Normal
kruskal.test(MaxD ~ Antibiotics, crds.inu.w)
  # p = 0.1102
fligner.test(MaxD ~ Antibiotics, crds.inu.w)
  # p = 0.01802

# Spring
res <- resid(lm(MaxD ~ Antibiotics, crds.inu.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(MaxD ~ Antibiotics, crds.inu.p))
  # p = 0.000914
var.test(MaxD ~ Antibiotics, crds.inu.p)
  # p = 0.0004868




### Saline ###

# Summer
res <- resid(lm(MaxD ~ Antibiotics, crds.sal.s))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(MaxD ~ Antibiotics, crds.sal.s))
  # p = 0.0148
var.test(MaxD ~ Antibiotics, crds.sal.s)
  # p = 0.03738

# Winter
res <- resid(lm(MaxD ~ Antibiotics, crds.sal.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p = 0.002705
  # Not Normal
kruskal.test(MaxD ~ Antibiotics, crds.sal.w)
  # p = 0.01762
fligner.test(MaxD ~ Antibiotics, crds.sal.w)
  # p = 0.7543

# Spring
res <- resid(lm(MaxD ~ Antibiotics, crds.sal.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(MaxD ~ Antibiotics, crds.sal.p))
  # p = 0.753
var.test(MaxD ~ Antibiotics, crds.sal.p)
  # p = 0.1693

# ANOVA
p.adjust(c(0.000331, 0.1102, 0.000914, 0.0148, 0.01762, 0.753), "BH")
  # Inulin Summer = 0.01174*
  # Inulin Winter = 0.01802*
  # Inulin Spring = 0.0004868*
  # Saline Summer = 0.03738*
  # Saline Winter = 0.7543
  # Saline Spring = 0.1693

# F test
p.adjust(c(0.01174, 0.01802, 0.0004868, 0.03738, 0.7543, 0.1693), "BH")
  # Inulin Summer = 0.03522
  # Inulin Winter = 0.03604
  # Inulin Spring = 0.0029208 
  # Saline Summer = 0.05607
  # Saline Winter = 0.7543
  # Saline Spring = 0.20316

```


### Test MaxD
```{r}
### Inulin ###

# Summer
res <- resid(lm(MaxD ~ Antibiotics, crds.inu.s))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(MaxD ~ Antibiotics, crds.inu.s))
  # p = 0.00199
var.test(MaxD ~ Antibiotics, crds.inu.s)
  # p = 0.0004015

# Winter
res <- resid(lm(MaxD ~ Antibiotics, crds.inu.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p = 0.02108
  # Not Normal
kruskal.test(MaxD ~ Antibiotics, crds.inu.w)
  # p = 0.06392
fligner.test(MaxD ~ Antibiotics, crds.inu.w)
  # p = 0.01802

# Spring
res <- resid(lm(MaxD ~ Antibiotics, crds.inu.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(MaxD ~ Antibiotics, crds.inu.p))
  # p = 0.000913
var.test(MaxD ~ Antibiotics, crds.inu.p)
  # p = 2.431e-06




### Saline ###

# Summer
res <- resid(lm(MaxD ~ Antibiotics, crds.sal.s))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(MaxD ~ Antibiotics, crds.sal.s))
  # p = 0.0729
var.test(MaxD ~ Antibiotics, crds.sal.s)
  # p = 0.0003736

# Winter
res <- resid(lm(MaxD ~ Antibiotics, crds.sal.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p = 8.816e-05
  # Not Normal
kruskal.test(MaxD ~ Antibiotics, crds.sal.w)
  # p = 0.02846
fligner.test(MaxD ~ Antibiotics, crds.sal.w)
  # p = 0.2565

# Spring
res <- resid(lm(MaxD ~ Antibiotics, crds.sal.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(MaxD ~ Antibiotics, crds.sal.p))
  # p = 0.937
var.test(MaxD ~ Antibiotics, crds.sal.p)
  # p = 0.2943

# ANOVA
p.adjust(c(0.00199, 0.06392, 0.000913, 0.0729, 0.02846, 0.937), "BH")
  # Inulin Summer = 0.005970*
  # Inulin Winter = 0.087480
  # Inulin Spring = 0.005478*
  # Saline Summer = 0.087480 
  # Saline Winter = 0.056920
  # Saline Spring = 0.937000

# F test
p.adjust(c(0.0004015, 0.01802, 2.431e-06, 0.0003736, 0.2565, 0.2943), "BH")
  # Inulin Summer = 8.0300e-04*
  # Inulin Winter = 0.027030*
  # Inulin Spring = 1.4586e-05*
  # Saline Summer = 8.0300e-04* 
  # Saline Winter = 0.29430
  # Saline Spring = 0.29430

```



### Test AvgDelta
```{r}
### Inulin ###

# Summer
res <- resid(lm(AvgDelta ~ Antibiotics, crds.inu.s))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(AvgDelta ~ Antibiotics, crds.inu.s))
  # p = 0.00133
var.test(AvgDelta ~ Antibiotics, crds.inu.s)
  # p = 0.0007286

# Winter
res <- resid(lm(AvgDelta ~ Antibiotics, crds.inu.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p = 0.0422
  # Not Normal
kruskal.test(AvgDelta ~ Antibiotics, crds.inu.w)
  # p = 0.06392
fligner.test(AvgDelta ~ Antibiotics, crds.inu.w)
  # p = 0.01802

# Spring
res <- resid(lm(AvgDelta ~ Antibiotics, crds.inu.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(AvgDelta ~ Antibiotics, crds.inu.p))
  # p = 0.00259
var.test(AvgDelta ~ Antibiotics, crds.inu.p)
  # p = 3.869e-06




### Saline ###

# Summer
res <- resid(lm(AvgDelta ~ Antibiotics, crds.sal.s))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(AvgDelta ~ Antibiotics, crds.sal.s))
  # p = 0.0462
var.test(AvgDelta ~ Antibiotics, crds.sal.s)
  # p = 0.0008584

# Winter
res <- resid(lm(AvgDelta ~ Antibiotics, crds.sal.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p = 0.0002892
  # Not Normal
kruskal.test(AvgDelta ~ Antibiotics, crds.sal.w)
  # p = 0.01762
fligner.test(AvgDelta ~ Antibiotics, crds.sal.w)
  # p = 0.4757

# Spring
res <- resid(lm(AvgDelta ~ Antibiotics, crds.sal.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(AvgDelta ~ Antibiotics, crds.sal.p))
  # p = 0.758
var.test(AvgDelta ~ Antibiotics, crds.sal.p)
  # p = 0.08643

# ANOVA
p.adjust(c(0.00133, 0.06392, 0.00259, 0.0462, 0.01762, 0.758), "BH")
  # Inulin Summer = 0.007770*
  # Inulin Winter = 0.076704
  # Inulin Spring = 0.007770* 
  # Saline Summer = 0.069300 
  # Saline Winter = 0.035240*
  # Saline Spring = 0.758000

# F test
p.adjust(c(0.0007286, 0.01802, 3.869e-06, 0.0008584, 0.4757, 0.08643), "BH")
  # Inulin Summer = 0.0017168*
  # Inulin Winter = 0.02703*
  # Inulin Spring = 0.000023214 *
  # Saline Summer = 0.0017168*
  # Saline Winter = 0.4757
  # Saline Spring = 0.103716

```



### Test MaxSlope
```{r}
### Inulin ###

# Summer
res <- resid(lm(MaxSlope ~ Antibiotics, crds.inu.s))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p = 0.04677
  # Not Normal
kruskal.test(MaxSlope ~ Antibiotics, crds.inu.s)
  # p = 0.004483
var.test(MaxSlope ~ Antibiotics, crds.inu.s)
  # p = 0.0001639

# Winter
res <- resid(lm(MaxSlope ~ Antibiotics, crds.inu.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(MaxSlope ~ Antibiotics, crds.inu.w))
  # p = 0.00661v
fligner.test(MaxSlope ~ Antibiotics, crds.inu.w)
  # p = 0.01802

# Spring
res <- resid(lm(MaxSlope ~ Antibiotics, crds.inu.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(MaxSlope ~ Antibiotics, crds.inu.p))
  # p = 2.15e-05
var.test(MaxSlope ~ Antibiotics, crds.inu.p)
  # p = 2.543e-06




### Saline ###

# Summer
res <- resid(lm(MaxSlope ~ Antibiotics, crds.sal.s))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p = 0.005105
  # Not Normal
kruskal.test(MaxSlope ~ Antibiotics, crds.sal.s)
  # p = 0.631
var.test(MaxSlope ~ Antibiotics, crds.sal.s)
  # p = 0.002351

# Winter
res <- resid(lm(MaxSlope ~ Antibiotics, crds.sal.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p = 0.0002066
  # Not Normal
kruskal.test(MaxSlope ~ Antibiotics, crds.sal.w)
  # p = 0.4652
fligner.test(MaxSlope ~ Antibiotics, crds.sal.w)
  # p = 0.3803

# Spring
res <- resid(lm(MaxSlope ~ Antibiotics, crds.sal.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(MaxSlope ~ Antibiotics, crds.sal.p))
  # p = 0.734
var.test(MaxSlope ~ Antibiotics, crds.sal.p)
  # p = 0.5717

# ANOVA
p.adjust(c(0.00133, 0.06392, 0.00259, 0.0462, 0.01762, 0.758), "BH")
  # Inulin Summer = 0.007770*
  # Inulin Winter = 0.076704
  # Inulin Spring = 0.007770* 
  # Saline Summer = 0.069300 
  # Saline Winter = 0.035240*
  # Saline Spring = 0.758000

# F test
p.adjust(c(0.0007286, 0.01802, 3.869e-06, 0.0008584, 0.4757, 0.08643), "BH")
  # Inulin Summer = 0.0017168*
  # Inulin Winter = 0.02703*
  # Inulin Spring = 0.000023214 *
  # Saline Summer = 0.0017168*
  # Saline Winter = 0.4757
  # Saline Spring = 0.103716

```



### Hib Dates
```{r}
### Load data ###

# Dates
dates <- read.csv('metadata_dates.csv')
dates_use <- dates[-which(dates$Season == "Summer"),]
rownames(dates_use) <- 1:nrow(dates_use)
dates_use <- dates_use[-13:-28,]
rownames(dates_use) <- 1:nrow(dates_use)
dates_use <- dates_use[-33:-40,]
dates_use <- dates_use[-3,]
  # Remove outlier P04

# Add d metrics + AUC
for(k in 1:nrow(dates_use)){
  ID <- dates_use$ID[k]
  rowUse <- which(d.metrics$ID == ID)
  dates_use$Slope[k] <- d.metrics$Slope[rowUse]
  rowUse2 <- which(auc.df$ID == ID)
  dates_use$AUC[k] <- auc.df$AUC[rowUse2]
}
  
# Separate by Season
dates.spr <- dates_use[which(dates_use$ Season == "Spring"),]
dates.win <- dates_use[which(dates_use$ Season == "Winter"),]



### Test normality ###

# Spring
hist(dates.spr$Days_Hib)
qqnorm(dates.spr$Days_Hib)
qqline(dates.spr$Days_Hib)
shapiro.test(dates.spr$Days_Hib)
  # p-value = 0.4172
  # Normal
hist(dates.spr$IBA.Hib)
qqnorm(dates.spr$IBA.Hib)
qqline(dates.spr$IBA.Hib)
shapiro.test(dates.spr$IBA.Hib)
  # p-value = 0.8294
  # Normal
hist(dates.spr$Num_IBA)
qqnorm(dates.spr$Num_IBA)
qqline(dates.spr$Num_IBA)
shapiro.test(dates.spr$Num_IBA)
  # p-value = 0.401
  # Normal

# Winter
hist(dates.win$Days_Hib)
qqnorm(dates.win$Days_Hib)
qqline(dates.win$Days_Hib)
shapiro.test(dates.win$Days_Hib)
  # p-value = 0.1513
  # Normal
hist(dates.win$IBA.Hib)
qqnorm(dates.win$IBA.Hib)
qqline(dates.win$IBA.Hib)
shapiro.test(dates.win$IBA.Hib)
  # p-value = 0.9897
  # Normal
hist(dates.win$Num_IBA)
qqnorm(dates.win$Num_IBA)
qqline(dates.win$Num_IBA)
shapiro.test(dates.win$Num_IBA)
  # p-value = 0.2462
  # Normal



### Test ABX within Season ###

# Spring
t.test(Days_Hib ~ Antibiotics, dates.spr)
  # p-value = 0.2672
t.test(IBA.Hib ~ Antibiotics, dates.spr)
  # p-value = 9.588
t.test(Num_IBA ~ Antibiotics, dates.spr)
  # p-value = 0.4637

# Spring variance
leveneTest(Days_Hib ~ Antibiotics, dates.spr)
  # p-value = 0.8931
leveneTest(IBA.Hib ~ Antibiotics, dates.spr)
  # p-value = 0.5261
leveneTest(Num_IBA ~ Antibiotics, dates.spr)
  # p-value = 0.3318



# Winter
t.test(Days_Hib ~ Antibiotics, dates.win)
  # p-value = 0.0006263*
t.test(IBA.Hib ~ Antibiotics, dates.win)
  # p-value = 0.4635
t.test(Num_IBA ~ Antibiotics, dates.win)
  # p-value = 0.2693

# Winter variance
leveneTest(Days_Hib ~ Antibiotics, dates.win)
  # p-value = 0.6559
leveneTest(IBA.Hib ~ Antibiotics, dates.win)
  # p-value = 0.2451
leveneTest(Num_IBA ~ Antibiotics, dates.win)
  # p-value = 0.7173
```
