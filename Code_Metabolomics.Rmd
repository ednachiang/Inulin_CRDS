---
title: "Multiomics"
author: "Edna Chiang"
date: "4/27/2022"
output: html_document
---

### Load Libraries
```{r}
library(ggplot2)
library(grid)
source('scripts/misc.R')
theme_set(theme_bw())
set.seed(1)
```


### Load Data
```{r}
# Load metabolomic data
metab <- read.csv('metabolomics/metabolomics_use.csv', row.names = 1)
metab <- data.frame(t(metab))
for(i in 1:(ncol(metab) - 2)){
  metab[,i] <- as.numeric(metab[,i])
}
metab <- metab[,-7]
  # Remove mannose --> no Inulin ABX squirrels
metab <- metab[,-9]
  # Remove uracil --> no Inulin ABX squirrels
metab <- metab[,-5]
  # Remove lactate
metab <- metab[,-6:-7]
  # Remove phenylalanine & propionate

# Remove outliers
#metab <- metab[-which(substr(rownames(metab),3,5) == "S23"),]
  # Not in data
metab <- metab[-which(substr(rownames(metab),3,5) == "S37"),]
metab <- metab[-which(substr(rownames(metab),3,5) == "S60"),]

# Split up data
metab.noabx <- metab[which(metab$Antibiotics == "No"),]
metab.abx <- metab[which(metab$Antibiotics == "Yes"),]
metab.inu <- metab[which(metab$Substrate == "Inulin"),]
metab.sal <- metab[which(metab$Substrate == "Saline"),]





# Load metadata
meta <- read.csv('metadata.csv')

```


### Test Substrate
```{r}
metab.noabx.output <- data.frame(matrix(nrow = 1, ncol = 4))
colnames(metab.noabx.output) <- c("Compound", "P-value", "Lower_CI", "Upper_CI")
for(j in 1:(ncol(metab.noabx) - 2)){
  test <- wilcox.test(metab.noabx[,j] ~ Substrate, metab.noabx, conf.int = T)
  metab.noabx.output[j,] <- c(colnames(metab.noabx)[j], test$p.value, test$conf.int[1], test$conf.int[2])
}
metab.noabx.output$AdjP <- p.adjust(metab.noabx.output$`P-value`, "BH")
#write.table(metab.noabx.output, file = 'metabolomics/NoABX_TestSubstrate.csv', sep = ",", row.names = F)

metab.abx.output <- data.frame(matrix(nrow = 1, ncol = 4))
colnames(metab.abx.output) <- c("Compound", "P-value", "Lower_CI", "Upper_CI")
for(j in 1:(ncol(metab.abx) - 2)){
  test <- wilcox.test(metab.abx[,j] ~ Substrate, metab.abx, conf.int = T)
  metab.abx.output[j,] <- c(colnames(metab.abx)[j], test$p.value, test$conf.int[1], test$conf.int[2])
}
metab.abx.output$AdjP <- p.adjust(metab.abx.output$`P-value`, "BH")
#write.table(metab.abx.output, file = 'metabolomics/ABX_TestSubstrate.csv', sep = ",", row.names = F)
```

### Test ABX
```{r}
metab.inu.output <- data.frame(matrix(nrow = 1, ncol = 4))
colnames(metab.inu.output) <- c("Compound", "P-value", "Lower_CI", "Upper_CI")
for(j in 1:(ncol(metab.inu) - 2)){
  test <- wilcox.test(metab.inu[,j] ~ Antibiotics, metab.inu, conf.int = T)
  metab.inu.output[j,] <- c(colnames(metab.inu)[j], test$p.value, test$conf.int[1], test$conf.int[2])
}
metab.inu.output$AdjP <- p.adjust(metab.inu.output$`P-value`, "BH")
#write.table(metab.inu.output, file = 'metabolomics/Inulin_TestABX.csv', sep = ",", row.names = F)


metab.sal.output <- data.frame(matrix(nrow = 1, ncol = 4))
colnames(metab.sal.output) <- c("Compound", "P-value", "Lower_CI", "Upper_CI")
for(j in 1:(ncol(metab.sal) - 2)){
  test <- wilcox.test(metab.sal[,j] ~ Antibiotics, metab.sal, conf.int = T)
  metab.sal.output[j,] <- c(colnames(metab.sal)[j], test$p.value, test$conf.int[1], test$conf.int[2])
}
metab.sal.output$AdjP <- p.adjust(metab.sal.output$`P-value`, "BH")
#write.table(metab.sal.output, file = 'metabolomics/Saline_TestABX.csv', sep = ",", row.names = F)
```


### Plot
```{r}
### Prepare data for plotting
metab$SubstrateABX <- interaction(metab$Substrate, metab$Antibiotics)
metab$SubstrateABX <- ordered(metab$SubstrateABX, levels = c("Inulin.No", "Inulin.Yes", "Saline.No", "Saline.Yes"))

metabplot <- metab


### Acetate
acetate.plot <- ggplot(metabplot, aes(x = Substrate, y = Acetate, color = SubstrateABX,
                                    fill = SubstrateABX)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 2,
               position = position_dodge(0.8), stackratio = 0.7) +
  scale_color_manual(values = c("gray20", "gray20", "gray40", "gray40")) +
  scale_fill_manual(values = c("gray45", "white", "gray70", "white")) +
  stat_summary(fun.data = "mean_cl_normal", geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.5) +
  scale_y_continuous(limits = c(0, 1071), breaks = c(0,200,400,600,800,1000)) +
  ggtitle("Acetate")  + 
  ylab("mmol / L") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(size=10, margin = margin(t = 7.5)),
        axis.title.y = element_text(size=10),
        axis.text.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
        legend.position = "none")

### Butyrate
butyrate.plot <- ggplot(metabplot, aes(x = Substrate, y = Butyrate, color = SubstrateABX,
                                    fill = SubstrateABX)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 2,
               position = position_dodge(0.8), stackratio = 0.7) +
  scale_color_manual(values = c("gray20", "gray20", "gray40", "gray40")) +
  scale_fill_manual(values = c("gray45", "white", "gray70", "white")) +
  stat_summary(fun.data = "mean_cl_normal", geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.5) +
  scale_y_continuous(limits = c(-1, 102), breaks = c(0,20,40,60,80,100)) +
  ggtitle("Butyrate")  + 
  ylab("mmol / L") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(size=10, margin = margin(t = 7.5)),
        axis.title.y = element_text(size=10),
        axis.text.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
        legend.position = "none")

### Fructose
fructose.plot <- ggplot(metabplot, aes(x = Substrate, y = Fructose, color = SubstrateABX,
                                    fill = SubstrateABX)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 2,
               position = position_dodge(0.8), stackratio = 0.7) +
  scale_color_manual(values = c("gray20", "gray20", "gray40", "gray40")) +
  scale_fill_manual(values = c("gray45", "white", "gray70", "white")) +
  stat_summary(fun.data = "mean_cl_normal", geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.5) +
  scale_y_continuous(limits = c(-22, 170), breaks = c(0,34,68,102,136,170)) +
  ggtitle("Fructose")  + 
  ylab("mmol / L") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(size=10, margin = margin(t = 7.5)),
        axis.title.y = element_text(size=10),
        axis.text.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
        legend.position = "none")

### Glucose
glucose.plot <- ggplot(metabplot, aes(x = Substrate, y = Glucose, color = SubstrateABX,
                                    fill = SubstrateABX)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 2,
               position = position_dodge(0.8), stackratio = 0.7) +
  scale_color_manual(values = c("gray20", "gray20", "gray40", "gray40")) +
  scale_fill_manual(values = c("gray45", "white", "gray70", "white")) +
  stat_summary(fun.data = "mean_cl_normal", geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.5) +
  scale_y_continuous(limits = c(-1, 48), breaks = c(0,12,24,36,48)) +
  ggtitle("Glucose")  + 
  ylab("mmol / L") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(size=10, margin = margin(t = 7.5)),
        axis.title.y = element_text(size=10),
        axis.text.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
        legend.position = "none")

# ### Glutamate
# glutamate.plot <- ggplot(metabplot, aes(x = Substrate, y = Glutamate, color = SubstrateABX,
#                                     fill = SubstrateABX)) +
#   geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 3,
#                position = position_dodge(0.8), stackratio = 0.7) +
#   scale_color_manual(values = c("gray20", "gray40", "gray40")) +
#   scale_fill_manual(values = c("gray45", "gray70", "white")) +
#   stat_summary(fun.data = "mean_se", geom = "pointrange",
#                color = "black", position = position_dodge(0.7), size = 0.65) +
#   ggtitle("Glutamate")  + 
#   ylab("mmol / L") +
#   theme(panel.grid.major = element_blank(),
#         panel.grid.minor = element_blank(),
#         strip.background = element_blank(),
#         axis.title.x = element_text(size=10, margin = margin(t = 7.5)),
#         axis.title.y = element_text(size=10),
#         axis.text.x = element_text(size=10),
#         axis.text.y = element_text(size=10),
#         plot.title = element_text(hjust = 0.5, size = 11),
#         legend.position = "none")

### Lactate
lactate.plot <- ggplot(metabplot, aes(x = Substrate, y = Lactate, color = SubstrateABX,
                                    fill = SubstrateABX)) +
  geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 2,
               position = position_dodge(0.8), stackratio = 0.7) +
  scale_color_manual(values = c("gray20", "gray20", "gray40", "gray40")) +
  scale_fill_manual(values = c("gray45", "white", "gray70", "white")) +
  stat_summary(fun.data = "mean_cl_normal", geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.5) +
  scale_y_continuous(limits = c(-0.2, 5.5), breaks = c(0,2.5,5.0)) +
  ggtitle("Lactate")  + 
  ylab("mmol / L") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background = element_blank(),
        axis.title.x = element_text(size=10, margin = margin(t = 7.5)),
        axis.title.y = element_text(size=10),
        axis.text.x = element_text(size=10),
        axis.text.y = element_text(size=10),
        plot.title = element_text(hjust = 0.5, size = 10, face = "bold"),
        legend.position = "none")


# ### Phenylalanine
# phenylalanine.plot <- ggplot(metabplot, aes(x = Substrate, y = Phenylalanine, color = SubstrateABX,
#                                     fill = SubstrateABX)) +
#   geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 3,
#                position = position_dodge(0.8), stackratio = 0.7) +
#   scale_color_manual(values = c("gray20", "gray40", "gray40")) +
#   scale_fill_manual(values = c("gray45", "gray70", "white")) +
#   stat_summary(fun.data = "mean_se", geom = "pointrange",
#                color = "black", position = position_dodge(0.7), size = 0.65) +
#   ggtitle("Phenylalanine")  + 
#   ylab("Phenylalanine per mg content") +
#   theme(panel.grid.major = element_blank(),
#         panel.grid.minor = element_blank(),
#         strip.background = element_blank(),
#         axis.title.x = element_text(size=10, margin = margin(t = 7.5)),
#         axis.title.y = element_text(size=10),
#         axis.text.x = element_text(size=10),
#         axis.text.y = element_text(size=10),
#         plot.title = element_text(hjust = 0.5, size = 11),
#         legend.position = "none")
# 
# ### Propionate
# propionate.plot <- ggplot(metabplot, aes(x = Substrate, y = Propionate, color = SubstrateABX,
#                                     fill = SubstrateABX)) +
#   geom_dotplot(binaxis = 'y', stackdir = 'center', dotsize = 3,
#                position = position_dodge(0.8), stackratio = 0.7) +
#   scale_color_manual(values = c("gray20", "gray40", "gray40")) +
#   scale_fill_manual(values = c("gray45", "gray70", "white")) +
#   stat_summary(fun.data = "mean_se", geom = "pointrange",
#                color = "black", position = position_dodge(0.7), size = 0.65) +
#   ggtitle("Propionate")  + 
#   ylab("Propionate per mg content") +
#   theme(panel.grid.major = element_blank(),
#         panel.grid.minor = element_blank(),
#         strip.background = element_blank(),
#         axis.title.x = element_text(size=10, margin = margin(t = 7.5)),
#         axis.title.y = element_text(size=10),
#         axis.text.x = element_text(size=10),
#         axis.text.y = element_text(size=10),
#         plot.title = element_text(hjust = 0.5, size = 11),
#         legend.position = "none")

```


### Save plots
```{r}
tiff("metabolites.tiff", width = 6, height = 9, units = "in", res = 600)
grid.newpage()
pushViewport(viewport(layout=grid.layout(3,2, widths = c(1, 1))))

print(fructose.plot, vp=viewport(layout.pos.row=1, layout.pos.col=1))
grid.text("A", x=unit(0.05, "npc"), y=unit(0.97, "npc"), 
          vp=viewport(layout.pos.row=1, layout.pos.col=1), gp=gpar(fontsize=14,fontface="bold"))

print(glucose.plot, vp=viewport(layout.pos.row=1, layout.pos.col=2))
grid.text("B", x=unit(0.05, "npc"), y=unit(0.97, "npc"),
          vp=viewport(layout.pos.row=1, layout.pos.col=2), gp=gpar(fontsize=14,fontface="bold"))


print(acetate.plot, vp=viewport(layout.pos.row=2, layout.pos.col=1))
grid.text("C", x=unit(0.05, "npc"), y=unit(0.97, "npc"), 
          vp=viewport(layout.pos.row=2, layout.pos.col=1), gp=gpar(fontsize=14,fontface="bold"))

print(butyrate.plot, vp=viewport(layout.pos.row=2, layout.pos.col=2))
grid.text("D", x=unit(0.05, "npc"), y=unit(0.97, "npc"), 
          vp=viewport(layout.pos.row=2, layout.pos.col=2), gp=gpar(fontsize=14,fontface="bold"))



print(lactate.plot, vp=viewport(layout.pos.row=3, layout.pos.col=1))
grid.text("E", x=unit(0.05, "npc"), y=unit(0.97, "npc"), 
          vp=viewport(layout.pos.row=3, layout.pos.col=1), gp=gpar(fontsize=14,fontface="bold"))


#season.legend$vp <- viewport(layout.pos.row=1:4, layout.pos.col=3)
#grid.draw(season.legend)
#abx.legend$vp <- viewport(layout.pos.row=1:4, layout.pos.col=3)
#grid.draw(abx.legend)
dev.off()
```