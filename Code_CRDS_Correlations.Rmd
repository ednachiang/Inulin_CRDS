---
title: "Code_TestCorrelations"
author: "Edna Chiang"
date: "12/14/2021"
output: html_document
---

### Load Packages, scripts, and functions
```{r}
library(ggplot2)
library(plyr)
library(dplyr)
library(grid)
library(car)
library(Rmisc)
library(confintr)
source('scripts/misc.R')
set.seed(1)
theme_set(theme_bw())
```

### Load Data
```{r}
load('crds.norm.RData')
load('crds.use.Rdata')
meta <- read.csv('metadata.csv')
```

### Prepare CRDS data
```{r}
# Add metadata
crds.use[, colnames(meta)[3:ncol(meta)]] <- NA
for(i in 1:nrow(crds.use)){
  meta.row <- which(meta$ID == crds.use$ID[i])
  crds.use[i, 7:ncol(crds.use)] <- meta[meta.row, 3:ncol(meta)]
}

# Calculate square root of AUC
crds.use$AUC <- as.numeric(crds.use$AUC)
minAUC <- min(crds.use$AUC)
crds.use$AUC_sqrt <- crds.use$AUC + (minAUC * -1)
crds.use$AUC_sqrt <- sqrt(crds.use$AUC_sqrt)

# Convert to numeric
crds.use$AvgD <- as.numeric(crds.use$AvgD)
crds.use$MaxD <- as.numeric(crds.use$MaxD)
crds.use$MaxSlope <- as.numeric(crds.use$MaxSlope)
crds.use$AUC <- as.numeric(crds.use$AUC)
crds.use$MaxD <- as.numeric(crds.use$MaxD)
crds.use$Baseline <- as.numeric(crds.use$Baseline)

# Order categorical variables
crds.use$Season <- ordered(crds.use$Season, levels = c("Summer", "Winter", "Spring"))
crds.use$Sex <- ordered(crds.use$Sex, levels = c("Female", "Male"))
crds.use$Antibiotics <- ordered(crds.use$Antibiotics, levels = c("No", "Yes"))
crds.use$Substrate <- ordered(crds.use$Substrate, levels = c("Inulin", "Saline"))
crds.use$Diet <- ordered(crds.use$Diet, levels = c("1", "2"))

# Remove outliers
crds.rem <- crds.use[-which(crds.use$ID == "S23"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "S37"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "S60"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "W43"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "W20"),]
  # This is due to odd metagenome
crds.rem <- crds.rem[-which(crds.rem$ID == "W50"),]

# Separate by substrate
crds.inu <- crds.rem[which(crds.rem$Substrate == "Inulin"),]
crds.sal <- crds.rem[which(crds.rem$Substrate == "Saline"),]

# Separate by substrate + season
crds.inu.s <- crds.inu[which(crds.inu$Season == "Summer"),]
crds.inu.w <- crds.inu[which(crds.inu$Season == "Winter"),]
crds.inu.p <- crds.inu[which(crds.inu$Season == "Spring"),]
crds.sal.s <- crds.sal[which(crds.sal$Season == "Summer"),]
crds.sal.w <- crds.sal[which(crds.sal$Season == "Winter"),]
crds.sal.p <- crds.sal[which(crds.sal$Season == "Spring"),]

# Separate by substrate + ABX
crds.inu.noabx <- crds.inu[which(crds.inu$Antibiotics == "No"),]
crds.inu.abx <- crds.inu[which(crds.inu$Antibiotics == "Yes"),]
crds.sal.noabx <- crds.sal[which(crds.sal$Antibiotics == "No"),]
crds.sal.abx <- crds.sal[which(crds.sal$Antibiotics == "Yes"),]
```


### Test Baseline
```{r}
### Test BodyMass Correlation

# Inulin No ABX
res <- resid(lm(Baseline ~ BodyMass, crds.inu.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.inu.noabx$Baseline, crds.inu.noabx$BodyMass, method = "pearson")
  # p = 0.0006718
  # cor = 0.6813544

# Inulin ABX
res <- resid(lm(Baseline ~ BodyMass, crds.inu.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p = 0.01681
  # Not Normal
cor.test(crds.inu.abx$Baseline, crds.inu.abx$BodyMass, method = "kendall")
  # p = 0.008264
  # tau = 0.4385965
ci_cor(crds.inu.abx$Baseline, crds.inu.abx$BodyMass, method = "kendall", type = c("bootstrap"), R = 9999, boot_type = "bca")
  # -0.01863354  0.70552147

# Saline No ABX
res <- resid(lm(Baseline ~ BodyMass, crds.sal.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.sal.noabx$Baseline, crds.sal.noabx$BodyMass, method = "pearson")
  # p = 0.1602

# Saline ABX
res <- resid(lm(Baseline ~ BodyMass, crds.sal.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Test says normal, but residuals are clearly sigmoid.
  # Not Normal
cor.test(crds.sal.abx$Baseline, crds.sal.abx$BodyMass, method = "kendall")
  # p = 0.0002925
  # tau = 0.6176471 
ci_cor(crds.sal.abx$Baseline, crds.sal.abx$BodyMass, method = "kendall", type = c("bootstrap"), R = 9999, boot_type = "bca")
  # 0.3750000 0.8016052



### Test BodyTemp Correlation

# Inulin No ABX
res <- resid(lm(Baseline ~ BodyTemp, crds.inu.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.inu.noabx$Baseline, crds.inu.noabx$BodyTemp, method = "pearson")
  # p = 0.443

# Inulin ABX
res <- resid(lm(Baseline ~ BodyTemp, crds.inu.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.inu.abx$Baseline, crds.inu.abx$BodyTemp, method = "pearson")
  # p = 0.7934

# Saline No ABX
res <- resid(lm(Baseline ~ BodyTemp, crds.sal.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.sal.noabx$Baseline, crds.sal.noabx$BodyTemp, method = "pearson")
  # p = 0.5212

# Saline ABX
res <- resid(lm(Baseline ~ BodyTemp, crds.sal.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.sal.abx$Baseline, crds.sal.abx$BodyTemp, method = "pearson")
  # p = 0.05815





### Test Ketones Correlation

# Inulin No ABX
res <- resid(lm(Baseline ~ Ketones, crds.inu.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.inu.noabx$Baseline, crds.inu.noabx$Ketones, method = "pearson")
  # p = 0.002927
  # cor = -0.6928471

# Inulin ABX
res <- resid(lm(Baseline ~ Ketones, crds.inu.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.inu.abx$Baseline, crds.inu.abx$Ketones, method = "pearson")
  # p = 0.166

# Saline No ABX
res <- resid(lm(Baseline ~ Ketones, crds.sal.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Test is on the edge, but residuals are sigmoid
  # Not Normal
cor.test(crds.sal.noabx$Baseline, crds.sal.noabx$Ketones, method = "kendall")
  # p = 0.0378
  # tau = -0.4149041

# Saline ABX
res <- resid(lm(Baseline ~ Ketones, crds.sal.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.sal.abx$Baseline, crds.sal.abx$Ketones, method = "pearson")
  # p = 0.1171

```



### Test MaxD
```{r}
### Test BodyMass Correlation

# Inulin No ABX
res <- resid(lm(MaxD ~ BodyMass, crds.inu.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p = 0.04659
  # Not Normal
cor.test(crds.inu.noabx$MaxD, crds.inu.noabx$BodyMass, method = "kendall")
  # p = 0.06493
  # tau = 0.2952381 
ci_cor(crds.inu.noabx$MaxD, crds.inu.noabx$BodyMass, method = "kendall", type = c("bootstrap"), R = 9999, boot_type = "bca")
  # 0.0800000 0.5175879

# Inulin ABX
res <- resid(lm(MaxD ~ BodyMass, crds.inu.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.inu.abx$MaxD, crds.inu.abx$BodyMass, method = "pearson")
  # p = 0.9988
  # CI = -0.4544963  0.4539222
  # cor = -0.0003616989

# Saline No ABX
res <- resid(lm(MaxD ~ BodyMass, crds.sal.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.sal.noabx$MaxD, crds.sal.noabx$BodyMass, method = "pearson")
  # p = 0.09483
  # CI = -0.71962116  0.07299315
  # cor = -0.3942884 

# Saline ABX
res <- resid(lm(MaxD ~ BodyMass, crds.sal.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p = 0.02585
  # Not Normal
cor.test(crds.sal.abx$MaxD, crds.sal.abx$BodyMass, method = "kendall")
  # p = 0.1089
  # tau = -0.2941176
ci_cor(crds.sal.abx$MaxD, crds.sal.abx$BodyMass, method = "kendall", type = c("bootstrap"), R = 9999, boot_type = "bca")
  # -0.5968992  0.1544715 


### Test BodyTemp Correlation

# Inulin No ABX
res <- resid(lm(MaxD ~ BodyTemp, crds.inu.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Test is on edge, but histo isn't normal
  # Not Normal
cor.test(crds.inu.noabx$MaxD, crds.inu.noabx$BodyTemp, method = "kendall")
  # p = 0.1045
  # tau = 0.2660329
ci_cor(crds.inu.noabx$MaxD, crds.inu.noabx$BodyTemp, method = "kendall", type = c("bootstrap"), R = 9999, boot_type = "bca")
  # -0.1072009  0.5669246

# Inulin ABX
res <- resid(lm(MaxD ~ BodyTemp, crds.inu.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.inu.abx$MaxD, crds.inu.abx$BodyTemp, method = "pearson")
  # p = 0.8846
  # CI = -0.4253959  0.4821028
  # cor = 0.03571397

# Saline No ABX
res <- resid(lm(MaxD ~ BodyTemp, crds.sal.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.sal.noabx$MaxD, crds.sal.noabx$BodyTemp, method = "pearson")
  # p = 0.1684
  # CI = -0.1467414  0.6816414
  # cor = 0.3294245

# Saline ABX
res <- resid(lm(MaxD ~ BodyTemp, crds.sal.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.sal.abx$MaxD, crds.sal.abx$BodyTemp, method = "pearson")
  # p = 0.5788
  # CI = -0.3608304  0.5848513
  # cor = 0.1449539





### Test Ketones Correlation

# Inulin No ABX
res <- resid(lm(MaxD ~ Ketones, crds.inu.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.inu.noabx$MaxD, crds.inu.noabx$Ketones, method = "pearson")
  # p = 0.1923
  # CI = -0.7172618  0.1831208
  # cor = -0.3437919

# Inulin ABX
res <- resid(lm(MaxD ~ Ketones, crds.inu.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.inu.abx$MaxD, crds.inu.abx$Ketones, method = "pearson")
  # p = 0.9001
  # CI = -0.5210269  0.4695120
  # cor = -0.03413881

# Saline No ABX
res <- resid(lm(MaxD ~ Ketones, crds.sal.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.sal.noabx$MaxD, crds.sal.noabx$Ketones, method = "pearson")
  # p = 0.1928
  # CI = -0.1911244  0.7343397
  # cor = 0.3559922

# Saline ABX
res <- resid(lm(MaxD ~ Ketones, crds.sal.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.sal.abx$MaxD, crds.sal.abx$Ketones, method = "pearson")
  # p = 0.1538
  # CI = -0.1630006  0.7688198
  # cor = 0.4023786

```




### Test MaxSlope
```{r}
### Test BodyMass Correlation

# Inulin No ABX
res <- resid(lm(MaxSlope ~ BodyMass, crds.inu.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p = 0.02615
  # Not Normal
cor.test(crds.inu.noabx$MaxSlope, crds.inu.noabx$BodyMass, method = "kendall")
  # p = 0.006091
  # tau = 0.4285714
ci_cor(crds.inu.noabx$MaxSlope, crds.inu.noabx$BodyMass, method = "kendall", type = c("bootstrap"), R = 9999, boot_type = "bca")
  # 0.2121212 0.6205128 

# Inulin ABX
res <- resid(lm(MaxSlope ~ BodyMass, crds.inu.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.inu.abx$MaxSlope, crds.inu.abx$BodyMass, method = "pearson")
  # p = 0.5483
  # CI = -0.5635368  0.3292449
  # cor = -0.1469384

# Saline No ABX
res <- resid(lm(MaxSlope ~ BodyMass, crds.sal.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.sal.noabx$MaxSlope, crds.sal.noabx$BodyMass, method = "pearson")
  # p = 0.6134
  # CI = -0.5472759  0.3500475
  # cor = -0.1238539

# Saline ABX
res <- resid(lm(MaxSlope ~ BodyMass, crds.sal.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.sal.abx$MaxSlope, crds.sal.abx$BodyMass, method = "pearson")
  # p = 0.6564
  # CI = -0.5654201  0.3858203
  # cor = -0.1164123





### Test BodyTemp Correlation

# Inulin No ABX
res <- resid(lm(MaxSlope ~ BodyTemp, crds.inu.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p = 0.03657
  # Not Normal
cor.test(crds.inu.noabx$MaxSlope, crds.inu.noabx$BodyTemp, method = "kendall")
  # p = 0.2322
  # tau = 0.19576

# Inulin ABX
res <- resid(lm(MaxSlope ~ BodyTemp, crds.inu.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.inu.abx$MaxSlope, crds.inu.abx$BodyTemp, method = "pearson")
  # p = 0.9296
  # CI =  -0.4367759  0.4713017
  # cor = 0.02174795

# Saline No ABX
res <- resid(lm(MaxSlope ~ BodyTemp, crds.sal.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.sal.noabx$MaxSlope, crds.sal.noabx$BodyTemp, method = "pearson")
  # p = 0.197
  # CI = -0.1682215  0.6696709
  # cor = 0.3096473

# Saline ABX
res <- resid(lm(MaxSlope ~ BodyTemp, crds.sal.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.sal.abx$MaxSlope, crds.sal.abx$BodyTemp, method = "pearson")
  # p = 0.921
  # CI = -0.5004148  0.4603737
  # cor = -0.02603109





### Test Ketones Correlation

# Inulin No ABX
res <- resid(lm(MaxSlope ~ Ketones, crds.inu.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.inu.noabx$MaxSlope, crds.inu.noabx$Ketones, method = "pearson")
  # p = 0.06079
  # CI = -0.78744162  0.02252662
  # cor = -0.4785222 

# Inulin ABX
res <- resid(lm(MaxSlope ~ Ketones, crds.inu.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.inu.abx$MaxSlope, crds.inu.abx$Ketones, method = "pearson")
  # p = 0.09455
  # CI = -0.08082526  0.76418175
  # cor = 0.4321962 

# Saline No ABX
res <- resid(lm(MaxSlope ~ Ketones, crds.sal.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.sal.noabx$MaxSlope, crds.sal.noabx$Ketones, method = "pearson")
  # p = 0.3626
  # CI = -0.6775746  0.2976777
  # cor = -0.2531946 

# Saline ABX
res <- resid(lm(MaxSlope ~ Ketones, crds.sal.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(crds.sal.abx$MaxSlope, crds.sal.abx$Ketones, method = "pearson")
  # p = 0.9939
  # CI = -0.5289464  0.5322086
  # cor = 0.002270203

```




### Load/Test Inulinase RPKG
```{r}
### Exo - RPKG
exo_rpkg <- read.csv('eCAMI/inulinase/exoRPKG.csv')
exo_rpkg$Season <- ordered(exo_rpkg$Season, c("Summer", "Winter", "Spring"))

# Remove W20 outlier
exo_rpkg <- exo_rpkg[-which(exo_rpkg$Sample == "S-W20"),]


### Prepare AUC & slope data
for(sample in 1:nrow(exo_rpkg)){
  sampName <- substr(exo_rpkg$Sample[sample], 3, 5)
  useRow <- which(crds.rem$ID == sampName)
  exo_rpkg$Baseline[sample] <- crds.rem$Baseline[useRow]
  exo_rpkg$AUC_sqrt[sample] <- crds.rem$AUC_sqrt[useRow]
  exo_rpkg$AvgD[sample] <- crds.rem$AvgD[useRow]
  exo_rpkg$MaxD[sample] <- crds.rem$MaxD[useRow]
  exo_rpkg$MaxSlope[sample] <- crds.rem$MaxSlope[useRow]
}

# Subset out inulin samples
exo_rpkg_inu <- exo_rpkg[1:9,]


# Test RPKG - Baseline
res <- resid(lm(RPKG ~ Baseline, exo_rpkg_inu))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(exo_rpkg_inu$RPKG, exo_rpkg_inu$Baseline, method = "pearson")
  # p = 0.9096
  # CI = -0.6385148  0.6882598
  # cor = 0.04446048

# Test RPKG - AUC_sqrt
res <- resid(lm(RPKG ~ AUC_sqrt, exo_rpkg_inu))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(exo_rpkg_inu$RPKG, exo_rpkg_inu$AUC_sqrt, method = "pearson")
  # p = 0.6674
  # CI =  -0.7481911  0.5590641
  # cor = -0.1670994 


# Test RPKG - AvgD
res <- resid(lm(RPKG ~ AvgD, exo_rpkg_inu))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(exo_rpkg_inu$RPKG, exo_rpkg_inu$AvgD, method = "pearson")
  # p = 0.6854
  # CI =  -0.7438889  0.5656978
  # cor = -0.1576529 


# Test RPKG - MaxD
res <- resid(lm(RPKG ~ MaxD, exo_rpkg_inu))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(exo_rpkg_inu$RPKG, exo_rpkg_inu$MaxD, method = "pearson")
  # p = 0.7554
  # CI = -0.7269830  0.5902212
  # cor = -0.1215427 

# Test RPKG - MaxSlope
res <- resid(lm(RPKG ~ MaxSlope, exo_rpkg_inu))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(exo_rpkg_inu$RPKG, exo_rpkg_inu$MaxSlope, method = "pearson")
  # p = 0.9127
  # CI = -0.6874511  0.6394231
  # cor = -0.04292835 
```


### Load/Test DNA Yield
```{r}
# Load DNA data
dna <- read.csv('dna.csv')
dna$Season <- ordered(dna$Season, levels=c("Summer", "Winter", "Spring"))
dna <- dna[-which(dna$Squirrel == "S23"),]
dna <- dna[-which(dna$Squirrel == "S37"),]
dna <- dna[-which(dna$Squirrel == "S60"),]
dna <- dna[-which(dna$Squirrel == "W43"),]
dna <- dna[-which(dna$Squirrel == "W20"),]
#dna <- dna[-which(dna$Squirrel == "W53"),]
dna <- dna[-which(dna$Squirrel == "P04"),]
dna <- dna[-which(dna$Squirrel == "S11"),]
dna <- dna[-which(dna$Squirrel == "S40"),]
dna <- dna[-which(dna$Squirrel == "W50"),]
dna.con <- dna[which(substr(dna$Sample,2,2) == "C"),]


### Add in delta metrics
for(sample in 1:nrow(dna.con)){
  sampName <- dna.con$Squirrel[sample]
  useRow <- which(crds.rem$ID == sampName)
  dna.con$Baseline[sample] <- crds.rem$Baseline[useRow]
  dna.con$AUC_sqrt[sample] <- crds.rem$AUC_sqrt[useRow]
  dna.con$AvgD[sample] <- crds.rem$AvgD[useRow]
  dna.con$MaxD[sample] <- crds.rem$MaxD[useRow]
  dna.con$MaxSlope[sample] <- crds.rem$MaxSlope[useRow]
}

# Subset out inulin
dna.c.inu <- dna.con[which(dna.con$Substrate == "Inulin"),]

# Subset out ABX treatments
dna.c.inu.abx <- dna.c.inu[which(dna.c.inu$Antibiotics == "Antibiotics"),]
dna.c.inu.noabx <- dna.c.inu[which(dna.c.inu$Antibiotics == "No Antibiotics"),]



### Test Baseline
res <- resid(lm(DNA_Yield_.ng.mg. ~ Baseline, dna.c.inu.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dna.c.inu.noabx$DNA_Yield_.ng.mg., dna.c.inu.noabx$Baseline, method = "pearson")
  # p = 0.3841
  # CI = -0.5816553  0.2533366
  # cor = -0.2002499 

res <- resid(lm(DNA_Yield_.ng.mg. ~ Baseline, dna.c.inu.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p = 0.03934
  # Not Normal
cor.test(dna.c.inu.abx$DNA_Yield_.ng.mg., dna.c.inu.abx$Baseline, method = "kendall")
  # p = 0.04198
  # tau = -0.3421963
ci_cor(dna.c.inu.abx$DNA_Yield_.ng.mg., dna.c.inu.abx$Baseline, method = "kendall", type = c("bootstrap"), R = 9999, boot_type = "bca")
  # -0.6457419  0.1401161 


### Test AUC_sqrt
res <- resid(lm(DNA_Yield_.ng.mg. ~ AUC_sqrt, dna.c.inu.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dna.c.inu.noabx$DNA_Yield_.ng.mg., dna.c.inu.noabx$AUC_sqrt, method = "pearson")
  # p = 0.3267
  # CI = -0.2288608  0.5985913
  # cor = 0.2250612 

res <- resid(lm(DNA_Yield_.ng.mg. ~ AUC_sqrt, dna.c.inu.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p = 0.0005985
  # Not Normal
cor.test(dna.c.inu.abx$DNA_Yield_.ng.mg., dna.c.inu.abx$AUC_sqrt, method = "kendall")
  # p = 0.2618
  # tau = 0.188798 
ci_cor(dna.c.inu.abx$DNA_Yield_.ng.mg., dna.c.inu.abx$AUC_sqrt, method = "kendall", type = c("bootstrap"), R = 9999, boot_type = "bca")
  # CI = -0.1265823  0.4480533 

### Test AvgD
res <- resid(lm(DNA_Yield_.ng.mg. ~ AvgD, dna.c.inu.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dna.c.inu.noabx$DNA_Yield_.ng.mg., dna.c.inu.noabx$AvgD, method = "pearson")
  # p = 0.2561
  # CI =  -0.1939760  0.6215154
  # cor = 0.2594351

res <- resid(lm(DNA_Yield_.ng.mg. ~ AvgD, dna.c.inu.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p = 0.0005395
  # Not Normal
cor.test(dna.c.inu.abx$DNA_Yield_.ng.mg., dna.c.inu.abx$AvgD, method = "kendall")
  # p = 0.4405
  # tau = 0.1297986
ci_cor(dna.c.inu.abx$DNA_Yield_.ng.mg., dna.c.inu.abx$AvgD, method = "kendall", type = c("bootstrap"), R = 9999, boot_type = "bca")
  # -0.2138407  0.4303381


### Test MaxD
res <- resid(lm(DNA_Yield_.ng.mg. ~ MaxD, dna.c.inu.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dna.c.inu.noabx$DNA_Yield_.ng.mg., dna.c.inu.noabx$MaxD, method = "pearson")
  # p = 0.2957
  # CI =  -0.2143355  0.6083040
  # cor = 0.2395124

res <- resid(lm(DNA_Yield_.ng.mg. ~ MaxD, dna.c.inu.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p = 0.001553
  # Not Normal
cor.test(dna.c.inu.abx$DNA_Yield_.ng.mg., dna.c.inu.abx$MaxD, method = "kendall")
  # p = 0.8885
  # tau = 0.02359974 
ci_cor(dna.c.inu.abx$DNA_Yield_.ng.mg., dna.c.inu.abx$MaxD, method = "kendall", type = c("bootstrap"), R = 9999, boot_type = "bca")
  # -0.3883515  0.3376644 


### Test MaxSlope
res <- resid(lm(DNA_Yield_.ng.mg. ~ MaxSlope, dna.c.inu.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dna.c.inu.noabx$DNA_Yield_.ng.mg., dna.c.inu.noabx$MaxSlope, method = "pearson")
  # p = 0.4263
  # CI = -0.2697019  0.5699128
  # cor = 0.1833294 

res <- resid(lm(DNA_Yield_.ng.mg. ~ MaxSlope, dna.c.inu.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p = 0.002416
  # Not Normal
cor.test(dna.c.inu.abx$DNA_Yield_.ng.mg., dna.c.inu.abx$MaxSlope, method = "kendall")
  # p = 0.05829
  # tau = 0.3185965
ci_cor(dna.c.inu.abx$DNA_Yield_.ng.mg., dna.c.inu.abx$MaxSlope, method = "kendall", type = c("bootstrap"), R = 9999, boot_type = "bca")
  # -0.07955287  0.55564849

```


### Hib Dates
```{r}
### Load data ###

# Dates
dates <- read.csv('metadata_dates.csv')
dates_use <- dates[-which(dates$Season == "Summer"),]
rownames(dates_use) <- 1:nrow(dates_use)
dates_use <- dates_use[-13:-28,]
rownames(dates_use) <- 1:nrow(dates_use)
dates_use <- dates_use[-33:-40,]
dates_use <- dates_use[-3,]
  # Remove outlier P04
dates_use <- dates_use[-which(dates_use$ID == "W20"),]



# Add CRDS metrics
for(k in 1:nrow(dates_use)){
  ID <- dates_use$ID[k]
  rowUse <- which(crds.rem$ID == ID)
  dates_use$AvgD[k] <- crds.rem$AvgD[rowUse]
  dates_use$MaxD[k] <- crds.rem$MaxD[rowUse]
  dates_use$MaxSlope[k] <- crds.rem$MaxSlope[rowUse]
  dates_use$AUC_sqrt[k] <- crds.rem$AUC_sqrt[rowUse]
  dates_use$Baseline[k] <- crds.rem$Baseline[rowUse]
}



# Separate by Substrate
dates.inu <- dates_use[which(dates_use$Substrate == "Inulin"),]
dates.sal <- dates_use[which(dates_use$Substrate == "Saline"),]

# Separate by Substrate + Season
dates.inu.p <- dates.inu[which(dates.inu$Season == "Spring"),]
dates.inu.w <- dates.inu[which(dates.inu$Season == "Winter"),]
dates.sal.p <- dates.sal[which(dates.sal$Season == "Spring"),]
dates.sal.w <- dates.sal[which(dates.sal$Season == "Winter"),]



### Correlate Baseline ### 

# Inulin Winter
res <- resid(lm(Days_Hib ~ Baseline, dates.inu.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p = 0.04767
  # Not Normal
cor.test(dates.inu.w$Days_Hib, dates.inu.w$Baseline, method = "pearson")
  # p-value = 0.8616
  # CI = -0.7005837  0.6242007
  # cor = -0.0681881 

res <- resid(lm(IBA.Hib ~ Baseline, dates.inu.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dates.inu.w$IBA.Hib, dates.inu.w$Baseline, method = "pearson")
  # p-value = 0.6949
  # CI = -0.7416104  0.5691438
  # cor = -0.1526929 


# Inulin Spring
res <- resid(lm(Days_Hib ~ Baseline, dates.inu.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dates.inu.p$Days_Hib, dates.inu.p$Baseline, method = "pearson")
  # p-value = 0.09606
  # CI = -0.2515161  0.9870016
  # cor = 0.8106333 

res <- resid(lm(IBA.Hib ~ Baseline, dates.inu.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dates.inu.p$IBA.Hib, dates.inu.p$Baseline, method = "pearson")
  # p-value = 0.5982
  # CI = -0.7829395  0.9377288
  # cor = 0.3211981 


# Saline Winter
res <- resid(lm(Days_Hib ~ Baseline, dates.sal.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dates.sal.w$Days_Hib, dates.sal.w$Baseline, method = "pearson")
  # p-value = 5.622e-05
  # CI = -0.9858039 -0.7568553
  # cor = -0.9390097

res <- resid(lm(IBA.Hib ~ Baseline, dates.sal.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dates.sal.w$IBA.Hib, dates.sal.w$Baseline, method = "pearson")
  # p-value = 0.9251
  # CI = -0.6842065  0.6430302
  # cor = -0.03681214 



# Saline Spring
res <- resid(lm(Days_Hib ~ Baseline, dates.sal.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dates.sal.p$Days_Hib, dates.sal.p$Baseline, method = "pearson")
  # p-value = 0.172
  # CI = -0.3585561  0.9551933
  # cor = 0.6389266 

res <- resid(lm(IBA.Hib ~ Baseline, dates.sal.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dates.sal.p$IBA.Hib, dates.sal.p$Baseline, method = "pearson")
  # p-value = 0.6928
  # CI = -0.8134565  0.9267202
  # cor = 0.2437349 









### Correlate MaxD ### 

# Inulin Winter
res <- resid(lm(Days_Hib ~ MaxD, dates.inu.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dates.inu.w$Days_Hib, dates.inu.w$MaxD, method = "pearson")
  # p-value = 0.4531
  # CI = -0.4654628  0.7990726
  # cor = 0.2875464 

res <- resid(lm(IBA.Hib ~ MaxD, dates.inu.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dates.inu.w$IBA.Hib, dates.inu.w$MaxD, method = "pearson")
  # p-value = 0.4515
  # CI = -0.7994647  0.4646120
  # cor = -0.2885419



# Inulin Spring
res <- resid(lm(Days_Hib ~ MaxD, dates.inu.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dates.inu.p$Days_Hib, dates.inu.p$MaxD, method = "pearson")
  # p-value = 0.7036
  # CI = -0.9253957  0.8165791
  # cor = -0.2349671 

res <- resid(lm(IBA.Hib ~ MaxD, dates.inu.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dates.inu.p$IBA.Hib, dates.inu.p$MaxD, method = "pearson")
  # p-value = 0.5327
  # CI = -0.9434008  0.7631471
  # cor = -0.3646128


# Saline Winter
res <- resid(lm(Days_Hib ~ MaxD, dates.sal.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dates.sal.w$Days_Hib, dates.sal.w$MaxD, method = "pearson")
  # p-value = 0.1624
  # CI = -0.8422896  0.2473532
  # cor = -0.4527908

res <- resid(lm(IBA.Hib ~ MaxD, dates.sal.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dates.sal.w$IBA.Hib, dates.sal.w$MaxD, method = "pearson")
  # p-value = 0.4762
  # CI = -0.5795931  0.7345112
  # cor = 0.1374271 


# Saline Spring
res <- resid(lm(Days_Hib ~ MaxD, dates.sal.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dates.sal.p$Days_Hib, dates.sal.p$MaxD, method = "pearson")
  # p-value = 0.38
  # CI = -0.5761544  0.9226388
  # cor = 0.4421488

res <- resid(lm(IBA.Hib ~ MaxD, dates.sal.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dates.sal.p$IBA.Hib, dates.sal.p$MaxD, method = "pearson")
  # p-value = 0.01461
  # Ci = -0.9972995 -0.4863357
  # cor = -0.9576821 






### Correlate MaxSlope ### 

# Inulin Winter
res <- resid(lm(Days_Hib ~ MaxSlope, dates.inu.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # p = 0.04767
  # Not Normal
cor.test(dates.inu.w$Days_Hib, dates.inu.w$MaxSlope, method = "kendall")
  # p-value = 0.3454
  # tau = 0.2535463
ci_cor(dates.inu.w$Days_Hib, dates.inu.w$MaxSlope, method = "kendall", type = c("bootstrap"), R = 9999, boot_type = "bca")
  # -0.5315096  0.7500000 

res <- resid(lm(IBA.Hib ~ MaxSlope, dates.inu.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dates.inu.w$IBA.Hib, dates.inu.w$MaxSlope, method = "pearson")
  # p-value = 0.4296
  # CI = -0.8047344  0.4529456
  # cor = -0.3020301 



# Inulin Spring
res <- resid(lm(Days_Hib ~ MaxSlope, dates.inu.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dates.inu.p$Days_Hib, dates.inu.p$MaxSlope, method = "pearson")
  # p-value = 0.7633
  # Ci = -0.9178319  0.8326501
  # cor = -0.1869628

res <- resid(lm(IBA.Hib ~ MaxSlope, dates.inu.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dates.inu.p$IBA.Hib, dates.inu.p$MaxSlope, method = "pearson")
  # p-value = 0.6705
  # CI = -0.9293996  0.8068176
  # cor = -0.2618188


# Saline Winter
res <- resid(lm(Days_Hib ~ MaxSlope, dates.sal.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dates.sal.w$Days_Hib, dates.sal.w$MaxSlope, method = "pearson")
  # p-value = 0.3965
  # CI = -0.4046253  0.7827478
  # cor = 0.3019186 

res <- resid(lm(IBA.Hib ~ MaxSlope, dates.sal.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dates.sal.w$IBA.Hib, dates.sal.w$MaxSlope, method = "pearson")
  # p-value = 0.9288
  # CI = -0.6832444  0.6440887
  # cor = -0.0350077 



# Saline Spring
res <- resid(lm(Days_Hib ~ MaxSlope, dates.sal.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dates.sal.p$Days_Hib, dates.sal.p$MaxSlope, method = "pearson")
  # p-value = 0.4402
  # CI = -0.6142233  0.9133714
  # cor = 0.3934797 

res <- resid(lm(IBA.Hib ~ MaxSlope, dates.sal.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
cor.test(dates.sal.p$IBA.Hib, dates.sal.p$MaxSlope, method = "pearson")
  # p-value = 0.7359
  # CI =  -0.8254998  0.9213618
  # cor = 0.2089396 





### Combine RPKG + Hib Dates ###
rpkg.dates <- exo_rpkg[which(exo_rpkg$Season != "Summer"),]

for(m in 1:nrow(rpkg.dates)){
  ID <- substr(rpkg.dates$Sample, 3, 5)[m]
  
  useRow <- which(dates_use$ID == ID)
  rpkg.dates$Days_Hib[m] <- dates_use$Days_Hib[useRow]
  rpkg.dates$IBA.Hib[m] <- dates_use$IBA.Hib[useRow]
  rpkg.dates$Num_IBA[m] <- dates_use$Num_IBA[useRow]
}

# Separate by Season
rpkg.dates.w <- rpkg.dates[which(rpkg.dates$Season == "Winter"),]
rpkg.dates.p <- rpkg.dates[which(rpkg.dates$Season == "Spring"),]



### Correlate RPKG w/ Hib Dates ###
res <- resid(lm(Days_Hib ~ RPKG, rpkg.dates.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
cor.test(rpkg.dates.w$Days_Hib, rpkg.dates.w$RPKG, method = "pearson")
  # p-value = 0.5756
  # CI = -0.9402272  0.7746305
  # cor = -0.3400072 

res <- resid(lm(IBA.Hib ~ RPKG, rpkg.dates.w))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
cor.test(rpkg.dates.w$IBA.Hib, rpkg.dates.w$RPKG, method = "pearson")
  # p-value = 0.6959
  # CI = -0.9263363  0.8143722
  # cor = -0.2411816 


res <- resid(lm(Days_Hib ~ RPKG, rpkg.dates.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
cor.test(rpkg.dates.p$Days_Hib, rpkg.dates.p$RPKG, method = "pearson")
  # p-value = 0.3231
  # CI = -0.5332439  0.9313537
  # cor = 0.490652 

res <- resid(lm(IBA.Hib ~ RPKG, rpkg.dates.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
cor.test(rpkg.dates.p$IBA.Hib, rpkg.dates.p$RPKG, method = "pearson")
  # p-value = 0.8018
  # CI = -0.8525207  0.7606957
  # cor = -0.1329302 



```

### Adj P
```{r}

```


### Misc
```{r}
res <- resid(lm(Num_IBA ~ RPKG, rpkg.dates.p))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
cor.test(crds.inu.noabx$MaxD, crds.inu.noabx$MaxSlope, method = "pearson")
  # p = 9.496e-11
  # CI = 0.8694993 0.9782406
  # cor = 0.9460754 


```