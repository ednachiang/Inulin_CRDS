---
title: "Code_CAZymes"
author: "Edna Chiang"
date: "2/2/2022"
output: html_document
---

### Load Packages, scripts, and functions
```{r}
library(ggplot2)
library(plyr)
library(dplyr)
library(grid)
#library(MESS)
#library(pgirmess)
#library(Bolstad2)
library(phyloseq)
library(vegan)
#library(miLineage)
#library(psych)
library(car)
library(DESeq2)
library(labdsv)
library(ggdendro)
library(ape)
library(pvclust)
#source('scripts/import_crds.R')
#source('scripts/bin_crds.R')
source('scripts/misc.R')
#source('scripts/calc_delta_metrics.R')
source('scripts/simper_pretty.R')
source('scripts/R_krusk.R')
source('scripts/removeTaxa.R')
source('scripts/kaijuCreatePhyseq.R')
set.seed(1)
theme_set(theme_bw())
```

### Prepare dbCAN data ***DON'T RUN***
```{r}
# Load data
otu.i <- read.csv('dbcan/inulin_dbcan_otu_table.csv', row.names=1)
tax.i <- read.csv('dbcan/inulin_dbcan_tax_table.csv', row.names=1, header = T)
tax.i <- tax_table(tax.i)
taxa_names(tax.i) <- tax.i[,2]
colnames(tax.i) <- c("Class", "Family")

otu.s <- read.csv('dbcan/saline_dbcan_otu_table.csv', row.names=1)
tax.s <- read.csv('dbcan/saline_dbcan_tax_table.csv', row.names=1, header = T)
tax.s <- tax_table(tax.s)
taxa_names(tax.s) <- tax.s[,2]
colnames(tax.s) <- c("Class", "Family")


meta <- read.csv('metadata_metag.csv', row.names = 2)


# Combine inulin & saline data
phy.i <- merge_phyloseq(sample_data(meta), tax.i, otu_table(otu.i, taxa_are_rows = T))
phy.s <- merge_phyloseq(sample_data(meta), tax.s, otu_table(otu.s, taxa_are_rows = T))
phy <- merge_phyloseq(phy.i, phy.s)
phy <- prune_taxa(taxa_names(phy) != "cohesin", phy)
  # Remove cohesin
phy <- prune_taxa(taxa_names(phy) != "SLH", phy)
  # Remove SLH

# Remove outlier (S-W20)
phy <- prune_samples(x = phy, sample_names(phy) != "S.W20")


# Remove CAZymes that appear in < 3 samples
cazy.rem <- list()
otu <- data.frame(otu_table(phy))
for(i in 1:nrow(otu)){
  empty <- length(which(otu[i,] == 0))
    # Identifies # of samples w/o CAZyme
  if(empty > 15){
    # If CAZyme appears < 3 samples
    cazy.rem <- append(cazy.rem, i)
      # Create list of CAZymes that appear in < 3 samples
  }
}
cazy.rem.row <- as.numeric(cazy.rem)
  # Convert list to numeric
otu.rem <- otu[-cazy.rem.row,]
  # Remove CAZymes that appear in < 3 samples
  # 6 CAZymes
  # GT52, GT89, CE5, GH121, GT44, GT61


# Create phyloseq object
cazy.phy <- merge_phyloseq(sample_data(phy), tax_table(phy), otu_table(otu.rem, taxa_are_rows = T))
#save(cazy.phy, file = "cazy.phy.RData")  
  



# Normalized Counts At Family-level
# https://hbctraining.github.io/DGE_workshop/lessons/02_DGE_count_normalization.html
otu.rem <- data.frame(otu_table(cazy.phy))
cazy.dds <- DESeqDataSetFromMatrix(countData = otu.rem, colData = data.frame(sample_data(cazy.phy)), design = ~ Season)
cazy.dds <- estimateSizeFactors(cazy.dds)
cazy.norm <- counts(cazy.dds, normalized=T)
#write.csv(cazy.norm, file="dbcan/cazy.Normalized.Counts.Family.csv")

cazy.fam.norm <- read.csv('dbcan/cazy.Normalized.Counts.Family.csv', row.names=1)
cazy.fam.norm.otu <- otu_table(cazy.fam.norm, taxa_are_rows=T)
cazy.fam.norm.phy <- merge_phyloseq(cazy.fam.norm.otu, sample_data(cazy.phy), tax_table(cazy.phy))
#save(cazy.fam.norm.phy, file = "cazy.fam.norm.phy.RData")

# Normalize Counts to Class-Level
cazy.class <- tax_glom(cazy.phy, taxrank="Class")
cazy.class.otu <- data.frame(otu_table(cazy.class))
cazy.dds <- DESeqDataSetFromMatrix(countData = cazy.class.otu, 
                                   colData = data.frame(sample_data(cazy.phy)), 
                                   design = ~ Season)
cazy.dds <- estimateSizeFactors(cazy.dds)
cazy.class.norm <- counts(cazy.dds, normalized=T)
#write.csv(cazy.class.norm, file="dbcan/cazy.Normalized.Counts.Class.csv")

cazy.class.norm <- read.csv('dbcan/cazy.Normalized.Counts.Class.csv', row.names=1)
rownames(cazy.class.norm) <- c("Carbohydrate Esterase", "Glycoside Hydrolase", "Glycosyltransferase", "Polysaccharide Lyase")

```


### Load phyloseq object
```{r}
# Load data
meta <- read.csv('metadata_metag.csv', row.names = 2)
meta <- meta[-which(rownames(meta) == "S.W20"),]
load("cazy.phy.Rdata")
cazy.fam.norm <- read.csv('dbcan/cazy.Normalized.Counts.Family.csv', row.names=1)
load("cazy.fam.norm.phy.RData")
cazy.class.norm <- read.csv('dbcan/cazy.Normalized.Counts.Class.csv', row.names=1)
rownames(cazy.class.norm) <- c("Carbohydrate Esterase", "Glycoside Hydrolase", "Glycosyltransferase", "Polysaccharide Lyase")
```


### Count unique CAZyme families
```{r}
# Subset out samples by season
phy.sum <- subset_samples(cazy.phy, Season == "Summer")
phy.win <- subset_samples(cazy.phy, Season == "Winter")
phy.spr <- subset_samples(cazy.phy, Season == "Spring")


# Pull out unique CAZyme families in each season and order alphabetically
phy.sum <- filter_taxa(phy.sum, function(x) sum(x) > 0, T)
sum.fam <- get_taxa_unique(phy.sum, "Family")
sum.fam <- sort(sum.fam)
phy.win <- filter_taxa(phy.win, function(x) sum(x) > 0, T)
win.fam <- get_taxa_unique(phy.win, "Family")
win.fam <- sort(win.fam)
phy.spr <- filter_taxa(phy.spr, function(x) sum(x) > 0, T)
spr.fam <- get_taxa_unique(phy.spr, "Family")
spr.fam <- sort(spr.fam)


# Summer - Count # of CAZymes in each class
class <- substr(sum.fam,1,2)
length(which(class == "GH"))
  # 118
length(which(class == "GT"))
  # 52
length(which(class == "CE"))
  # 14
length(which(class == "PL"))
  # 23


# Winter - Count # of CAZymes in each class
class <- substr(win.fam,1,2)
length(which(class == "GH"))
  # 111
length(which(class == "GT"))
  # 49
length(which(class == "CE"))
  # 14
length(which(class == "PL"))
  # 21


# Spring - Count # of CAZymes in each class
class <- substr(spr.fam,1,2)
length(which(class == "GH"))
  # 115
length(which(class == "GT"))
  # 53
length(which(class == "CE"))
  # 14
length(which(class == "PL"))
  # 22
```


### Class-level dot plot
```{r}
# Create phyloseq object to summarize data
class.tax <- data.frame(c("Carbohydrate Esterase", "Glycoside Hydrolase", "Glycosyltransferase", 
                          "Polysaccharide Lyase"))
class.tax <- tax_table(class.tax)
row.names(class.tax) <- class.tax[,1]
colnames(class.tax) <- "Class"
cazy.class.norm.otu <- otu_table(cazy.class.norm, taxa_are_rows=T)
class.phy <- merge_phyloseq(cazy.class.norm.otu, class.tax, sample_data(meta))

# Calculate relative abundance
class.phy <- transform_sample_counts(class.phy, function(x){(x/sum(x))*100})

# Summarize data
class.df <- psmelt(class.phy)
class.df$Class <- ordered(class.df$Class, c("Glycoside Hydrolase", "Glycosyltransferase",
                                            "Carbohydrate Esterase","Polysaccharide Lyase"))
class.df$Season <- ordered(class.df$Season, levels = c("Summer", "Winter", "Spring"))
#class.sum <- class.df %>%
#  group_by(Class, Season) %>%
#  summarize(Mean = mean(Abundance),
#            SD = sd(Abundance),
#            SE = se(Abundance))
#cazy.class.sum$Class <- ordered(cazy.class.sum$Class, c("Glycoside Hydrolase",
#                                                                  "Glycosyltransferase",
#                                                                  "Carbohydrate Esterase",
#                                                                  "Polysaccharide Lyase"))
#cazy.class.sum$Season <- ordered(cazy.class.sum$Season, levels = c("Summer", "Winter", #"Spring"))
```


### Test class-level
```{r}
### CE
ce <- class.df[which(class.df$Class == "Carbohydrate Esterase"),]

# Test normality
hist(ce$Abundance)
qqnorm(ce$Abundance)
qqline(ce$Abundance)
shapiro.test(ce$Abundance)
  # p-value = 0.9824
  # Normal

# Test CE w/ ANOVA
summary(aov(Abundance ~ Season, data = ce))
  # p-value = 0.0273*
TukeyHSD(aov(Abundance ~ Season, data = ce))
  # Summer-Winter = 0.0982259
  # Summer-Spring = 0.7254842
  # Winter-Spring = 0.0252833*

# Test CE variance
fligner.test(Abundance ~ Season, data = ce)
  # p-value = 0.993



### GH
gh <- class.df[which(class.df$Class == "Glycoside Hydrolase"),]

# Test normality
hist(gh$Abundance)
qqnorm(gh$Abundance)
qqline(gh$Abundance)
shapiro.test(gh$Abundance)
  # p-value = 0.1289
  # Normal

# Test GH w/ ANOVA
summary(aov(Abundance ~ Season, data = gh))
  # p-value = 0.0188*
TukeyHSD(aov(Abundance ~ Season, data = gh))
  # Summer-Winter = 0.0478718*
  # Summer-Spring = 0.9011395
  # Winter-Spring = 0.0218147*

# Test GH variance
fligner.test(Abundance ~ Season, gh)
  # p-value = 0.7951



### GT
gt <- class.df[which(class.df$Class == "Glycosyltransferase"),]

# Test normality
hist(gt$Abundance)
qqnorm(gt$Abundance)
qqline(gt$Abundance)
shapiro.test(gt$Abundance)
  # p-value = 0.5863
  # Normal

# Test GT w/ ANOVA
summary(aov(Abundance ~ Season, data = gt))
  # p-value = 0.173

# Test GT variance
fligner.test(Abundance ~ Season, gt)
  # p-value = 0.4993



### PL
pl <- class.df[which(class.df$Class == "Polysaccharide Lyase"),]

# Test normality
hist(pl$Abundance)
qqnorm(pl$Abundance)
qqline(pl$Abundance)
shapiro.test(pl$Abundance)
  # p-value = 0.01793
  # Not Normal

# Test PL w/ ANOVA
kruskal.test(Abundance ~ Season, pl)
  # p-value = 0.7604

# Test PL variance
fligner.test(Abundance ~ Season, pl)
  # p-value = 0.04577*
```



### Prepare Plot - Class dotplot
```{r}
### Steal Season legend
season.legend <- g_legend(ggplot(class.df[which(class.df$OTU == "Glycoside Hydrolase"),], 
                   aes(x=Season, y=Abundance, fill=Season)) + 
                     geom_dotplot(binaxis='y', stackdir='center', 
                                  dotsize=1.5, stackratio=1.2) +
                     scale_fill_manual(name="Season", 
                                       values=c("#E69F00", "#0072B2", "#00bf8b")) +
                     theme(panel.grid.major = element_blank(),
                           panel.grid.minor = element_blank(),
                           strip.background = element_blank(),
                           legend.title = element_text(size=12, face = "bold"),
                           legend.text = element_text(size=12)))




### GH Plot
gh.ann <- data.frame(lab = c("a", "b", "a"), Season = factor(c("Summer", "Winter", "Spring")))

gh.plot <- ggplot(class.df[which(class.df$OTU == "Glycoside Hydrolase"),], 
                   aes(x=Season, y=Abundance, fill=Season)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=1.5, stackratio=1.2) +
  scale_fill_manual(name="Season", values=c("#E69F00", "#0072B2", "#00bf8b")) +
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1), geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.75,
               show.legend = F) +
  scale_y_continuous(limits = c(47.0, 56), breaks=c(47.0, 49.7, 52.4, 55.1)) +
  ylab("Relative Abundance (%)") +
  ggtitle("Glycoside Hydrolase") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        legend.title = element_text(size=12, face = "bold"),
        legend.text = element_text(size=12),
        panel.spacing = unit(0.5, "lines"),
        axis.title.x = element_text(),
        plot.title = element_text(hjust = 0.5, size = 12),
        legend.position = "none") +
  geom_text(data = gh.ann, aes(label=lab), x=c(1,2,3), y=c(56,56,56), size=3.5, color="black")




### GT Plot
gt.ann <- data.frame(lab = c("ns", "", ""), Season = factor(c("Summer", "Winter", "Spring")))

gt.plot <- ggplot(class.df[which(class.df$OTU == "Glycosyltransferase"),], 
                   aes(x=Season, y=Abundance, fill=Season)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=1.5, stackratio=1.2) +
  scale_fill_manual(name="Season", values=c("#E69F00", "#0072B2", "#00bf8b")) +
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1), geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.75,
               show.legend = F) +
  scale_y_continuous(limits = c(31.5, 40.5), breaks=c(31.5, 33.2, 34.9, 36.6, 38.3, 40.0)) +
  ylab("Relative Abundance (%)") +
  ggtitle("Glycosyltransferase") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        #legend.title = element_text(size=12, face = "bold"),
        #legend.text = element_text(size=12),
        panel.spacing = unit(0.5, "lines"),
        axis.title.x = element_text(),
        plot.title = element_text(hjust = 0.5, size = 12),
        legend.position = "none") +
  geom_text(data = gt.ann, aes(label=lab), x=c(2,1,1), y=c(40.5,0,0), size=3.5, color="black")




### CE Plot
ce.ann <- data.frame(lab = c("ab", "a", "b"), Season = factor(c("Summer", "Winter", "Spring")))

ce.plot <- ggplot(class.df[which(class.df$OTU == "Carbohydrate Esterase"),], 
                   aes(x=Season, y=Abundance, fill=Season)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=1.5, stackratio=1.2) +
  scale_fill_manual(name="Season", values=c("#E69F00", "#0072B2", "#00bf8b")) +
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1), geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.75,
               show.legend = F) +
  scale_y_continuous(limits = c(9.1, 11.5), breaks=c(9.1, 10.2, 11.3)) +
  ylab("Relative Abundance (%)") +
  ggtitle("Carbohydrate Esterase") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        #legend.title = element_text(size=12, face = "bold"),
        #legend.text = element_text(size=12),
        panel.spacing = unit(0.5, "lines"),
        axis.title.x = element_text(),
        plot.title = element_text(hjust = 0.5, size = 12),
        legend.position = "none") +
  geom_text(data = ce.ann, aes(label=lab), x=c(1,2,3), y=c(11.5,11.5,11.5), size=3.5, color="black")




### PL Plot
pl.ann <- data.frame(lab = c("ns", "", ""), Season = factor(c("Summer", "Winter", "Spring")))

pl.plot <- ggplot(class.df[which(class.df$OTU == "Polysaccharide Lyase"),], 
                   aes(x=Season, y=Abundance, fill=Season)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize=1.5, stackratio=1.2) +
  scale_fill_manual(name="Season", values=c("#E69F00", "#0072B2", "#00bf8b")) +
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1), geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.75,
               show.legend = F) +
  scale_y_continuous(limits = c(1.7, 2.7), breaks=c(1.7, 2.2, 2.7)) +
  ylab("Relative Abundance (%)") +
  ggtitle("Polysaccharide Lyase") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        #legend.title = element_text(size=12, face = "bold"),
        #legend.text = element_text(size=12),
        panel.spacing = unit(0.5, "lines"),
        axis.title.x = element_text(),
        plot.title = element_text(hjust = 0.5, size = 12),
        legend.position = "none") +
  geom_text(data = pl.ann, aes(label=lab), x=c(2,0,0), y=c(2.7,2.7,2.7), size=3.5, color="black")
```


### Plot - Class dotplot
```{r}
png("prospectus.cazy.class.png", width = 250, height = 70, units = "mm", res = 400)
grid.newpage()
pushViewport(viewport(layout=grid.layout(1,4, widths = c(1,1,1,1))))

print(gh.plot, vp=viewport(layout.pos.row=1, layout.pos.col=1))
#grid.text("A", x=unit(0.065, "npc"), y=unit(0.95, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=1), gp=gpar(fontsize=20,fontface="bold"))


print(gt.plot, vp=viewport(layout.pos.row=1, layout.pos.col=2))
#grid.text("B", x=unit(0.065, "npc"), y=unit(0.95, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=2), gp=gpar(fontsize=20,fontface="bold"))


print(ce.plot, vp=viewport(layout.pos.row=1, layout.pos.col=3))
#grid.text("C", x=unit(0.065, "npc"), y=unit(0.95, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=3), gp=gpar(fontsize=20,fontface="bold"))



print(pl.plot, vp=viewport(layout.pos.row=1, layout.pos.col=4))
#grid.text("D", x=unit(0.065, "npc"), y=unit(0.95, "npc"), vp=viewport(layout.pos.row=1, layout.pos.col=4), gp=gpar(fontsize=20,fontface="bold"))


#season.legend$vp <- viewport(layout.pos.row=1:4, layout.pos.col=2)
#grid.draw(season.legend)
dev.off()
```



### Create DESeq Object
```{r}
# https://www.bioconductor.org/packages/devel/bioc/vignettes/DESeq2/inst/doc/DESeq2.html
# https://compbiocore.github.io/deseq-workshop-1/assets/deseq_workshop_1.html
# https://hbctraining.github.io/DGE_workshop/lessons/02_DGE_count_normalization.html
# Use UN-NORMALIZED data!!!
  # DESeq accounts for library size


### Test DESeq2 to determine fit type
# https://support.bioconductor.org/p/81094/
#dds <- phyloseq_to_deseq2(cazy.phy, ~Season)
#dds$Season <- factor(dds$Season, levels=c("Summer", "Winter", "Spring"))
#dds <- dds[rowSums(counts(dds)) > 1,]
#local <- DESeq(dds, fitType = "local")
#par <- DESeq(dds, fitType = "parametric")
#mad(log(mcols(local)$dispGeneEst) - log(mcols(local)$dispFit))
  # 7.770331
#mad(log(mcols(par)$dispGeneEst) - log(mcols(par)$dispFit))
  # 5.75149
# Parametric is a better fit (lower median absolute residual) than local

### Convert phyloseq object to deseq2 object
dds <- phyloseq_to_deseq2(cazy.phy, ~Season)
  # Design variable must be unordered otherwise you get an error
dds$Season <- factor(dds$Season, levels=c("Summer", "Winter", "Spring"))

# DESeq DataStructure for analyses
dds <- DESeq(dds)

# Hellinger-transformed data for visualizations
hell <- hellinger(t(assay(dds)))
```



### DESeq - find overrep genes
```{r}
# Pull out results from pairwise comparison
sw <- results(dds, contrast=c("Season", "Summer", "Winter"))
sw.sig <- sw[which(sw$padj < 0.05),]
sw.sig[which(sw.sig$log2FoldChange > 0),]
  # Enriched in Summer compared to Winter (positive log2FoldChange)
  # 12 CAZymes
  # CE12, GH10, GH115, GH31, GH42, GH43, GH44, GH5, GH51, GT11, PL1, PL11
sw.sig[which(sw.sig$log2FoldChange < 0),]
  # Enriched in Winter compared to Summer (negative log2FoldChange)
  # 5 CAZymes
  # GH109, GH20, GH33, GH84, GH85

sp <- results(dds, contrast=c("Season", "Summer", "Spring"))
sp.sig <- sp[which(sp$padj < 0.05),]
  # None

wp <- results(dds, contrast=c("Season", "Winter", "Spring"))
wp.sig <- wp[which(wp$padj < 0.05),]
wp.sig[which(wp.sig$log2FoldChange > 0),]
  # Enriched in Winter compared to Spring (positive log2FoldChange)
  # 9 CAZymes
  # GH109, GH20, GH23*, GH33, GH57*, GH84, GH85, GH92, GT3*
wp.sig[which(wp.sig$log2FoldChange < 0),]
  # Enriched in Spring compared to Winter (negative log2FoldChange)
  # 17 CAZymes
  # CE12, CE2, GH10, GH115, GH120*, GH3, GH31, GH42, GH43, GH5, GH51, GH9, GH94, GT11, PL1, PL11, PL9

### Old sig CAZymes to remove: PL12, PL8, GT94, GT24, GH110, GH101, GH89, GH88, GH47, GH26, GH25, GH11, GH8
```



### DESeq heatmap of normalized + transformed counts
```{r}
# Prepare data
hell.otu <- otu_table(t(hell), taxa_are_rows = T)
# Trying it with rel abund
#test <- transform_sample_counts(cazy.fam.norm.phy, function(x){(x/sum(x))*100})
#colnames(hell.otu) <- c("3715", "3717", "3723", "3733", "3734", "3744", "3772", "3773" , "3775")
sig <- merge_phyloseq(hell.otu, tax_table(cazy.phy), sample_data(cazy.phy))


sig.active <- subset_taxa(sig, Family == "GH5" | Family == "GH10" | Family == "GH31" | 
                             Family == "GH42"| Family == "GH44" | Family == "GH51" | 
                             Family == "GH115" | Family == "GT11" | Family == "CE12" | Family == "PL1" |
                             Family == "PL11" | Family == "GH9" | Family == "GH94" |
                             Family == "GH120" | Family == "CE2" | Family == "PL9")
sig.active.high <- subset_taxa(sig, Family == "GH43" | Family == "GH3")
sig.hib <- subset_taxa(sig, Family == "GH20" | Family == "GH33" | Family == "GH84" | Family == "GH85" |
                         Family == "GH109" | Family == "GH23" | Family == "GH57" | Family == "GH92" |
                         Family == "GT3")




##### BY SAMPLE


#tiff("cazy.heatmap.active.tiff", width=13, height=9.5, units="in", res=300)
plot_heatmap(sig.active, sample.label = "Season", sample.order = c("I.S07", "S.S08", "I.S29", "S.S32",
                                                                   "I.S34", "S.S05", "S.W36", "I.W32",
                                                                   "I.W31", "I.W33",  "S.W37", "I.P01",
                                                                   "S.P03", "I.P07", "S.P09", "I.P11",
                                                                   "S.P12"), 
             taxa.order = c("PL9", "CE2", "GH120", "GH94", "GH9", "GH3", "PL11", "PL1", "CE12", "GT11",
                            "GH115", "GH51", "GH44", "GH43", "GH42", "GH31", "GH10", "GH5")) +
  geom_tile(colour="gray40") +
  #scale_x_discrete(position = "top", labels=c(rep("Summer",6), rep("Winter", 5), rep("Spring", 6))) +
  xlab("Season\n\n") +
  ylab("CAZyme Family\n\n") +
  scale_fill_gradientn(name=expression("Hellinger-\ntransformed\nnormalized\ncounts"),
                       colours = c("#FFFFFF", "#FDF8F3", "#f9e7d7", "#f6c6a9", "#f49c74", "#d9444f", "#7b1c59", "#2e1438", "#000000"),
                       limits = c(0.000, 0.133), breaks = c(0.000, 0.033, 0.066, 0.099, 0.132),
                       labels = c("0.000", "0.033", "0.066", "0.099", "0.132")) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=20),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.border=element_blank(),
        axis.title.x = element_text(size=20, face="bold"),
        axis.title.y = element_text(size=20, face="bold"),
        legend.title = element_text(size=20, face="bold"),
        legend.text = element_text(size=20)) +
  guides(fill = guide_colorbar(barheight = unit(7,"in"),
                               frame.colour="black",
                               frame.linewidth=1))
#dev.off()



#tiff("cazy.heatmap.active.high.tiff", width=18, height=2.4, units="in", res=300)
plot_heatmap(sig.active.high, sample.label = "Season", sample.order = c("I.S07", "S.S08", "I.S29", 
                                                                        "S.S32", "I.S34", "S.S05",
                                                                        "S.W36", "I.W32", "I.W31",
                                                                        "I.W33",  "S.W37", "I.P01",
                                                                        "S.P03", "I.P07", "S.P09",
                                                                        "I.P11", "S.P12"), 
             taxa.order = c("GH3", "GH43")) +
  geom_tile(colour="gray40") +
  #scale_x_discrete(position = "top", labels=c(rep("Summer",6), rep("Winter", 5), rep("Spring", 6))) +
  xlab("Season\n\n") +
  ylab("CAZyme Family\n\n") +
  scale_fill_gradientn(name=expression("Hellinger-\ntransformed\nnormalized\ncounts"),
                       colours = c("#FFFFFF", "#FDF8F3", "#f9e7d7", "#f6c6a9", "#f49c74", "#d9444f", "#7b1c59", "#2e1438", "#000000"),
                       limits = c(0.156, 0.244), breaks = c(0.156, 0.178, 0.200, 0.222, 0.244),
                       labels = c("0.156", "0.178", "0.200", "0.222", "0.244")) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=10),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.border=element_blank(),
        axis.title.x = element_text(size=10, face="bold"),
        axis.title.y = element_text(size=10, face="bold"),
        legend.title = element_text(size=10, face="bold"),
        legend.text = element_text(size=10)) +
  guides(fill = guide_colorbar(barheight = unit(1,"in"),
                               frame.colour="black",
                               frame.linewidth=1))
#dev.off()






#tiff("cazy.heatmap.hib.tiff", width=17, height=8.7, units="in", res=300)
plot_heatmap(sig.hib, sample.label = "Season", sample.order = c("I.S07", "S.S08", "I.S29","S.S32",
                                                                "I.S34", "S.S05", "S.W36", "I.W32",
                                                                "I.W31", "I.W33",  "S.W37", "I.P01",
                                                                "S.P03", "I.P07", "S.P09", "I.P11",
                                                                "S.P12"), 
             taxa.order = c("GT3", "GH92", "GH57", "GH23", "GH109", "GH85", "GH84", "GH33", "GH20")) +
  geom_tile(colour="gray40") +
  scale_x_discrete(position = "top", labels=c(rep("Summer",6), rep("Winter", 6), rep("Spring", 6))) +
  xlab("Season\n\n") +
  ylab("CAZyme Family\n\n") +
  scale_fill_gradientn(name=expression("Hellinger-\ntransformed\nnormalized\ncounts"),
                       colours = c("#FFFFFF", "#FDF8F3", "#f9e7d7", "#f6c6a9", "#f49c74", "#d9444f", "#7b1c59", "#2e1438", "#000000"),
                       limits = c(0.02, 0.14), breaks = c(0.02, 0.05, 0.08, 0.11, 0.14),
                       labels = c("0.02", "0.05", "0.08", "0.11", "0.14")) +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_text(size=20),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.border=element_blank(),
        axis.title.x = element_text(size=20, face="bold"),
        axis.title.y = element_text(size=20, face="bold"),
        legend.title = element_text(size=20, face="bold"),
        legend.text = element_text(size=20)) +
  guides(fill = guide_colorbar(barheight = unit(7,"in"),
                               frame.colour="black",
                               frame.linewidth=1))
#dev.off()


```




### DESeq sample dist heatmap / dendrogram
```{r}
# https://www.bioconductor.org/packages/devel/bioc/vignettes/DESeq2/inst/doc/DESeq2.html#exploring-and-exporting-results
# http://bioconductor.org/packages/devel/workflows/vignettes/rnaseqGene/inst/doc/rnaseqGene.html

dist <- dist(hell, method = "euclidean")
dist.matrix <- as.matrix(dist)
rownames(dist.matrix) <- meta$Season
colnames(dist.matrix) <- meta$Season


# Dendrogram
hclust <- hclust(dist, method = "average")
den <- as.dendrogram(hclust)
den.data <- dendro_data(den, type="rectangle")
den.data$leaf_labels <- c(rep("Winter",5), "Spring", "Summer", "Summer", rep("Spring",4), "Summer", "Spring", "Summer", "Summer", "Summer")
den.data$leaf_labels <- ordered(den.data$leaf_labels, levels = c("Summer", "Winter", "Spring"))


#tiff("cazy.dendro.tiff", width=10, height=5, units="in", res=300)
ggplot(den.data$segments) +
  geom_segment(aes(x=x, y=y, xend=xend, yend=yend)) +
  geom_text(data = den.data$labels, aes(x, y, label=den.data$leaf_labels, colour=den.data$leaf_labels,
                                        fontface = "bold"), hjust=0, size=5) +
  ylab("Hellinger Distance") +
  xlab("Season") +
  labs(colour = "Season") +
  coord_flip() +
  scale_y_reverse() +
  scale_color_manual(values=c("#E69F00", "#0072B2", "#00bf8b")) +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank(),
        axis.text.x = element_text(size=20),
        panel.border = element_blank(),
        axis.line.x = element_line(),
        legend.title = element_text(face="bold"),
        axis.title.x = element_text(face="bold", size=20),
        axis.title.y = element_text(face="bold", size=20))
#dev.off()






### Validate clusters
# https://github.com/shimo-lab/pvclust
# https://cran.r-project.org/web/packages/pvclust/pvclust.pdf
# SI: https://rdrr.io/cran/scaleboot/f/vignettes/pvclust.Rmd
clust.test <- pvclust(t(hell), method.hclust = "average", method.dist = "euclidean")
plot(clust.test)
pvrect(clust.test, alpha = 0.95)
#plot(clust.test, print.pv = "si")
#pvrect(clust.test, alpha = 0.95, pv = "si")
```




### Sample dist PCoA & PERMANOVA
```{r}
pcoa <- pcoa(dist)
phy.ord <- cazy.phy
sample_data(phy.ord)$Season <- ordered(sample_data(phy.ord)$Season, levels = c("Summer", "Winter", "Spring"))

#tiff("prospectus.pcoa.tiff", width=8, height=6, units="in", res=300)
plot_ordination(physeq = phy.ord, ordination = pcoa, axes = c(1,2),
                color = "Season") +
  geom_point(size=10) +
  scale_color_manual(values=c("#E69F00", "#0072B2", "#00bf8b")) +
  ggtitle("CAZyme Profiles") +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(size=20),
        axis.title.y = element_text(size=20),
        legend.title = element_text(size=20),
        legend.text = element_text(size=18),
        plot.title = element_blank())
#dev.off()



### Run PERMANOVA on DESEq Hellinger distance
adonis(dist ~ Metabolism, data=meta, permutations = 99999)
  # p-value = 0.1737
beta.tax = betadisper(d=dist, group=meta$Metabolism) 
p <- permutest(beta.tax)
p$tab
  # p-value = 0.711
```


### Taxa
```{r}
#removeTaxa('kaiju/sig_cazymes/CE12/')

### Remove taxa in < 3 samples
#removeTaxa('kaiju/all_shortreads/')

### Create phyloseq objects
#kaijuCreatePhyseq('kaiju/all_shortreads/', 'metadata_metag.csv')
```