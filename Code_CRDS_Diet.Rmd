---
title: "Test Diet"
author: "Edna Chiang"
date: "12/14/2021"
output: html_document
---

### Load Packages, scripts, and functions
```{r}
library(ggplot2)
library(plyr)
library(dplyr)
library(grid)
library(car)
source('scripts/misc.R')
set.seed(1)
theme_set(theme_bw())
```

### Load Data
```{r}
load('crds.norm.RData')
load('crds.use.Rdata')
meta <- read.csv('metadata.csv')
```

### Prepare CRDS data
```{r}
# Add metadata
crds.use[, colnames(meta)[3:ncol(meta)]] <- NA
for(i in 1:nrow(crds.use)){
  meta.row <- which(meta$ID == crds.use$ID[i])
  crds.use[i, 7:ncol(crds.use)] <- meta[meta.row, 3:ncol(meta)]
}

# Calculate square root of AUC
crds.use$AUC <- as.numeric(crds.use$AUC)
minAUC <- min(crds.use$AUC)
crds.use$AUC_sqrt <- crds.use$AUC + (minAUC * -1)
crds.use$AUC_sqrt <- sqrt(crds.use$AUC_sqrt)

# Convert to numeric
crds.use$AvgD <- as.numeric(crds.use$AvgD)
crds.use$MaxD <- as.numeric(crds.use$MaxD)
crds.use$MaxSlope <- as.numeric(crds.use$MaxSlope)
crds.use$AUC <- as.numeric(crds.use$AUC)
crds.use$AUC_sqrt <- as.numeric(crds.use$AUC_sqrt)
crds.use$Baseline <- as.numeric(crds.use$Baseline)

# Order categorical variables
crds.use$Season <- ordered(crds.use$Season, levels = c("Summer", "Winter", "Spring"))
crds.use$Sex <- ordered(crds.use$Sex, levels = c("Female", "Male"))
crds.use$Antibiotics <- ordered(crds.use$Antibiotics, levels = c("No", "Yes"))
crds.use$Substrate <- ordered(crds.use$Substrate, levels = c("Inulin", "Saline"))
crds.use$Diet <- ordered(crds.use$Diet, levels = c("1", "2"))

# Remove outliers
crds.rem <- crds.use[-which(crds.use$ID == "S23"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "S37"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "S60"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "W43"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "W20"),]
  # This is due to odd metagenome
crds.rem <- crds.rem[-which(crds.rem$ID == "W50"),]


# Separate by substrate
crds.inu <- crds.rem[which(crds.rem$Substrate == "Inulin"),]
crds.sal <- crds.rem[which(crds.rem$Substrate == "Saline"),]

# Separate by substrate + ABX
crds.inu.abx <- crds.inu[which(crds.inu$Antibiotics == "Yes"),]
crds.inu.noabx <- crds.inu[which(crds.inu$Antibiotics == "No"),]
crds.sal.abx <- crds.sal[which(crds.sal$Antibiotics == "Yes"),]
crds.sal.noabx <- crds.sal[which(crds.sal$Antibiotics == "No"),]

# Separate by substrate + season
crds.inu.s <- crds.inu[which(crds.inu$Season == "Summer"),]
crds.inu.w <- crds.inu[which(crds.inu$Season == "Winter"),]
crds.inu.p <- crds.inu[which(crds.inu$Season == "Spring"),]
crds.sal.s <- crds.sal[which(crds.sal$Season == "Summer"),]
crds.sal.w <- crds.sal[which(crds.sal$Season == "Winter"),]
crds.sal.p <- crds.sal[which(crds.sal$Season == "Spring"),]

# Separate by substrate + season + antibiotics
#crds.inu.s.noabx <- crds.inu.s[which(crds.inu.s$Antibiotics == "No"),]
#crds.inu.s.abx <- crds.inu.s[which(crds.inu.s$Antibiotics == "Yes"),]
#crds.inu.w.noabx <- crds.inu.w[which(crds.inu.w$Antibiotics == "No"),]
#crds.inu.w.abx <- crds.inu.w[which(crds.inu.w$Antibiotics == "Yes"),]
#crds.inu.p.noabx <- crds.inu.p[which(crds.inu.p$Antibiotics == "No"),]
#crds.inu.p.abx <- crds.inu.p[which(crds.inu.p$Antibiotics == "Yes"),]
#crds.sal.s.noabx <- crds.sal.s[which(crds.sal.s$Antibiotics == "No"),]
crds.sal.s.abx <- crds.sal.s[which(crds.sal.s$Antibiotics == "Yes"),]
#crds.sal.w.noabx <- crds.sal.w[which(crds.sal.w$Antibiotics == "No"),]
#crds.sal.w.abx <- crds.sal.w[which(crds.sal.w$Antibiotics == "Yes"),]
crds.sal.p.noabx <- crds.sal.p[which(crds.sal.p$Antibiotics == "No"),]
#crds.sal.p.abx <- crds.sal.p[which(crds.sal.p$Antibiotics == "Yes"),]

# Separate by substrate + season + antibiotics + diet
crds.sal.s.abx.1 <- crds.sal.s.abx[which(crds.sal.s.abx$Diet == "1"),]
crds.sal.s.abx.2 <- crds.sal.s.abx[which(crds.sal.s.abx$Diet == "2"),]
crds.sal.p.noabx1 <- crds.sal.p.noabx[which(crds.sal.p.noabx$Diet == "1"),]
crds.sal.p.noabx2 <- crds.sal.p.noabx[which(crds.sal.p.noabx$Diet == "2"),]
```

### Test Baseline
```{r}
### Saline Summer ABX
res <- resid(lm(Baseline ~ Diet, crds.sal.s.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
var.test(Baseline ~ Diet, crds.sal.s.abx)
  # p = 0.3087
  # CI = 0.1405008 213.7017544
t.test(Baseline ~ Diet, crds.sal.s.abx)
  # Diet p = 0.9143
  # CI = -1.782114  1.662114



### Saline Spring No ABX
res <- resid(lm(Baseline ~ Diet, crds.sal.p.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
var.test(Baseline ~ Diet, crds.sal.p.noabx)
  # p = 0.1722
  # CI = 0.004123699 2.591231036
t.test(Baseline ~ Diet, crds.sal.p.noabx)
  # Diet p = 0.1306
  # CI =  -2.059159  8.795826

```

### Test AUC_sqrt
```{r}
### Saline Summer ABX
res <- resid(lm(AUC_sqrt ~ Diet, crds.sal.s.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
var.test(AUC_sqrt ~ Diet, crds.sal.s.abx)
  # p = 0.1852
  # CI = 0.2511889 382.0583410
t.test(AUC_sqrt ~ Diet, crds.sal.s.abx)
  # Diet p = 0.268
  # CI = -0.1345586  0.3064121


### Saline Spring No ABX
res <- resid(lm(AUC_sqrt ~ Diet, crds.sal.p.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
var.test(AUC_sqrt ~ Diet, crds.sal.p.noabx)
  # p = 0.3769
  # CI = 0.1139545 71.6061810
t.test(AUC_sqrt ~ Diet, crds.sal.p.noabx)
  # Diet p = 0.06659
  # CI =  -0.30517107  0.01512587

```


### Test AvgD
```{r}
### Saline Summer ABX
res <- resid(lm(AvgD ~ Diet, crds.sal.s.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
var.test(AvgD ~ Diet, crds.sal.s.abx)
  # p = 0.7124
  # CI = 0.01418543 21.57603599
t.test(AvgD ~ Diet, crds.sal.s.abx)
  # p = 0.03003*
  # CI = 0.3373245 3.7816588

  

### Saline Spring No ABX
res <- resid(lm(AvgD ~ Diet, crds.sal.p.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
var.test(AvgD ~ Diet, crds.sal.p.noabx)
  # p = 0.8107
  # CI = 0.02061477 12.95381629
t.test(AvgD ~ Diet, crds.sal.p.noabx)
  # Diet p = 0.1803
  # CI = -2.9438965  0.7647299

```


### Test MaxD
```{r}
### Saline Summer ABX
res <- resid(lm(MaxD ~ Diet, crds.sal.s.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
var.test(MaxD ~ Diet, crds.sal.s.abx)
  # p = 0.5284
  # CI = 0.009205925 14.002211533
t.test(MaxD ~ Diet, crds.sal.s.abx)
  # Diet p = 0.04545
  # CI = 0.08752738 4.74478925




### Saline Spring No ABX
res <- resid(lm(MaxD ~ Diet, crds.sal.p.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
var.test(MaxD ~ Diet, crds.sal.p.noabx)
  # p = 0.6419
  # CI = 0.05782592 36.33638334
t.test(MaxD ~ Diet, crds.sal.p.noabx)
  # Diet p = 0.01287*
  # CI = -3.2910880 -0.6283564

```

### Test Max Slope
```{r}
### Saline Summer ABX
res <- resid(lm(MaxSlope ~ Diet, crds.sal.s.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
var.test(MaxSlope ~ Diet, crds.sal.s.abx)
  # p = 0.1236
  # CI = 0.3892262 592.0129772
t.test(MaxSlope ~ Diet, crds.sal.s.abx)
  # Diet p = 0.04078
  # CI = 0.2989149 6.0204070




### Saline Spring No ABX
res <- resid(lm(MaxSlope ~ Diet, crds.sal.p.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
var.test(MaxSlope ~ Diet, crds.sal.p.noabx)
  # p = 0.2304
  # CI = 0.005279595 3.317567710
t.test(MaxSlope ~ Diet, crds.sal.p.noabx)
  # Diet p = 0.9466
  # CI = -5.984995  5.735285

```


### Adjust P
```{r}
### Summer Saline ABX
# T-tests
p.adjust(c(0.9143, 0.268, 0.03003, 0.04545, 0.040788), "BH")
  # 0.91430 0.33500 0.07575 0.07575 0.07575

# F-tests
p.adjust(c(0.3087, 0.1852, 0.7124, 0.5284, 0.1236), "BH")
  # 0.5145 0.4630 0.7124 0.6605 0.4630


### Spring Saline No ABX
p.adjust(c(0.1306, 0.06659, 0.1803, 0.01287, 0.9466), "BH")
  # 0.2176667 0.1664750 0.2253750 0.0643500 0.9466000

# F-tests
p.adjust(c(0.1722, 0.3769, 0.8107, 0.6419, 0.2304), "BH")
  # 0.5760000 0.6281667 0.8107000 0.8023750 0.5760000

```