---
title: "Test Diet"
author: "Edna Chiang"
date: "12/14/2021"
output: html_document
---

### Load Packages, scripts, and functions
```{r}
library(ggplot2)
library(plyr)
library(dplyr)
library(grid)
library(MESS)
library(pgirmess)
library(Bolstad2)
library(phyloseq)
library(psych)
library(car)
library(equivalence)
source('scripts/misc.R')
set.seed(1)
theme_set(theme_bw())
```

### Load Data
```{r}
load('crds.norm.RData')
load('crds.use.Rdata')
meta <- read.csv('metadata.csv')
```

### Prepare CRDS data
```{r}
# Add metadata
crds.use[, colnames(meta)[3:ncol(meta)]] <- NA
for(i in 1:nrow(crds.use)){
  meta.row <- which(meta$ID == crds.use$ID[i])
  crds.use[i, 7:ncol(crds.use)] <- meta[meta.row, 3:ncol(meta)]
}

# Calculate square root of AUC
crds.use$AUC <- as.numeric(crds.use$AUC)
minAUC <- min(crds.use$AUC)
crds.use$AUC_sqrt <- crds.use$AUC + (minAUC * -1)
crds.use$AUC_sqrt <- sqrt(crds.use$AUC_sqrt)

# Convert to numeric
crds.use$AvgDelta <- as.numeric(crds.use$AvgDelta)
crds.use$MaxD <- as.numeric(crds.use$MaxD)
crds.use$MaxSlope <- as.numeric(crds.use$MaxSlope)
crds.use$AUC <- as.numeric(crds.use$AUC)
crds.use$AUC_sqrt <- as.numeric(crds.use$AUC_sqrt)

# Order categorical variables
crds.use$Season <- ordered(crds.use$Season, levels = c("Summer", "Winter", "Spring"))
crds.use$Sex <- ordered(crds.use$Sex, levels = c("Female", "Male"))
crds.use$Antibiotics <- ordered(crds.use$Antibiotics, levels = c("No", "Yes"))
crds.use$Substrate <- ordered(crds.use$Substrate, levels = c("Inulin", "Saline"))
crds.use$Diet <- ordered(crds.use$Diet, levels = c("1", "2"))

# Remove outliers
crds.rem <- crds.use[-which(crds.use$ID == "S23"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "S37"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "S60"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "W43"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "W20"),]
  # This is due to odd metagenome
crds.rem <- crds.rem[-which(crds.rem$ID == "W50"),]


# Separate by substrate
crds.inu <- crds.rem[which(crds.rem$Substrate == "Inulin"),]
crds.sal <- crds.rem[which(crds.rem$Substrate == "Saline"),]

# Separate by substrate + ABX
crds.inu.abx <- crds.inu[which(crds.inu$Antibiotics == "Yes"),]
crds.inu.noabx <- crds.inu[which(crds.inu$Antibiotics == "No"),]
crds.sal.abx <- crds.sal[which(crds.sal$Antibiotics == "Yes"),]
crds.sal.noabx <- crds.sal[which(crds.sal$Antibiotics == "No"),]

# Separate by substrate + season
crds.inu.s <- crds.inu[which(crds.inu$Season == "Summer"),]
crds.inu.w <- crds.inu[which(crds.inu$Season == "Winter"),]
crds.inu.p <- crds.inu[which(crds.inu$Season == "Spring"),]
crds.sal.s <- crds.sal[which(crds.sal$Season == "Summer"),]
crds.sal.w <- crds.sal[which(crds.sal$Season == "Winter"),]
crds.sal.p <- crds.sal[which(crds.sal$Season == "Spring"),]

# Separate by substrate + season + antibiotics
#crds.inu.s.noabx <- crds.inu.s[which(crds.inu.s$Antibiotics == "No"),]
#crds.inu.s.abx <- crds.inu.s[which(crds.inu.s$Antibiotics == "Yes"),]
#crds.inu.w.noabx <- crds.inu.w[which(crds.inu.w$Antibiotics == "No"),]
#crds.inu.w.abx <- crds.inu.w[which(crds.inu.w$Antibiotics == "Yes"),]
#crds.inu.p.noabx <- crds.inu.p[which(crds.inu.p$Antibiotics == "No"),]
#crds.inu.p.abx <- crds.inu.p[which(crds.inu.p$Antibiotics == "Yes"),]
#crds.sal.s.noabx <- crds.sal.s[which(crds.sal.s$Antibiotics == "No"),]
crds.sal.s.abx <- crds.sal.s[which(crds.sal.s$Antibiotics == "Yes"),]
#crds.sal.w.noabx <- crds.sal.w[which(crds.sal.w$Antibiotics == "No"),]
#crds.sal.w.abx <- crds.sal.w[which(crds.sal.w$Antibiotics == "Yes"),]
crds.sal.p.noabx <- crds.sal.p[which(crds.sal.p$Antibiotics == "No"),]
#crds.sal.p.abx <- crds.sal.p[which(crds.sal.p$Antibiotics == "Yes"),]
```

### Test AUC_sqrt
```{r}
### Saline Summer ABX
res <- resid(lm(AUC_sqrt ~ Diet, crds.sal.s.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(AUC_sqrt ~ Diet, crds.sal.s.abx))
  # Diet p = 0.321
var.test(AUC_sqrt ~ Diet, crds.sal.s.abx)
  # p = 0.3737


### Saline Spring No ABX
res <- resid(lm(AUC_sqrt ~ Diet, crds.sal.p.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(AUC_sqrt ~ Diet, crds.sal.p.noabx))
  # Diet p = 0.135
var.test(AUC_sqrt ~ Diet, crds.sal.p.noabx)
  # p = 0.5353
```


### Test AvgDelta
```{r}
### Saline Summer ABX
res <- resid(lm(AvgDelta ~ Diet, crds.sal.s.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(AvgDelta ~ Diet, crds.sal.s.abx))
  # Diet p = 0.17
var.test(AvgDelta ~ Diet, crds.sal.s.abx)
  # p = 0.4674
  

### Saline Spring No ABX
res <- resid(lm(AvgDelta ~ Diet, crds.sal.p.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(AvgDelta ~ Diet, crds.sal.p.noabx))
  # Diet p = 0.145
var.test(AvgDelta ~ Diet, crds.sal.p.noabx)
  # p = 0.5345
```


### Test MaxD
```{r}
### Saline Summer ABX
res <- resid(lm(MaxD ~ Diet, crds.sal.s.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(MaxD ~ Diet, crds.sal.s.abx))
  # Diet p = 0.124
var.test(MaxD ~ Diet, crds.sal.s.abx)
  # p = 0.741



### Saline Spring No ABX
res <- resid(lm(MaxD ~ Diet, crds.sal.p.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(MaxD ~ Diet, crds.sal.p.noabx))
  # Diet p = 0.0171
var.test(MaxD ~ Diet, crds.sal.p.noabx)
  # p = 0.8439
```

### Test Slope
```{r}
### Saline Summer ABX
res <- resid(lm(MaxSlope ~ Diet, crds.sal.s.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(MaxSlope ~ Diet, crds.sal.s.abx))
  # Diet p = 0.0124
var.test(MaxSlope ~ Diet, crds.sal.s.abx)
  # p = 0.6804



### Saline Spring No ABX
res <- resid(lm(MaxSlope ~ Diet, crds.sal.p.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
summary(aov(MaxSlope ~ Diet, crds.sal.p.noabx))
  # Diet p = 0.128
var.test(MaxSlope ~ Diet, crds.sal.p.noabx)
  # p = 0.3409
```