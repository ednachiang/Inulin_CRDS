---
title: "Test Diet"
author: "Edna Chiang"
date: "12/14/2021"
output: html_document
---

### Load Packages, scripts, and functions
```{r}
library(ggplot2)
library(plyr)
library(dplyr)
library(grid)
library(car)
source('scripts/misc.R')
set.seed(1)
theme_set(theme_bw())
```

### Load Data
```{r}
load('crds.norm.RData')
load('crds.use.Rdata')
meta <- read.csv('metadata.csv')
```

### Prepare CRDS data
```{r}
# Add metadata
crds.use[, colnames(meta)[3:ncol(meta)]] <- NA
for(i in 1:nrow(crds.use)){
  meta.row <- which(meta$ID == crds.use$ID[i])
  crds.use[i, 7:ncol(crds.use)] <- meta[meta.row, 3:ncol(meta)]
}

# Calculate square root of AUC
crds.use$AUC <- as.numeric(crds.use$AUC)
minAUC <- min(crds.use$AUC)
crds.use$AUC_sqrt <- crds.use$AUC + (minAUC * -1)
crds.use$AUC_sqrt <- sqrt(crds.use$AUC_sqrt)

# Convert to numeric
crds.use$AvgD <- as.numeric(crds.use$AvgD)
crds.use$MaxD <- as.numeric(crds.use$MaxD)
crds.use$MaxSlope <- as.numeric(crds.use$MaxSlope)
crds.use$AUC <- as.numeric(crds.use$AUC)
crds.use$AUC_sqrt <- as.numeric(crds.use$AUC_sqrt)
crds.use$Baseline <- as.numeric(crds.use$Baseline)

# Order categorical variables
crds.use$Season <- ordered(crds.use$Season, levels = c("Summer", "Winter", "Spring"))
crds.use$Sex <- ordered(crds.use$Sex, levels = c("Female", "Male"))
crds.use$Antibiotics <- ordered(crds.use$Antibiotics, levels = c("No", "Yes"))
crds.use$Substrate <- ordered(crds.use$Substrate, levels = c("Inulin", "Saline"))
crds.use$Diet <- ordered(crds.use$Diet, levels = c("1", "2"))

# Remove outliers
crds.rem <- crds.use[-which(crds.use$ID == "S23"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "S37"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "S60"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "W43"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "W20"),]
  # This is due to odd metagenome
crds.rem <- crds.rem[-which(crds.rem$ID == "W50"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "P20"),]
crds.rem <- crds.rem[-which(crds.rem$ID == "P22"),]

# Separate by substrate
crds.inu <- crds.rem[which(crds.rem$Substrate == "Inulin"),]
crds.sal <- crds.rem[which(crds.rem$Substrate == "Saline"),]

# Separate by substrate + ABX
crds.inu.abx <- crds.inu[which(crds.inu$Antibiotics == "Yes"),]
crds.inu.noabx <- crds.inu[which(crds.inu$Antibiotics == "No"),]
crds.sal.abx <- crds.sal[which(crds.sal$Antibiotics == "Yes"),]
crds.sal.noabx <- crds.sal[which(crds.sal$Antibiotics == "No"),]

# Separate by substrate + season
crds.inu.s <- crds.inu[which(crds.inu$Season == "Summer"),]
crds.inu.w <- crds.inu[which(crds.inu$Season == "Winter"),]
crds.inu.p <- crds.inu[which(crds.inu$Season == "Spring"),]
crds.sal.s <- crds.sal[which(crds.sal$Season == "Summer"),]
crds.sal.w <- crds.sal[which(crds.sal$Season == "Winter"),]
crds.sal.p <- crds.sal[which(crds.sal$Season == "Spring"),]

# Separate by substrate + season + antibiotics
#crds.inu.s.noabx <- crds.inu.s[which(crds.inu.s$Antibiotics == "No"),]
#crds.inu.s.abx <- crds.inu.s[which(crds.inu.s$Antibiotics == "Yes"),]
#crds.inu.w.noabx <- crds.inu.w[which(crds.inu.w$Antibiotics == "No"),]
#crds.inu.w.abx <- crds.inu.w[which(crds.inu.w$Antibiotics == "Yes"),]
#crds.inu.p.noabx <- crds.inu.p[which(crds.inu.p$Antibiotics == "No"),]
#crds.inu.p.abx <- crds.inu.p[which(crds.inu.p$Antibiotics == "Yes"),]
#crds.sal.s.noabx <- crds.sal.s[which(crds.sal.s$Antibiotics == "No"),]
crds.sal.s.abx <- crds.sal.s[which(crds.sal.s$Antibiotics == "Yes"),]
#crds.sal.w.noabx <- crds.sal.w[which(crds.sal.w$Antibiotics == "No"),]
#crds.sal.w.abx <- crds.sal.w[which(crds.sal.w$Antibiotics == "Yes"),]
crds.sal.p.noabx <- crds.sal.p[which(crds.sal.p$Antibiotics == "No"),]
#crds.sal.p.abx <- crds.sal.p[which(crds.sal.p$Antibiotics == "Yes"),]

# Separate by substrate + season + antibiotics + diet
crds.sal.s.abx.1 <- crds.sal.s.abx[which(crds.sal.s.abx$Diet == "1"),]
crds.sal.s.abx.2 <- crds.sal.s.abx[which(crds.sal.s.abx$Diet == "2"),]
crds.sal.p.noabx1 <- crds.sal.p.noabx[which(crds.sal.p.noabx$Diet == "1"),]
crds.sal.p.noabx2 <- crds.sal.p.noabx[which(crds.sal.p.noabx$Diet == "2"),]
```

### Test Baseline
```{r}
### Saline Summer ABX
res <- resid(lm(Baseline ~ Diet, crds.sal.s.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
var.test(Baseline ~ Diet, crds.sal.s.abx)
  # p = 0.3087
  # CI = 0.1405008 213.7017544
t.test(Baseline ~ Diet, crds.sal.s.abx)
  # Diet p = 0.9143
  # CI = -1.782114  1.662114



### Saline Spring No ABX
res <- resid(lm(Baseline ~ Diet, crds.sal.p.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
var.test(Baseline ~ Diet, crds.sal.p.noabx)
  # p = 0.1722
  # CI = 0.004123699 2.591231036
t.test(Baseline ~ Diet, crds.sal.p.noabx)
  # Diet p = 0.1306
  # CI =  -2.059159  8.795826

```

### Test AUC_sqrt
```{r}
### Saline Summer ABX
res <- resid(lm(AUC_sqrt ~ Diet, crds.sal.s.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
var.test(AUC_sqrt ~ Diet, crds.sal.s.abx)
  # p = 0.604
  # CI = 0.05926816 90.14687021
t.test(AUC_sqrt ~ Diet, crds.sal.s.abx)
  # Diet p = 0.451
  # CI = -0.1254548  0.2263755


### Saline Spring No ABX
res <- resid(lm(AUC_sqrt ~ Diet, crds.sal.p.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
var.test(AUC_sqrt ~ Diet, crds.sal.p.noabx)
  # p = 0.9548
  # CI = 0.03144354 19.75834383
t.test(AUC_sqrt ~ Diet, crds.sal.p.noabx)
  # Diet p = 0.06976
  # CI =  -0.3596784  0.0203990

```


### Test AvgD
```{r}
### Saline Summer ABX
res <- resid(lm(AvgD ~ Diet, crds.sal.s.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
var.test(AvgD ~ Diet, crds.sal.s.abx)
  # p = 0.7567
  # CI = 0.04213282 64.08401548
t.test(AvgD ~ Diet, crds.sal.s.abx)
  # p = 0.1504
  # CI = -0.5998532  2.6718912

  

### Saline Spring No ABX
res <- resid(lm(AvgD ~ Diet, crds.sal.p.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
var.test(AvgD ~ Diet, crds.sal.p.noabx)
  # p = 0.5746
  # CI = 0.01312798 8.24930106
t.test(AvgD ~ Diet, crds.sal.p.noabx)
  # Diet p = 0.1842
  # CI = -3.634382  1.021343

```


### Test MaxD
```{r}
### Saline Summer ABX
res <- resid(lm(MaxD ~ Diet, crds.sal.s.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
var.test(MaxD ~ Diet, crds.sal.s.abx)
  # p = 0.6156
  # CI = 0.05766075 87.70199579
t.test(MaxD ~ Diet, crds.sal.s.abx)
  # Diet p = 0.07351
  # CI = -0.1949976  2.5951838




### Saline Spring No ABX
res <- resid(lm(MaxD ~ Diet, crds.sal.p.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
var.test(MaxD ~ Diet, crds.sal.p.noabx)
  # p = 0.6572
  # CI = 0.05596073 35.16434252
t.test(MaxD ~ Diet, crds.sal.p.noabx)
  # Diet p = 0.01297*
  # CI = -3.3050951 -0.6272905

```

### Test Max Slope
```{r}
### Saline Summer ABX
res <- resid(lm(MaxSlope ~ Diet, crds.sal.s.abx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
var.test(MaxSlope ~ Diet, crds.sal.s.abx)
  # p = 0.0805
  # CI = 0.6113762 929.9031256
t.test(MaxSlope ~ Diet, crds.sal.s.abx)
  # Diet p = 0.08127
  # CI = -0.6560599  5.2077483




### Saline Spring No ABX
res <- resid(lm(MaxSlope ~ Diet, crds.sal.p.noabx))
hist(res)
qqnorm(res)
qqline(res)
shapiro.test(res)
  # Normal
var.test(MaxSlope ~ Diet, crds.sal.p.noabx)
  # p = 0.6202
  # CI = 0.0143907 9.0427606
t.test(MaxSlope ~ Diet, crds.sal.p.noabx)
  # Diet p = 0.4842
  # CI = -4.189960  2.415195

```


### Adjust P
```{r}
### Summer Saline ABX
# F-tests
p.adjust(c(0.3087, 0.604, 0.7567, 0.6156, 0.0805), "BH")
  # 0.7567 0.7567 0.7567 0.7567 0.4025

# T-tests
p.adjust(c(0.9143, 0.451, 0.1504, 0.07351, 0.08127), "BH")
  # 0.9143000 0.5637500 0.2506667 0.2031750 0.2031750




### Spring Saline No ABX
# F-tests
p.adjust(c(0.1722, 0.9548, 0.5746, 0.6572, 0.6202), "BH")
  # 0.8215 0.9548 0.8215 0.8215 0.8215

# T-tests
p.adjust(c(0.1306, 0.06976, 0.1842, 0.01297, 0.4842), "BH")
  # 0.2176667 0.1744000 0.2302500 0.0648500 0.4842000


```