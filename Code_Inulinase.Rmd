---
title: "Code_Inulinase"
author: "Edna Chiang"
date: "12/14/2021"
output: html_document
---

### Load Packages, scripts, and functions
```{r}
library(ggplot2)
library(plyr)
library(dplyr)
library(grid)
#library(MESS)
#library(pgirmess)
#library(Bolstad2)
library(phyloseq)
library(vegan)
#library(miLineage)
#library(psych)
library(car)
#source('scripts/import_crds.R')
#source('scripts/bin_crds.R')
source('scripts/misc.R')
#source('scripts/calc_delta_metrics.R')
source('scripts/simper_pretty.R')
source('scripts/R_krusk.R')
set.seed(1)
theme_set(theme_bw())
```



### Average genome size /  Genome Equivalents
```{r}
ags <- read.csv('AverageGenomeSize.csv')

shapiro.test(ags$Avg_Genome_Size)
  # p-value = 0.4778
  # Normal
shapiro.test(ags$Genome_Equivalents)
  # p-value = 0.1762
  # Normal


summary(aov(Avg_Genome_Size ~ Season, data = ags))
  # p-value = 0.298
summary(aov(Genome_Equivalents ~ Season, data = ags))
  # p-value = 0.254

summary(aov(Avg_Genome_Size ~ Metabolism, data = ags))
  # p-value = 0.122
summary(aov(Genome_Equivalents ~ Metabolism, data = ags))
  # p-value = 0.382
```



### Endo/Exo Rel Abund & RPKG
```{r}
### Rel Abund
mapped_all <- read.csv('eCAMI/mapped_reads_all.csv')
exo_mapped <- mapped_all[which(mapped_all$Protein == "Exo"),]
endo_mapped <- mapped_all[which(mapped_all$Protein == "Endo"),]

# Normality
shapiro.test(exo_mapped$RelAbund.100000)
  # p-value = 0.0005701
  # Not Normal
shapiro.test(endo_mapped$RelAbund.100000)
  # p-value = 3.281e-06
  # Not Normal

# Kruskal-Wallis
kruskal.test(formula = RelAbund.100000 ~ Season, data = exo_mapped)
  # p-value = 0.8342
kruskal.test(formula = RelAbund.100000 ~ Season, data = endo_mapped)
  # p-value = 0.3329
kruskal.test(formula = RelAbund.100000 ~ Metabolism, data = exo_mapped)
  # p-value = 0.6396
kruskal.test(formula = RelAbund.100000 ~ Metabolism, data = endo_mapped)
  # p-value = 0.3798

# Variance
leveneTest(RelAbund.100000 ~ Season, data=exo_mapped)
  # p-value = 0.3951
leveneTest(RelAbund.100000 ~ Season, data=endo_mapped)
  # p-value = 0.4414
leveneTest(RelAbund.100000 ~ Metabolism, data=exo_mapped)
  # p-value = 0.2143
leveneTest(RelAbund.100000 ~ Metabolism, data=endo_mapped)
  # p-value = 0.5622



### Exo - RPKG
exo_rpkg <- read.csv('eCAMI/exoRPKG.csv')

shapiro.test(exo_rpkg$RPKG)
  # p-value = 3.348e-05

kruskal.test(formula = RPKG ~ Season, data = exo_rpkg)
  # p-value = 0.9322
kruskal.test(formula = RPKG ~ Metabolism, data = exo_rpkg)
  # p-value = 0.7079

leveneTest(RPKG ~ Season, data=exo_rpkg)
  # p-value = 0.3806
leveneTest(RPKG ~ Metabolism, data=exo_rpkg)
  # p-value = 0.2045
```


### Plot - Rel Abund and RPKG
```{r}
##### This is old code that I'm saving for when I'm ready to make plots

### Plot Endo
endo.plot <- ggplot(endoexo, aes(x=Season, y=Endo_RelAbund, fill=Season)) +
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_fill_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Endo-Inulinase") +
  ylab("Relative Abundance (%)") +
  scale_y_continuous(breaks=c(0.00, 0.0125, 0.025, 0.0375, 0.05), limits=c(0, 0.05)) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.text.x = element_text(size=14),
        axis.text.y = element_text(size=14),
        axis.title.x = element_text(size=20, margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y = element_text(size=20, margin=margin(t=0, r=10, b=0, l=0)),
        strip.text.x = element_text(size=20),
        #strip.text.y = element_text(size=14),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 18),
        legend.text = element_text(size=16),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
  )+
  guides(fill=F)

tiff("endo.mdtp.tiff", width = 5.5, height = 3.5, units = "in", res = 300)
endo.plot
dev.off()


### Plot Exo

legend <- g_legend(exo.plot)

exo.plot <- ggplot(endoexo, aes(x=Season, y=Exo_RelAbund, fill=Season)) +
  geom_dotplot(binaxis='y', stackdir='center') +
  scale_fill_manual(name="Season", values=c("darkgoldenrod2", "dodgerblue3", "green3")) +
  ggtitle("Exo-Inulinase") +
  ylab("Relative Abundance (%)") +
  scale_y_continuous(breaks=c(0.00, 0.0125, 0.025, 0.0375, 0.05), limits=c(0, 0.05)) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.text.x = element_text(size=14),
        axis.text.y = element_text(size=14),
        axis.title.x = element_text(size=20, margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y = element_text(size=20, margin=margin(t=0, r=10, b=0, l=0)),
        strip.text.x = element_text(size=20),
        strip.text.y = element_text(size=14),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 18, face="bold"),
        legend.text = element_text(size=16),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
  ) +
  guides(fill=F)

tiff("exo.mdtp.tiff", width = 5.5, height = 3.5, units = "in", res = 300)
exo.plot
dev.off()



tiff("endo.exo.mdtp.tiff", width = 12.5, height = 3.5, units = "in", res = 300)
grid.newpage()
pushViewport(viewport(layout=(grid.layout(1,3, widths=c(1,1,0.25), heights=c(1,1,1)))))
print(endo.plot, vp=viewport(layout.pos.row=1, layout.pos.col=1))
print(exo.plot, vp=viewport(layout.pos.row=1, layout.pos.col=2))
legend$vp <- viewport(layout.pos.row=1, layout.pos.col=3)
grid.draw(legend)
dev.off()

```



### DON'T RUN - Prepare taxonomic data
```{r}
# Already moved taxa found in < 3 samples

### Import rel abund tables
phy.ra <- read.csv('kaiju/relAbund_tables/exo.phylum.csv', header=T, row.names=1)
cla.ra <- read.csv('kaiju/relAbund_tables/exo.class.csv', header=T, row.names=1)
ord.ra <- read.csv('kaiju/relAbund_tables/exo.order.csv', header=T, row.names=1)
fam.ra <- read.csv('kaiju/relAbund_tables/exo.family.csv', header=T, row.names=1)
gen.ra <- read.csv('kaiju/relAbund_tables/exo.genus.csv', header=T, row.names=1)
spe.ra <- read.csv('kaiju/relAbund_tables/exo.species.csv', header=T, row.names=1)

phy.otu <- otu_table(phy.ra, taxa_are_rows = T)
cla.otu <- otu_table(cla.ra, taxa_are_rows = T)
ord.otu <- otu_table(ord.ra, taxa_are_rows = T)
fam.otu <- otu_table(fam.ra, taxa_are_rows = T)
gen.otu <- otu_table(gen.ra, taxa_are_rows = T)
spe.otu <- otu_table(spe.ra, taxa_are_rows = T)


### Import metadata
meta <- read.csv('metadata_metag.csv', header=T)
meta.samp <- sample_data(meta)
sample_names(meta.samp) <- meta$ID
meta.samp$Season <- ordered(meta$Season, levels=c("Summer", "Winter", "Spring"))


### Create tax table
phy <- data.frame(full = taxa_names(phy.otu))
phy <- cbind(phy,colsplit(phy$full, pattern = ";", names = c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species")))
rownames(phy) <- phy$full
phy <- phy[,-1]

cla <- data.frame(full = taxa_names(cla.otu))
cla <- cbind(cla,colsplit(cla$full, pattern = ";", names = c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species")))
rownames(cla) <- cla$full
cla <- cla[,-1]

ord <- data.frame(full = taxa_names(ord.otu))
ord <- cbind(ord,colsplit(ord$full, pattern = ";", names = c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species")))
rownames(ord) <- ord$full
ord <- ord[,-1]

fam <- data.frame(full = taxa_names(fam.otu))
fam <- cbind(fam,colsplit(fam$full, pattern = ";", names = c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species")))
rownames(fam) <- fam$full
fam <- fam[,-1]

gen <- data.frame(full = taxa_names(gen.otu))
gen <- cbind(gen,colsplit(gen$full, pattern = ";", names = c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species")))
rownames(gen) <- gen$full
gen <- gen[,-1]

spe <- data.frame(full = taxa_names(spe.otu))
spe <- cbind(spe,colsplit(spe$full, pattern = ";", names = c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species")))
rownames(spe) <- spe$full
spe <- spe[,-1]

phy.tax <- tax_table(phy)
cla.tax <- tax_table(cla)
ord.tax <- tax_table(ord)
fam.tax <- tax_table(fam)
gen.tax <- tax_table(gen)
spe.tax <- tax_table(spe)


### Make phyloseq objects
taxa_names(phy.tax) <- taxa_names(phy.otu)
phy.phy <- merge_phyloseq(phy.tax, phy.otu, meta.samp)
taxa_names(cla.tax) <- taxa_names(cla.otu)
cla.phy <- merge_phyloseq(cla.tax, cla.otu, meta.samp)
taxa_names(ord.tax) <- taxa_names(ord.otu)
ord.phy <- merge_phyloseq(ord.tax, ord.otu, meta.samp)
taxa_names(fam.tax) <- taxa_names(fam.otu)
fam.phy <- merge_phyloseq(fam.tax, fam.otu, meta.samp)
taxa_names(gen.tax) <- taxa_names(gen.otu)
gen.phy <- merge_phyloseq(gen.tax, gen.otu, meta.samp)
taxa_names(spe.tax) <- taxa_names(spe.otu)
spe.phy <- merge_phyloseq(spe.tax, spe.otu, meta.samp)


### Save physeq objects
#save(phy.phy, file="kaiju/physeq/phylum.phy.RData")
#save(cla.phy, file="kaiju/physeq/class.phy.RData")
#save(ord.phy, file="kaiju/physeq/order.phy.RData")
#save(fam.phy, file="kaiju/physeq/family.phy.RData")
#save(gen.phy, file="kaiju/physeq/genus.phy.RData")
#save(spe.phy, file="kaiju/physeq/species.phy.RData")
```

### Load tax physeq data
```{r}
### Load physeq data
load("kaiju/inulinase/physeq/phylum.phy.RData")
load("kaiju/inulinase/physeq/class.phy.RData")
load("kaiju/inulinase/physeq/order.phy.RData")
load("kaiju/inulinase/physeq/family.phy.RData")
load("kaiju/inulinase/physeq/genus.phy.RData")
load("kaiju/inulinase/physeq/species.phy.RData")


### Melt physeq objects into dataframes
phy.melt <- psmelt(phy.phy)
cla.melt <- psmelt(cla.phy)
ord.melt <- psmelt(ord.phy)
fam.melt <- psmelt(fam.phy)
gen.melt <- psmelt(gen.phy)
spe.melt <- psmelt(spe.phy)


### Import metadata
meta <- read.csv('metadata_metag.csv', header=T)
meta$Season <- ordered(meta$Season, levels=c("Summer", "Winter", "Spring"))
```


### Summarize tax data
```{r}
phy.sum <- phy.melt %>%
  group_by(Season, OTU) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance),
            SE = se(Abundance))
#write.csv(phy.sum, file = "kaiju/phylum.sum.csv", row.names = F)

cla.sum <- cla.melt %>%
  group_by(Season, OTU) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance),
            SE = se(Abundance))
#write.csv(cla.sum, file = "kaiju/class.sum.csv", row.names = F)

ord.sum <- ord.melt %>%
  group_by(Season, OTU) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance),
            SE = se(Abundance))
#write.csv(ord.sum, file = "kaiju/order.sum.csv", row.names = F)

fam.sum <- fam.melt %>%
  group_by(Season, OTU) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance),
            SE = se(Abundance))
#write.csv(fam.sum, file = "kaiju/family.sum.csv", row.names = F)

gen.sum <- gen.melt %>%
  group_by(Season, OTU) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance),
            SE = se(Abundance))
#write.csv(gen.sum, file = "kaiju/genus.sum.csv", row.names = F)

spe.sum <- spe.melt %>%
  group_by(Season, OTU) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance),
            SE = se(Abundance))
#write.csv(spe.sum, file = "kaiju/species.sum.csv", row.names = F)
```
## Tax - # of Taxa
```{r}
### Family-level
fam.phy.w <- subset_samples(fam.phy, Season == "Winter")
length(which(taxa_sums(fam.phy.w) == 0))
  # Winter has 7 fewer families than Summer and Spring

### Genus-level
gen.phy.w <- subset_samples(gen.phy, Season == "Winter")
length(which(taxa_sums(gen.phy.w) == 0))
  # Winter has 16 fewer genera than Summer and Spring

### Species-level
spe.phy.w <- subset_samples(spe.phy, Season == "Winter")
length(which(taxa_sums(spe.phy.w) == 0))
  # Winter has 40 fewer species than the whole dataset
spe.phy.s <- subset_samples(spe.phy, Season == "Summer")
length(which(taxa_sums(spe.phy.s) == 0))
  # Summer has 4 fewer species than the whole dataset
spe.phy.p <- subset_samples(spe.phy, Season == "Spring")
length(which(taxa_sums(spe.phy.p) == 0))
  # Spring has 8 fewer species than the whole dataset
```

### Tax - Substrate Comparisons
```{r}
### Taxon-level comparisons
sum.gen.melt <- gen.melt[which(gen.melt$Season == "Summer"),]
wilcox.test(Abundance ~ Substrate, data = sum.gen.melt)
  # p-value = 0.311

### Beta-diversity comparisons
sum.phy <- subset_samples(gen.phy, Season == "Summer")

sum.sampdf <- data.frame(sample_data(sum.phy))
sum.bray <- phyloseq::distance(physeq=sum.phy, method="bray")

adonis(sum.bray ~ Substrate, data=sum.sampdf)
  # p-value = 0.7
```


### Tax - Season Analysis
```{r}
### Kruskal-Wallis
#kruskal.test(Abundance ~ Season, phy.melt)
#kruskal.test(Abundance ~ Season, cla.melt)
#kruskal.test(Abundance ~ Season, ord.melt)
#kruskal.test(Abundance ~ Season, fam.melt)
#kruskal.test(Abundance ~ Season, gen.melt)
#kruskal.test(Abundance ~ Season, spe.melt)


### PERMANOVA
phy.sampdf <- data.frame(sample_data(phy.phy))
phy.bray <- phyloseq::distance(physeq=phy.phy, method="bray")
adonis(phy.bray ~ Season + Substrate, data=phy.sampdf, permutations = 9999)
  # Season P = 0.0013, R2 = 0.63416
  # Substrate P = 0.7766, R2 = 0.00316
beta.tax = betadisper(d=phy.bray, group=phy.sampdf$Season)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.175


cla.sampdf <- data.frame(sample_data(cla.phy))
cla.bray <- phyloseq::distance(physeq=cla.phy, method="bray")
adonis(cla.bray ~ Season + Substrate, data=cla.sampdf, permutations = 9999)
  # Season P = 0.0011, R2 = 0.63136
  # Substrate P = 0.7249, R2 = 0.00394
beta.tax = betadisper(d=cla.bray, group=cla.sampdf$Season)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.265

ord.sampdf <- data.frame(sample_data(ord.phy))
ord.bray <- phyloseq::distance(physeq=ord.phy, method="bray")
adonis(ord.bray ~ Season + Substrate, data=ord.sampdf, permutations = 9999)
  # Season P = 0.0011, R2 = 0.63414 
  # Substrate P = 0.6339, R2 = 0.00689
beta.tax = betadisper(d=ord.bray, group=ord.sampdf$Season)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.284

fam.sampdf <- data.frame(sample_data(fam.phy))
fam.bray <- phyloseq::distance(physeq=fam.phy, method="bray")
adonis(fam.bray ~ Season + Substrate, data=fam.sampdf, permutations = 9999)
  # Season P = 0.1668, R2 = 0.18249  
  # Substrate P = 0.8172, R2 = 0.01823
beta.tax = betadisper(d=fam.bray, group=fam.sampdf$Season)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.344

gen.sampdf <- data.frame(sample_data(gen.phy))
gen.bray <- phyloseq::distance(physeq=gen.phy, method="bray")
adonis(gen.bray ~ Season + Substrate, data=gen.sampdf, permutations = 9999)
  # Season P = 0.1873, R2 = 0.18023
  # Substrate P = 0.7654, R2 = 0.01927
beta.tax = betadisper(d=gen.bray, group=gen.sampdf$Season)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.658

spe.sampdf <- data.frame(sample_data(spe.phy))
spe.bray <- phyloseq::distance(physeq=spe.phy, method="bray")
adonis(spe.bray ~ Season + Substrate, data=spe.sampdf, permutations = 9999)
  # Season P = 0.0220, R2 = 0.22711 
  # Substrate P = 0.1999, R2 = 0.06964
beta.tax = betadisper(d=spe.bray, group=spe.sampdf$Season)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.64
```

### Tax - Plot ordinations
```{r}
# Phylum
phy.nmds <- ordinate(physeq=phy.phy, method="NMDS", distance="bray")
  # stress = 0.09468586 

plot_ordination(physeq=phy.phy, ordination=phy.nmds, color="Season") + 
  scale_color_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"))


# Class
cla.nmds <- ordinate(physeq=cla.phy, method="NMDS", distance="bray")
  # stress = 0.1569837

plot_ordination(physeq=cla.phy, ordination=cla.nmds, color="Season") + 
  scale_color_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"))


# Order
ord.nmds <- ordinate(physeq=ord.phy, method="NMDS", distance="bray")
  # stress = 0.1441563

plot_ordination(physeq=ord.phy, ordination=ord.nmds, color="Season") + 
  scale_color_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"))


# Family
fam.nmds <- ordinate(physeq=fam.phy, method="NMDS", distance="bray")
  # stress = 0.152523 

plot_ordination(physeq=fam.phy, ordination=fam.nmds, color="Season") + 
  scale_color_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"))


# Genus
gen.nmds <- ordinate(physeq=gen.phy, method="NMDS", distance="bray")
  # stress = 0.1418113

plot_ordination(physeq=gen.phy, ordination=gen.nmds, color="Season") + 
  scale_color_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"))


# Species
spe.nmds <- ordinate(physeq=spe.phy, method="NMDS", distance="bray")
  # stress = 0.1361342

plot_ordination(physeq=spe.phy, ordination=spe.nmds, color="Season") + 
  scale_color_manual(values=c("darkgoldenrod2", "dodgerblue3", "green3"))
```


### Test taxa - Season
```{r}
# Phyla
otus <- data.frame(otu_table(phy.phy))
kw.phy <- data.frame()
for(taxon in 1:dim(data.frame(otu_table(phy.phy))[2])){
  kw <- kruskal.test(x=as.numeric(otus[taxon,]), g=meta$Season)
  kw.phy <- rbind(kw.phy, data.frame(taxon = rownames(otus)[taxon], pval = kw$p.value))
}
kw.phy$padj <- p.adjust(kw.phy$pval, method = "BH")

# Class
otus <- data.frame(otu_table(cla.phy))
kw.cla <- data.frame()
for(taxon in 1:dim(data.frame(otu_table(cla.phy))[2])){
  kw <- kruskal.test(x=as.numeric(otus[taxon,]), g=meta$Season)
  kw.cla <- rbind(kw.cla, data.frame(taxon = rownames(otus)[taxon], pval = kw$p.value))
}
kw.cla$padj <- p.adjust(kw.cla$pval, method = "BH")

# Order
otus <- data.frame(otu_table(ord.phy))
kw.ord <- data.frame()
for(taxon in 1:dim(data.frame(otu_table(ord.phy))[2])){
  kw <- kruskal.test(x=as.numeric(otus[taxon,]), g=meta$Season)
  kw.ord <- rbind(kw.ord, data.frame(taxon = rownames(otus)[taxon], pval = kw$p.value))
}
kw.ord$padj <- p.adjust(kw.ord$pval, method = "BH")

# Family
otus <- data.frame(otu_table(fam.phy))
kw.fam <- data.frame()
for(taxon in 1:dim(data.frame(otu_table(fam.phy))[2])){
  kw <- kruskal.test(x=as.numeric(otus[taxon,]), g=meta$Season)
  kw.fam <- rbind(kw.fam, data.frame(taxon = rownames(otus)[taxon], pval = kw$p.value))
}
kw.fam$padj <- p.adjust(kw.fam$pval, method = "BH")

# Genus
otus <- data.frame(otu_table(gen.phy))
kw.gen <- data.frame()
for(taxon in 1:dim(data.frame(otu_table(gen.phy))[2])){
  kw <- kruskal.test(x=as.numeric(otus[taxon,]), g=meta$Season)
  kw.gen <- rbind(kw.gen, data.frame(taxon = rownames(otus)[taxon], pval = kw$p.value))
}
kw.gen$padj <- p.adjust(kw.gen$pval, method = "BH")

# Species
otus <- data.frame(otu_table(spe.phy))
kw.spe <- data.frame()
for(taxon in 1:dim(data.frame(otu_table(spe.phy))[2])){
  kw <- kruskal.test(x=as.numeric(otus[taxon,]), g=meta$Season)
  kw.spe <- rbind(kw.spe, data.frame(taxon = rownames(otus)[taxon], pval = kw$p.value))
}
kw.spe$padj <- p.adjust(kw.spe$pval, method = "BH")
```


### Test taxa - Metabolism
```{r}
# Phyla
otus <- data.frame(otu_table(phy.phy))
kw.phy <- data.frame()
for(taxon in 1:dim(data.frame(otu_table(phy.phy))[2])){
  kw <- kruskal.test(x=as.numeric(otus[taxon,]), g=meta$Metabolism)
  kw.phy <- rbind(kw.phy, data.frame(taxon = rownames(otus)[taxon], pval = kw$p.value))
}
kw.phy$padj <- p.adjust(kw.phy$pval, method = "BH")

# Class
otus <- data.frame(otu_table(cla.phy))
kw.cla <- data.frame()
for(taxon in 1:dim(data.frame(otu_table(cla.phy))[2])){
  kw <- kruskal.test(x=as.numeric(otus[taxon,]), g=meta$Metabolism)
  kw.cla <- rbind(kw.cla, data.frame(taxon = rownames(otus)[taxon], pval = kw$p.value))
}
kw.cla$padj <- p.adjust(kw.cla$pval, method = "BH")

# Order
otus <- data.frame(otu_table(ord.phy))
kw.ord <- data.frame()
for(taxon in 1:dim(data.frame(otu_table(ord.phy))[2])){
  kw <- kruskal.test(x=as.numeric(otus[taxon,]), g=meta$Metabolism)
  kw.ord <- rbind(kw.ord, data.frame(taxon = rownames(otus)[taxon], pval = kw$p.value))
}
kw.ord$padj <- p.adjust(kw.ord$pval, method = "BH")

# Family
otus <- data.frame(otu_table(fam.phy))
kw.fam <- data.frame()
for(taxon in 1:dim(data.frame(otu_table(fam.phy))[2])){
  kw <- kruskal.test(x=as.numeric(otus[taxon,]), g=meta$Metabolism)
  kw.fam <- rbind(kw.fam, data.frame(taxon = rownames(otus)[taxon], pval = kw$p.value))
}
kw.fam$padj <- p.adjust(kw.fam$pval, method = "BH")

# Genus
otus <- data.frame(otu_table(gen.phy))
kw.gen <- data.frame()
for(taxon in 1:dim(data.frame(otu_table(gen.phy))[2])){
  kw <- kruskal.test(x=as.numeric(otus[taxon,]), g=meta$Metabolism)
  kw.gen <- rbind(kw.gen, data.frame(taxon = rownames(otus)[taxon], pval = kw$p.value))
}
kw.gen$padj <- p.adjust(kw.gen$pval, method = "BH")

# Species
otus <- data.frame(otu_table(spe.phy))
kw.spe <- data.frame()
for(taxon in 1:dim(data.frame(otu_table(spe.phy))[2])){
  kw <- kruskal.test(x=as.numeric(otus[taxon,]), g=meta$Metabolism)
  kw.spe <- rbind(kw.spe, data.frame(taxon = rownames(otus)[taxon], pval = kw$p.value))
}
kw.spe$padj <- p.adjust(kw.spe$pval, method = "BH")
```
### Tax - SIMPER
```{r}
#simper.pretty(data.frame(otu_table(phy.phy)), meta, c("Season"), perc_cutoff = 0.5, low_cutoff = 'y', low_val = 0.01, output_name = 'phylum')
simp.phy <- read.csv("phylum_clean_simper.csv")
#kruskal.pretty(data.frame(otu_table(phy.phy)), meta, csv = simp.phy, c("Season"), output_name = 'phylum', taxonomy = data.frame(tax_table(phy.phy)))


#simper.pretty(data.frame(otu_table(cla.phy)), meta, c("Season"), perc_cutoff = 0.5, low_cutoff = 'y', low_val = 0.01, output_name = 'class')
simp.cla <- read.csv("class_clean_simper.csv")
#kruskal.pretty(data.frame(otu_table(cla.phy)), meta, csv = simp.cla, c("Season"), output_name = 'class', taxonomy = data.frame(tax_table(cla.phy)))


#simper.pretty(data.frame(otu_table(ord.phy)), meta, c("Season"), perc_cutoff = 0.5, low_cutoff = 'y', low_val = 0.01, output_name = 'order')
simp.ord <- read.csv("order_clean_simper.csv")
#kruskal.pretty(data.frame(otu_table(ord.phy)), meta, csv = simp.ord, c("Season"), output_name = 'order', taxonomy = data.frame(tax_table(ord.phy)))


#simper.pretty(data.frame(otu_table(fam.phy)), meta, c("Season"), perc_cutoff = 0.5, low_cutoff = 'y', low_val = 0.01, output_name = 'family')
simp.fam <- read.csv("family_clean_simper.csv")
#kruskal.pretty(data.frame(otu_table(fam.phy)), meta, csv = simp.fam, c("Season"), output_name = 'family', taxonomy = data.frame(tax_table(fam.phy)))


#simper.pretty(data.frame(otu_table(gen.phy)), meta, c("Season"), perc_cutoff = 0.5, low_cutoff = 'y', low_val = 0.01, output_name = 'genus')
simp.gen <- read.csv("genus_clean_simper.csv")
#kruskal.pretty(data.frame(otu_table(gen.phy)), meta, csv = simp.gen, c("Season"), output_name = 'genus', taxonomy = data.frame(tax_table(gen.phy)))


#simper.pretty(data.frame(otu_table(spe.phy)), meta, c("Season"), perc_cutoff = 0.5, low_cutoff = 'y', low_val = 0.01, output_name = 'species')
simp.spe <- read.csv("species_clean_simper.csv")
#kruskal.pretty(data.frame(otu_table(spe.phy)), meta, csv = simp.spe, c("Season"), output_name = 'species', taxonomy = data.frame(tax_table(spe.phy)))
```

```