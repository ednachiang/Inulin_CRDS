---
title: "Multiomics"
author: "Edna Chiang"
date: "4/27/2022"
output: html_document
---

### Load Libraries
```{r}
library(ape)
library(dplyr)
library(dunn.test)
library(ggplot2)
library(grid)
library(gridExtra)
library(phyloseq)
library(picante)
library(pwr)
library(tidyr)
library(vegan)
library(mixOmics)
library(metagMisc)
library(compositions)
source('scripts/misc.R')
theme_set(theme_bw())
set.seed(1)
```

### Convert "OTU" table to biom format
```{r}
test <- read.csv('scripts/test/output/I-P01_otu_table.tsv', sep = "\t")
test1 <- test
test1$OTU <- 1:nrow(test1)
test1 <- test1[,-2:-8]
colnames(test1) <- c("I.S07", "OTU")
rownames(test1) <- test1$OTU
test1 <- data.frame(test1[,-2])
colnames(test1) <- "I.S07"
test1$S.S07 <- test1[,1]
test1$W.S07 <- test1[,1]
#test <- test[,-1]
#test$OTU <- 1:nrow(test)

metatest <- meta[2,]
rownames(metatest) <- "I.S07"
#test$OTU <- paste(test[,2], test[,3], test[,4], test[,5], test[,6], test[,7], test[,8])
#test <- test[,-2:-8]
#test$OTU <- 1:nrow(test)
biom1 <- make_biom(test1, id = "test")
write_biom(biom1, biom_file = 'test_otu.biom')

metabTest <- metab[1:3,]
rownames(metabTest) <- colnames(test1)
metabTest <- t(metabTest)
test2 <- make_biom(metabTest)
write_biom(test2, biom_file = 'test_metab.biom')
```

### Test mmvec output
```{r}
ranks <- read.table('multi-omics/test_ranks.txt', sep = "\t", header = T, row.names = 1)
ranks_use <- clrInv(ranks)
```


### Load Data
```{r}
# Load KEGG table
KO <- read.table('KEGG/KOtable_norm.tab', header = T, row.names = 1)
KO <- t(KO)
seasonRem <- which(substr(rownames(KO), 1,1) != "S")
KO <- KO[-seasonRem,]
#KO <- KO[,1:25]

# Load metabolomic data
metab <- read.csv('metabolomics/metabolomics_use.csv', row.names = 1)
metab <- t(metab)
metabUse <- c()
for(i in 1:nrow(KO)){
  useRow <- which(substr(rownames(metab),3,5) == rownames(KO)[i])
  metabUse <- c(metabUse, useRow)
}
metab <- metab[metabUse,]
metab <- metab[, (-(ncol(metab)-1) : -ncol(metab) )]
metab <- data.frame(metab)
for(j in 1:ncol(metab)){
  metab[,j] <- as.numeric(metab[,j])
}

# Load metadata
meta <- read.csv('metadata_metag.csv', row.names = 2)
row.names(meta) <- substr(rownames(meta),3,5)
meta <- meta[-7:-18,]
  # Remove Winter and Spring samples
meta <- meta[,-11]
  # Remove Ketones because NA

# Load CRDS data
#load('crds.use.Rdata')

# Combine data into list
data <- list(KO = KO, metabolomics = metab)


### Pull out just Inulin squirrels
metab.inu <- metab[which(substr(rownames(metab),1,1) == "I"),]
KO.inu <- KO[1:3,]
data.inu <- list(KO = KO.inu, metabolomics = metab.inu)


```

### RCC - Initial Analysis
```{r}
X11()
imgCor(KO, metab)



### Tune rCCA
grid1 <- seq(0.001, 0.2, length = 10) 
grid2 <- seq(0.001, 0.2, length = 10)

# Run RCC to optimize
#tune_rcc <- tune.rcc(KO, metab, grid1 = grid1, grid2 = grid2, validation = "loo")

# Pull out optimal lambda values
#optl1 <- tune_rcc$opt.lambda1
#optl2 <- tune_rcc$opt.lambda2

# Save optimized rCCA
#rcc.opt <- rcc(KO, metab, method = "ridge", lambda1 = optl1, lambda2 = optl2)




### Shrinkage Method
rcc.shrink <- rcc(KO, metab, method = "shrinkage")







### Select # components
plot(rcc.opt, type = "barplot", main = "Cross Validation")
plot(rcc.shrink, type = "barplot", main = "Shrinkage")





### Plot models
plotIndiv(rcc.opt, comp = 1:2, rep.space = "XY-variate", legend = T)
plotArrow(rcc.opt)

plotIndiv(rcc.shrink, comp = 1:2, rep.space = "XY-variate", legend = T)
plotArrow(rcc.shrink)

plotVar(rcc.opt, var.names = c(T, T), cutoff = 0.5)
plotVar(rcc.shrink, var.names = c(T, T), cutoff = 0.5)




### Network Plot
X.11()
network(rcc.opt, comp = 1:2, interactive = F, lwd.edge = 2, cutoff = 0.5)


network(rcc.shrink, comp = 1:2, interactive = F, lwd.edge = 2, cutoff = 0.5)





### CIM plot
X11()
cim(rcc.opt, comp = 1:2, xlab = "KOIDs", ylab = "Metabolites")

X11()
cim(rcc.shrink, comp = 1:2, xlab = "KOIDs", ylab = "Metabolites")

```


### Preliminary analysis (pre-sPLS)
```{r}
# http://mixomics.org/case-studies/spls-liver-toxicity-case-study/

# How many components to use?
pca.ko <- pca(KO[,1:67], ncomp = 6, center = TRUE, scale = TRUE)
  # Selected first 67 to test because they don't have NA's
pca.metab <- pca(metab, ncomp = 6, center = TRUE, scale = TRUE)
plot(pca.ko)
  # Component 1
  # Not much of an elbow
plot(pca.metab)
  # Component 1

# Assess clustering of samples
plotIndiv(pca.ko, comp = c(1, 2))
plotIndiv(pca.metab, comp = c(1, 2))

```
### Pairwise PLS
```{r}
# Current n is too small to perf or tune spls
# http://mixomics.org/case-studies/spls-liver-toxicity-case-study/


pls1 <- spls(data[["KO"]][,1:67], data[["metabolomics"]])




#list.keepX = c(25,25)
#list.keepY = c(10,10)
#pls1 <- spls(data.inu[["KO"]], data.inu[["metabolomics"]], keepX = list.keepX, keepY = list.keepY)

plotVar(pls1, cutoff = 0.5, title = "KO vs. Metabolomics", style = 'graphics')
plotIndiv(pls1, group = meta$Substrate, legend = T)
plotArrow(pls1, group = meta$Substrate)
# Calculate correlation of KO and metabolomics
cor(pls1$variates$X, pls1$variates$Y)
```

### ONLY FOR SEASONAL COMPARISON - DIABLO Model
```{r}
# X = data (KO and metabolomics)
# Y = season


design = matrix(0.1, ncol = length(data), nrow = length(data),
                dimnames = list(names(data), names(data)))
diag(design) <- 0

basic.diablo.model <- block.splsda(X = data, Y = Y, ncomp = 5, design = design)

final.diablo.model <- block.splsda(X = data, Y = Y, design = design)

### Plot
plotDiablo(final.diablo.model, ncomp = 1)
plotIndiv(final.diablo.model, legend = T)
plotArrow(final.diablo.model, legend = T)
plotVar(final.diablo.model, style = 'graphics', legend = T)
circosPlot(final.diablo.model, cutoff = 0.7, line = TRUE, size.labels = 2)
#network(final.diablo.model, cutoff = 0.4)
plotLoadings(final.diablo.model, comp = 2, contrib = 'max', method = 'median')
```
