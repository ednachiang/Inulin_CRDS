---
title: "Multiomics"
author: "Edna Chiang"
date: "4/27/2022"
output: html_document
---

### Load Libraries
```{r}
library(ape)
library(dplyr)
library(dunn.test)
library(ggplot2)
library(grid)
library(gridExtra)
library(phyloseq)
library(picante)
library(pwr)
library(tidyr)
library(vegan)
library(mixOmics)
library(metagMisc)
library(compositions)
source('scripts/misc.R')
source('scripts/kaijuCreateTable.R')
source('scripts/kaiju_to_OTU_table.R')
source('scripts/kaijuCreateBigOTUtable.R')
theme_set(theme_bw())
set.seed(1)
```

### Prepare Data - DON'T RUN!!!
```{r}
### Prepare kaiju output --> "OTU" table
#kaijuCreateTable('kaiju/all_shortreads/pre-processed/output/', 'kaiju/all_shortreads/kaijuCreateTable_output/')
#kaiju_to_OTU_table('kaiju/all_shortreads/kaijuCreateTable_output/', 'kaiju/all_shortreads/kaiju_to_OTU_table_output/')
#kaiju_big_OTU_table('kaiju/all_shortreads/kaiju_to_OTU_table_output/', 'kaiju/all_shortreads/bigOTU.txt')

# Create final kaiju "OTU" table
OTU <- read.table('kaiju/all_shortreads/bigOTU.txt', sep = "\t", header = T)
OTU.dup <- OTU[which(duplicated(OTU$OTU) == T),]
rownames(OTU) <- OTU$OTU
OTU <- OTU[,-2]
#write.table(OTU, 'kaiju/all_shortreads/OTU_use.txt')

# Create OTU biom files
OTU <- read.table('kaiju/all_shortreads/OTU_use.txt', sep = " ", header = T)
OTU.sum <- OTU[,-1:-3]
OTU.sum <- OTU.sum[,-4:-9]
OTU.sum <- OTU.sum[,-7:-9]
OTU.sum.rem <- list()
for(i in 1:nrow(OTU.sum)){
  if(length(which(OTU.sum[i,] == 0) > 3)){
    OTU.sum.rem <- c(OTU.sum.rem, i)
  }
}
# Remove 8805 taxa
OTU.sum.rem <- as.numeric(OTU.sum.rem)
OTU.sum <- OTU.sum[-OTU.sum.rem,]
rownames(OTU.sum) <- 1:nrow(OTU.sum)
OTU.sum.biom <- make_biom(OTU.sum, id = "AllSummer")
#write_biom(OTU.sum.biom, biom_file = 'OTU.sum.biom')

OTU.inu <- OTU.sum[,1:3]
#OTU.inu.rem <- list()
#for(j in 1:nrow(OTU.inu)){
#  if(length(which(OTU.inu[j,] == 0) > 0)){
#    OTU.inu.rem <- c(OTU.inu.rem, j)
#  }
#}
# No taxa to remove
OTU.inu.biom <- make_biom(OTU.inu, id = "InulinSummer")
#write_biom(OTU.inu.biom, biom_file = 'OTU.inu.biom')





# Load KEGG table
KO <- read.table('KEGG/KOtable_norm.tab', header = T, row.names = 1)
KO <- t(KO)
seasonRem <- which(substr(rownames(KO), 1,1) != "S")
KO <- KO[-seasonRem,]
#KO <- KO[,1:25]


# Load metabolomic data
metab <- read.csv('metabolomics/metabolomics_use.csv', row.names = 1)
metab <- t(metab)
metabUse <- c()
for(k in 1:nrow(KO)){
  useRow <- which(substr(rownames(metab),3,5) == rownames(KO)[k])
  metabUse <- c(metabUse, useRow)
}
metab <- metab[metabUse,]
metab <- metab[, (-(ncol(metab)-1) : -ncol(metab) )]
metab <- data.frame(metab)
for(l in 1:ncol(metab)){
  metab[,l] <- as.numeric(metab[,l])
}
metab.all.biom <- make_biom(t(metab))
metab.inu.biom <- make_biom(t(metab[1:3,]))
#write_biom(metab.all.biom, biom_file = 'metab.sum.biom')
#write_biom(metab.inu.biom, biom_file = 'metab.inu.biom')


# Load metadata
meta <- read.csv('metadata_metag.csv', row.names = 2)
row.names(meta) <- substr(rownames(meta),3,5)
meta <- meta[-7:-18,]
  # Remove Winter and Spring samples
meta <- meta[,-11]
  # Remove Ketones because NA
meta.inu <- meta[which(meta$Substrate == "Inulin"),]


### Create physeq object
otu.inu <- otu_table(OTU.inu, taxa_are_rows = T)
inu.tax <- rownames(OTU.sum)
inu.tax.split <- strsplit(inu.tax, split = expression("*"), fixed = T)
inu.tax <- data.frame(inu.tax)
inu.tax$Domain <- NA
inu.tax$Phylum <- NA
inu.tax$Class <- NA
inu.tax$Order <- NA
inu.tax$Family <- NA
inu.tax$Genus <- NA
inu.tax$Species <- NA

for(m in 1:length(inu.tax.split)){
  entry <- inu.tax.split[[m]]
  inu.tax$Domain[m] <- entry[1]
  inu.tax$Phylum[m] <- entry[2]
  inu.tax$Class[m] <- entry[3]
  inu.tax$Order[m] <- entry[4]
  inu.tax$Family[m] <- entry[5]
  inu.tax$Genus[m] <- entry[6]
  inu.tax$Species[m] <- entry[7]
}

OTU.sum <- OTU[,-1:-3]
OTU.sum <- OTU.sum[,-4:-9]
OTU.sum <- OTU.sum[,-7:-9]
OTU.sum.rem <- list()
for(i in 1:nrow(OTU.sum)){
  if(length(which(OTU.sum[i,] == 0) > 3)){
    OTU.sum.rem <- c(OTU.sum.rem, i)
  }
}
# Remove 8805 taxa
OTU.sum.rem <- as.numeric(OTU.sum.rem)
OTU.sum <- OTU.sum[-OTU.sum.rem,]
OTU.sum$ID <- 1:nrow(OTU.sum)

inu.tax$ID <- NA
for(n in 1:nrow(inu.tax)){
  match <- which(rownames(OTU.sum) == inu.tax[n,1])
  inu.tax$ID[n] <- OTU.sum$ID[match]
}
tax.inu <- tax_table(inu.tax)
taxa_names(tax.inu) <- taxa_names(otu.inu)

samp.inu <- sample_data(meta.inu)
sample_names(samp.inu) <- sample_names(otu.inu)
inu.phy <- merge_phyloseq(otu.inu, tax.inu, samp.inu)
#save(inu.phy, file = 'multi-omics/inulin.phyloseq.RData')
```


### Test mmvec output
```{r}
### Summer
sum.ranks <- read.table('multi-omics/mmvec_summer/latent_dim_3_input_prior_1.00_output_prior_1.00_beta1_0.90_beta2_0.95_ranks.txt', sep = "\t", header = T, row.names = 1)
#sum.ranks.use <- clrInv(sum.ranks)


### Inulin
inu.ranks <- read.table('multi-omics/mmvec_inulin/latent_dim_3_input_prior_1.00_output_prior_1.00_beta1_0.90_beta2_0.95_ranks.txt', sep = "\t", header = T, row.names = 1)
#inu.ranks.use <- clrInv(inu.ranks)
inu.microbe.ord <- read.table('multi-omics/mmvec_inulin/inu_ord_microbes.txt', sep = "\t", header = F, row.names = 1)
inu.metab.ord <- read.table('multi-omics/mmvec_inulin/inu_ord_metab.txt', sep = "\t", header = F, row.names = 1)

```

### Pull out top co-occurence probabilities
```{r}
top.prob <- data.frame(matrix(nrow = nrow(inu.ranks), ncol = 11))
for(o in 1:nrow(inu.ranks)){
  top <- sort(abs(inu.ranks[o,]), decreasing = T)[1:10]
  names <- colnames(top)
  if(length(which(names == "X1")) == 1){
    top <- sort(abs(inu.ranks[o,]), decreasing = T)[1:11]
    unclass <- which(names == "X1")
    top <- top[,-unclass]
    names <- colnames(top)
  }
  top.prob[o,1] <- rownames(inu.ranks)[o]
  top.prob[o, 2:11] <- names
}

top.unique <- list()
for(p in 2:ncol(top.prob)){
  topTax <- as.character(unique(top.prob[p,2:11]))
  top.unique <- as.character(append(top.unique, topTax))
  top.unique <- unique(top.unique)
}
top.unique <- na.omit(top.unique)

prob.use <- data.frame(matrix(nrow = nrow(inu.ranks), ncol = length(top.unique)))
rownames(prob.use) <- rownames(inu.ranks)
colnames(prob.use) <- top.unique
for(q in 1:length(top.unique)){
  match <- which(colnames(inu.ranks) == top.unique[q])
  prob.use[,q] <- as.numeric(inu.ranks[,match])
}



### Make phyloseq object
colnames(prob.use) <- substr(colnames(prob.use),2,10)
prob.otu <- otu_table(t(prob.use), taxa_are_rows = T)
load('multi-omics/inulin.phyloseq.RData')
prob.phy <- merge_phyloseq(prob.otu, tax_table(inu.phy))


# Save taxa names
prob.taxa <- data.frame(tax_table(prob.phy))
#write.table(prob.taxa, 'multi-omics/top_taxa.txt', sep = "\t")
rename <- prob.taxa$ta8
rename[13] <- "Chromobacterium"
rename[19] <- "Spirosoma"
rename[23] <- "Bacteroides"
rename[24] <- "Candidatus Methanomethylophilus"
rename[27] <- "Clostridiales"
prob.taxa$Name <- rename
prob.taxa <- tax_table(prob.taxa)
taxa_names(prob.taxa) <- taxa_names(prob.otu)
colnames(prob.taxa) <- c("Full", "Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species", "ID", "Taxon")
prob.phy <- merge_phyloseq(prob.otu, prob.taxa)
#save(prob.phy, file = 'multi-omics/probability.phyloseq.RData')

#prob.phy <- subset_taxa(prob.phy, ID == 1187 | ID == 1652 | ID == 1768 | ID == 1779 | ID == 3037 | ID == 3625 | ID == 3750 | ID == 4018 | ID == 4036 | ID == 4259 | ID == 4498 | ID == 5273 | ID == 6065 | ID == 6079 | ID == 6171 | ID == 6325 | ID == 7272 | ID == 7453 | ID == 7696 | ID == 7825 | ID == 8307 | ID == 8648 | ID == 8661 | ID == 8786 | ID == 10288 | ID == 10921 | ID == 11196 | ID == 11374)

```

### Plot co-occurrence probability heatmap
```{r}
#tiff("multi-omics_hm.tiff", width=6.5, height=8, units="in", res=600)
plot_heatmap(prob.phy, sample.order = c("Acetate", "Butyrate", "Propionate", "Lactate", "Fructose", "Glucose", "Mannose", "Phenylalanine", "Glutamate", "Uracil"), taxa.label = "Taxon", taxa.order = c(11374, 11196, 10921, 10288, 9870, 8661, 8648, 7825, 7696, 7673, 7453, 7272, 6325, 5273, 4791, 4498, 4018, 3982, 3765, 3750, 3625, 2069, 1896, 1779, 1768, 1652, 1187, 1006, 8)) +
  geom_tile(colour="gray40") +
  scale_y_discrete(labels=c("candidate division TA06 bacterium B3_TA06", "\nbacterium D16-36", "Candidatus Falkowbacteria bacterium\nCG10_big_fil_rev_8_21_14_0_10_43_11", "Lentisphaerae bacterium GWF2_49_21", "Candidatus Methanomethylophilus", "Akkermansia sp. BIOML-A41", "Akkermansia sp. KLE1797", "Xenophilus sp. L33", "Extensimonas vulgaris", "Vibrio lentus", "Solimonas terrae", "Magnetospira sp. QH-2", "Chromobacterium", "Psychroflexus salarius", "Sphingobacterium detergens", "Prevotella sp. BCRC 81118", "Spirosoma", "Bacteroides", "Thalassobacillus cyri", "Bacillus hwajinpoensis", "Virgibacillus sp. 7505", "Pelotomaculum sp. PtaU1.Bin035", "Dorea sp. BIOML-A1", "Butyricicoccus sp. AF35-5AC", "Clostridium sp. ND2", "Lachnoanaerobaculum orale", "Eubacterium sp. BL-380-WT-2B", "Butyrivibrio sp. WCE2006", "Clostridiales")) +
  xlab("Metabolite") + ylab("Taxon") +
  scale_fill_gradientn(name="Co-occurence\nProbability",
                       colours = c("#3232FF", "#6464FF", "#9696FF", "#E1E1FF", "#FFFFFF", "#FFE1E1", "#FFC8C8", "#FF6464", "#EA0000", "#C90000"),
                       limits = c(-2.0, 2.7),
                       breaks = c(-2.0, -1.5, -1.0, -0.5, 0.0, 0.5, 1.0, 1.5, 2.0, 2.5),
                       labels = c("-2.0", "-1.5", "-1.0", "-0.5", "0.0", "0.5", "1.0", "1.5", "2.0", "2.5")) +
  theme(axis.text.x = element_text(size=10, angle=40, hjust=1, vjust=1.15),
        axis.text.y = element_text(size=9),
        axis.ticks.x = element_blank(),
        axis.ticks.y = element_blank(),
        panel.border=element_blank(),
        axis.title.x = element_text(size=12, face = "bold"),
        axis.title.y = element_text(size=12, face = "bold"),
        legend.title = element_text(size=10, face = "bold"),
        legend.text = element_text(size=10),
        plot.margin = margin(t=0, r=0, b=0, l=0)) +
  guides(fill = guide_colorbar(barheight = unit(4,"in"),
                               frame.colour="black",
                               frame.linewidth=1))
  
  
#dev.off()

```



### Load Data
```{r}
# Load KEGG table
KO <- read.table('KEGG/KOtable_norm.tab', header = T, row.names = 1)
KO <- t(KO)
seasonRem <- which(substr(rownames(KO), 1,1) != "S")
KO <- KO[-seasonRem,]
#KO <- KO[,1:25]

# Load metabolomic data
metab <- read.csv('metabolomics/metabolomics_use.csv', row.names = 1)
metab <- t(metab)
metabUse <- c()
for(i in 1:nrow(KO)){
  useRow <- which(substr(rownames(metab),3,5) == rownames(KO)[i])
  metabUse <- c(metabUse, useRow)
}
metab <- metab[metabUse,]
metab <- metab[, (-(ncol(metab)-1) : -ncol(metab) )]
metab <- data.frame(metab)
for(j in 1:ncol(metab)){
  metab[,j] <- as.numeric(metab[,j])
}

# Load metadata
meta <- read.csv('metadata_metag.csv', row.names = 2)
row.names(meta) <- substr(rownames(meta),3,5)
meta <- meta[-7:-18,]
  # Remove Winter and Spring samples
meta <- meta[,-11]
  # Remove Ketones because NA

# Load CRDS data
#load('crds.use.Rdata')

# Combine data into list
data <- list(KO = KO, metabolomics = metab)


### Pull out just Inulin squirrels
metab.inu <- metab[which(substr(rownames(metab),1,1) == "I"),]
KO.inu <- KO[1:3,]
data.inu <- list(KO = KO.inu, metabolomics = metab.inu)


```

### RCC - Initial Analysis
```{r}
X11()
imgCor(KO, metab)



### Tune rCCA
grid1 <- seq(0.001, 0.2, length = 10) 
grid2 <- seq(0.001, 0.2, length = 10)

# Run RCC to optimize
#tune_rcc <- tune.rcc(KO, metab, grid1 = grid1, grid2 = grid2, validation = "loo")

# Pull out optimal lambda values
#optl1 <- tune_rcc$opt.lambda1
#optl2 <- tune_rcc$opt.lambda2

# Save optimized rCCA
#rcc.opt <- rcc(KO, metab, method = "ridge", lambda1 = optl1, lambda2 = optl2)




### Shrinkage Method
rcc.shrink <- rcc(KO, metab, method = "shrinkage")







### Select # components
plot(rcc.opt, type = "barplot", main = "Cross Validation")
plot(rcc.shrink, type = "barplot", main = "Shrinkage")





### Plot models
plotIndiv(rcc.opt, comp = 1:2, rep.space = "XY-variate", legend = T)
plotArrow(rcc.opt)

plotIndiv(rcc.shrink, comp = 1:2, rep.space = "XY-variate", legend = T)
plotArrow(rcc.shrink)

plotVar(rcc.opt, var.names = c(T, T), cutoff = 0.5)
plotVar(rcc.shrink, var.names = c(T, T), cutoff = 0.5)




### Network Plot
X.11()
network(rcc.opt, comp = 1:2, interactive = F, lwd.edge = 2, cutoff = 0.5)


network(rcc.shrink, comp = 1:2, interactive = F, lwd.edge = 2, cutoff = 0.5)





### CIM plot
X11()
cim(rcc.opt, comp = 1:2, xlab = "KOIDs", ylab = "Metabolites")

X11()
cim(rcc.shrink, comp = 1:2, xlab = "KOIDs", ylab = "Metabolites")

```


### Preliminary analysis (pre-sPLS)
```{r}
# http://mixomics.org/case-studies/spls-liver-toxicity-case-study/

# How many components to use?
pca.ko <- pca(KO[,1:67], ncomp = 6, center = TRUE, scale = TRUE)
  # Selected first 67 to test because they don't have NA's
pca.metab <- pca(metab, ncomp = 6, center = TRUE, scale = TRUE)
plot(pca.ko)
  # Component 1
  # Not much of an elbow
plot(pca.metab)
  # Component 1

# Assess clustering of samples
plotIndiv(pca.ko, comp = c(1, 2))
plotIndiv(pca.metab, comp = c(1, 2))

```
### Pairwise PLS
```{r}
# Current n is too small to perf or tune spls
# http://mixomics.org/case-studies/spls-liver-toxicity-case-study/


pls1 <- spls(data[["KO"]][,1:67], data[["metabolomics"]])




#list.keepX = c(25,25)
#list.keepY = c(10,10)
#pls1 <- spls(data.inu[["KO"]], data.inu[["metabolomics"]], keepX = list.keepX, keepY = list.keepY)

plotVar(pls1, cutoff = 0.5, title = "KO vs. Metabolomics", style = 'graphics')
plotIndiv(pls1, group = meta$Substrate, legend = T)
plotArrow(pls1, group = meta$Substrate)
# Calculate correlation of KO and metabolomics
cor(pls1$variates$X, pls1$variates$Y)
```

### ONLY FOR SEASONAL COMPARISON - DIABLO Model
```{r}
# X = data (KO and metabolomics)
# Y = season


design = matrix(0.1, ncol = length(data), nrow = length(data),
                dimnames = list(names(data), names(data)))
diag(design) <- 0

basic.diablo.model <- block.splsda(X = data, Y = Y, ncomp = 5, design = design)

final.diablo.model <- block.splsda(X = data, Y = Y, design = design)

### Plot
plotDiablo(final.diablo.model, ncomp = 1)
plotIndiv(final.diablo.model, legend = T)
plotArrow(final.diablo.model, legend = T)
plotVar(final.diablo.model, style = 'graphics', legend = T)
circosPlot(final.diablo.model, cutoff = 0.7, line = TRUE, size.labels = 2)
#network(final.diablo.model, cutoff = 0.4)
plotLoadings(final.diablo.model, comp = 2, contrib = 'max', method = 'median')
```
