---
title: "Code_16S"
author: "Edna Chiang"
date: "2/24/2022"
output: html_document
---

### Load Libraries
```{r}
library(ape)
library(dplyr)
library(dunn.test)
library(effsize)
library(ggplot2)
library(grid)
library(gridExtra)
library(phyloseq)
library(picante)
library(pwr)
library(tidyr)
library(vegan)
library(miLineage)
library(pwr)
library(effsize)
#source('scripts/import_crds.R')
#source('scripts/bin_crds.R')
source('scripts/misc.R')
#source('scripts/calc_delta_metrics.R')
source('scripts/simper_pretty.R')
source('scripts/R_krusk.R')
source('scripts/removeTaxa.R')
#source('scripts/kaijuCreatePhyseq.R')
theme_set(theme_bw())
set.seed(1)
```

### DON'T RUN - Import Data
```{r}
# Link files
shared = "16S/final.0.03.norm.shared"
taxonomy = "16S/final.taxonomy"

# Import mothur data
mothurdata = import_mothur(
  mothur_shared_file = shared,
  mothur_constaxonomy_file = taxonomy)

# Add OTU column in taxonomy table
tax_table(mothurdata) <- cbind(tax_table(mothurdata), 
                               row.names(tax_table(mothurdata)))

# Rename taxonomy table columns
colnames(tax_table(mothurdata)) <- c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species")

### Prepare metadata
meta <- read.csv("metadata.csv")
auc <- read.csv("auc.csv")
delta <- read.csv("delta_metrics.csv")
rownames(meta) <- meta$Sample
divsum <- read.table("16S/final.0.03.norm.groups.summary", header = T)
divsum$test <- strsplit(divsum$group, "_")
dna <- read.csv("dna.csv")

# Remove samples w/o CRDS metrics
#divsum <- divsum[-which(divsum$group == "CC1_S11"),]
#divsum <- divsum[-which(divsum$group == "CC1_S34"),]
#divsum <- divsum[-which(divsum$group == "CC1_W26"),]
#divsum <- divsum[-which(divsum$group == "CC2_S37"),]
  # Since miLineage is not sig, there's no reason to remove these samples anymore

# Fill in metadata
for(i in 1:nrow(divsum)){
  divsum$Individual[i] <- divsum$test[[i]][[2]]
  
  use <- which(meta$ID == divsum$Individual[i])
  divsum$Source[i] <- divsum$test[[i]][[1]]
  divsum[i,18:30] <- meta[use,]
  
  #auc.use <- which(auc$ID == divsum$Individual[i])
  #divsum$AUC[i] <- auc$AUC[auc.use]
  
  #delta.use <- which(delta$ID == divsum$Individual[i])
  #divsum$DeltaSlope[i] <- delta$Slope[delta.use]
  
  dna.use <- which(dna$Sample == divsum$group[i])
  divsum$DNAyield[i] <- dna$DNA_Yield_.ng.mg.[dna.use]
  
}
divsum <- divsum[,-1]
divsum <- divsum[,-6:-7]
divsum <- divsum[,-7:-8]
divsum <- divsum[,-8:-10]
divsum <- divsum[,-22]
#divsum <- divsum[,-8:-9]
#divsum <- divsum[,-8:-9]
#divsum <- divsum[,-21]
colnames(divsum)[1] <- "Sample"
divsum$Source <- substr(divsum$Source, start = 2, stop = 2)
divsum$Source[which(divsum$Source == "C")] <- "Content"
divsum$Source[which(divsum$Source == "T")] <- "Mucosa"



### Add metadata to phyloseq object
meta.ready <- sample_data(divsum)
sample_names(meta.ready) <- divsum$Sample
physeq <- merge_phyloseq(mothurdata, meta.ready)


# Remove OTUs that appear in < 3 samples
otu <- data.frame(otu_table(physeq))
otu.rem <- list()
for(j in 1:nrow(otu)){
  empty <- length(which(otu[j,] == 0))
    # Identifies # of samples w/o OTU
  if(empty > 38){
    # If OTU appears in < 3 samples
    otu.rem <- append(otu.rem, j)
      # Create list of OTUs that appear in only 1 sample
  }
}
# 2521 OTUs to remove
otu.rem <- otu[-unlist(otu.rem),]


# Update phyloseq object w/ removed OTUs
phy.rem <- merge_phyloseq(otu_table(otu.rem, taxa_are_rows=T), sample_data(physeq), tax_table(physeq))
 

# Order factors
sample_data(phy.rem)$Season <- ordered(sample_data(phy.rem)$Season,
                                     levels=c("Summer", "Winter", "Spring"))

# Remove Inulin outliers
########crds.rem <- crds.bin[-which(crds.bin$ID == "S34"),]
#phy.use <- subset_samples(phy.rem, ID != "S37")
  # ABX didn't work; high [DNA]
  # Already removed
phy.use <- subset_samples(phy.rem, ID != "P28")
#########crds.rem <- crds.rem[-which(crds.rem$ID == "P30"),]

# Remove Saline outliers
#########crds.rem <- crds.rem[-which(crds.rem$ID == "W26"),]
#########crds.rem <- crds.rem[-which(crds.rem$ID == "W43"),]
phy.use <- subset_samples(phy.use, ID != "W50")
phy.use <- subset_samples(phy.use, ID != "P04")
  # This is an adult, not pup


# Calculate relative abundance
phy.ra <- transform_sample_counts(phy.use, function(x){(x/sum(x))*100})

# Separate by Sample Type
phy.c <- subset_samples(phy.ra, Source == "Content")
phy.m <- subset_samples(phy.ra, Source == "Mucosa")

# Separate by Season
phy.sum <- subset_samples(phy.ra, Season == "Summer")
phy.win <- subset_samples(phy.ra, Season == "Winter")
phy.spr <- subset_samples(phy.ra, Season == "Spring")

# Separate by Season + Sample Type
phy.sum.c <- subset_samples(phy.sum, Source == "Content")
  # 17 samples
phy.sum.m <- subset_samples(phy.sum, Source == "Mucosa")
  # 15 samples
phy.win.c <- subset_samples(phy.win, Source == "Content")
  # 5 samples
phy.win.m <- subset_samples(phy.win, Source == "Mucosa")
  # 1 sample
phy.spr.c <- subset_samples(phy.spr, Source == "Content")
  # 4 samples
phy.spr.m <- subset_samples(phy.spr, Source == "Mucosa")
  # 2 samples


# Save phyloseq objects
#save(phy.use, file = "16S/physeq/phy.all.counts.RData")
#save(phy.ra, file = "16S/physeq/phy.all.relabund.RData")
#save(phy.c, file = "16S/physeq/phy.content.RData")
#save(phy.m, file = "16S/physeq/phy.mucosa.RData")
#save(phy.sum.c, file = "16S/physeq/phy.summer.content.RData")
#save(phy.sum.m, file = "16S/physeq/phy.summer.mucosa.RData")
#save(phy.win.c, file = "16S/physeq/phy.winter.content.RData")
#save(phy.spr.c, file = "16S/physeq/phy.spring.content.RData")
```



### Load Phyloseq Data
```{r}
load("16S/physeq/phy.all.counts.RData")
load("16S/physeq/phy.all.relabund.RData")
load("16S/physeq/phy.content.RData")
load("16S/physeq/phy.mucosa.RData")
load("16S/physeq/phy.summer.content.RData")
load("16S/physeq/phy.summer.mucosa.RData")
load("16S/physeq/phy.winter.content.RData")
load("16S/physeq/phy.spring.content.RData")

meta <- data.frame(sample_data(phy.use))
```


### miLineage - OTUs associated w/ Delta metrics
```{r}
### Format phyloseq objects
phy.con.raw <- subset_samples(phy.use, Source == "Content")
phy.c.rem <- filter_taxa(phy.con.raw, function(x) sum(x) > 0, T)
phy.muc.raw <- subset_samples(phy.use, Source == "Mucosa")
phy.m.rem <- filter_taxa(phy.muc.raw, function(x) sum(x) > 0, T)


### Format tax table
tax.con <- data.frame(tax_table(phy.c.rem))
colnames(tax.con) <- c("Rank1", "Rank2", "Rank3", "Rank4", "Rank5", "Rank6", "Rank7")
tax.con <- as.matrix(tax.con)
tax.muc <- data.frame(tax_table(phy.m.rem))
colnames(tax.muc) <- c("Rank1", "Rank2", "Rank3", "Rank4", "Rank5", "Rank6", "Rank7")
tax.muc <- as.matrix(tax.muc)                    
                    

### Format metadata
meta.con <- data.frame(sample_data(phy.c.rem))
meta.muc <- data.frame(sample_data(phy.m.rem))
delta.c <- meta.con[,21:22]
delta.c$BodyMass <- meta.con$BodyMass
delta.c$DNAyield <- meta.con$DNAyield
delta.c <- as.matrix(delta.c)
delta.m <- meta.muc[,21:22]
delta.m$BodyMass <- meta.muc$BodyMass
delta.m$DNAyield <- meta.muc$DNAyield
delta.m <- as.matrix(delta.m)


### Format OTU table
otu.c <- as.matrix(t(data.frame(otu_table(phy.c.rem))))
otu.m <- as.matrix(t(data.frame(otu_table(phy.m.rem))))



all.phy.c <- QCAT_GEE(OTU=otu.c, Tax=tax.con, X=delta.c, X.index = 1, Z=delta.c, Z.index=1,  fdr.alpha=0.05, n.resample = 999)
  # No sig

all.phy.m <- QCAT_GEE(OTU=otu.m, Tax=tax.muc, X=delta.m, X.index = 1, Z=delta.m, Z.index=1,  fdr.alpha=0.05, n.resample = 999)
  # No sig





### Format phyloseq objects
phy.con.raw <- subset_samples(phy.use, Source == "Content")
phy.con.sum <- subset_samples(phy.con.raw, Season == "Summer")
phy.con.sum <- filter_taxa(phy.con.sum, function(x) sum(x) > 0, T)


### Format tax table
tax.con <- data.frame(tax_table(phy.con.sum))
colnames(tax.con) <- c("Rank1", "Rank2", "Rank3", "Rank4", "Rank5", "Rank6", "Rank7")
tax.con <- as.matrix(tax.con)


### Format metadata
meta.con <- data.frame(sample_data(phy.con.sum))
delta.c <- meta.con[,21:22]
delta.c$BodyMass <- meta.con$BodyMass
delta.c$DNAyield <- meta.con$DNAyield
delta.c <- as.matrix(delta.c)

### Format OTU table
otu.c <- as.matrix(t(data.frame(otu_table(phy.con.sum))))

phy.con.sum.test <- QCAT_GEE(OTU=otu.c, Tax=tax.con, X=delta.c, X.index = 1, Z=delta.c, Z.index=1,  fdr.alpha=0.05, n.resample = 99)
  # No sig





### Format phyloseq objects
phy.con.noabx.raw <- subset_samples(phy.con.sum, Antibiotics == "No")
phy.con.noabx.raw <- filter_taxa(phy.con.noabx.raw, function(x) sum(x) > 0, T)


### Format tax table
tax.con <- data.frame(tax_table(phy.con.noabx.raw))
colnames(tax.con) <- c("Rank1", "Rank2", "Rank3", "Rank4", "Rank5", "Rank6", "Rank7")
tax.con <- as.matrix(tax.con)


### Format metadata
meta.con <- data.frame(sample_data(phy.con.noabx.raw))
delta.c <- meta.con[,21:22]
delta.c$BodyMass <- meta.con$BodyMass
delta.c$DNAyield <- meta.con$DNAyield
delta.c <- as.matrix(delta.c)

### Format OTU table
otu.c <- as.matrix(t(data.frame(otu_table(phy.con.noabx.raw))))

phy.con.sum.noabx.test <- QCAT_GEE(OTU=otu.c, Tax=tax.con, X=delta.c, X.index = 1, Z=delta.c, Z.index=1,  fdr.alpha=0.05, n.resample = 99)
  # No sig


```



### ABX-surviving microbes - Prepare data
```{r}
### Separate ABX/No ABX
phy.sum.c.noabx <- subset_samples(phy.sum.c, Antibiotics == "No")
  # 14 samples
phy.sum.c.abx <- subset_samples(phy.sum.c, Antibiotics == "Yes")
  # 3 samples
phy.sum.m.noabx <- subset_samples(phy.sum.m, Antibiotics == "No")
  # 12 samples
phy.sum.m.abx <- subset_samples(phy.sum.m, Antibiotics == "Yes")
  # 3 samples
phy.win.c.abx <- subset_samples(phy.win.c, Antibiotics == "Yes")
  # 4 samples
phy.spr.c.noabx <- subset_samples(phy.spr.c, Antibiotics == "No")
  # 4 samples


### Drop taxa in < 2 samples
otu.sum.c.abx.otu <- data.frame(otu_table(phy.sum.c.abx))
otu.sum.c.abx.otu.rem <- list()
for(a in 1:nrow(otu.sum.c.abx.otu)){
  empty <- length(which(otu.sum.c.abx.otu[a,] == 0))
    # Identifies # of samples w/o OTU
  if(empty == 3){
    # If OTU appears in < 2 samples
    otu.sum.c.abx.otu.rem <- append(otu.sum.c.abx.otu.rem, a)
      # Create list of OTUs that appear in only 1 sample
  }
}
# 899 OTUs to remove
otu.sum.c.abx.otu.rem <- otu.sum.c.abx.otu[-unlist(otu.sum.c.abx.otu.rem),]
# Update physeq object
phy.sum.c.abx.rem <- merge_phyloseq(otu_table(otu.sum.c.abx.otu.rem, taxa_are_rows=T),
                                    sample_data(phy.sum.c.abx), tax_table(phy.sum.c.abx))



### Drop taxa in < 2 samples
otu.sum.m.abx.otu <- data.frame(otu_table(phy.sum.m.abx))
otu.sum.m.abx.otu.rem <- list()
for(b in 1:nrow(otu.sum.m.abx.otu)){
  empty <- length(which(otu.sum.m.abx.otu[b,] == 0))
    # Identifies # of samples w/o OTU
  if(empty == 3){
    # If OTU appears in < 2 samples
    otu.sum.m.abx.otu.rem <- append(otu.sum.m.abx.otu.rem, b)
      # Create list of OTUs that appear in only 1 sample
  }
}
# 642 OTUs to remove
otu.sum.m.abx.otu.rem <- otu.sum.m.abx.otu[-unlist(otu.sum.m.abx.otu.rem),]
# Update physeq object
phy.sum.m.abx.rem <- merge_phyloseq(otu_table(otu.sum.m.abx.otu.rem, taxa_are_rows=T),
                                    sample_data(phy.sum.m.abx), tax_table(phy.sum.m.abx))



### Drop taxa in < 2 samples
otu.win.c.abx.otu <- data.frame(otu_table(phy.win.c.abx))
otu.win.c.abx.otu.rem <- list()
for(c in 1:nrow(otu.win.c.abx.otu)){
  empty <- length(which(otu.win.c.abx.otu[c,] == 0))
    # Identifies # of samples w/o OTU
  if(empty == 4){
    # If OTU appears in < 1 samples
    otu.win.c.abx.otu.rem <- append(otu.win.c.abx.otu.rem, c)
      # Create list of OTUs that appear in only 1 sample
  }
}
# 939 OTUs to remove
otu.win.c.abx.otu.rem <- otu.win.c.abx.otu[-unlist(otu.win.c.abx.otu.rem),]
# Update physeq object
phy.win.c.abx.rem <- merge_phyloseq(otu_table(otu.win.c.abx.otu.rem, taxa_are_rows=T),
                                    sample_data(phy.win.c.abx), tax_table(phy.win.c.abx))

```


### Test ABX BetaDiv
```{r}
# Create physeq object
abx.use <- merge_phyloseq(phy.sum.c.abx.rem, phy.win.c.abx.rem)


# Test
bray.abx <- phyloseq::distance(physeq = abx.use, method = "bray")
beta.tax <- betadisper(d = bray.abx, group = data.frame(sample_data(abx.use))$Season)
p <- permutest(beta.tax)
p$tab
  # p-value = 0.75
adonis(bray.abx ~ Season, data=data.frame(sample_data(abx.use)), permutations = 9999)
  # p-value = 0.2571

```


### ABX SIMPER
```{r}
##### SIMPER

# Change Group names to be compatible (no "_")
muc.rename <- data.frame(sample_data(phy.muc))
muc.rename$GroupRename <- rep(NA, nrow(muc.rename))
muc.rename$GroupRename[which(muc.rename$Group == "Summer_Captive")] <- "Summer"
muc.rename$GroupRename[which(muc.rename$Group == "Torpor")] <- "Torpor"
muc.rename$GroupRename[which(muc.rename$Group == "IBA")] <- "IBA"
muc.rename$GroupRename[which(muc.rename$Group == "Spring")] <- "Spring"
muc.rename$GroupRename <- ordered(muc.rename$GroupRename, levels = c("Summer", "Torpor", "IBA", "Spring"))
phy.muc.simp <- merge_phyloseq(otu_table(phy.muc), sample_data(muc.rename), tax_table(phy.muc))
# Group



simper.pretty(data.frame(otu_table(abx.use)),
              data.frame(sample_data(abx.use)),
              c("Season"),
              perc_cutoff=0.5, low_cutoff='y', low_val=0.01,
              output_name='abx')
group.simper <- read.csv("abx_clean_simper.csv")
kruskal.pretty(data.frame(otu_table(abx.use)),
               data.frame(sample_data(abx.use)),
               csv = group.simper,
               c("Season"),
               output_name = 'abx',
               taxonomy = data.frame(tax_table(abx.use)))







##### TAXA WILCOXON
meta.abx <- data.frame(sample_data(abx.use))


# Phylum
abx.phy <- tax_glom(abx.use, taxrank="Phylum")
phy <- data.frame(otu_table(abx.phy))
wil.phy <- data.frame()
for(taxon in 1:dim(data.frame(otu_table(abx.phy)))[1]){
  es <- cohen.d(as.numeric(phy[taxon,]) ~ meta.abx$Season)
  pwr <- pwr.t2n.test(n1 = length(which(meta.abx$Season == "Summer")),
            n2 = length(which(meta.abx$Season == "Winter")), d = es$estimate)
  wil.phy <- rbind(wil.phy, data.frame(taxon = rownames(phy)[taxon], cohenD = es$estimate, power = pwr[[5]]))
}
wil.phy$fdr <- mt(abx.phy, classlabel = "Season")$fdr



# Class
abx.cla <- tax_glom(abx.use, taxrank="Class")
cla <- data.frame(otu_table(abx.cla))
wil.cla <- data.frame()
for(taxon in 1:dim(data.frame(otu_table(abx.cla)))[1]){
  es <- cohen.d(as.numeric(cla[taxon,]) ~ meta.abx$Season)
  pwr <- pwr.t2n.test(n1 = length(which(meta.abx$Season == "Summer")),
            n2 = length(which(meta.abx$Season == "Winter")), d = es$estimate)
  wil.cla <- rbind(wil.cla, data.frame(taxon = rownames(cla)[taxon], cohenD = es$estimate, power = pwr[[5]]))
}
wil.cla$fdr <- mt(abx.cla, classlabel = "Season")$fdr



# Order
abx.ord <- tax_glom(abx.use, taxrank="Order")
ord <- data.frame(otu_table(abx.ord))
wil.ord <- data.frame()
for(taxon in 1:dim(data.frame(otu_table(abx.ord)))[1]){
  es <- cohen.d(as.numeric(ord[taxon,]) ~ meta.abx$Season)
  pwr <- pwr.t2n.test(n1 = length(which(meta.abx$Season == "Summer")),
            n2 = length(which(meta.abx$Season == "Winter")), d = es$estimate)
  wil.ord <- rbind(wil.ord, data.frame(taxon = rownames(ord)[taxon], cohenD = es$estimate, power = pwr[[5]]))
}
wil.ord$fdr <- mt(abx.ord, classlabel = "Season")$fdr




# Family
abx.fam <- tax_glom(abx.use, taxrank="Family")
fam <- data.frame(otu_table(abx.fam))
wil.fam <- data.frame()
for(taxon in 1:dim(data.frame(otu_table(abx.fam)))[1]){
  es <- cohen.d(as.numeric(fam[taxon,]) ~ meta.abx$Season)
  pwr <- pwr.t2n.test(n1 = length(which(meta.abx$Season == "Summer")),
            n2 = length(which(meta.abx$Season == "Winter")), d = es$estimate)
  wil.fam <- rbind(wil.fam, data.frame(taxon = rownames(fam)[taxon], cohenD = es$estimate, power = pwr[[5]]))
}
wil.fam$fdr <- mt(abx.fam, classlabel = "Season")$fdr



# Genus
abx.gen <- tax_glom(abx.use, taxrank="Genus")
gen <- data.frame(otu_table(abx.gen))
wil.gen <- data.frame()
for(taxon in 1:dim(data.frame(otu_table(abx.gen)))[1]){
  es <- cohen.d(as.numeric(gen[taxon,]) ~ meta.abx$Season)
  pwr <- pwr.t2n.test(n1 = length(which(meta.abx$Season == "Summer")),
            n2 = length(which(meta.abx$Season == "Winter")), d = es$estimate)
  wil.gen <- rbind(wil.gen, data.frame(taxon = rownames(gen)[taxon], cohenD = es$estimate, power = pwr[[5]]))
}
wil.gen$fdr <- mt(abx.gen, classlabel = "Season")$fdr



# OTU
otus <- data.frame(otu_table(abx.use))
wil.spe <- data.frame()
for(taxon in 1:dim(data.frame(otu_table(abx.use)))[1]){
  es <- cohen.d(as.numeric(otus[taxon,]) ~ meta.abx$Season)
  pwr <- pwr.t2n.test(n1 = length(which(meta.abx$Season == "Summer")),
            n2 = length(which(meta.abx$Season == "Winter")), d = es$estimate)
  wil.spe <- rbind(wil.spe, data.frame(taxon = rownames(otus)[taxon], cohenD = es$estimate, power = pwr[[5]]))
}
wil.spe$fdr <- mt(abx.use, classlabel = "Season")$fdr
#write.csv(wil.spe, "16S/abx.spelum.output.csv")


```


### ABX Microbes - Create tables
```{r}
#barplot(sort(taxa_sums(phy.sum.c.abx.rem),TRUE)[1:10]/nsamples(phy.sum.c.abx.rem),las=2,cex.axis=.7)

phy.sum.c.abx.df <- psmelt(phy.sum.c.abx.rem)
phy.sum.c.abx.sum <- phy.sum.c.abx.df %>%
  group_by(OTU, Genus) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance),
            SE = se(Abundance))


phy.sum.m.abx.df <- psmelt(phy.sum.m.abx.rem)
phy.sum.m.abx.sum <- phy.sum.m.abx.df %>%
  group_by(OTU, Genus) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance),
            SE = se(Abundance))



phy.win.c.abx.df <- psmelt(phy.win.c.abx.rem)
phy.win.c.abx.sum <- phy.win.c.abx.df %>%
  group_by(OTU, Genus) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance),
            SE = se(Abundance))




#write.csv(phy.sum.c.abx.sum, "16S/SummerContentABX_TaxTable.csv")
#write.csv(phy.sum.m.abx.sum, "16S/SummerMucosaABX_TaxTable.csv")
#write.csv(phy.win.c.abx.sum, "16S/WinterContentABX_TaxTable.csv")
```


### ABX Microbes - All samples
```{r}
phy.c.abx <- subset_samples(phy.c, Antibiotics == "Yes")
phy.c.abx <- filter_taxa(phy.c.abx, function(x) sum(x) > 0, T)


phy.c.abx.df <- psmelt(phy.c.abx)
phy.c.abx.sum <- phy.c.abx.df %>%
  group_by(OTU, Genus, Season) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance),
            SE = se(Abundance))

#write.csv(phy.c.abx.sum, "16S/ContentABX_TaxTable.csv")


### Effect size calculation
cohen.d(phy.c.abx.df$Abundance ~ phy.c.abx.df$Season)
  # d = 8.591606e-18 (negligible)


### Power calculation
pwr.t2n.test(n1 = length(which(phy.c.abx.df$Season == "Summer")),
            n2 = length(which(phy.c.abx.df$Season == "Winter")), d = 8.591606e-18)
  # power = 0.05


### Species test
otus <- data.frame(otu_table(phy.c.abx))
wil.spe <- data.frame()
for(taxon in 1:dim(data.frame(otu_table(phy.c.abx)))[1]){
  wil <- wilcox.test(x=as.numeric(otus[taxon,]), g=meta$Season)
  wil.spe <- rbind(wil.spe, data.frame(taxon = rownames(otus)[taxon], pval = wil$p.value))
}
wil.spe$padj <- p.adjust(wil.spe$pval, method = "BH")




### Identify top 10 taxa in summer and winter content ABX
phy.c.abx.sum.top <- phy.c.abx.sum[which(phy.c.abx.sum$Season == "Summer"),]
phy.c.abx.sum.top <- phy.c.abx.sum.top[order(-phy.c.abx.sum.top$Mean),]
s.top <- phy.c.abx.sum.top[1:10,]

phy.c.abx.win.top <- phy.c.abx.sum[which(phy.c.abx.sum$Season == "Winter"),]
phy.c.abx.win.top <- phy.c.abx.win.top[order(-phy.c.abx.win.top$Mean),]
w.top <- phy.c.abx.win.top[1:10,]





## Subset out top 10 winter taxa from all samples
phy.c.abx.top <- subset_taxa(phy.c.abx, Species == w.top$OTU[1] | Species == w.top$OTU[2] |
                               Species == w.top$OTU[3] | Species == w.top$OTU[4] |
                               Species == w.top$OTU[5] | Species == w.top$OTU[6] |
                               Species == w.top$OTU[7] | Species == w.top$OTU[8] |
                               Species == w.top$OTU[9] | Species == w.top$OTU[10])
phy.c.abx.top.df <- psmelt(phy.c.abx.top)
```


### ABX Microbes - Plot top ABX taxa
```{r}
ggplot(phy.c.abx.top.df, aes(x=Season, y=Abundance, fill=Season)) +
  geom_dotplot(binaxis='y', stackdir='center', dotsize = 1.5) +
  facet_wrap(OTU ~ ., ncol = 5, scales = "free") +
  scale_fill_manual(name="Season", values=c("#E69F00", "#0072B2")) +
  ylab("Relative Abundance") +
  stat_summary(fun.data = "mean_se", fun.args = list(mult = 1), geom = "pointrange",
               color = "black", position = position_dodge(0.7), size = 0.75,
               show.legend = F) +
  theme(plot.title=element_text(hjust=0.5, size=20),
        axis.text.x = element_text(size=14),
        axis.text.y = element_text(size=14),
        axis.title.x = element_text(size=20, margin=margin(t=10, r=0, b=0, l=0)),
        axis.title.y = element_text(size=20, margin=margin(t=0, r=10, b=0, l=0)),
        strip.text.x = element_text(size=20),
        strip.text.y = element_text(size=14),
        panel.spacing=unit(1, "lines"),
        legend.title = element_text(size = 18, face="bold"),
        legend.text = element_text(size=16),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank()
  ) 
```