---
title: "Code_16S"
author: "Edna Chiang"
date: "2/24/2022"
output: html_document
---

### Load Libraries
```{r}
library(ape)
library(dplyr)
library(dunn.test)
library(effsize)
library(ggplot2)
library(grid)
library(gridExtra)
library(phyloseq)
library(picante)
library(pwr)
library(tidyr)
library(vegan)
library(miLineage)
#source('scripts/import_crds.R')
#source('scripts/bin_crds.R')
source('scripts/misc.R')
#source('scripts/calc_delta_metrics.R')
#source('scripts/simper_pretty.R')
#source('scripts/R_krusk.R')
source('scripts/removeTaxa.R')
#source('scripts/kaijuCreatePhyseq.R')
theme_set(theme_bw())
set.seed(1)
```

### DON'T RUN - Import Data
```{r}
# Link files
shared = "16S/final.0.03.norm.shared"
taxonomy = "16S/final.taxonomy"

# Import mothur data
mothurdata = import_mothur(
  mothur_shared_file = shared,
  mothur_constaxonomy_file = taxonomy)

# Add OTU column in taxonomy table
tax_table(mothurdata) <- cbind(tax_table(mothurdata), 
                               row.names(tax_table(mothurdata)))

# Rename taxonomy table columns
colnames(tax_table(mothurdata)) <- c("Domain", "Phylum", "Class", "Order", "Family", "Genus", "Species")

### Prepare metadata
meta <- read.csv("metadata.csv")
auc <- read.csv("auc.csv")
delta <- read.csv("delta_metrics.csv")
rownames(meta) <- meta$Sample
divsum <- read.table("16S/final.0.03.norm.groups.summary", header = T)
divsum$test <- strsplit(divsum$group, "_")
dna <- read.csv("dna.csv")

# Remove samples w/o CRDS metrics
divsum <- divsum[-which(divsum$group == "CC1_S11"),]
divsum <- divsum[-which(divsum$group == "CC1_S34"),]
divsum <- divsum[-which(divsum$group == "CC1_W26"),]
divsum <- divsum[-which(divsum$group == "CC2_S37"),]
  # Since miLineage is not sig, there's no reason to remove these samples anymore

# Fill in metadata
for(i in 1:nrow(divsum)){
  divsum$Individual[i] <- divsum$test[[i]][[2]]
  
  use <- which(meta$ID == divsum$Individual[i])
  divsum$Source[i] <- divsum$test[[i]][[1]]
  divsum[i,18:30] <- meta[use,]
  
  auc.use <- which(auc$ID == divsum$Individual[i])
  divsum$AUC[i] <- auc$AUC[auc.use]
  
  delta.use <- which(delta$ID == divsum$Individual[i])
  divsum$DeltaSlope[i] <- delta$Slope[delta.use]
  
  dna.use <- which(dna$Sample == divsum$group[i])
  divsum$DNAyield[i] <- dna$DNA_Yield_.ng.mg.[dna.use]
  
}
divsum <- divsum[,-1]
divsum <- divsum[,-6:-7]
divsum <- divsum[,-7:-8]
#divsum <- divsum[,-8:-10]
#divsum <- divsum[,-22]
divsum <- divsum[,-8:-9]
divsum <- divsum[,-8:-9]
divsum <- divsum[,-21]
colnames(divsum)[1] <- "Sample"
divsum$Source <- substr(divsum$Source, start = 2, stop = 2)
divsum$Source[which(divsum$Source == "C")] <- "Content"
divsum$Source[which(divsum$Source == "T")] <- "Mucosa"



### Add metadata to phyloseq object
meta.ready <- sample_data(divsum)
sample_names(meta.ready) <- divsum$Sample
physeq <- merge_phyloseq(mothurdata, meta.ready)


# Remove OTUs that appear in < 3 samples
otu <- data.frame(otu_table(physeq))
otu.rem <- list()
for(j in 1:nrow(otu)){
  empty <- length(which(otu[j,] == 0))
    # Identifies # of samples w/o OTU
  if(empty > 38){
    # If OTU appears in < 3 samples
    otu.rem <- append(otu.rem, j)
      # Create list of OTUs that appear in only 1 sample
  }
}
# 1275 OTUs to remove
otu.rem <- otu[-unlist(otu.rem),]


# Update phyloseq object w/ removed OTUs
phy.rem <- merge_phyloseq(otu_table(otu.rem, taxa_are_rows=T), sample_data(physeq), tax_table(physeq))
 

# Order factors
sample_data(phy.rem)$Season <- ordered(sample_data(phy.rem)$Season,
                                     levels=c("Summer", "Winter", "Spring"))

# Remove Inulin outliers
########crds.rem <- crds.bin[-which(crds.bin$ID == "S34"),]
#phy.use <- subset_samples(phy.rem, ID != "S37")
  # ABX didn't work; high [DNA]
  # Already removed
phy.use <- subset_samples(phy.rem, ID != "P28")
#########crds.rem <- crds.rem[-which(crds.rem$ID == "P30"),]

# Remove Saline outliers
#########crds.rem <- crds.rem[-which(crds.rem$ID == "W26"),]
#########crds.rem <- crds.rem[-which(crds.rem$ID == "W43"),]
phy.use <- subset_samples(phy.use, ID != "W50")
phy.use <- subset_samples(phy.use, ID != "P04")
  # This is an adult, not pup


# Calculate relative abundance
phy.ra <- transform_sample_counts(phy.use, function(x){(x/sum(x))*100})

# Separate by Sample Type
phy.c <- subset_samples(phy.ra, Source == "Content")
phy.m <- subset_samples(phy.ra, Source == "Mucosa")

# Separate by Season
phy.sum <- subset_samples(phy.ra, Season == "Summer")
phy.win <- subset_samples(phy.ra, Season == "Winter")
phy.spr <- subset_samples(phy.ra, Season == "Spring")

# Separate by Season + Sample Type
phy.sum.c <- subset_samples(phy.sum, Source == "Content")
  # 17 samples
phy.sum.m <- subset_samples(phy.sum, Source == "Mucosa")
  # 15 samples
phy.win.c <- subset_samples(phy.win, Source == "Content")
  # 5 samples
phy.win.m <- subset_samples(phy.win, Source == "Mucosa")
  # 1 sample
phy.spr.c <- subset_samples(phy.spr, Source == "Content")
  # 4 samples
phy.spr.m <- subset_samples(phy.spr, Source == "Mucosa")
  # 2 samples


# Save phyloseq objects
#save(phy.use, file = "16S/physeq/phy.all.counts.RData")
#save(phy.ra, file = "16S/physeq/phy.all.relabund.RData")
#save(phy.c, file = "16S/physeq/phy.content.RData")
#save(phy.m, file = "16S/physeq/phy.mucosa.RData")
#save(phy.sum.c, file = "16S/physeq/phy.summer.content.RData")
#save(phy.sum.m, file = "16S/physeq/phy.summer.mucosa.RData")
#save(phy.win.c, file = "16S/physeq/phy.winter.content.RData")
#save(phy.spr.c, file = "16S/physeq/phy.spring.content.RData")
```



### Load Phyloseq Data
```{r}
load("16S/physeq/phy.all.counts.RData")
load("16S/physeq/phy.all.relabund.RData")
load("16S/physeq/phy.content.RData")
load("16S/physeq/phy.mucosa.RData")
load("16S/physeq/phy.summer.content.RData")
load("16S/physeq/phy.summer.mucosa.RData")
load("16S/physeq/phy.winter.content.RData")
load("16S/physeq/phy.spring.content.RData")
```


### miLineage - OTUs associated w/ Delta metrics
```{r}
### Format phyloseq objects
phy.con.raw <- subset_samples(phy.use, Source == "Content")
phy.c.rem <- filter_taxa(phy.con.raw, function(x) sum(x) > 0, T)
phy.muc.raw <- subset_samples(phy.use, Source == "Mucosa")
phy.m.rem <- filter_taxa(phy.muc.raw, function(x) sum(x) > 0, T)


### Format tax table
tax.con <- data.frame(tax_table(phy.c.rem))
colnames(tax.con) <- c("Rank1", "Rank2", "Rank3", "Rank4", "Rank5", "Rank6", "Rank7")
tax.con <- as.matrix(tax.con)
tax.muc <- data.frame(tax_table(phy.m.rem))
colnames(tax.muc) <- c("Rank1", "Rank2", "Rank3", "Rank4", "Rank5", "Rank6", "Rank7")
tax.muc <- as.matrix(tax.muc)                    
                    

### Format metadata
meta.con <- data.frame(sample_data(phy.c.rem))
meta.muc <- data.frame(sample_data(phy.m.rem))
delta.c <- meta.con[,21:22]
delta.c$BodyMass <- meta.con$BodyMass
delta.c$DNAyield <- meta.con$DNAyield
delta.c <- as.matrix(delta.c)
delta.m <- meta.muc[,21:22]
delta.m$BodyMass <- meta.muc$BodyMass
delta.m$DNAyield <- meta.muc$DNAyield
delta.m <- as.matrix(delta.m)


### Format OTU table
otu.c <- as.matrix(t(data.frame(otu_table(phy.c.rem))))
otu.m <- as.matrix(t(data.frame(otu_table(phy.m.rem))))



all.phy.c <- QCAT_GEE(OTU=otu.c, Tax=tax.con, X=delta.c, X.index = 1, Z=delta.c, Z.index=1,  fdr.alpha=0.05, n.resample = 999)
  # No sig

all.phy.m <- QCAT_GEE(OTU=otu.m, Tax=tax.muc, X=delta.m, X.index = 1, Z=delta.m, Z.index=1,  fdr.alpha=0.05, n.resample = 999)
  # No sig





### Format phyloseq objects
phy.con.raw <- subset_samples(phy.use, Source == "Content")
phy.con.sum <- subset_samples(phy.con.raw, Season == "Summer")
phy.con.sum <- filter_taxa(phy.con.sum, function(x) sum(x) > 0, T)


### Format tax table
tax.con <- data.frame(tax_table(phy.con.sum))
colnames(tax.con) <- c("Rank1", "Rank2", "Rank3", "Rank4", "Rank5", "Rank6", "Rank7")
tax.con <- as.matrix(tax.con)


### Format metadata
meta.con <- data.frame(sample_data(phy.con.sum))
delta.c <- meta.con[,21:22]
delta.c$BodyMass <- meta.con$BodyMass
delta.c$DNAyield <- meta.con$DNAyield
delta.c <- as.matrix(delta.c)

### Format OTU table
otu.c <- as.matrix(t(data.frame(otu_table(phy.con.sum))))

phy.con.sum.test <- QCAT_GEE(OTU=otu.c, Tax=tax.con, X=delta.c, X.index = 1, Z=delta.c, Z.index=1,  fdr.alpha=0.05, n.resample = 99)
  # No sig





### Format phyloseq objects
phy.con.noabx.raw <- subset_samples(phy.con.sum, Antibiotics == "No")
phy.con.noabx.raw <- filter_taxa(phy.con.noabx.raw, function(x) sum(x) > 0, T)


### Format tax table
tax.con <- data.frame(tax_table(phy.con.noabx.raw))
colnames(tax.con) <- c("Rank1", "Rank2", "Rank3", "Rank4", "Rank5", "Rank6", "Rank7")
tax.con <- as.matrix(tax.con)


### Format metadata
meta.con <- data.frame(sample_data(phy.con.noabx.raw))
delta.c <- meta.con[,21:22]
delta.c$BodyMass <- meta.con$BodyMass
delta.c$DNAyield <- meta.con$DNAyield
delta.c <- as.matrix(delta.c)

### Format OTU table
otu.c <- as.matrix(t(data.frame(otu_table(phy.con.noabx.raw))))

phy.con.sum.noabx.test <- QCAT_GEE(OTU=otu.c, Tax=tax.con, X=delta.c, X.index = 1, Z=delta.c, Z.index=1,  fdr.alpha=0.05, n.resample = 99)
  # No sig


```


### Linear regression - OTUs + Delta metrics
```{r}
# Prepare data
sum.c.df <- psmelt(phy.sum.c)
sum.c.reg <- sum.c.df[,1:3]
sum.c.reg[,4:10] <- sum.c.df[,14:20]
sum.c.reg$BodyTemp <- sum.c.df$BodyTemp
sum.c.reg$BodyMass <- sum.c.df$BodyMass
sum.c.reg$DNAyield <- sum.c.df$DNAyield
sum.c.reg$AUC <- sum.c.df$AUC
sum.c.reg$DeltaSlope <- sum.c.df$DeltaSlope
sum.c.reg[,16:21] <- sum.c.df[,28:33]

# Look for correlations between variables
pairs(sum.c.reg[,12:15])
  # AUC & DeltaSlope --> Use just one metric
  # Other variables are fine (not correlated, visually)

xyplot(Abundance ~ BodyMass, sum.c.reg)
BodyMass.lm <- lm(BodyMass ~ Abundance, data = sum.c.reg, na.action = na.omit)
  # P = 1
cor.test(sum.c.reg$Abundance, sum.c.reg$BodyMass, method = "spearman", exact = F)
  # p-value < 2.2e-16
  # rho = -0.04892234


xyplot(Abundance ~ DNAyield, sum.c.reg)
DNAyield.lm <- lm(DNAyield ~ Abundance, data = sum.c.reg, na.action = na.omit)
  # P = 1
cor.test(sum.c.reg$Abundance, sum.c.reg$DNAyield, method = "spearman", exact = F)
  # p-value < 5.034e-14
  # rho = 0.04301139 


xyplot(Abundance ~ AUC, sum.c.reg)
AUC.lm <- lm(AUC ~ Abundance, data = sum.c.reg, na.action = na.omit)
  # P = 1
cor.test(sum.c.reg$Abundance, sum.c.reg$AUC, method = "spearman", exact = F)
  # p-value = 0.001555
  # rho = 0.01807829



# Function to extract the best subset multiple linear regression model 
# Arguments:
#   vars: vectors of all variables to consider in the model
#   response: response variable of the model (must be in quotes!)
#   dat: dataframe with vars and response
# Returns: a list with the variables in the best model, bic, cp, and adjusted r2
get_bestsub_summary <- function(vars, response, dat) {
  formula = reformulate(termlabels = vars, response = response)
  lm_model <- regsubsets(formula, method = "exhaustive", dat)
  bic <- summary(lm_model)$bic
  cp <- summary(lm_model)$cp
  adjr2 <- summary(lm_model)$adjr2
  best_model <- summary(lm_model)$which[which.min(bic), ]
  return(list(model = best_model, bic = bic, cp = cp, adjr2 = adjr2))
}




vars <- c("BodyMass", "DNAyield", "AUC")
sum.c.reg.use <- data.frame(sum.c.reg$Abundance)
colnames(sum.c.reg.use) <- "Abundance"
sum.c.reg.use$BodyMass <- sum.c.reg$BodyMass
sum.c.reg.use$DNAyield <- sum.c.reg$DNAyield
sum.c.reg.use$AUC <- sum.c.reg$AUC
sum.c.model <- lapply(sum.c.reg.use, 
  function(x) {
    best_model <- get_bestsub_summary(vars, "Abundance", sum.c.reg.use)
    model <- lm(
      formula = reformulate(vars[best_model$model[-1]], "Abundance"), 
      data = sum.c.reg.use)
    return(model)
  })
summary(sum.c.model)

```
### ABX-surviving microbes - Prepare data
```{r}
### Separate ABX/No ABX
phy.sum.c.noabx <- subset_samples(phy.sum.c, Antibiotics == "No")
  # 14 samples
phy.sum.c.abx <- subset_samples(phy.sum.c, Antibiotics == "Yes")
  # 3 samples
phy.sum.m.noabx <- subset_samples(phy.sum.m, Antibiotics == "No")
  # 12 samples
phy.sum.m.abx <- subset_samples(phy.sum.m, Antibiotics == "Yes")
  # 3 samples
phy.win.c.abx <- subset_samples(phy.win.c, Antibiotics == "Yes")
  # 4 samples
phy.spr.c.noabx <- subset_samples(phy.spr.c, Antibiotics == "No")
  # 4 samples


### Drop taxa in < 3 samples
otu.sum.m.abx.otu <- data.frame(otu_table(phy.sum.c.abx))
otu.sum.m.abx.otu.rem <- list()
for(a in 1:nrow(otu.sum.m.abx.otu)){
  empty <- length(which(otu.sum.m.abx.otu[a,] == 0))
    # Identifies # of samples w/o OTU
  if(empty > 0){
    # If OTU appears in < 3 samples
    otu.sum.m.abx.otu.rem <- append(otu.sum.m.abx.otu.rem, a)
      # Create list of OTUs that appear in only 1 sample
  }
}
# 899 OTUs to remove
otu.sum.m.abx.otu.rem <- otu.sum.m.abx.otu[-unlist(otu.sum.m.abx.otu.rem),]
# Update physeq object
phy.sum.m.abx.rem <- merge_phyloseq(otu_table(otu.sum.m.abx.otu.rem, taxa_are_rows=T),
                                    sample_data(phy.sum.c.abx), tax_table(phy.sum.c.abx))



### Drop taxa in < 3 samples
otu.sum.m.abx.otu <- data.frame(otu_table(phy.sum.m.abx))
otu.sum.m.abx.otu.rem <- list()
for(b in 1:nrow(otu.sum.m.abx.otu)){
  empty <- length(which(otu.sum.m.abx.otu[b,] == 0))
    # Identifies # of samples w/o OTU
  if(empty > 0){
    # If OTU appears in < 3 samples
    otu.sum.m.abx.otu.rem <- append(otu.sum.m.abx.otu.rem, b)
      # Create list of OTUs that appear in only 1 sample
  }
}
# 642 OTUs to remove
otu.sum.m.abx.otu.rem <- otu.sum.m.abx.otu[-unlist(otu.sum.m.abx.otu.rem),]
# Update physeq object
phy.sum.m.abx.rem <- merge_phyloseq(otu_table(otu.sum.m.abx.otu.rem, taxa_are_rows=T),
                                    sample_data(phy.sum.m.abx), tax_table(phy.sum.m.abx))



### Drop taxa in < 3 samples
otu.win.c.abx.otu <- data.frame(otu_table(phy.win.c.abx))
otu.win.c.abx.otu.rem <- list()
for(c in 1:nrow(otu.win.c.abx.otu)){
  empty <- length(which(otu.win.c.abx.otu[c,] == 0))
    # Identifies # of samples w/o OTU
  if(empty > 1){
    # If OTU appears in < 3 samples
    otu.win.c.abx.otu.rem <- append(otu.win.c.abx.otu.rem, c)
      # Create list of OTUs that appear in only 1 sample
  }
}
# 939 OTUs to remove
otu.win.c.abx.otu.rem <- otu.win.c.abx.otu[-unlist(otu.win.c.abx.otu.rem),]
# Update physeq object
phy.win.c.abx.rem <- merge_phyloseq(otu_table(otu.win.c.abx.otu.rem, taxa_are_rows=T),
                                    sample_data(phy.win.c.abx), tax_table(phy.win.c.abx))

```


### ABX Microbes - Create tables
```{r}
#barplot(sort(taxa_sums(phy.sum.c.abx.rem),TRUE)[1:10]/nsamples(phy.sum.c.abx.rem),las=2,cex.axis=.7)

phy.sum.c.abx.df <- psmelt(phy.sum.c.abx.rem)
phy.sum.c.abx.sum <- phy.sum.c.abx.df %>%
  group_by(OTU, Genus) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance),
            SE = se(Abundance))


phy.sum.m.abx.df <- psmelt(phy.sum.m.abx.rem)
phy.sum.m.abx.sum <- phy.sum.m.abx.df %>%
  group_by(OTU, Genus) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance),
            SE = se(Abundance))



phy.win.c.abx.df <- psmelt(phy.win.c.abx.rem)
phy.win.c.abx.sum <- phy.win.c.abx.df %>%
  group_by(OTU, Genus) %>%
  summarize(Mean = mean(Abundance),
            SD = sd(Abundance),
            SE = se(Abundance))




#write.csv(phy.sum.c.abx.sum, "16S/SummerContentABX_TaxTable.csv")
#write.csv(phy.sum.m.abx.sum, "16S/SummerMucosaABX_TaxTable.csv")
#write.csv(phy.win.c.abx.sum, "16S/WinterContentABX_TaxTable.csv")
```